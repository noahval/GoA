# 1.40 Save System Cloud Storage Plan

## Overview
Cloud save system using Nakama server for cross-device progression and data backup. Players can sync their game state across devices and recover progress if local data is lost.

## Core Goals
1. Automatic cloud saves after significant game events
2. Manual save/load from settings menu
3. Cross-device sync for authenticated players
4. Fallback to local saves for offline players
5. Save migration (local to cloud when player authenticates)

---

## Part 1: Save System Architecture

### What Gets Saved

#### Global Stats (Global.gd)
- Six stats: strength, constitution, dexterity, wisdom, intelligence, charisma
- Experience values for each stat
- Prestige system: reputation_points, lifetime_reputation_earned, reputation_upgrades
- Dev mode settings

#### Level Variables (Level1Vars.gd)
- **Resources**: coal, currency (copper/silver/gold/platinum), lifetime_currency, components, mechanisms, pipes
- **Upgrades**: shovel_lvl, plow_lvl, auto_shovel levels and upgrades, overseer_lvl
- **Story Flags**: barkeep_bribed, shopkeep_bribed, heart_taken, whisper_triggered, door_discovered
- **Progress**: stolen_coal, stolen_writs, correct_answers, suspicion, equipment_value
- **Timers/Buffs**: break_time_remaining, stamina, cooldowns, buff durations
- **Timestamps**: last_played_timestamp (for offline earnings)

### Storage Structure
```
Collection: "player_data"
    Key: "game_save"
        Value: {
            "version": "1.0",
            "timestamp": unix_time,
            "global": {...},
            "level1_vars": {...}
        }
```

---

## Part 2: Cloud Save Implementation

### 2.1 Save Game Function (Already Exists)
Located in `nakama_client.gd`:
```gdscript
func save_game() -> bool:
	if not is_authenticated:
		DebugLogger.error("Cannot save: Not authenticated")
		return false

	# Update timestamp
	Level1Vars.last_played_timestamp = Time.get_unix_time_from_system()

	var save_data = {
		"version": "1.0",
		"timestamp": Time.get_unix_time_from_system(),
		"global": _get_global_data(),
		"level1_vars": _get_level1_vars_data()
	}

	var result = await write_storage("player_data", "game_save", save_data)
	if result:
		DebugLogger.info("Full game state saved to cloud")
		return true
	return false
```

**What to verify**:
- [ ] `_get_global_data()` captures all necessary Global variables
- [ ] `_get_level1_vars_data()` captures all necessary Level1Vars variables
- [ ] Timestamp updates correctly
- [ ] Error handling prevents data loss

### 2.2 Load Game Function (Already Exists)
Located in `nakama_client.gd`:
```gdscript
func load_game() -> bool:
	if not is_authenticated:
		DebugLogger.error("Cannot load: Not authenticated")
		return false

	var save_data = await read_storage("player_data", "game_save")

	if save_data:
		# Validate structure
		if not save_data.has("global") or not save_data.has("level1_vars"):
			DebugLogger.error("Invalid cloud save structure")
			return false

		# Load data
		_set_global_data(save_data.global)
		_set_level1_vars_data(save_data.level1_vars)

		DebugLogger.info("Full game state loaded from cloud")
		return true

	DebugLogger.info("No cloud save found")
	return false
```

**What to verify**:
- [ ] `_set_global_data()` restores all Global variables correctly
- [ ] `_set_level1_vars_data()` restores all Level1Vars variables correctly
- [ ] Migration from old save format works (single currency to multi-currency)
- [ ] Missing fields use sensible defaults

---

## Part 3: Save Triggers

### When to Auto-Save

#### 3.1 After Major Purchases
```gdscript
# In shop.gd
func _on_upgrade_purchased():
	Level1Vars.currency.copper -= cost
	Level1Vars.shovel_lvl += 1

	# Save after spending currency
	if NakamaClient.is_authenticated:
		NakamaClient.save_game()  # Fire and forget, don't await
```

#### 3.2 After Stat Gains
```gdscript
# In Global.gd
func add_stat_exp(stat_name: String, amount: float):
	# Existing code to add exp...

	# Save if stat level changed
	if level_increased:
		if NakamaClient.is_authenticated:
			NakamaClient.save_game()
```

#### 3.3 Before Scene Changes
```gdscript
# In Global.gd
func change_scene_with_check(scene_path: String):
	# Save current progress before leaving scene
	if NakamaClient.is_authenticated:
		await NakamaClient.save_game()

	# Then change scene
	get_tree().change_scene_to_file(scene_path)
```

#### 3.4 Periodic Auto-Save
```gdscript
# In Global.gd or dedicated SaveManager
var autosave_timer: Timer

func _ready():
	# Setup autosave every 2 minutes
	autosave_timer = Timer.new()
	autosave_timer.wait_time = 120.0
	autosave_timer.autostart = true
	autosave_timer.timeout.connect(_on_autosave)
	add_child(autosave_timer)

func _on_autosave():
	if NakamaClient.is_authenticated:
		NakamaClient.save_game()
		print("Auto-saved to cloud")
```

#### 3.5 On Game Exit
```gdscript
# In Global.gd
func _notification(what):
	if what == NOTIFICATION_WM_CLOSE_REQUEST:
		# Save before closing
		if NakamaClient.is_authenticated:
			await NakamaClient.save_game()
		get_tree().quit()
```

---

## Part 4: Settings Menu Integration

### 4.1 Save/Load Buttons in Settings Panel

Add to settings panel UI:
- "Save to Cloud" button (only visible when authenticated)
- "Load from Cloud" button (only visible when authenticated)
- "Delete Cloud Save" button (only visible when authenticated, requires confirmation)
- Status text showing last save time

### 4.2 Settings Panel Script
```gdscript
extends Control

@onready var save_button = $SaveButton
@onready var load_button = $LoadButton
@onready var delete_button = $DeleteButton
@onready var save_status = $SaveStatus

func _ready():
	_update_cloud_save_ui()
	save_button.pressed.connect(_on_save_pressed)
	load_button.pressed.connect(_on_load_pressed)
	delete_button.pressed.connect(_on_delete_pressed)

func _update_cloud_save_ui():
	var authenticated = NakamaClient.is_authenticated

	save_button.visible = authenticated
	load_button.visible = authenticated
	delete_button.visible = authenticated

	if authenticated:
		save_status.text = "Logged in as: " + NakamaClient.username
	else:
		save_status.text = "Playing offline - saves are local only"

func _on_save_pressed():
	save_button.disabled = true
	var success = await NakamaClient.save_game()

	if success:
		_show_notification("Game saved to cloud!")
	else:
		_show_notification("Save failed - check connection")

	save_button.disabled = false

func _on_load_pressed():
	# Confirm before loading (overwrites current progress)
	var confirmed = await _show_confirmation("Load cloud save? Current progress will be replaced.")

	if not confirmed:
		return

	load_button.disabled = true
	var success = await NakamaClient.load_game()

	if success:
		_show_notification("Loaded from cloud!")
		# Refresh UI to show loaded data
		get_tree().reload_current_scene()
	else:
		_show_notification("Load failed - no cloud save found")

	load_button.disabled = false

func _on_delete_pressed():
	var confirmed = await _show_confirmation("Delete cloud save? This cannot be undone!")

	if not confirmed:
		return

	delete_button.disabled = true
	# Delete by writing empty data or using Nakama delete API
	var success = await NakamaClient.write_storage("player_data", "game_save", {})

	if success:
		_show_notification("Cloud save deleted")
	else:
		_show_notification("Delete failed")

	delete_button.disabled = false
```

---

## Part 5: Offline/Local Save Fallback

### 5.1 Hybrid Save System
Players should be able to play offline with local saves:

```gdscript
# Universal save function that picks cloud or local
func save_game_universal():
	if NakamaClient.is_authenticated:
		# Cloud save
		var success = await NakamaClient.save_game()
		if success:
			DebugLogger.info("Saved to cloud")
		else:
			# Cloud save failed, fall back to local
			LocalSaveManager.save_game()
			DebugLogger.warn("Cloud save failed, saved locally instead")
	else:
		# Offline mode - save locally
		LocalSaveManager.save_game()
		DebugLogger.info("Saved locally (offline mode)")
```

### 5.2 Load Priority
```gdscript
# Universal load function
func load_game_universal():
	if NakamaClient.is_authenticated:
		# Try cloud first
		var success = await NakamaClient.load_game()
		if success:
			DebugLogger.info("Loaded from cloud")
			return true
		else:
			# No cloud save, try local
			if LocalSaveManager.has_save():
				LocalSaveManager.load_game()
				DebugLogger.info("Cloud save not found, loaded local save")
				return true
	else:
		# Offline - load local
		if LocalSaveManager.has_save():
			LocalSaveManager.load_game()
			DebugLogger.info("Loaded from local storage")
			return true

	# No saves found anywhere
	DebugLogger.info("No saves found, starting fresh")
	return false
```

---

## Part 6: Save Migration

### 6.1 Local to Cloud Migration
When player authenticates after playing offline:

```gdscript
# In login_popup.gd or auth handler
func _on_auth_success(session_data):
	print("Logged in as: ", session_data.username)

	# Check if player has local save
	if LocalSaveManager.has_save():
		var migrate = await _ask_migrate_save()

		if migrate:
			# Current game state is already loaded from local save
			# Just save it to cloud
			var success = await NakamaClient.save_game()

			if success:
				_show_notification("Local progress uploaded to cloud!")
				# Optionally delete local save
				LocalSaveManager.delete_save()
			else:
				_show_notification("Upload failed - local save kept")
	else:
		# No local save, try loading from cloud
		var loaded = await NakamaClient.load_game()
		if loaded:
			_show_notification("Cloud save loaded!")

func _ask_migrate_save() -> bool:
	return await _show_confirmation("Upload your offline progress to cloud?")
```

### 6.2 Cloud to Local Sync
Download cloud save for offline play:

```gdscript
# In settings menu
func _on_sync_to_local_pressed():
	if not NakamaClient.is_authenticated:
		_show_notification("Not logged in")
		return

	# Load from cloud
	var success = await NakamaClient.load_game()

	if success:
		# Save loaded state locally
		LocalSaveManager.save_game()
		_show_notification("Cloud save downloaded for offline use!")
	else:
		_show_notification("No cloud save to download")
```

---

## Part 7: Save Versioning

### 7.1 Version Field
All saves include version number:
```gdscript
var save_data = {
	"version": "1.0",  # Increment when save format changes
	"timestamp": time,
	"global": {...},
	"level1_vars": {...}
}
```

### 7.2 Migration Handling
```gdscript
func _set_level1_vars_data(data: Dictionary):
	# Check version
	var version = data.get("version", "0.9")  # Default to old version

	if version == "0.9":
		# Migrate old format
		_migrate_from_0_9(data)
	elif version == "1.0":
		# Current format, load normally
		_load_1_0_format(data)
	else:
		DebugLogger.warn("Unknown save version: " + version)
		# Try to load anyway, use defaults for missing fields
```

---

## Part 8: Error Recovery

### 8.1 Corrupted Cloud Save
```gdscript
func load_game() -> bool:
	var save_data = await read_storage("player_data", "game_save")

	if save_data:
		# Validate critical fields exist
		if not save_data.has("global") or not save_data.has("level1_vars"):
			DebugLogger.error("Cloud save corrupted - missing required fields")

			# Try to load local backup
			if LocalSaveManager.has_save():
				LocalSaveManager.load_game()
				DebugLogger.info("Loaded local backup instead")
				return true

			return false

		# Load if valid
		_set_global_data(save_data.global)
		_set_level1_vars_data(save_data.level1_vars)
		return true

	return false
```

### 8.2 Save Failure Retry
```gdscript
# Queue failed saves for retry
var save_queue = []

func save_game_with_retry():
	var success = await NakamaClient.save_game()

	if not success:
		# Queue for retry
		save_queue.append({
			"timestamp": Time.get_unix_time_from_system(),
			"attempts": 0
		})
		DebugLogger.warn("Save failed, queued for retry")

# Retry queued saves every minute
func _on_retry_timer_timeout():
	if save_queue.is_empty():
		return

	if not NakamaClient.is_authenticated:
		return

	var save_attempt = save_queue[0]
	save_attempt.attempts += 1

	var success = await NakamaClient.save_game()

	if success:
		save_queue.pop_front()
		DebugLogger.info("Retry save succeeded")
	elif save_attempt.attempts >= 3:
		save_queue.pop_front()
		DebugLogger.error("Save failed after 3 attempts, giving up")
```

---

## Implementation Checklist

### Phase 1: Verify Existing Code
- [ ] Test `save_game()` saves all necessary data
- [ ] Test `load_game()` restores all data correctly
- [ ] Verify save migration from old format works
- [ ] Check error handling prevents crashes

### Phase 2: Add Save Triggers
- [ ] Implement auto-save after purchases
- [ ] Implement auto-save after stat level-ups
- [ ] Add save before scene changes
- [ ] Setup periodic autosave timer
- [ ] Add save on game exit

### Phase 3: Settings Menu Integration
- [ ] Add save/load/delete buttons to settings panel
- [ ] Show authentication status
- [ ] Display last save timestamp
- [ ] Add confirmation dialogs for destructive actions

### Phase 4: Hybrid System
- [ ] Implement universal save (cloud if online, local if offline)
- [ ] Implement universal load with fallback priority
- [ ] Add local to cloud migration on login
- [ ] Test offline -> online -> offline flow

### Phase 5: Testing
- [ ] Test save/load with real game progression
- [ ] Test cross-device sync (save on one device, load on another)
- [ ] Test offline fallback when server unreachable
- [ ] Test corrupted save recovery
- [ ] Test save migration from old format

---

## Success Criteria

- [ ] Cloud saves work reliably for authenticated players
- [ ] Local saves work for offline players
- [ ] No data loss when switching between cloud and local
- [ ] Migration from local to cloud is seamless
- [ ] Error handling prevents crashes and data corruption
- [ ] Settings menu provides clear save/load controls
- [ ] Auto-save triggers at appropriate moments

---

## Notes

- Don't over-save - too frequent saves waste bandwidth
- Always update timestamp before saving
- Validate saves on load to catch corruption early
- Provide clear feedback when saves succeed/fail
- Keep local saves as backup even when using cloud

---

## Dependencies

**Before This**:
- Nakama Server Integration (provides save/load infrastructure)
- Global.gd stats system
- Level1Vars autoload
- LocalSaveManager (for offline fallback)

**After This**:
- Logging System (will use similar storage for bug reports)

---

## Files to Create/Modify

- `nakama_client.gd` - Already has save/load, verify completeness
- `global.gd` - Add auto-save triggers
- `settings_overlay.gd` - Add save/load/delete buttons
- New file: `save_manager.gd` - Universal save system (optional autoload)
