# scenes navigation

## Purchase System

### Furnace Ownership Purchase

**Location:** Overseer's Office scene ([level1/overseers_office.tscn](level1/overseers_office.tscn))

**Button Properties:**
- Text: "Buy Furnace Ownership"
- Position: Right panel, below Overtime button
- Visibility: Requires `lifetimecoins >= 10000` (1 Gold lifetime)
- Cost: 1 Gold

**Purchase Flow:**
```gdscript
func _on_buy_furnace_button_pressed():
    var cost = 10000  # 1 Gold
    if Level1Vars.coins >= cost:
        # Confirmation popup
        show_confirmation_popup(
            "Purchase Furnace Ownership?",
            "You'll become a furnace owner. Cost: 1 Gold"
        )

func confirm_purchase():
    var cost = 10000  # 1 Gold
    Level1Vars.coins -= cost
    Level1Vars.furnace_owned = true

    # Track for prestige system
    UpgradeTypesConfig.track_equipment_purchase("furnace_ownership", cost)

    # Log purchase
    DebugLogger.log_shop_purchase("Furnace Ownership", cost, 1)

    # Show success notification
    show_notification("You are now the owner of your own furnace")

    # Transition to owned furnace
    Global.change_scene_with_check(get_tree(), "res://level1/owned_furnace.tscn")
```

**One-Time Purchase:**
- Cannot be reversed
- Button disappears after purchase
- Unlocks worker management systems
- Changes bar scene navigation

---

## Scene Architecture

### Current Furnace (furnace.tscn)

**Remains as-is for non-owners:**
- Worker perspective
- Overseer interaction
- Coal → Coins conversion

### New Owned Furnace (own_furnace.tscn)

**Purpose:** Manager/owner perspective with new mechanics

**Scene Structure:**
Inherit from scene_template.tscn and set background to own-furnace.jpg

**Left Panel:**
- Title: "Your Furnace - Manager's Station"
- **Heat Gauge** (ProgressBar)
  - Shows current_heat / max_heat
  - Color: Red/orange gradient
  - Label: "Heat: 45 / 100"
- **Steam Production Display** (Label)
  - Shows steam_production_rate_lbh
  - Format: "Production: 10 lb/h"
  - Color: White text
- **Demand Indicator** (Panel with RichTextLabel)
  - Shows current demand state and rate
  - Format: "Demand: gold per lb/h (MEDIUM)"
  - Color-coded: Dark Blue (ZERO) / Green (LOW) / Yellow (MEDIUM) / Orange (HIGH) / Red (CRITICAL)
  - Shows demand reason text below
- **Payment Progress Display** (Option 2 Format)
  - **Progress Bar:** Shows gold_progress (0.0 - 1.0)
    - Color: Gold/yellow gradient
    - Visual: [=====>--------------]
  - Updates in real-time
- **Steam Storage Gauge** (ProgressBar) *(visible only when storage purchased)*
  - Shows stored_steam_lbs / max_storage_lbs
  - Color: Cyan/blue gradient (distinct from production)
  - Label: "Storage: 180 / 500 lb"
  - Shows efficiency: "Efficiency: 80%" (subtle, small text)
  - **Hidden by default** - only shows when has_storage_system = true
- **Resource Display**
  - Gold coins (current_gold)
  - Coal (still used for shoveling)

**Right Panel Buttons:**
- **Shovel Coal** - Manager helps with shoveling (replaces old coal generation)
  - Costs stamina
  - Gives charisma XP and strength
  - Generates small amount of heat
  - Temporarily boosts worker morale/efficiency
- **To Dormitory** - Transitions to owned_dorm.tscn for worker management ⭐ NEW
- **Upgrade Furnace** - Opens furnace upgrade popup
- **Storage Controls** *(visible only when Tier 3+ storage purchased)*
  - Opens storage control popup with release buttons and auto-release settings
- **Take Break** - Returns to bar

**Center Area:**
- Could display animated elements (heat glow, steam pipes) in future

**Color Indicator** (subtle discovery mechanic):
- Small dot next to "Visit Dormitory" button
- **Green:** All workers healthy (< 55 fatigue, morale > 60, food > 25%)
- **Yellow:** Some concerns (workers 55-80 fatigue OR morale 40-60 OR food 10-25%)
- **Red:** Critical issues (any worker > 80 fatigue OR morale < 40 OR food < 10%)

### New Owned Dormitory (owned_dorm.tscn) ⭐

**Purpose:** Worker management hub - hire, manage, upgrade dormitory

**Scene Structure:**
Duplicate existing [level1/dorm.tscn](level1/dorm.tscn) → owned_dorm.tscn

**Visual Changes:**
- Shows actual beds in scene (empty vs occupied)
- Bed count increases as upgrades purchased (visual progression)
- Workers visible when idle/on break

**Panel 1 (Left in Landscape / Top in Portrait): Worker Roster**
- Title: "Worker Roster"
- **Scrollable list** of hired workers (up to 20)
- Each worker entry shows:
  - **Name** (e.g., "Thomas")
  - **Type** (Stoker/Fireman/Engineer)
  - **Quality descriptor** (e.g., "Steady Hand", "Skilled Worker")
  - **Current status**: Active / Idle / On Break
  - If on break: countdown timer ("Break: 3:45 remaining")
  - **Action buttons per worker:**
    - [Assign Active] - Send to work
    - [Set Idle] - Rest in dorm
    - [Send on Break] - 5min recovery break
    - [Fire] - Remove worker (confirmation required)

**Panel 2 (Right in Landscape / Bottom in Portrait): Status & Controls**

*Status Info Section (Top):*
- **Food Supply:** "Food: 47 units (Decent Meal quality)"
  - Warning color if low (< 15 units: orange, < 5 units: red)
- **Dormitory Capacity:** "Beds: 8 / 10 occupied"
- **Reputation Hint** (narrative only, no number):
  - High reputation (70+): "Workers speak well of this place"
  - Medium reputation (30-70): "Your reputation is mixed"
  - Low reputation (< 30): "Conditions here are poorly regarded"
- **Worker Status Indicator:** Color dot (discovery mechanic)
  - Green/Yellow/Red based on crew health
  - No explicit explanation - players discover meaning

*Action Buttons Section (Middle):*
- **[Hire Workers]** - Opens hiring pool dialog (shows 3-8 candidates)
- **[Send All on Break]** - Group break, enhanced recovery ⭐
  - Shows "Cooldown: 12:34" if recently used (15min cooldown)
- **[Buy Food]** - Opens food shop (5 quality tiers)
- **[Dormitory Upgrades]** - Opens upgrade menu
  - **Beds Tab:** Purchase bed expansions (7 tiers, 2 → 20 capacity)
  - **Amenities Tab:** Purchase quality-of-life upgrades (10 tiers)
- **[Return to Furnace]** - Goes back to owned_furnace.tscn

*Settings Section (Bottom):*
- **Auto-Break Policy:** Dropdown selector
  - Options: Never / Conservative / Balanced / Aggressive / Preventive
  - Applies to all workers (individual breaks only)

**Dialogs Opened from owned_dorm.tscn:**

**1. Hiring Pool Dialog**
- Shows 3-8 available candidates (based on reputation)
- Each candidate: Name, Type, Quality descriptor, Hire cost
- [Refresh Pool - 50 coins] button
- Cannot hire if no empty beds

**2. Food Shop Dialog**
- Shows current supply and quality
- Purchase options: 5 quality tiers (Stale Bread → Premium Provisions)
- Each tier: Cost per 10 units, purchase buttons (10/50/100 units)
- Auto-purchase settings: Enable toggle, tier selector, amount selector

**3. Dormitory Upgrades Dialog**
- **Beds Tab:** 7 tiers of bed expansions
  - Visual: Checkmarks for owned, locks for locked
  - Shows requirements (runtime hours, components/mechanisms)
- **Amenities Tab:** 10 tiers of quality-of-life upgrades
  - Each shows: Description, vague benefit (no numbers), cost, requirements
  - Players discover actual effects through experimentation

**Center Area:**
- Background: dormitory interior (reuse dorm.jpg or create owned_dorm.jpg)
- Visual representation of beds (scalable, shows occupancy)
- Could show workers as sprites when idle/on break (future enhancement)

### Bar Scene Navigation Updates

**File:** [level1/bar.gd](level1/bar.gd)

**Modified Functions:**

**1. Furnace Button:**
```gdscript
func _on_to_blackbore_furnace_button_pressed():
    var target_scene
    if Level1Vars.furnace_owned:
        target_scene = "res://level1/owned_furnace.tscn"
    else:
        target_scene = "res://level1/furnace.tscn"
    Global.change_scene_with_check(get_tree(), target_scene)
```

**Button Text Update:**
- Before: "To Blackbore Furnace"
- After: "To Your Furnace" (when owned)

**2. Dormitory Button:** ⭐ NEW
```gdscript
func _on_to_dorm_button_pressed():
    var target_scene
    if Level1Vars.furnace_owned:
        target_scene = "res://level1/owned_dorm.tscn"
    else:
        target_scene = "res://level1/dorm.tscn"
    Global.change_scene_with_check(get_tree(), target_scene)
```

**Button Text Update:**
- Before: "To Dormitory"
- After: "To Worker Quarters" or "To Your Dormitory" (when owned)

**Routing Logic:**
- Before furnace purchase: All scenes route to original worker-perspective scenes
- After furnace purchase: Bar routes to owned_furnace.tscn and owned_dorm.tscn
- Maintains narrative consistency (player is now the owner/manager)

---

## Implementation Steps

### Phase 1: Level1Vars Setup

Add ownership flag to Level1Vars.gd:

```gdscript
# Furnace Ownership
var furnace_owned: bool = false
```

### Phase 2: Purchase System in Overseer's Office

Update [level1/overseers_office.gd](level1/overseers_office.gd):

```gdscript
@onready var buy_furnace_button = $Panel/BuyFurnaceButton

func _ready():
    update_buy_furnace_button()

func update_buy_furnace_button():
    # Show button only if player has 1 gold lifetime and hasn't purchased
    if Level1Vars.lifetimecoins >= 10000 and not Level1Vars.furnace_owned:
        buy_furnace_button.visible = true
        buy_furnace_button.disabled = Level1Vars.current_gold < 10000
    else:
        buy_furnace_button.visible = false

func _on_buy_furnace_button_pressed():
    show_confirmation_dialog(
        "Purchase Furnace Ownership?",
        "You'll become a furnace owner and can hire workers.\nCost: 1 Gold (10,000 copper)\n\nThis cannot be reversed.",
        confirm_furnace_purchase
    )

func confirm_furnace_purchase():
    var cost = 10000  # 1 Gold
    if Level1Vars.current_gold >= cost:
        Level1Vars.current_gold -= cost
        Level1Vars.furnace_owned = true

        # Track for prestige system
        UpgradeTypesConfig.track_equipment_purchase("furnace_ownership", cost)

        # Log purchase
        DebugLogger.log_shop_purchase("Furnace Ownership", cost, 1)

        # Show success notification
        Global.show_notification("You are now the owner of your own furnace!")

        # Transition to owned furnace scene
        Global.change_scene_with_check(get_tree(), "res://level1/owned_furnace.tscn")
    else:
        Global.show_notification("Insufficient gold")
```

### Phase 3: Create owned_furnace Scene

Create new scene: [level1/owned_furnace.tscn](level1/owned_furnace.tscn)

**Scene Structure:**
1. Inherit from scene_template.tscn
2. Set background to own-furnace.jpg (or reuse furnace.jpg initially)
3. Add UI panels (left, right, center)

**Left Panel Components:**

```gdscript
# owned_furnace.gd (attached to scene root)

@onready var heat_gauge = $LeftPanel/HeatGauge
@onready var steam_label = $LeftPanel/SteamLabel
@onready var demand_label = $LeftPanel/DemandLabel
@onready var gold_progress_bar = $LeftPanel/GoldProgressBar
@onready var storage_gauge = $LeftPanel/StorageGauge  # Hidden initially

func _ready():
    # Initialize UI
    storage_gauge.visible = Level1Vars.has_storage_system
    update_ui()

func update_heat_gauge():
    heat_gauge.value = Level1Vars.current_heat
    heat_gauge.max_value = Level1Vars.max_heat
    heat_gauge.get_node("Label").text = "Heat: %d / %d" % [Level1Vars.current_heat, Level1Vars.max_heat]

func update_steam_production_display():
    steam_label.text = "Production: %.1f lb/h" % Level1Vars.steam_production_rate_lbh

func update_demand_display():
    var state_colors = {
        "very_low": Color.DARK_BLUE,
        "low": Color.GREEN,
        "medium": Color.YELLOW,
        "high": Color.ORANGE,
        "critical": Color.RED
    }

    demand_label.text = "Demand: %.2fx (%s)" % [Level1Vars.demand_multiplier, Level1Vars.demand_state.to_upper()]
    demand_label.add_theme_color_override("font_color", state_colors[Level1Vars.demand_state])

func update_gold_progress_bar():
    gold_progress_bar.value = Level1Vars.gold_progress
    gold_progress_bar.max_value = 1.0
    gold_progress_bar.get_node("Label").text = "%.2f Gold" % Level1Vars.gold_progress
```

**Right Panel Buttons:**

```gdscript
@onready var shovel_button = $RightPanel/ShovelCoalButton
@onready var dormitory_button = $RightPanel/ToDormitoryButton
@onready var upgrade_button = $RightPanel/UpgradeFurnaceButton
@onready var break_button = $RightPanel/TakeBreakButton

func _on_shovel_coal_pressed():
    # Implementation from 6.1
    pass

func _on_to_dormitory_pressed():
    Global.change_scene_with_check(get_tree(), "res://level1/owned_dorm.tscn")

func _on_upgrade_furnace_pressed():
    # Open upgrade dialog (6.6)
    pass

func _on_take_break_pressed():
    Global.change_scene_with_check(get_tree(), "res://level1/bar.tscn")
```

### Phase 4: Create owned_dorm Scene

Create new scene: [level1/owned_dorm.tscn](level1/owned_dorm.tscn)

**Scene Structure:**
1. Duplicate existing [level1/dorm.tscn](level1/dorm.tscn)
2. Rename to owned_dorm.tscn
3. Attach new script: owned_dorm.gd
4. Modify UI for worker management

**Panel Structure:**

```gdscript
# owned_dorm.gd

@onready var worker_roster_container = $LeftPanel/ScrollContainer/WorkerRoster
@onready var food_label = $RightPanel/FoodLabel
@onready var capacity_label = $RightPanel/CapacityLabel
@onready var reputation_hint = $RightPanel/ReputationHint

func _ready():
    update_worker_roster()
    update_status_displays()

func update_worker_roster():
    # Clear existing roster display
    for child in worker_roster_container.get_children():
        child.queue_free()

    # Create worker entry for each hired worker
    for worker in Level1Vars.worker_roster:
        var entry = create_worker_entry(worker)
        worker_roster_container.add_child(entry)

func create_worker_entry(worker: Dictionary) -> Control:
    var entry = VBoxContainer.new()

    # Worker info
    var name_label = Label.new()
    name_label.text = "%s (%s - %s)" % [worker.name, worker.type.capitalize(), get_quality_descriptor(worker.quality_tier)]
    entry.add_child(name_label)

    # Status
    var status_label = Label.new()
    status_label.text = "Status: " + worker.status.capitalize()
    entry.add_child(status_label)

    # Action buttons
    var buttons = HBoxContainer.new()
    buttons.add_child(create_button("Assign Active", func(): set_worker_active(worker)))
    buttons.add_child(create_button("Set Idle", func(): set_worker_idle(worker)))
    buttons.add_child(create_button("Send on Break", func(): send_worker_on_break(worker)))
    buttons.add_child(create_button("Fire", func(): fire_worker(worker)))
    entry.add_child(buttons)

    return entry

func update_status_displays():
    # Food supply
    food_label.text = "Food: %d units (%s)" % [
        Level1Vars.food_supply,
        get_food_tier_name(Level1Vars.current_food_tier)
    ]

    # Dormitory capacity
    capacity_label.text = "Beds: %d / %d occupied" % [
        Level1Vars.worker_roster.size(),
        Level1Vars.dormitory_beds
    ]

    # Reputation hint (narrative, no number)
    if Level1Vars.worker_reputation >= 70:
        reputation_hint.text = "Workers speak well of this place"
    elif Level1Vars.worker_reputation >= 30:
        reputation_hint.text = "Your reputation is mixed"
    else:
        reputation_hint.text = "Conditions here are poorly regarded"
```

**Action Buttons:**

```gdscript
@onready var hire_button = $RightPanel/HireWorkersButton
@onready var group_break_button = $RightPanel/GroupBreakButton
@onready var food_button = $RightPanel/BuyFoodButton
@onready var upgrades_button = $RightPanel/DormUpgradesButton
@onready var return_button = $RightPanel/ReturnToFurnaceButton

func _on_hire_workers_pressed():
    # Open hiring pool dialog (6.3)
    pass

func _on_group_break_pressed():
    # Send all active workers on break (6.3)
    pass

func _on_buy_food_pressed():
    # Open food shop dialog (6.3)
    pass

func _on_dorm_upgrades_pressed():
    # Open dormitory upgrades dialog (6.3)
    pass

func _on_return_to_furnace_pressed():
    Global.change_scene_with_check(get_tree(), "res://level1/owned_furnace.tscn")
```

### Phase 5: Update Bar Scene Navigation

Update [level1/bar.gd](level1/bar.gd):

```gdscript
@onready var furnace_button = $Panel/ToBlackboreFurnaceButton
@onready var dorm_button = $Panel/ToDormButton

func _ready():
    update_navigation_buttons()

func update_navigation_buttons():
    # Update button text based on ownership
    if Level1Vars.furnace_owned:
        furnace_button.text = "To Your Furnace"
        dorm_button.text = "To Your Dormitory"
    else:
        furnace_button.text = "To Blackbore Furnace"
        dorm_button.text = "To Dormitory"

func _on_to_blackbore_furnace_button_pressed():
    var target_scene = "res://level1/owned_furnace.tscn" if Level1Vars.furnace_owned else "res://level1/furnace.tscn"
    Global.change_scene_with_check(get_tree(), target_scene)

func _on_to_dorm_button_pressed():
    var target_scene = "res://level1/owned_dorm.tscn" if Level1Vars.furnace_owned else "res://level1/dorm.tscn"
    Global.change_scene_with_check(get_tree(), target_scene)
```

---

## Testing Scenarios

### Test 1: Furnace Purchase Flow

**Objective:** Verify purchase system works correctly

**Steps:**
1. Start with lifetimecoins < 10,000
2. Go to Overseer's Office
3. Verify "Buy Furnace" button is hidden
4. Earn 1 gold (lifetimecoins >= 10,000)
5. Return to Overseer's Office
6. Verify button is now visible
7. Try clicking with insufficient current gold
8. Verify button is disabled or shows error
9. Acquire 1 gold current balance
10. Click "Buy Furnace" button
11. Verify confirmation dialog appears
12. Confirm purchase
13. Verify:
    - current_gold reduced by 10,000
    - furnace_owned = true
    - Scene transitions to owned_furnace.tscn
    - Purchase tracked in UpgradeTypesConfig

**Expected Results:**
- Button only shows when eligible
- Confirmation prevents accidental purchases
- One-time purchase (button disappears afterward)
- Successful transition to new scene

---

### Test 2: owned_furnace Scene UI

**Objective:** Verify owned_furnace scene displays correctly

**Steps:**
1. Purchase furnace (furnace_owned = true)
2. Enter owned_furnace.tscn
3. Verify Left Panel displays:
   - Heat gauge (0-700 initially)
   - Steam production label (0 lb/h initially)
   - Demand indicator (MEDIUM, yellow)
   - Gold progress bar (0.0)
   - Storage gauge (HIDDEN initially)
4. Verify Right Panel buttons:
   - Shovel Coal
   - To Dormitory
   - Upgrade Furnace
   - Take Break
5. Click each button, verify expected behavior:
   - Shovel Coal: Increases heat
   - To Dormitory: Transitions to owned_dorm.tscn
   - Upgrade Furnace: Opens upgrade dialog (or shows "Not implemented yet")
   - Take Break: Returns to bar.tscn

**Expected Results:**
- All UI elements visible and functional
- Scene layout matches design specs
- No visual errors or missing assets

---

### Test 3: owned_dorm Scene UI

**Objective:** Verify owned_dorm scene displays correctly

**Steps:**
1. From owned_furnace, click "To Dormitory"
2. Verify scene transition to owned_dorm.tscn
3. Verify Left Panel displays:
   - "Worker Roster" title
   - Empty roster (initially no workers hired)
   - Scrollable container
4. Verify Right Panel displays:
   - Food supply: "0 units (None)"
   - Capacity: "0 / 2 occupied" (starting with 2 beds)
   - Reputation hint: (varies based on initial reputation)
5. Verify action buttons:
   - Hire Workers
   - Send All on Break (disabled when no workers)
   - Buy Food
   - Dormitory Upgrades
   - Return to Furnace
6. Click "Return to Furnace"
7. Verify transition back to owned_furnace.tscn

**Expected Results:**
- Scene displays correctly with initial empty state
- Navigation works in both directions
- Buttons appropriately enabled/disabled

---

### Test 4: Bar Scene Navigation Updates

**Objective:** Verify bar navigation changes based on ownership

**Steps:**
1. Start game, furnace_owned = false
2. Go to bar
3. Verify buttons read:
   - "To Blackbore Furnace"
   - "To Dormitory"
4. Click "To Blackbore Furnace"
5. Verify transition to furnace.tscn (worker perspective)
6. Return to bar, purchase furnace
7. Return to bar again
8. Verify buttons now read:
   - "To Your Furnace"
   - "To Your Dormitory"
9. Click "To Your Furnace"
10. Verify transition to owned_furnace.tscn (owner perspective)
11. Return to bar, click "To Your Dormitory"
12. Verify transition to owned_dorm.tscn

**Expected Results:**
- Button text updates based on ownership status
- Correct scenes loaded based on ownership
- No errors or incorrect routing

---

### Test 5: Scene Persistence and Save/Load

**Objective:** Verify ownership and scene state persist correctly

**Steps:**
1. Purchase furnace
2. Visit owned_furnace scene
3. Shovel coal to generate heat (heat = 50)
4. Go to owned_dorm scene
5. Save game
6. Exit to main menu
7. Load game
8. Verify:
   - furnace_owned = true
   - Player spawns at correct location
   - Bar buttons show ownership text
   - Can navigate to owned scenes
   - Heat value persisted (= 50)

**Expected Results:**
- Ownership status persists
- Scene states restore correctly
- No regressions to worker-perspective scenes

---

### Test 6: One-Time Purchase Lock

**Objective:** Verify furnace cannot be purchased twice

**Steps:**
1. Purchase furnace (furnace_owned = true)
2. Return to Overseer's Office
3. Verify "Buy Furnace" button is hidden/gone
4. Manually set furnace_owned = false (via debug)
5. Return to Overseer's Office
6. Verify button reappears (for testing only)
7. Purchase again
8. Verify furnace_owned = true
9. Verify no duplicate charges or errors

**Expected Results:**
- Button properly hides after purchase
- Cannot accidentally purchase twice
- Purchase logic is idempotent

---

### Test 7: Scene Transition Edge Cases

**Objective:** Verify navigation handles edge cases gracefully

**Test Cases:**

| Starting Scene | Action | Expected Destination |
|----------------|--------|---------------------|
| owned_furnace | Take Break | bar.tscn |
| owned_furnace | To Dormitory | owned_dorm.tscn |
| owned_dorm | Return to Furnace | owned_furnace.tscn |
| bar (owned) | To Your Furnace | owned_furnace.tscn |
| bar (owned) | To Your Dormitory | owned_dorm.tscn |
| bar (not owned) | To Blackbore Furnace | furnace.tscn |
| bar (not owned) | To Dormitory | dorm.tscn |

**Steps:**
1. Test each transition in table
2. Verify no crashes or incorrect scenes
3. Verify Global.change_scene_with_check() validates properly

**Expected Results:**
- All transitions work correctly
- No scene loading errors
- Validation prevents invalid transitions

---
