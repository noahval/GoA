# Break and Demand

**Goal**: Add rhythm and pressure through timed breaks and rush orders.

**Success Criteria**: Breaks and demand events add pressure and rhythm

**Prerequisites**: Phases 2.1, 2.2, and 2.3 complete

---

## Implementation Tasks

### 1. Break System

Add to `RunState.gd`:
```gdscript
var coal_at_last_break = 0
var is_on_break = false
var break_time_remaining = 60.0  # seconds
var break_start_time = 0.0
var total_break_time = 0.0
```

#### Break Trigger
- Every 50 coal shoveled
- Forced break (cannot refuse unless bribed)
- Timer starts at 60 seconds

#### During Break
- Cannot shovel coal
- Can access temporary shop (consumables only)
- Stamina slowly recovers (+0.5 per second)
- Focus drains while shopping (-2 per purchase action)
- Timer counts down visibly

#### Break Effects on Payment
- Hidden penalty: -0.5% pay per second on break
- 60s break = -30% pay multiplier (player doesn't know this)
- Encourages quick breaks or bribing through

### 2. Bribe: Work Through Break

Add to break UI:
- "Work Through Break" button
- Cost: 5c (affordable early, but significant)
- Effect: Skip break entirely, +10% pay multiplier this shift
- Overseer approval increases (tracked for Phase 2.5)

### 3. Demand Events (Rush Orders)

Add to `RunState.gd`:
```gdscript
var active_demand_event = null
var demand_multiplier = 1.0
var demand_coal_count = 0
```

#### Event Structure
```gdscript
const DEMAND_EVENTS = [
    {
        "urgency": "low",
        "message": "Shovel more.",
        "duration": 90.0,
        "multiplier": 1.5
    },
    {
        "urgency": "medium",
        "message": "Pick up the pace!",
        "duration": 75.0,
        "multiplier": 2.0
    },
    {
        "urgency": "high",
        "message": "SHOVEL LIKE YOUR LIFE DEPENDS ON IT!",
        "duration": 60.0,
        "multiplier": 2.5
    }
]
```

#### Triggering
- Random during shift (20% chance every 2 minutes)
- Cannot overlap with breaks
- 1-3 demand events per shift

#### Visual Feedback
- Message banner at top (urgency-colored)
- Timer countdown
- NO coal target shown (intentionally vague)
- Screen intensity/saturation increases during event

#### Payment Integration
- Coal shoveled during event counts for `demand_multiplier`
- Example: 10 coal at 2.0x = 20 coal worth of pay
- Player discovers this through experimentation

### 4. Break Time Tracking for Payment

Extend payment calculation:
```gdscript
func calculate_payment():
    var base_copper_per_coal = 0.05
    var coal_value = RunState.coal_count * base_copper_per_coal

    # Break time penalty (hidden from player)
    var break_time_total = RunState.total_break_time
    var break_penalty = 1.0 - (break_time_total * 0.005)  # -0.5% per second

    # Demand event bonus (hidden from player)
    var demand_bonus = RunState.demand_coal_count * (RunState.demand_multiplier - 1.0) * base_copper_per_coal

    var total = (coal_value * break_penalty) + demand_bonus
    return max(0, total)  # Cannot go negative
```

### 5. UI Integration

#### Break UI
- Full-screen overlay (cannot interact with furnace)
- Timer countdown prominently displayed
- Shop access (temp consumables only)
- "Work Through Break" bribe button
- "Return to Work" button (when timer expires)

#### Demand Event UI
- Banner at screen top with urgency message
- Timer countdown
- Visual intensity (screen shake frequency increases, saturation boost)
- NO progress bar or coal counter (discovery-driven)

---

## TDD Requirements (Headless Tests)

Create `tests/test_phase_2_4.gd`:

```gdscript
# Test: Break triggers every 50 coal
func test_break_trigger_frequency():
    RunState.coal_count = 49
    simulate_coal_shovel(1)
    assert_true(RunState.is_on_break)

# Test: Stamina recovers during break
func test_stamina_recovery_during_break():
    RunState.stamina = 50
    RunState.is_on_break = true
    simulate_break_time(10)  # 10 seconds
    assert_eq(RunState.stamina, 55)  # +0.5 per second

# Test: Break time penalty affects payment
func test_break_time_penalty():
    RunState.coal_count = 100
    RunState.total_break_time = 60  # 60 seconds
    var payment = calculate_payment()
    assert_eq(payment, 3.5)  # 5 copper * 0.7 penalty = 3.5

# Test: Demand event multiplier applies
func test_demand_event_multiplier():
    start_demand_event("medium")  # 2.0x multiplier
    simulate_coal_shovel(10)
    var demand_bonus = calculate_demand_bonus()
    assert_eq(demand_bonus, 0.5)  # 10 coal * 0.05 * 1.0 extra = 0.5

# Test: Demand event doesn't overlap break
func test_demand_event_break_exclusion():
    RunState.is_on_break = true
    var can_trigger = can_trigger_demand_event()
    assert_false(can_trigger)

# Test: Bribe skips break
func test_bribe_work_through_break():
    trigger_break()
    bribe_work_through_break()
    assert_false(RunState.is_on_break)
    assert_eq(Global.copper, -5)  # Cost deducted
```

---

## Manual Test Criteria

- [ ] Break triggers every 50 coal shoveled
- [ ] Break timer counts down visibly
- [ ] Stamina recovers during break
- [ ] Can purchase consumables during break
- [ ] "Work Through Break" bribe skips break
- [ ] Demand event appears randomly during shift
- [ ] Demand event message/timer visible
- [ ] Shoveling fast during demand event increases pay
- [ ] Payment varies based on break time (compare long vs. short breaks)

---

## Files to Create

- `res://ui/break_overlay.gd/.tscn`
- `res://ui/demand_event_banner.gd/.tscn`
- `res://tests/test_phase_2_4.gd`

## Files to Modify

- `res://level1/furnace_work.gd`: Add break/demand logic
- `res://autoloads/run_state.gd`: Add break and demand tracking
- `res://level1/evening.gd`: Update payment calculation

---

## Design Values (Reference)

### Break System
- Frequency: Every 50 coal
- Duration: 60 seconds
- Stamina recovery: +0.5 per second
- Hidden penalty: -0.5% pay per second on break

### Demand Events
- Frequency: 20% chance every 2 minutes
- Low urgency: 1.5x multiplier, 90s duration
- Medium urgency: 2.0x multiplier, 75s duration
- High urgency: 2.5x multiplier, 60s duration

### Bribes
- Work Through Break: 5 copper, skip break, +10% pay

