# ATM Scene

**Goal**: Create complete ATM scene UI for currency exchange, purse management, and market rate display (works with static and dynamic rates)

**Success Criteria**:
- ATM scene loads without errors
- Market rates display panel shows current conversion rates
- Exchange interface with live preview works
- Purse capacity bar displays correctly with color coding
- Purse upgrade purchasing works
- All UI scales properly with ResponsiveLayout
- Scene works identically with static (1.0) and dynamic market modifiers

**Prerequisites**:
- Phase 1.3: Global Autoload (notifications, scene management)
- Phase 1.5: Currencies (data structures)
- Phase 1.6: Currency Manager (exchange logic, market rate hooks)

---

## Overview

**IMPORTANT: Future-Proof UI**
This ATM scene is built to work with **both** static market rates (Phase 1.6) and dynamic market rates (Phase 3.1). The UI simply reads from `CurrencyManager.conversion_rate_modifiers` - whether those values are 1.0 or fluctuating doesn't matter.

The ATM scene provides the complete player interface for currency operations: viewing rates, exchanging currencies, monitoring capacity, and purchasing purse upgrades.

### Key Design Principles

- **Read-Only UI**: All logic in CurrencyManager, UI just displays and triggers
- **Future-Proof**: Built for dynamic rates from day one
- **Responsive**: Works in portrait and landscape modes
- **Real-Time Updates**: Preview recalculates on every input change
- **Clear Feedback**: Color coding, notifications, visual warnings

---

## Scene Structure

### File Locations

- **Scene**: `res://scenes/atm.tscn`
- **Script**: `res://scenes/atm.gd`

### Node Hierarchy

```
ATM (Control)
├── Background (ColorRect - optional)
├── MarginContainer
│   └── MainVBox (VBoxContainer)
│       ├── TitleLabel ("Currency Exchange")
│       ├── HSeparator
│       ├── ContentHBox (HBoxContainer)
│       │   ├── LeftPanel (VBoxContainer)
│       │   │   ├── MarketRatesPanel (Panel)
│       │   │   │   ├── RatesVBox (VBoxContainer)
│       │   │   │   │   ├── RatesTitle ("Market Rates")
│       │   │   │   │   └── RatesLabel (Label)
│       │   │   ├── VSpacer (Control - expand)
│       │   │   └── PursePanel (Panel)
│       │   │       └── PurseVBox (VBoxContainer)
│       │   │           ├── PurseTitle ("Purse")
│       │   │           ├── PurseNameLabel ("Torn Pocket")
│       │   │           ├── CapacityBar (ProgressBar)
│       │   │           ├── CapacityLabel ("450 / 1000 coins")
│       │   │           └── UpgradeButton ("Upgrade to Small Pouch (135c)")
│       │   └── RightPanel (VBoxContainer)
│       │       ├── ExchangePanel (Panel)
│       │       │   └── ExchangeVBox (VBoxContainer)
│       │       │       ├── ExchangeTitle ("Exchange Currency")
│       │       │       ├── FromLabel ("From:")
│       │       │       ├── FromDropdown (OptionButton)
│       │       │       ├── AmountLabel ("Amount:")
│       │       │       ├── AmountInput (LineEdit)
│       │       │       ├── ToLabel ("To:")
│       │       │       ├── ToDropdown (OptionButton)
│       │       │       ├── HSeparator
│       │       │       └── PreviewLabel (RichTextLabel)
│       │       ├── ExchangeButton (Button)
│       │       └── BackButton (Button)
│       └── NotificationBar (VBoxContainer - for Global notifications)
```

---

## Implementation Tasks

### 1. Scene Setup and Visual Styling

**Background and containers**:

```gdscript
# In atm.gd
extends Control

# Node references
@onready var title_label = $MarginContainer/MainVBox/TitleLabel
@onready var market_rates_label = $MarginContainer/MainVBox/ContentHBox/LeftPanel/MarketRatesPanel/RatesVBox/RatesLabel
@onready var purse_name_label = $MarginContainer/MainVBox/ContentHBox/LeftPanel/PursePanel/PurseVBox/PurseNameLabel
@onready var capacity_bar = $MarginContainer/MainVBox/ContentHBox/LeftPanel/PursePanel/PurseVBox/CapacityBar
@onready var capacity_label = $MarginContainer/MainVBox/ContentHBox/LeftPanel/PursePanel/PurseVBox/CapacityLabel
@onready var upgrade_button = $MarginContainer/MainVBox/ContentHBox/LeftPanel/PursePanel/PurseVBox/UpgradeButton
@onready var from_dropdown = $MarginContainer/MainVBox/ContentHBox/RightPanel/ExchangePanel/ExchangeVBox/FromDropdown
@onready var to_dropdown = $MarginContainer/MainVBox/ContentHBox/RightPanel/ExchangePanel/ExchangeVBox/ToDropdown
@onready var amount_input = $MarginContainer/MainVBox/ContentHBox/RightPanel/ExchangePanel/ExchangeVBox/AmountInput
@onready var preview_label = $MarginContainer/MainVBox/ContentHBox/RightPanel/ExchangePanel/ExchangeVBox/PreviewLabel
@onready var exchange_button = $MarginContainer/MainVBox/ContentHBox/RightPanel/ExchangeButton
@onready var back_button = $MarginContainer/MainVBox/ContentHBox/RightPanel/BackButton

func _ready():
	# Connect signals
	from_dropdown.item_selected.connect(_on_from_selected)
	to_dropdown.item_selected.connect(_on_to_selected)
	amount_input.text_changed.connect(_on_amount_changed)
	exchange_button.pressed.connect(_on_exchange_pressed)
	upgrade_button.pressed.connect(_on_upgrade_pressed)
	back_button.pressed.connect(_on_back_pressed)

	# Initial setup
	populate_currency_dropdowns()
	update_market_rates_display()
	update_purse_panel()
	update_preview()
```

**Visual styling**:

```gdscript
# StyleBoxFlat for panels
# MarketRatesPanel and PursePanel:
- Background color: (0.2, 0.2, 0.2, 0.9)
- Corner radius: 8px all corners
- Border color: (0.5, 0.5, 0.5, 1.0)
- Border width: 2px

# ExchangePanel:
- Background color: (0.25, 0.25, 0.25, 0.95)
- Corner radius: 8px
- Border: subtle light gray

# Buttons:
- Default theme with custom colors
- Exchange button: Highlight color (green-ish) when enabled
- Disabled: Gray out
```

---

### 2. Market Rates Display

**Update market rates panel**:

```gdscript
# Update the market rates display
# Reads from CurrencyManager.conversion_rate_modifiers
# Works with static (1.0) OR dynamic values
func update_market_rates_display() -> void:
	var rates = CurrencyManager.get_market_rates_display()

	var rates_text = ""
	for rate in rates:
		rates_text += rate.display + "\n"

	market_rates_label.text = rates_text

# Call this:
# - In _ready()
# - When scene becomes visible (if rates changed while away)
# - Optionally in _process() if we want live updates during market changes
```

**Display format examples**:

Static rates (Phase 1.6-1.7):
```
Market Rates:
1 silver = 1000 copper
1 gold = 1000 silver
1 platinum = 1000 gold
```

Dynamic rates (Phase 3.1+):
```
Market Rates:
1 silver = 1275 copper
1 gold = 920 silver
1 platinum = 1050 gold
```

**Styling for rates label**:
- Monospace font for alignment
- Font size: 18px (scaled by ResponsiveLayout)
- Color: White text on dark background
- Center aligned

---

### 3. Currency Exchange Interface

**Populate currency dropdowns**:

```gdscript
# Populate From and To dropdowns with unlocked currencies
func populate_currency_dropdowns() -> void:
	from_dropdown.clear()
	to_dropdown.clear()

	var currencies = [
		{"type": CurrencyManager.CurrencyType.COPPER, "name": "Copper"},
		{"type": CurrencyManager.CurrencyType.SILVER, "name": "Silver"},
		{"type": CurrencyManager.CurrencyType.GOLD, "name": "Gold"},
		{"type": CurrencyManager.CurrencyType.PLATINUM, "name": "Platinum"}
	]

	for curr in currencies:
		# Only add if currency is unlocked
		var unlocked = Level1Vars.is_currency_unlocked(
			CurrencyManager._currency_type_to_string(curr.type)
		)

		if unlocked:
			from_dropdown.add_item(curr.name, curr.type)
			to_dropdown.add_item(curr.name, curr.type)

	# Set default selection (copper → silver if available)
	if from_dropdown.item_count > 0:
		from_dropdown.select(0)
	if to_dropdown.item_count > 1:
		to_dropdown.select(1)
```

**Exchange preview with live updates**:

```gdscript
# Update exchange preview in real-time
# Shows: amount, fee, received, preview text
func update_preview() -> void:
	# Get current form values
	var amount_text = amount_input.text
	if amount_text.is_empty() or amount_text.to_float() <= 0:
		preview_label.text = "[center]Enter amount to exchange[/center]"
		exchange_button.disabled = true
		return

	var from_idx = from_dropdown.get_selected_id()
	var to_idx = to_dropdown.get_selected_id()
	var amount = amount_text.to_float()

	# Get preview from CurrencyManager
	var preview = CurrencyManager.preview_exchange(from_idx, to_idx, amount)

	if not preview.valid:
		# Show error
		match preview.error:
			"insufficient_funds":
				preview_label.text = "[center][color=red]Insufficient funds[/color][/center]"
			"same_currency":
				preview_label.text = "[center][color=yellow]Select different currency[/color][/center]"
			"currency_locked":
				preview_label.text = "[center][color=red]Currency not yet unlocked[/color][/center]"
			_:
				preview_label.text = "[center][color=red]Invalid exchange[/color][/center]"

		exchange_button.disabled = true
		return

	# Format preview display
	var from_name = CurrencyManager.CURRENCY_NAMES[from_idx].to_lower()
	var to_name = CurrencyManager.CURRENCY_NAMES[to_idx].to_lower()

	# Main exchange line
	var preview_text = "[center][b]%.1f %s → %.2f %s[/b]\n" % [
		preview.amount, from_name,
		preview.received, to_name
	]

	# Fee breakdown
	preview_text += "[color=gray](broker takes %.1f %s - %.1f%% fee)[/color]" % [
		preview.fee, from_name, preview.fee_percent
	]

	# Market modifier info (if not 1.0)
	if preview.from_modifier != 1.0 or preview.to_modifier != 1.0:
		preview_text += "\n[color=yellow]Market rates applied[/color]"

	preview_text += "[/center]"

	preview_label.text = preview_text
	exchange_button.disabled = false
```

**Execute exchange**:

```gdscript
# Execute the currency exchange
func _on_exchange_pressed() -> void:
	var from_idx = from_dropdown.get_selected_id()
	var to_idx = to_dropdown.get_selected_id()
	var amount = amount_input.text.to_float()

	# Execute via CurrencyManager
	var result = CurrencyManager.exchange_currency(from_idx, to_idx, amount)

	if result.success:
		# Success - notification shown by CurrencyManager
		# Reset form
		amount_input.text = ""
		update_preview()
		update_purse_panel()
		update_market_rates_display()  # In case unlocks changed

		# Repopulate dropdowns (in case new currencies unlocked)
		populate_currency_dropdowns()
	else:
		# Error - show notification
		match result.error:
			"insufficient_funds":
				Global.show_notification("Insufficient funds for exchange")
			"currency_locked":
				Global.show_notification("Currency not yet accessible")
			_:
				Global.show_notification("Exchange failed")
```

---

### 4. Purse Capacity Display

**Update purse panel**:

```gdscript
# Update purse display: name, capacity bar, upgrade button
func update_purse_panel() -> void:
	# Get capacity info from CurrencyManager
	var capacity_info = CurrencyManager.get_capacity_info()

	# Get current purse tier
	var tier = CurrencyManager.PURSE_TIERS[Level1Vars.purse_level]
	purse_name_label.text = tier.name

	# Update capacity bar
	capacity_bar.max_value = capacity_info.max_capacity
	capacity_bar.value = capacity_info.current_coins

	# Color coding based on warning level
	match capacity_info.warning_level:
		0:  # Safe (< 80%)
			capacity_bar.modulate = Color(0.2, 0.8, 0.2)  # Green
		1:  # Caution (80-90%)
			capacity_bar.modulate = Color(0.9, 0.9, 0.2)  # Yellow
		2:  # Warning (90-100%)
			capacity_bar.modulate = Color(0.9, 0.5, 0.0)  # Orange
		3:  # Full (100%)
			capacity_bar.modulate = Color(0.9, 0.2, 0.2)  # Red

	# Capacity label
	capacity_label.text = "%d / %d coins (%.0f%%)" % [
		capacity_info.current_coins,
		capacity_info.max_capacity,
		capacity_info.percent_full
	]

	# Update upgrade button
	_update_upgrade_button()

# Update upgrade button text and state
func _update_upgrade_button() -> void:
	var upgrade_info = Level1Vars.get_purse_upgrade_info()

	if upgrade_info.at_max:
		upgrade_button.visible = false
		return

	if not upgrade_info.can_upgrade:
		upgrade_button.visible = false
		return

	# Show button with cost
	upgrade_button.visible = true
	upgrade_button.text = "Upgrade to %s (%d %s)" % [
		upgrade_info.next_name,
		upgrade_info.cost,
		upgrade_info.currency_type
	]

	# Enable/disable based on affordability
	upgrade_button.disabled = not upgrade_info.can_afford

	# Tooltip with details
	var tooltip = "Capacity: %d → %d coins (+%d)" % [
		upgrade_info.current_cap,
		upgrade_info.next_cap,
		upgrade_info.capacity_increase
	]
	upgrade_button.tooltip_text = tooltip
```

**Purchase purse upgrade**:

```gdscript
# Handle purse upgrade purchase
func _on_upgrade_pressed() -> void:
	var success = Level1Vars.purchase_purse_upgrade()

	if success:
		# Success - notification shown by Level1Vars
		update_purse_panel()
		update_preview()  # Might enable exchanges that were blocked
	else:
		Global.show_notification("Cannot afford purse upgrade")
```

---

### 5. Signal Handling

**Dropdown change handlers**:

```gdscript
func _on_from_selected(index: int) -> void:
	update_preview()

func _on_to_selected(index: int) -> void:
	update_preview()

func _on_amount_changed(new_text: String) -> void:
	update_preview()
```

**Back button**:

```gdscript
func _on_back_pressed() -> void:
	# Return to previous scene (game determines what that is)
	Global.change_scene(get_tree(), "res://level1/loading_screen.tscn")
```

---

### 6. Responsive Layout Integration

**Apply ResponsiveLayout**:

```gdscript
# In _ready() after other setup
func _ready():
	# ... existing setup ...

	# Apply responsive layout if needed
	if ResponsiveLayout:
		ResponsiveLayout.apply_to_scene(self)
```

**Portrait mode adjustments**:

In `atm.tscn` scene setup:
- ContentHBox switches to VBoxContainer in portrait
- Left and Right panels stack vertically
- Font sizes scale with `ResponsiveLayout.PORTRAIT_FONT_SCALE`
- Element heights use `ResponsiveLayout.PORTRAIT_ELEMENT_HEIGHT`

**Metadata for height preservation**:
- Capacity bar should preserve height (set `_responsive_layout_preserve_height` metadata)
- Preview label should expand to fill space

---

### 7. Visual Polish

**Color scheme**:

```gdscript
# Panel backgrounds
Market Rates Panel: rgba(0.2, 0.2, 0.2, 0.9)
Purse Panel: rgba(0.2, 0.2, 0.2, 0.9)
Exchange Panel: rgba(0.25, 0.25, 0.25, 0.95)

# Text colors
Title: White (1, 1, 1, 1)
Body text: Light gray (0.9, 0.9, 0.9, 1)
Error text: Red (1, 0.3, 0.3, 1)
Warning text: Yellow (0.9, 0.9, 0.2, 1)
Fee text: Gray (0.6, 0.6, 0.6, 1)

# Capacity bar colors
Safe: Green (0.2, 0.8, 0.2)
Caution: Yellow (0.9, 0.9, 0.2)
Warning: Orange (0.9, 0.5, 0.0)
Full: Red (0.9, 0.2, 0.2)
```

**Font sizes**:

```gdscript
Title: 32px
Section headers: 24px
Body text: 18px
Preview text: 20px (bold main line)
Fee text: 16px (italic gray)
Button text: 20px
```

**Animations (optional)**:

```gdscript
# Capacity bar color transition
var tween = create_tween()
tween.tween_property(capacity_bar, "modulate", target_color, 0.3)

# Preview update fade
preview_label.modulate.a = 0.0
var tween2 = create_tween()
tween2.tween_property(preview_label, "modulate:a", 1.0, 0.2)
```

---

## Testing Strategy

### Manual Test Cases

**Test 1: Scene Loading**
- [ ] Navigate to ATM scene
- [ ] No errors in console
- [ ] All UI elements visible
- [ ] Market rates show "1 silver = 1000 copper"
- [ ] Dropdowns populated with copper and silver
- [ ] Purse panel shows "Torn Pocket" and capacity bar

**Test 2: Exchange Preview**
- [ ] Enter "100" in amount
- [ ] From: Copper, To: Silver
- [ ] Preview shows "100.0 copper → 0.92 silver"
- [ ] Preview shows "(broker takes 8.0 copper - 8.0% fee)"
- [ ] Exchange button enabled

**Test 3: Exchange Execution**
- [ ] Click Exchange button
- [ ] Notification shows "Exchanged 100 copper for 0.92 silver"
- [ ] Copper decreases by 100
- [ ] Silver increases by ~0.92
- [ ] Form resets (amount cleared)
- [ ] Preview shows "Enter amount to exchange"

**Test 4: Insufficient Funds**
- [ ] Set copper to 50
- [ ] Enter amount 100
- [ ] Preview shows "Insufficient funds" in red
- [ ] Exchange button disabled

**Test 5: Currency Unlocks**
- [ ] Start with only copper/silver
- [ ] Add 50 silver via console
- [ ] Dropdowns update to show gold option
- [ ] Market rates panel adds "1 gold = 1000 silver" line

**Test 6: Purse Capacity**
- [ ] Fill purse to 120/150 coins (80%)
- [ ] Capacity bar turns yellow
- [ ] Fill to 135/150 (90%)
- [ ] Capacity bar turns orange
- [ ] Notification: "Purse nearly full"
- [ ] Fill to 150/150 (100%)
- [ ] Capacity bar turns red

**Test 7: Purse Upgrade**
- [ ] Have 150+ copper
- [ ] Upgrade button shows "Upgrade to Small Pouch (135c)"
- [ ] Click upgrade
- [ ] Purse name changes to "Small Pouch"
- [ ] Capacity changes to 300
- [ ] Copper decreases by 135

**Test 8: Responsive Layout**
- [ ] Resize window to portrait orientation
- [ ] Panels stack vertically
- [ ] Font sizes scale appropriately
- [ ] No overlapping UI elements
- [ ] All text readable

**Test 9: Market Modifiers (Static)**
- [ ] Market rates show 1000:1 ratios
- [ ] Exchange 100 copper
- [ ] Receive 0.92 silver (after 8% fee)
- [ ] Math correct: (100 - 8) / 1000 = 0.092... wait that's wrong

Actually let me recalculate:
- 100 copper exchanged
- Fee = 8 copper (8%)
- Net = 92 copper
- At 1000:1 ratio: 92 / 1000 = 0.092 silver

So the preview should show 0.092 or ~0.09 silver, not 0.92. Let me check the formula in Currency Manager...

Looking back at the exchange formula:
```gdscript
var received = (net_amount * from_rate) / to_rate
```

With:
- net_amount = 92 (after fee)
- from_rate = 1.0 * 1.0 = 1.0 (copper rate * modifier)
- to_rate = 1000.0 * 1.0 = 1000.0 (silver rate * modifier)

So: received = (92 * 1.0) / 1000.0 = 0.092 silver

That's correct! The preview should show ~0.09 silver, not 0.92.

**Test 10: Back Button**
- [ ] Click Back
- [ ] Returns to loading screen
- [ ] No errors

---

## Files to Create

**scenes/atm.tscn** (new scene file)
- Complete UI hierarchy
- Panel styling
- Responsive layout configuration
- Signal connections

**scenes/atm.gd** (~500 lines new)
- Node references
- Market rates display
- Currency dropdown population
- Exchange preview logic
- Exchange execution
- Purse panel updates
- Purse upgrade handling
- Signal handlers
- Responsive layout integration

---

## Files to Modify

None - all new files

---

## Design Values (Reference)

### UI Layout

**Panel sizes (landscape)**:
- Left panel width: 35% of container
- Right panel width: 65% of container
- Market rates panel: Expands to fit content
- Purse panel: Fixed height ~200px
- Exchange panel: Expands to fill remaining space

**Spacing**:
- Margin: 20px all sides
- Panel padding: 15px
- Element spacing: 10px between elements
- Separator thickness: 2px

### Preview Display Format

```
Standard:
"100.0 copper → 0.09 silver"
"(broker takes 8.0 copper - 8.0% fee)"

With market rates:
"100.0 copper → 0.12 silver"
"(broker takes 8.0 copper - 8.0% fee)"
"Market rates applied"

Error:
"Insufficient funds"
"Select different currency"
"Currency not yet unlocked"
```

### Capacity Bar Thresholds

- 0-79%: Green (safe)
- 80-89%: Yellow (caution)
- 90-99%: Orange (warning)
- 100%: Red (full)

---

## Integration Points

### Uses CurrencyManager

```gdscript
CurrencyManager.get_market_rates_display()  # Market rates panel
CurrencyManager.preview_exchange()  # Exchange preview
CurrencyManager.exchange_currency()  # Execute exchange
CurrencyManager.get_capacity_info()  # Capacity display
CurrencyManager.PURSE_TIERS  # Purse names
CurrencyManager.CURRENCY_NAMES  # Display names
```

### Uses Level1Vars

```gdscript
Level1Vars.currency  # Display current holdings
Level1Vars.purse_level  # Current purse tier
Level1Vars.get_purse_upgrade_info()  # Upgrade button
Level1Vars.purchase_purse_upgrade()  # Execute upgrade
Level1Vars.is_currency_unlocked()  # Filter dropdowns
```

### Uses Global

```gdscript
Global.change_scene()  # Back button
Global.show_notification()  # Error feedback
```

---


## Notes & Decisions

**Decision 1**: Complete UI from day one
- **Rationale**: Write once, works with static AND dynamic rates
- **Benefit**: No UI rewrites when Phase 3.1 adds volatility
- **Implementation**: UI just reads modifiers, doesn't care about values

**Decision 2**: RichTextLabel for preview
- **Rationale**: Allows color coding, bold, formatting
- **Usage**: Main exchange bold, fee gray, errors red
- **Benefit**: Clear visual hierarchy

**Decision 3**: Real-time preview updates
- **Rationale**: Player sees exactly what they'll get
- **Implementation**: Update on every text change
- **Performance**: Fast enough with current calculation complexity

**Decision 4**: Color-coded capacity bar
- **Rationale**: Immediate visual feedback
- **Accessibility**: Color + percentage both convey info
- **Design**: Traffic light pattern (green → yellow → orange → red)

**Decision 5**: Purse upgrade in same scene
- **Rationale**: Logical grouping (capacity management)
- **Alternative**: Separate shop scene (more navigation)
- **Choice**: Keep together for convenience

**Decision 6**: Back button to loading screen
- **Rationale**: ATM accessible from multiple locations
- **Future**: Could track previous scene and return there
- **Current**: Simple approach, loading screen is hub

---

## Open Questions

- [ ] Should market rates auto-update while scene is open (Phase 3.1)?
- [ ] Do we want quick-exchange buttons ("Max", "Half")?
- [ ] Should we show exchange history?
- [ ] Do we want currency conversion calculator (doesn't execute)?
- [ ] Should purse panel show copper-equivalent value?

---

## Implementation Checklist

Before marking this phase complete:

- [ ] atm.tscn scene created with full hierarchy
- [ ] atm.gd script created with all functions
- [ ] All node references connected
- [ ] Signals connected correctly
- [ ] Market rates display implemented
- [ ] Currency dropdowns populate correctly
- [ ] Exchange preview updates in real-time
- [ ] Exchange execution works
- [ ] Purse panel updates correctly
- [ ] Capacity bar color coding works
- [ ] Purse upgrade button functions
- [ ] Responsive layout applied
- [ ] Portrait mode tested
- [ ] All manual tests pass
- [ ] No console errors
- [ ] Ready for copper era use

---

**Last Updated**: 2025-11-28
**Maintainer**: Claude + User collaboration
**Plan Version**: 1.0 (Future-proof UI - works with static and dynamic rates)
