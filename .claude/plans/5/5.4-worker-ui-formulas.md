# Worker UI formulas

All worker management happens in **owned_dorm.tscn** (new scene).

#### Owned Dormitory Scene (owned_dorm.tscn)

**New Scene Required:**
- Duplicate existing [level1/dorm.tscn](level1/dorm.tscn) â†’ owned_dorm.tscn
- Shows dormitory with visible beds (empty vs occupied)
- Accessible from owned_furnace scene via "Visit Dormitory" button
- Accessible from bar scene (replaces dorm.tscn after furnace purchase)

**Scene Layout:**

**Left Panel: Worker Roster**
- Title: "Worker Roster"
- Scrollable list of hired workers
- Each entry shows:
  - Name (e.g., "Thomas")
  - Type (Stoker/Fireman/Engineer)
  - Quality descriptor (e.g., "Steady Hand")
  - Current status: Active / Idle / On Break
  - Buttons: [Assign Active] [Set Idle] [Send on Break] [Fire]
- If on break, shows countdown timer

**Right Panel Buttons:**
- **Hire Workers** - Opens hiring pool dialog
- **Send All on Break** - Group break (shows 15min cooldown if active)
- **Buy Food** - Opens food shop
- **Dormitory Upgrades** - Opens upgrade menu (beds + amenities)
- **Return to Furnace** - Goes back to owned_furnace.tscn

**Top Panel Info:**
- Current Food Supply: "Food: 47 units (Decent Meal)"
- Dormitory Capacity: "Beds: 8 / 10 occupied"
- Subtle reputation hint (narrative only, no number):
  - High reputation: "Workers speak well of this place"
  - Low reputation: "Conditions here are poorly regarded"

**Bottom Panel:**
- Auto-break policy dropdown: [Never â–¼]
- Color indicator dot (discovery mechanic):
  - **Green:** All workers < 55 fatigue, morale > 60, food > 25%
  - **Yellow:** Some concerns (55-80 fatigue OR morale 40-60 OR food 10-25%)
  - **Red:** Critical issues (any worker > 80 fatigue OR morale < 40 OR food < 10%)

#### Hiring Pool Dialog

**Opened from:** "Hire Workers" button in owned_dorm.tscn

**Layout:**
```
+---------------------------------------+
|  Available Workers                 [X]|
+---------------------------------------+
| Beds Available: 2 / 10                |
|                                       |
| [Refresh Pool - 5 Silver]             |
|                                       |
| 1. Thomas (Stoker)                    |
|    "Ordinary Laborer"                 |
|    Cost: 8 Silver                     |
|    [Hire]                             |
|                                       |
| 2. Jakob (Fireman)                    |
|    "Green Recruit"                    |
|    Cost: 10 Silver                    |
|    [Hire]                             |
|                                       |
| 3. William (Stoker)                   |
|    "Sickly Youth"                     |
|    Cost: 2 Silver                     |
|    [Hire]                             |
|                                       |
| 4. Elias (Engineer)                   |
|    "Steady Hand"                      |
|    Cost: 65 Silver                    |
|    [Hire]                             |
|                                       |
| 5. Henrik (Stoker)                    |
|    "Capable Hand"                     |
|    Cost: 30 Silver                    |
|    [Hire]                             |
+---------------------------------------+
```

**Features:**
- Shows 3-8 candidates (based on reputation)
- Quality distribution based on reputation (hidden)
- Manual refresh: 5 Silver, generates new candidates
- Auto-refresh: Every 2 hours of runtime
- Cannot hire if no empty beds

#### Food Shop Dialog

**Opened from:** "Buy Food" button

**Layout:**
```
+---------------------------------------+
|  Food Supply                       [X]|
+---------------------------------------+
| Current: 47 units (Decent Meal)       |
|                                       |
| [âœ“] Stale Bread - 0.2 Silver/10 units |
|     "Barely edible scraps"            |
|     [Buy 50 units - 1 Silver]         |
|                                       |
| [âœ“] Basic Rations - 0.5 Silver/10 units |
|     "Plain but filling"               |
|     [Buy 50 units - 2.5 Silver]       |
|                                       |
| [âœ“] Decent Meal - 1.2 Silver/10 units |
|     "Simple but satisfying"           |
|     [Buy 50 units - 6 Silver]         |
|                                       |
| [ðŸ”’] Quality Food - 2.5 Silver/10 units |
|     Requires: 20h runtime             |
|                                       |
| [ðŸ”’] Premium Provisions - 5 Silver/10 units |
|     Requires: 50h runtime             |
|                                       |
| Auto-Purchase Settings:               |
| [âœ“] Enable Auto-Purchase              |
| When supply < 20 units, buy:          |
| [Decent Meal â–¼] [50 units â–¼]          |
+---------------------------------------+
```

#### Dormitory Upgrades Dialog

**Opened from:** "Dormitory Upgrades" button

**Two tabs:** Beds | Amenities

**Beds Tab:**
```
+---------------------------------------+
|  Dormitory Upgrades - Beds         [X]|
+---------------------------------------+
| Current Capacity: 8 / 10 beds         |
|                                       |
| [âœ“] Starting Beds - 2 beds            |
|     (Included)                        |
|                                       |
| [âœ“] Bunk Bed Pair - 2 beds            |
|     (Purchased)                       |
|                                       |
| [âœ“] Second Bunk Set - 2 beds          |
|     (Purchased)                       |
|                                       |
| [ ] Third Bunk Set - 2 beds           |
|     Cost: 90 Silver                   |
|     Requires: 25h runtime             |
|     [Purchase]                        |
|                                       |
| [ðŸ”’] Fourth Bunk Set - 2 beds         |
|     Requires: 40h runtime             |
+---------------------------------------+
```

**Amenities Tab:**
```
+---------------------------------------+
|  Dormitory Upgrades - Amenities    [X]|
+---------------------------------------+
| Improve worker conditions             |
|                                       |
| [âœ“] Water Barrels                     |
|     "Cool water for the crew"         |
|     (Purchased)                       |
|                                       |
| [ ] Simple Cots                       |
|     Cost: 50 Silver, 8h runtime       |
|     "Mattresses for the bunks"        |
|     Benefit: "Better than the floor"  |
|     [Purchase]                        |
|                                       |
| [ ] Tool Storage Rack                 |
|     Cost: 80 Silver, 15h runtime      |
|     "Organized equipment area"        |
|     Benefit: "Keeps things tidy"      |
|     [Purchase]                        |
|                                       |
| [ðŸ”’] Ventilation Grate                |
|     Requires: 25h runtime             |
+---------------------------------------+
```

---

### Worker Production Formulas

#### Heat Generation (Stokers)

```gdscript
func calculate_stoker_heat_generation(delta):
    var total_heat = 0.0
    for worker in worker_roster:
        if worker.type == "stoker" and worker.status == "active":
            var base_heat_per_sec = 1.0  # Baseline for Tier 4
            var quality_multiplier = get_quality_productivity(worker.quality_tier)
            var fatigue_multiplier = get_fatigue_performance(worker.fatigue)
            var morale_multiplier = get_morale_productivity(crew_morale)

            var worker_heat = base_heat_per_sec * quality_multiplier *
                              fatigue_multiplier * morale_multiplier * delta
            total_heat += worker_heat

    current_heat += total_heat
```

#### Heat Decay Reduction (Firemen)

```gdscript
func calculate_heat_decay(delta):
    var base_decay = 0.5  # per second
    var fireman_reduction = 0.0

    for worker in worker_roster:
        if worker.type == "fireman" and worker.status == "active":
            var quality_multiplier = get_quality_productivity(worker.quality_tier)
            var fatigue_multiplier = get_fatigue_performance(worker.fatigue)
            var morale_multiplier = get_morale_productivity(crew_morale)

            fireman_reduction += 0.1 * quality_multiplier *
                                 fatigue_multiplier * morale_multiplier

    var effective_decay = max(base_decay - fireman_reduction, 0.1)
    current_heat -= effective_decay * delta
```

#### Steam Efficiency (Engineers)

```gdscript
func calculate_steam_efficiency():
    var base_efficiency = 1.0
    var engineer_bonus = 0.0

    for worker in worker_roster:
        if worker.type == "engineer" and worker.status == "active":
            var quality_multiplier = get_quality_productivity(worker.quality_tier)
            var fatigue_multiplier = get_fatigue_performance(worker.fatigue)
            var morale_multiplier = get_morale_productivity(crew_morale)

            engineer_bonus += 0.1 * quality_multiplier *
                              fatigue_multiplier * morale_multiplier

    return base_efficiency + engineer_bonus
```

---

### Strategic Gameplay Implications

#### Multiple Valid Strategies

**"Sweatshop" Strategy:**
- Hire cheap workers (Tier 1-2)
- Feed stale bread
- Ruthless management
- Minimal amenities
- **Result:** Low productivity, high fatigue, low morale, poor reputation, unsustainable long-term

**"Balanced" Strategy:**
- Mid-tier workers (Tier 3-4)
- Decent food
- Orderly management
- Some amenities
- **Result:** Stable, reliable production, moderate costs

**"Premium Operation" Strategy:**
- Skilled workers (Tier 6-7)
- Quality/premium food
- Comfortable management
- All amenities
- **Result:** High productivity, low fatigue, high morale, excellent reputation, attracts best candidates

**"Rotation Specialist" Strategy:**
- Many workers hired
- Manual active/idle management
- Strategic group breaks
- **Result:** Micromanagement-intensive but highly efficient

**"Automation" Strategy:**
- Aggressive auto-break policy
- Good amenities
- Quality food
- **Result:** Hands-off, consistent performance

#### Reputation Feedback Loop

Good treatment â†’ High reputation â†’ Better candidates â†’ Higher efficiency â†’ More profits â†’ Afford better treatment

Poor treatment â†’ Low reputation â†’ Only desperate workers â†’ Low efficiency â†’ Lower profits â†’ Cannot afford improvements

#### Charisma as Key Stat

High charisma provides:
- -40% fatigue accumulation (workers tire much slower)
- +12 morale (workers happier)
- +30 reputation (attracts better workers)
- Better recovery rates

**Makes charisma extremely valuable** beyond just dialogue options.

---

### Save/Load Variables

Add to Level1Vars:

```gdscript
# Worker roster (array of dictionaries)
var worker_roster = []
# Each worker dict:
# {
#     "name": "Thomas",
#     "type": "stoker",  # stoker, fireman, engineer
#     "quality_tier": 4,  # 1-7
#     "fatigue": 35.0,  # 0.0-100.0
#     "status": "active",  # active, idle, on_break
#     "break_end_time": 0,  # timestamp
#     "hire_timestamp": 12345
# }

# Dormitory capacity
var dormitory_beds = 2  # Starts at 2, increases with bed purchases

# Reputation system (hidden from player)
var worker_reputation = 0.0  # 0-100

# Hiring pool
var hiring_pool = []
# Each candidate dict:
# {
#     "name": "Jakob",
#     "type": "fireman",
#     "tier": 3,
#     "cost": 180
# }
var last_pool_refresh_time = 0

# Crew morale (shared pool)
var crew_morale = 50.0  # 0-100

# Food system
var food_supply = 0  # Units remaining
var current_food_tier = 2  # Which quality tier is stocked
var auto_purchase_food = false
var auto_purchase_tier = 2
var auto_purchase_amount = 50

# Break management
var break_policy = "never"  # never, conservative, balanced, aggressive, preventive
var last_group_break_time = 0

# Amenities purchased (bitmask for 10 tiers)
var dorm_amenities_purchased = 0

# Statistics tracking
var total_workers_hired = 0
var total_workers_fired = 0
var total_individual_breaks = 0
var total_group_breaks = 0
var total_worker_collapses = 0  # Times any worker hit 95+ fatigue
var peak_morale = 50.0
var peak_reputation = 0.0

# Notification throttling
var last_fatigue_notification_per_worker = {}  # {"Thomas": 12345, ...}
var last_food_notification = 0
var last_reputation_notification = 0
```

---

## Implementation Steps

### Phase 1: UI Scene Creation

**See [6.2-scenes-navigation.md](6.2-scenes-navigation.md) for owned_dorm.tscn creation.**

Create UI components for worker roster display, hiring pool dialog, food shop, and dormitory upgrades.

### Phase 2: Production Formulas

Implement worker contribution calculations:

```gdscript
func calculate_stoker_heat_generation():
    # Heat = base * quality * fatigue_perf * morale
    for worker in roster:
        if worker.type == "stoker" and worker.status == "active":
            heat += 1.0 * quality_mult * fatigue_mult * morale_mult

func calculate_fireman_decay_reduction():
    # Each fireman reduces decay by 0.1/sec (scaled by quality/fatigue)
    for worker in roster:
        if worker.type == "fireman" and worker.status == "active":
            decay_reduction += 0.1 * quality_mult * fatigue_mult

func calculate_engineer_efficiency():
    # Each engineer adds +10% steam efficiency
    for worker in roster:
        if worker.type == "engineer" and worker.status == "active":
            efficiency_bonus += 0.1 * quality_mult * fatigue_mult
```

### Phase 3: Dynamic UI Updates

Update worker roster display in real-time as status/fatigue changes.

### Phase 4: Dialog Systems

Implement hiring pool, food shop, and dormitory upgrade dialogs with purchase logic.

---

## Testing Scenarios

### Test 1: Worker Roster UI
- Display updates when workers hired/fired
- Status changes reflect correctly (Active/Idle/Break)
- Break timers count down and auto-end

### Test 2: Production Calculations
- Stokers increase heat generation proportional to quality
- Firemen reduce heat decay correctly
- Engineers boost steam efficiency
- Fatigue reduces all effectiveness proportionally

### Test 3: Hiring Pool Dialog
- Pool size scales with reputation (3-8 candidates)
- Quality distribution matches reputation tier
- Cannot hire when beds full
- Refresh costs 200 silver

### Test 4: Food Shop
- All 5 tiers purchasable (when unlocked)
- Auto-purchase triggers at threshold
- Food tier affects worker performance (hidden)

### Test 5: Dormitory Upgrades
- Bed expansions increase capacity correctly
- Amenity purchases apply hidden bonuses
- Visual feedback for purchased items

---
