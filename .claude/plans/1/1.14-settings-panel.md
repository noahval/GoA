# Settings Scene

**Goal**: Create settings scene with UI scale, audio volume, dev speed mode, and save reset

**Success Criteria**:
- Settings button appears in menu (right side) of every scene (already added in 1.12)
- Clicking settings navigates to settings scene
- Settings scene contains: UI Scale slider, Music Volume slider, SFX Volume slider, Dev Speed Mode toggle, Save Reset button
- Back button returns to previous scene
- Settings auto-save on change (combined with game progress in save.json)

**Prerequisites**:
- Phase 1.12 (UI Scale Slider) - UI scale system exists, settings button added to scene_template
- Phase 1.13 (Scene Template) - Scene template with Menu and PlayArea
- Phase 1.14 (Button Hierarchy) - Settings button sorted to bottom
- AudioManager autoload exists with set_music_volume() and set_sfx_volume() methods

---

## Overview

Adds a dedicated Settings scene that players navigate to from any scene. Uses existing Global.change_scene() infrastructure. Settings include all player preferences (UI scale, audio volumes, dev mode) and game management (save reset). Uses structured save system where settings and game progress are separated into distinct sections within save.json. Reset operations preserve the settings section while clearing the game section.

### Key Design Principles

- **Always accessible**: Settings button already in every scene's menu (from 1.12)
- **Dedicated scene**: Full scene like furnace/mind - natural pause state
- **Simple navigation**: Store previous scene, navigate back on close
- **Auto-save**: Settings save immediately on change
- **Structured save**: Settings and game data separated in save.json for clean reset logic
- **Surgical reset**: reset_save() preserves settings section, clears game section

---

## Implementation Tasks

### 1. Add previous_scene Tracking to Global

**Modify**: `res://global.gd`

Add at top of Global:
```gdscript
# Navigation tracking for settings return
var previous_scene: String = ""
```

### 2. Create Settings Scene

**File**: `res://settings.tscn`

**Structure**:
```
Settings (Control)
└── Background (ColorRect, black)
    └── AspectContainer (AspectRatioContainer, 16:9)
        └── MainContainer (Control)
            └── CenterContainer
                └── PanelContainer
                    └── MarginContainer
                        └── VBoxContainer
                            ├── HeaderLabel ("Settings")
                            ├── UIScaleContainer (HBoxContainer)
                            │   ├── Label ("UI Scale:")
                            │   ├── UIScaleSlider (HSlider, 0.8-1.2, step 0.05)
                            │   └── UIScaleValueLabel ("100%")
                            ├── MusicVolumeContainer (HBoxContainer)
                            │   ├── Label ("Music Volume:")
                            │   ├── MusicVolumeSlider (HSlider, 0-100)
                            │   └── MusicVolumeValueLabel ("80%")
                            ├── SFXVolumeContainer (HBoxContainer)
                            │   ├── Label ("SFX Volume:")
                            │   ├── SFXVolumeSlider (HSlider, 0-100)
                            │   └── SFXVolumeValueLabel ("80%")
                            ├── DevSpeedContainer (HBoxContainer)
                            │   ├── Label ("Dev Speed Mode:")
                            │   └── DevSpeedCheckBox (CheckBox)
                            ├── HSeparator
                            ├── SaveResetButton (Button, "Reset Save")
                            └── BackButton (Button, "Back")
```

**Root Control properties**:
- Layout mode: Anchors preset 15 (full rect)
- Mouse filter: 2 (ignore)

**Background ColorRect**:
- Layout mode: Anchors preset 15 (full rect)
- Color: Black
- Mouse filter: 2 (ignore)

**AspectContainer**:
- Ratio: 1.77778 (16:9)
- Stretch mode: 3 (fit width)
- Mouse filter: 2 (ignore)

**PanelContainer**:
- Custom minimum size: 400x400
- Theme override (background): StyleBoxFlat with dark background, border

**MarginContainer**:
- Theme override constants: 20px all sides

### 3. Settings Scene Script

**File**: `res://settings.gd`

```gdscript
extends Control

const UI_SCALE_MIN = 0.8
const UI_SCALE_MAX = 1.2
const VOLUME_MIN = 0
const VOLUME_MAX = 100

@onready var ui_scale_slider = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/UIScaleContainer/UIScaleSlider
@onready var ui_scale_value = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/UIScaleContainer/UIScaleValueLabel
@onready var music_slider = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/MusicVolumeContainer/MusicVolumeSlider
@onready var music_value = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/MusicVolumeContainer/MusicVolumeValueLabel
@onready var sfx_slider = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/SFXVolumeContainer/SFXVolumeSlider
@onready var sfx_value = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/SFXVolumeContainer/SFXVolumeValueLabel
@onready var dev_speed_checkbox = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/DevSpeedContainer/DevSpeedCheckBox
@onready var save_reset_button = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/SaveResetButton
@onready var back_button = $Background/AspectContainer/MainContainer/CenterContainer/PanelContainer/MarginContainer/VBoxContainer/BackButton

func _ready():
	ResponsiveLayout.apply_to_scene(self)

	# Load and validate current settings
	ui_scale_slider.min_value = UI_SCALE_MIN
	ui_scale_slider.max_value = UI_SCALE_MAX
	ui_scale_slider.step = 0.05
	ui_scale_slider.value = clampf(Global.ui_scale, UI_SCALE_MIN, UI_SCALE_MAX)

	music_slider.min_value = VOLUME_MIN
	music_slider.max_value = VOLUME_MAX
	music_slider.value = clampf(Global.music_volume * 100, VOLUME_MIN, VOLUME_MAX)

	sfx_slider.min_value = VOLUME_MIN
	sfx_slider.max_value = VOLUME_MAX
	sfx_slider.value = clampf(Global.sfx_volume * 100, VOLUME_MIN, VOLUME_MAX)

	dev_speed_checkbox.button_pressed = Global.dev_speed_mode

	update_value_labels()

	# Connect signals
	back_button.pressed.connect(_on_back_pressed)
	ui_scale_slider.value_changed.connect(_on_ui_scale_changed)
	music_slider.value_changed.connect(_on_music_volume_changed)
	sfx_slider.value_changed.connect(_on_sfx_volume_changed)
	dev_speed_checkbox.toggled.connect(_on_dev_speed_toggled)
	save_reset_button.pressed.connect(_on_save_reset_pressed)

func _on_back_pressed():
	# Return to previous scene
	if Global.previous_scene.is_empty():
		push_error("No previous scene stored, cannot navigate back")
		return
	Global.change_scene(Global.previous_scene)

func _on_ui_scale_changed(value: float):
	var clamped_value = clampf(value, UI_SCALE_MIN, UI_SCALE_MAX)
	Global.ui_scale = clamped_value
	update_value_labels()
	Global.save()

	# Apply to current scene immediately
	ResponsiveLayout.apply_to_scene(self)

func _on_music_volume_changed(value: float):
	var clamped_value = clampf(value, VOLUME_MIN, VOLUME_MAX)
	Global.music_volume = clamped_value / 100.0
	update_value_labels()
	Global.save()

	# Apply audio change if AudioManager exists
	if AudioManager:
		AudioManager.set_music_volume(Global.music_volume)

func _on_sfx_volume_changed(value: float):
	var clamped_value = clampf(value, VOLUME_MIN, VOLUME_MAX)
	Global.sfx_volume = clamped_value / 100.0
	update_value_labels()
	Global.save()

	# Apply audio change if AudioManager exists
	if AudioManager:
		AudioManager.set_sfx_volume(Global.sfx_volume)

func _on_dev_speed_toggled(pressed: bool):
	Global.dev_speed_mode = pressed
	Global.save()

func _on_save_reset_pressed():
	# Confirmation dialog
	var confirm = ConfirmationDialog.new()
	confirm.dialog_text = "Reset all game progress? Settings will be preserved."
	confirm.confirmed.connect(_perform_save_reset)
	add_child(confirm)
	confirm.popup_centered()

func _perform_save_reset():
	Global.reset_save()
	# After reset, return to previous scene (which will reload)

func update_value_labels():
	ui_scale_value.text = "%d%%" % int(Global.ui_scale * 100)
	music_value.text = "%d%%" % int(Global.music_volume * 100)
	sfx_value.text = "%d%%" % int(Global.sfx_volume * 100)
```

### 4. Connect Settings Button in Each Scene

Settings button already exists in scene_template.tscn. Each scene script needs to connect it.

**Pattern to add to each scene's _ready()** (furnace.gd, mind.gd, etc.):

```gdscript
func _ready():
	ResponsiveLayout.apply_to_scene(self)
	connect_navigation()
	connect_settings_button()  # Add this line
	# ... rest of _ready

func connect_settings_button():
	var settings_button = $AspectContainer/MainContainer/mainarea/Menu/SettingsButton
	if settings_button:
		settings_button.pressed.connect(_on_settings_pressed)

func _on_settings_pressed():
	# Store current scene for return navigation
	Global.previous_scene = scene_file_path
	Global.change_scene("res://settings.tscn")
```

**Scenes to modify**:
- `res://level1/furnace.gd`
- `res://level1/mind.gd`
- Any future scenes inheriting from scene_template

### 5. Structured Save System in Global

**Modify**: `res://global.gd`

Add structured save_data and related functions:

```gdscript
extends Node

# Navigation tracking for settings return
var previous_scene: String = ""

# Structured save data (settings/game separation for clean reset logic)
var save_data = {
	"settings": {
		"ui_scale": 1.0,
		"music_volume": 0.8,
		"sfx_volume": 0.8,
		"dev_speed_mode": false,
	},
	"game": {
		"copper_current": 0,
		"copper_lifetime": 0,
		# Add other game variables as needed
	}
}

# Convenience accessors for settings (use like: Global.ui_scale = 1.2)
var ui_scale: float:
	get: return save_data.settings.ui_scale
	set(value): save_data.settings.ui_scale = clampf(value, 0.8, 1.2)

var music_volume: float:
	get: return save_data.settings.music_volume
	set(value): save_data.settings.music_volume = clampf(value, 0.0, 1.0)

var sfx_volume: float:
	get: return save_data.settings.sfx_volume
	set(value): save_data.settings.sfx_volume = clampf(value, 0.0, 1.0)

var dev_speed_mode: bool:
	get: return save_data.settings.dev_speed_mode
	set(value): save_data.settings.dev_speed_mode = value

# Convenience accessors for game data
var copper_current: int:
	get: return save_data.game.copper_current
	set(value): save_data.game.copper_current = maxi(value, 0)

var copper_lifetime: int:
	get: return save_data.game.copper_lifetime
	set(value): save_data.game.copper_lifetime = maxi(value, 0)

# ... add getters/setters for other game fields as needed

const SAVE_FILE_PATH = "user://save.json"

func _ready():
	load_save()

func save():
	"""
	Save all settings and game progress.
	Called automatically on setting changes and after technique/upgrade selections.
	"""
	var file = FileAccess.open(SAVE_FILE_PATH, FileAccess.WRITE)
	if not file:
		push_error("Failed to open save file for writing: " + SAVE_FILE_PATH)
		return

	var json_string = JSON.stringify(save_data, "\t")
	file.store_string(json_string)
	file.close()

func load_save():
	"""Load settings and game progress"""
	if not FileAccess.file_exists(SAVE_FILE_PATH):
		return  # Use defaults

	var file = FileAccess.open(SAVE_FILE_PATH, FileAccess.READ)
	if not file:
		push_error("Failed to open save file for reading: " + SAVE_FILE_PATH)
		return

	var json_text = file.get_as_text()
	file.close()

	var json = JSON.new()
	var parse_result = json.parse(json_text)

	if parse_result != OK:
		push_error("Failed to parse save file JSON at line " + str(json.get_error_line()) + ": " + json.get_error_message())
		return

	var loaded_data = json.data
	if typeof(loaded_data) != TYPE_DICTIONARY:
		push_error("Save file does not contain a dictionary")
		return

	# Merge loaded settings with defaults (handles new fields gracefully)
	if loaded_data.has("settings") and typeof(loaded_data.settings) == TYPE_DICTIONARY:
		for key in loaded_data.settings:
			if save_data.settings.has(key):
				save_data.settings[key] = loaded_data.settings[key]

	# Merge loaded game data with defaults
	if loaded_data.has("game") and typeof(loaded_data.game) == TYPE_DICTIONARY:
		for key in loaded_data.game:
			if save_data.game.has(key):
				save_data.game[key] = loaded_data.game[key]

func reset_save():
	"""Reset game progress, preserve settings (called from settings scene)"""
	# Preserve settings, get fresh game defaults
	var settings_backup = save_data.settings.duplicate(true)

	# Reconstruct save_data with default game data
	save_data.settings = settings_backup
	save_data.game = get_default_game_data()

	save()

	# Return to previous scene and reload
	if not previous_scene.is_empty():
		change_scene(previous_scene)

func get_default_game_data() -> Dictionary:
	"""Returns default game data structure (used by reset_save and prestige)"""
	return {
		"copper_current": 0,
		"copper_lifetime": 0,
		# Add other default game values as needed
	}
```

**Save triggers**:
- Settings sliders/toggles changed → `Global.save()`
- Technique selected (Phase 2.3) → `Global.save()`
- Upgrade purchased → `Global.save()`
- Major game events → `Global.save()`

**Benefits of structured approach**:
- Settings and game data cleanly separated
- `reset_save()` simply replaces `game` section, preserves `settings` section
- Adding new settings/game vars only requires updating one location (the defaults dict)
- Validation in setters prevents corruption
- Error handling prevents crashes from corrupted saves

---

## Testing

**Settings Button:**
- [ ] Settings button appears in every scene's menu
- [ ] Settings button is at bottom of menu (after nav buttons)
- [ ] Clicking button navigates to settings scene

**Settings Scene:**
- [ ] Settings scene displays centered panel
- [ ] All sliders and controls visible and labeled
- [ ] Scene uses 16:9 aspect ratio container

**UI Scale:**
- [ ] Slider shows current UI scale (default 100%)
- [ ] Moving slider changes UI scale immediately in settings scene
- [ ] Value label updates (80%-120%)
- [ ] Changes persist after returning to game

**Audio Volume:**
- [ ] Music slider shows current volume (default 80%)
- [ ] SFX slider shows current volume (default 80%)
- [ ] Moving sliders changes volume immediately
- [ ] Value labels update (0%-100%)
- [ ] Volume changes audible in real-time

**Dev Speed Mode:**
- [ ] Checkbox shows current state (default off)
- [ ] Toggling checkbox changes Global.dev_speed_mode
- [ ] State persists after returning to game

**Save Reset:**
- [ ] Button shows confirmation dialog
- [ ] Confirming resets game progress
- [ ] Settings preserved after reset (UI scale, volumes, dev mode)
- [ ] Returns to previous scene after reset

**Navigation:**
- [ ] Back button returns to previous scene
- [ ] Can enter settings from furnace, return to furnace
- [ ] Can enter settings from mind, return to mind
- [ ] Previous scene tracked correctly

**Persistence:**
- [ ] Change settings, return to game, reopen settings - settings match
- [ ] Change settings, restart game - settings persist
- [ ] Reset save - settings persist, game progress reset

---

## Files to Create

- `res://settings.tscn` - Settings scene UI
- `res://settings.gd` - Settings scene script

## Files to Modify

- `res://global.gd` - Add previous_scene, structured save_data (settings/game), save(), load_save(), reset_save(), get_default_game_data()
- `res://level1/furnace.gd` - Add connect_settings_button() and _on_settings_pressed()
- `res://level1/mind.gd` - Add connect_settings_button() and _on_settings_pressed()
- Any future scene scripts inheriting from scene_template

---

## Design Values

### Settings Scene Layout

- **AspectContainer**: 16:9 ratio (1.77778), fit width stretch mode
- **PanelContainer**: 400x400 minimum size, centered
- **Margins**: 20px all sides

### Slider Ranges

| Setting | Min | Max | Default | Step |
|---------|-----|-----|---------|------|
| UI Scale | 0.8 | 1.2 | 1.0 | 0.05 |
| Music Volume | 0 | 100 | 80 | 1 |
| SFX Volume | 0 | 100 | 80 | 1 |

### Save Structure

```json
{
    "settings": {
        "ui_scale": 1.0,
        "music_volume": 0.8,
        "sfx_volume": 0.8,
        "dev_speed_mode": false
    },
    "game": {
        "copper_current": 150,
        "copper_lifetime": 500
    }
}
```

**settings section**: Preserved during prestige/reset
**game section**: Reset by prestige, cleared by save reset

---

## Notes

**Decision**: Dedicated settings scene instead of overlay
- **Rationale**: Simpler implementation, uses existing navigation patterns
- **Benefit**: No CanvasLayer complexity, no script inheritance issues, natural pause state
- **Trade-off**: Can't see game state while in settings (not needed for adjusting sliders)
- **Implementation**: Standard scene with Global.previous_scene tracking

**Decision**: Structured save with settings/game sections
- **Rationale**: Clean separation prevents accidental settings loss during resets
- **Benefit**: reset_save() is simple - duplicate settings, replace game section
- **Maintainability**: Adding new settings/game vars only requires updating default dicts
- **Validation**: Getters/setters clamp values to valid ranges, preventing corruption
- **Error handling**: All file operations check for failures and log errors

**Decision**: Per-scene button connection
- **Rationale**: Scene scripts already extend Control directly, don't inherit from scene_template
- **Implementation**: Add connect_settings_button() to each scene's _ready()
- **Trade-off**: Small code duplication (3 lines per scene) vs complex inheritance refactor
- **Maintainability**: Pattern is simple and easy to copy to new scenes

**Decision**: Auto-save on change
- **Rationale**: No save button needed, changes persist immediately
- **Implementation**: Each slider/toggle change calls Global.save()
- **Trade-off**: Slightly more disk writes (negligible for small JSON)

**Decision**: Confirmation for save reset
- **Rationale**: Destructive action, prevent accidents
- **Implementation**: ConfirmationDialog built into Godot
- **Message**: Clear about what's reset vs preserved

---

**Last Updated**: 2025-12-16
**Maintainer**: Claude + User collaboration
