# Responsive Layout System

**Goal**: Create simple, unified layout system with right-side menu, play area, and notification bar that scales from 1280x720 to 1920x1080+ resolutions

**Success Criteria**:
- Single layout structure (landscape only, no portrait mode)
- Right menu (33% width) for stats, currencies, navigation
- Play area (66% width) for gameplay interaction
- Notification bar (120px base, scales with resolution) for 3 lines of notifications
- Font scaling: 25px base at 1280x720 scales to 37px at 1920x1080
- Automatic scaling capped at 1.5x maximum
- All scenes inherit layout automatically via scene template

**Prerequisites**:
- Phase 1.1 (Project Setup) - Base resolution configured
- Phase 1.10 (Default Theme) - Theme system exists

---

## Overview

Establishes the foundational layout structure used by ALL game scenes. Provides a simple 3-area layout (play area, menu, notifications) with automatic font and element scaling based on screen resolution. Designed for landscape-only desktop/browser gameplay with clean separation of concerns.

### Key Design Principles

- **Landscape only**: No portrait mode, no mobile support
- **Percentage-based widths**: Menu and play area scale with screen width
- **Fixed notification height**: Based on 3 lines of text (120px base, scales with resolution)
- **Automatic font scaling**: 25px base → 37px at 1080p → cap at 1.5x
- **Single layout mode**: No complex reparenting or orientation switching
- **Template inheritance**: All scenes inherit from base template

---

## Layout Structure

```
Screen (100% width × 100% height)
├── Play Area (66% width, left side)
│   └── Gameplay interaction (coal shoveling, furnace, etc.)
├── Menu (33% width, right side)
│   ├── Stats display
│   ├── Currencies
│   ├── Navigation buttons
│   └── Scene-specific controls
└── Notification Bar (bottom, 120px base height)
    └── 3 lines of notification text
```

### Visual Layout Diagram

```
+------------------------------------------+
|                           |              |
|                           |   [Stats]    |
|                           |              |
|      PLAY AREA (66%)      |   [Money]    |
|                           |              |
|    (Furnace, coal,        |  MENU (33%)  |
|     interactions)         |              |
|                           | [Navigation] |
|                           |              |
|                           |  [Buttons]   |
|                           |              |
+------------------------------------------+
|  Notification Bar (120px / 3 lines)      |
+------------------------------------------+
```

---

## Implementation Tasks

### 1. Create Scene Template

**File**: `res://level1/scene_template.tscn`

**Node Structure**:
```
SceneRoot (Control, anchors fill parent)
├── Background (TextureRect, stretch mode: keep aspect covered)
├── MainLayout (HBoxContainer)
│   ├── PlayArea (Control, custom_minimum_size_x = 66% of screen)
│   │   └── CenterContainer (optional, for centering content)
│   └── Menu (VBoxContainer, custom_minimum_size_x = 33% of screen)
│       └── (Scene-specific menu content goes here)
└── NotificationBar (VBoxContainer, bottom anchor)
    └── (Notifications appear here, managed by Global.gd)
```

**Properties**:
- **SceneRoot**: anchors (0,0,1,1), mouse_filter = PASS
- **Background**: anchors (0,0,1,1), stretch_mode = KEEP_ASPECT_COVERED, mouse_filter = PASS
  - For TextureRect: stretch_mode = 6 (KEEP_ASPECT_COVERED) - maintains aspect ratio, covers entire area, crops overflow
  - For VideoStreamPlayer: Use `expand = true` with similar covered behavior - maintains aspect ratio while filling screen
- **MainLayout**: anchors top-left to bottom-right (excludes notification bar), mouse_filter = PASS
- **PlayArea**: size_flags_horizontal = EXPAND_FILL, custom_minimum_size based on percentage
- **Menu**: size_flags_horizontal = EXPAND_FILL, custom_minimum_size based on percentage
- **NotificationBar**: anchor_bottom = 1.0, custom_minimum_size_y = 120 (scaled)

### 2. Create ResponsiveLayout Autoload

**File**: `res://responsive_layout.gd`

```gdscript
extends Node

# Base resolution (design target)
const BASE_WIDTH: int = 1280
const BASE_HEIGHT: int = 720

# Layout percentages
const PLAY_AREA_WIDTH_PERCENT: float = 0.66
const MENU_WIDTH_PERCENT: float = 0.33

# Notification bar (3 lines of text)
const BASE_FONT_SIZE: int = 25
const LINE_HEIGHT_MULTIPLIER: float = 1.3
const NOTIFICATION_LINES: int = 3
const NOTIFICATION_PADDING: int = 20  # Top + bottom
const NOTIFICATION_BAR_HEIGHT: int = int(BASE_FONT_SIZE * LINE_HEIGHT_MULTIPLIER * NOTIFICATION_LINES + NOTIFICATION_PADDING)  # 120px

# Scaling limits
const MAX_AUTO_SCALE: float = 1.5  # Cap automatic scaling at 1.5x

var current_auto_scale: float = 1.0

func _ready():
    calculate_scale()
    get_viewport().size_changed.connect(_on_viewport_size_changed)

func _on_viewport_size_changed():
    calculate_scale()

func calculate_scale() -> float:
    """
    Calculate automatic resolution-based scale factor.
    Base: 1280x720 = 1.0x
    1920x1080 = 1.5x
    Capped at MAX_AUTO_SCALE
    """
    var viewport = get_viewport()
    if not viewport:
        return 1.0

    var viewport_width = viewport.get_visible_rect().size.x
    var scale = viewport_width / float(BASE_WIDTH)
    current_auto_scale = clamp(scale, 1.0, MAX_AUTO_SCALE)
    return current_auto_scale

func get_auto_scale() -> float:
    """
    Returns current automatic scale (1.0 to 1.5)
    """
    return current_auto_scale

func get_final_scale() -> float:
    """
    Returns final scale including user UI scale preference.
    final_scale = auto_scale * user_ui_scale
    (user_ui_scale comes from settings, see Phase 1.12)
    """
    var user_scale = 1.0
    if Global.has("ui_scale"):
        user_scale = Global.ui_scale
    return current_auto_scale * user_scale

func get_scaled_font_size(base_size: int = BASE_FONT_SIZE) -> int:
    """
    Returns scaled font size based on resolution and user preference
    """
    return int(base_size * get_final_scale())

func get_notification_bar_height() -> int:
    """
    Returns notification bar height scaled to current resolution
    """
    return int(NOTIFICATION_BAR_HEIGHT * get_auto_scale())

func get_play_area_width() -> int:
    """
    Returns play area width in pixels
    """
    var viewport_width = get_viewport().get_visible_rect().size.x
    return int(viewport_width * PLAY_AREA_WIDTH_PERCENT)

func get_menu_width() -> int:
    """
    Returns menu width in pixels
    """
    var viewport_width = get_viewport().get_visible_rect().size.x
    return int(viewport_width * MENU_WIDTH_PERCENT)

func apply_to_scene(scene_root: Control) -> void:
    """
    Apply responsive layout to a scene.
    Call from scene's _ready(): ResponsiveLayout.apply_to_scene(self)
    """
    call_deferred("_apply_layout", scene_root)

func _apply_layout(scene_root: Control) -> void:
    calculate_scale()

    # Get layout nodes
    var main_layout = scene_root.get_node_or_null("MainLayout")
    var play_area = scene_root.get_node_or_null("MainLayout/PlayArea")
    var menu = scene_root.get_node_or_null("MainLayout/Menu")
    var notification_bar = scene_root.get_node_or_null("NotificationBar")

    if not main_layout or not play_area or not menu:
        push_warning("ResponsiveLayout: Scene missing required layout nodes")
        return

    # Set widths based on percentages
    var viewport_width = get_viewport().get_visible_rect().size.x
    play_area.custom_minimum_size.x = get_play_area_width()
    menu.custom_minimum_size.x = get_menu_width()

    # Set notification bar height
    if notification_bar:
        notification_bar.custom_minimum_size.y = get_notification_bar_height()

    # Apply font scaling to all labels and buttons
    _apply_font_scaling(scene_root)

    # Set mouse filters
    _set_mouse_filters(scene_root)

func _apply_font_scaling(node: Node) -> void:
    """
    Recursively apply font scaling to all UI elements
    """
    var scaled_font = get_scaled_font_size()

    if node is Label or node is Button or node is RichTextLabel:
        node.add_theme_font_size_override("font_size", scaled_font)

    for child in node.get_children():
        _apply_font_scaling(child)

func _set_mouse_filters(scene_root: Control) -> void:
    """
    Set mouse_filter to PASS on background and containers to prevent click blocking
    """
    var background = scene_root.get_node_or_null("Background")
    if background:
        background.mouse_filter = Control.MOUSE_FILTER_PASS

    var main_layout = scene_root.get_node_or_null("MainLayout")
    if main_layout:
        main_layout.mouse_filter = Control.MOUSE_FILTER_PASS
```

### 3. Register Autoload

**File**: `project.godot`

```ini
[autoload]

ResponsiveLayout="*res://responsive_layout.gd"
```

### 4. Usage in Scenes

**In any scene script** (that inherits from scene_template.tscn):

```gdscript
extends Control

func _ready():
    ResponsiveLayout.apply_to_scene(self)

    # Scene-specific setup below
    # ...
```

---

## Notification System Integration

**Note**: Detailed notification plans are covered in separate TOC items:
- **Notifications** - Generic notification system
- **Stat Notification System** - Stat gain feedback

**Layout responsibilities** (this plan):
- Provide notification bar area (120px base, bottom of screen)
- Scale notification bar with resolution
- Ensure notifications don't overlap play area or menu

**Notification system responsibilities** (future plans):
- Display notification messages
- Queue and timing logic
- Animation and styling
- Stat-specific formatting


---

## Code Examples

### Complete Scene Template Setup

**scene_template.tscn** (text format excerpt):

```
[gd_scene format=3]

[node name="SceneRoot" type="Control"]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
mouse_filter = 2

[node name="Background" type="TextureRect" parent="."]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
expand_mode = 1
stretch_mode = 6
mouse_filter = 2

[node name="MainLayout" type="HBoxContainer" parent="."]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_bottom = -120.0
mouse_filter = 2

[node name="PlayArea" type="Control" parent="MainLayout"]
custom_minimum_size = Vector2(845, 0)
layout_mode = 2
size_flags_horizontal = 3

[node name="Menu" type="VBoxContainer" parent="MainLayout"]
custom_minimum_size = Vector2(422, 0)
layout_mode = 2
size_flags_horizontal = 3

[node name="NotificationBar" type="VBoxContainer" parent="."]
anchors_preset = 12
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_top = -120.0
custom_minimum_size = Vector2(0, 120)
```

### Scaling Examples

**Font Scaling**:
```gdscript
# At 1280x720 (base):
ResponsiveLayout.get_scaled_font_size(25)  # Returns: 25px

# At 1920x1080 (1.5x):
ResponsiveLayout.get_scaled_font_size(25)  # Returns: 37px

# At 2560x1440 (2.0x, but capped at 1.5x):
ResponsiveLayout.get_scaled_font_size(25)  # Returns: 37px (capped)
```

**Layout Widths**:
```gdscript
# At 1280x720:
ResponsiveLayout.get_play_area_width()  # Returns: 845px (66%)
ResponsiveLayout.get_menu_width()       # Returns: 422px (33%)

# At 1920x1080:
ResponsiveLayout.get_play_area_width()  # Returns: 1267px (66%)
ResponsiveLayout.get_menu_width()       # Returns: 634px (33%)
```

---

## Testing Strategy

### Manual Test Criteria

**Layout Structure:**
- [ ] Scene template created with correct node structure
- [ ] PlayArea takes 66% width
- [ ] Menu takes 33% width
- [ ] Notification bar at bottom, 120px height

**Resolution Scaling:**
- [ ] At 1280x720: Font 25px, notification bar 120px
- [ ] At 1920x1080: Font 37px, notification bar 180px
- [ ] At 2560x1440: Font 37px (capped), notification bar 180px (capped)
- [ ] At 3840x2160 (4K): Font 37px (capped), notification bar 180px (capped)

**Layout Proportions:**
- [ ] Play area always 66% width at all resolutions
- [ ] Menu always 33% width at all resolutions
- [ ] Notification bar scales proportionally with resolution

**Mouse Interaction:**
- [ ] Clicks work in play area
- [ ] Buttons in menu are clickable
- [ ] Background doesn't block clicks
- [ ] Notifications don't block play area clicks

**Cross-Scene Consistency:**
- [ ] Multiple scenes inherit template correctly
- [ ] Layout consistent across scene changes
- [ ] Scaling applies to all scenes uniformly

---

## Files to Create

- `res://responsive_layout.gd` - Responsive layout autoload
- `res://level1/scene_template.tscn` - Base scene template for inheritance

## Files to Modify

- `project.godot` - Add ResponsiveLayout autoload

---

## Design Values (Reference)

### Layout Percentages

| Area | Width % | Calculation (at 1280x720) | Calculation (at 1920x1080) |
|------|---------|---------------------------|----------------------------|
| Play Area | 66% | 1280 × 0.66 = 845px | 1920 × 0.66 = 1267px |
| Menu | 33% | 1280 × 0.33 = 422px | 1920 × 0.33 = 634px |
| Notification Bar | 100% width | 1280 × 1.0 = 1280px | 1920 × 1.0 = 1920px |

### Notification Bar Height

**Calculation**:
```
height = (font_size × line_height × lines) + padding
height = (25px × 1.3 × 3) + 20px
height = 97px + 20px = 120px (base)
```

**Scaled**:
- 1280x720: 120px
- 1920x1080: 120 × 1.5 = 180px
- 2560x1440: 120 × 1.5 = 180px (capped)

### Font Scaling

| Resolution | Scale Factor | Base Font (25px) | Result |
|------------|--------------|------------------|--------|
| 1280x720 | 1.0x | 25px | 25px |
| 1600x900 | 1.25x | 25px | 31px |
| 1920x1080 | 1.5x | 25px | 37px |
| 2560x1440 | 2.0x (capped at 1.5x) | 25px | 37px |
| 3840x2160 | 3.0x (capped at 1.5x) | 25px | 37px |

**Why cap at 1.5x?**
- Prevents excessively large text at 4K
- 37px is already very readable
- Allows more information density at higher resolutions
- User can adjust with UI Scale Slider (Phase 1.12) if needed

---

## Notes & Decisions

**Decision 1**: Landscape only (no portrait mode)
- **Rationale**: Desktop/browser focus, simpler implementation, no mobile support needed
- **Benefit**: Eliminates complex reparenting logic, easier to maintain
- **Trade-off**: Not usable on mobile devices (acceptable for this project)

**Decision 2**: 66/33 split (play area/menu)
- **Rationale**: Prioritizes gameplay area while giving menu enough space for stats/currencies
- **Alternative considered**: 75/25 (rejected - menu too cramped), 50/50 (rejected - play area too small)

**Decision 3**: Percentage-based widths (not fixed pixels)
- **Rationale**: Scales naturally with resolution, maintains proportions
- **Benefit**: Looks correct at all resolutions without manual adjustment

**Decision 4**: Fixed notification height (120px base)
- **Rationale**: Based on 3 lines of text, predictable and consistent
- **Scales with resolution**: 120px → 180px at 1080p

**Decision 5**: Cap automatic scaling at 1.5x
- **Rationale**: Prevents giant text at 4K, maintains information density
- **Override**: User can adjust with UI Scale Slider if they want bigger text

**Decision 6**: Menu on right side
- **Rationale**: Western reading pattern (left to right), play area gets visual priority
- **Benefit**: Natural eye flow from gameplay to stats

---

## Implementation Checklist

Before marking this phase complete:

- [ ] responsive_layout.gd created
- [ ] scene_template.tscn created with correct node structure
- [ ] Autoload registered in project.godot
- [ ] calculate_scale() function working
- [ ] get_scaled_font_size() function working
- [ ] get_notification_bar_height() function working
- [ ] apply_to_scene() function working
- [ ] PlayArea width = 66% at all resolutions
- [ ] Menu width = 33% at all resolutions
- [ ] Notification bar height scales correctly
- [ ] Font scaling: 25px → 37px at 1080p
- [ ] Font scaling capped at 1.5x
- [ ] Mouse filters set correctly (clicks work)
- [ ] Test scene created to verify layout
- [ ] Tested at 1280x720
- [ ] Tested at 1920x1080
- [ ] Tested at 2560x1440
- [ ] Documentation complete

---

**Last Updated**: 2025-11-30
**Maintainer**: Claude + User collaboration
