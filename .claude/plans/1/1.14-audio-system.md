# Audio System

**Goal**: Create simple audio manager for music and sound effects with volume control

**Success Criteria**:
- AudioManager autoload plays music and SFX
- Music loops continuously, fades between tracks
- SFX plays one-shot sounds
- Separate volume controls for music and SFX (0-100%)
- Volume settings persist across sessions
- Simple API: AudioManager.play_music(track), AudioManager.play_sfx(sound)

**Prerequisites**:
- Phase 1.3 (Global Autoload) - Global.gd exists for settings storage
- Phase 1.36 (Settings Button/Panel) - Settings panel for volume sliders (UI only)

---

## Overview

Implements a centralized audio system using Godot's AudioStreamPlayer nodes. Provides simple API for playing background music and sound effects with independent volume control. Music tracks loop and fade between transitions, SFX are one-shot. Volume preferences saved to settings.json.

### Key Design Principles

- **Simple API**: Two main functions (play_music, play_sfx)
- **Autoload singleton**: Always available via AudioManager global
- **Independent volume**: Music and SFX controlled separately
- **Persistent settings**: Volume saved to settings.json
- **Fade transitions**: Smooth music changes (1 second fade)
- **No audio ducking**: Keep it simple (can add later if needed)

---

## Implementation Tasks

### 1. Create AudioManager Autoload

**File**: `res://audio_manager.gd`

**Structure**:
```gdscript
extends Node

# Audio players
var music_player: AudioStreamPlayer
var sfx_players: Array[AudioStreamPlayer] = []
const SFX_POOL_SIZE = 8
var next_sfx_index = 0

# Volume settings (0.0 to 1.0)
var music_volume: float = 0.8  # 80% default
var sfx_volume: float = 0.8    # 80% default

# Current music track
var current_music: AudioStream = null

func _ready():
    # Create music player
    music_player = AudioStreamPlayer.new()
    music_player.bus = "Music"
    add_child(music_player)

    # Create SFX player pool for overlapping sounds
    for i in SFX_POOL_SIZE:
        var sfx_player = AudioStreamPlayer.new()
        sfx_player.bus = "SFX"
        add_child(sfx_player)
        sfx_players.append(sfx_player)

    # Load volume settings
    load_volumes()
    apply_volumes()

func load_volumes():
    """Load volume settings from Global.settings"""
    if Global.has("music_volume"):
        music_volume = Global.music_volume
    if Global.has("sfx_volume"):
        sfx_volume = Global.sfx_volume

func apply_volumes():
    """Apply current volume settings to audio buses"""
    var music_bus_idx = AudioServer.get_bus_index("Music")
    var sfx_bus_idx = AudioServer.get_bus_index("SFX")

    # Convert 0.0-1.0 to decibels (logarithmic)
    if music_volume > 0:
        AudioServer.set_bus_volume_db(music_bus_idx, linear_to_db(music_volume))
        AudioServer.set_bus_mute(music_bus_idx, false)
    else:
        AudioServer.set_bus_mute(music_bus_idx, true)

    if sfx_volume > 0:
        AudioServer.set_bus_volume_db(sfx_bus_idx, linear_to_db(sfx_volume))
        AudioServer.set_bus_mute(sfx_bus_idx, false)
    else:
        AudioServer.set_bus_mute(sfx_bus_idx, true)

func set_music_volume(volume: float):
    """Set music volume (0.0 to 1.0) and save"""
    music_volume = clamp(volume, 0.0, 1.0)
    apply_volumes()
    Global.music_volume = music_volume
    Global.save_settings()

func set_sfx_volume(volume: float):
    """Set SFX volume (0.0 to 1.0) and save"""
    sfx_volume = clamp(volume, 0.0, 1.0)
    apply_volumes()
    Global.sfx_volume = sfx_volume
    Global.save_settings()
```

### 2. Music Playback with Fade

```gdscript
func play_music(track: AudioStream, fade_duration: float = 1.0):
    """
    Play music track with optional fade transition

    Args:
        track: AudioStream to play
        fade_duration: Seconds to fade between tracks (0 = instant)
    """
    if current_music == track and music_player.playing:
        return  # Already playing this track

    current_music = track

    if fade_duration > 0 and music_player.playing:
        # Fade out current, then fade in new
        await fade_out_music(fade_duration)
        _start_music(track, fade_duration)
    else:
        # Instant switch
        _start_music(track, 0)

func _start_music(track: AudioStream, fade_in_duration: float):
    """Internal: Start playing music track"""
    music_player.stream = track
    music_player.play()

    if fade_in_duration > 0:
        fade_in_music(fade_in_duration)

func fade_out_music(duration: float):
    """Fade out current music over duration"""
    var tween = create_tween()
    tween.tween_method(
        func(vol):
            var bus_idx = AudioServer.get_bus_index("Music")
            AudioServer.set_bus_volume_db(bus_idx, linear_to_db(vol * music_volume)),
        1.0,
        0.0,
        duration
    )
    await tween.finished
    music_player.stop()

func fade_in_music(duration: float):
    """Fade in current music over duration"""
    var tween = create_tween()
    tween.tween_method(
        func(vol):
            var bus_idx = AudioServer.get_bus_index("Music")
            AudioServer.set_bus_volume_db(bus_idx, linear_to_db(vol * music_volume)),
        0.0,
        1.0,
        duration
    )

func stop_music(fade_duration: float = 1.0):
    """Stop music with optional fade"""
    if fade_duration > 0:
        await fade_out_music(fade_duration)
    else:
        music_player.stop()
    current_music = null
```

### 3. SFX Playback with Pool

```gdscript
func play_sfx(sound: AudioStream):
    """
    Play one-shot sound effect using player pool for overlapping sounds

    Args:
        sound: AudioStream to play
    """
    if not sound:
        push_warning("AudioManager: Attempted to play null SFX")
        return

    # Use next player in pool (round-robin)
    sfx_players[next_sfx_index].stream = sound
    sfx_players[next_sfx_index].play()

    # Cycle to next player
    next_sfx_index = (next_sfx_index + 1) % SFX_POOL_SIZE
```

**Pool behavior**:
- 8 AudioStreamPlayer nodes for SFX
- Sounds can overlap (button click + notification + footstep simultaneously)
- Round-robin: Next sound uses next player in pool
- If all 8 busy, oldest sound gets replaced (rare)

### 4. Audio Bus Setup

**Modify**: `project.godot` (or create via Godot Editor → Audio panel)

```ini
[audio]

buses/default_bus_layout="res://default_bus_layout.tres"
```

**Create**: `res://default_bus_layout.tres` (via Godot Editor)

**Bus structure**:
```
Master (0 dB)
├── Music (0 dB) - Controlled by music_volume
└── SFX (0 dB) - Controlled by sfx_volume
```

### 5. Register AudioManager Autoload

**Modify**: `project.godot`

```ini
[autoload]

AudioManager="*res://audio_manager.gd"
```

### 6. Add Volume Settings to Global

**Modify**: `res://global.gd`

Add volume variables:
```gdscript
# Audio settings
var music_volume: float = 0.8  # 80% default
var sfx_volume: float = 0.8    # 80% default
```

Update save_settings():
```gdscript
func save_settings() -> void:
    var settings = {
        "ui_scale": ui_scale,
        "music_volume": music_volume,
        "sfx_volume": sfx_volume,
    }
    var file = FileAccess.open("user://settings.json", FileAccess.WRITE)
    if file:
        file.store_string(JSON.stringify(settings, "\t"))
        file.close()
```

Update load_settings():
```gdscript
func load_settings() -> void:
    if not FileAccess.file_exists("user://settings.json"):
        return

    var file = FileAccess.open("user://settings.json", FileAccess.READ)
    if file:
        var json = JSON.new()
        if json.parse(file.get_as_text()) == OK:
            var data = json.data
            ui_scale = data.get("ui_scale", 1.0)
            music_volume = data.get("music_volume", 0.8)
            sfx_volume = data.get("sfx_volume", 0.8)
        file.close()
```

---

## Usage Examples

### Playing Music

```gdscript
# In scene script
func _ready():
    # Load music track
    var menu_music = load("res://audio/music/menu_theme.ogg")
    AudioManager.play_music(menu_music)

# Changing music (with fade)
func switch_to_gameplay_music():
    var gameplay_music = load("res://audio/music/gameplay_theme.ogg")
    AudioManager.play_music(gameplay_music, 2.0)  # 2 second fade
```

### Playing Sound Effects

```gdscript
# Button click
func _on_button_pressed():
    var click_sound = load("res://audio/sfx/button_click.wav")
    AudioManager.play_sfx(click_sound)

# Coin pickup
func _on_coin_collected():
    var coin_sound = load("res://audio/sfx/coin.wav")
    AudioManager.play_sfx(coin_sound)
```

### Changing Volume (from settings panel)

```gdscript
# In settings panel script
func _on_music_slider_changed(value: float):
    # Slider range 0-100, convert to 0.0-1.0
    AudioManager.set_music_volume(value / 100.0)

func _on_sfx_slider_changed(value: float):
    AudioManager.set_sfx_volume(value / 100.0)
```

---

## Audio File Organization

**Recommended folder structure**:
```
res://audio/
├── music/
│   ├── menu_theme.ogg
│   ├── gameplay_theme.ogg
│   ├── bar_ambience.ogg
│   └── furnace_ambience.ogg
└── sfx/
    ├── button_click.wav
    ├── coin.wav
    ├── shovel.wav
    ├── furnace_open.wav
    └── notification.wav
```

**Audio format recommendations**:
- **Music**: .ogg (compressed, looping)
- **SFX**: .wav (uncompressed, short) or .ogg (longer SFX)

---

## Testing

**Music Playback:**
- [ ] Play music track, loops continuously
- [ ] Change music track, 1 second fade transition
- [ ] Stop music, fades out smoothly
- [ ] Music volume at 0% mutes music
- [ ] Music volume at 50% is audibly quieter
- [ ] Music volume at 100% is full volume

**SFX Playback:**
- [ ] Play SFX, sound plays once and stops
- [ ] Play multiple SFX rapidly (may overlap)
- [ ] SFX volume at 0% mutes SFX
- [ ] SFX volume at 50% is audibly quieter
- [ ] SFX volume at 100% is full volume

**Volume Persistence:**
- [ ] Set music volume to 30%, restart game, volume is 30%
- [ ] Set SFX volume to 80%, restart game, volume is 80%
- [ ] Delete settings.json, restart, volumes are default (70%/80%)

**Cross-Scene:**
- [ ] Music continues playing when changing scenes
- [ ] SFX plays correctly in all scenes
- [ ] Volume changes apply immediately

---

## Files to Create

- `res://audio_manager.gd` - AudioManager autoload
- `res://default_bus_layout.tres` - Audio bus configuration (via Editor)
- `res://audio/` - Folder for music and SFX (placeholder)

## Files to Modify

- `project.godot` - Register AudioManager autoload, set audio bus layout
- `global.gd` - Add music_volume and sfx_volume settings

---

## Design Values

### Volume Defaults

| Setting | Default | Range | Format |
|---------|---------|-------|--------|
| Music Volume | 80% (0.8) | 0-100% | Float 0.0-1.0 |
| SFX Volume | 80% (0.8) | 0-100% | Float 0.0-1.0 |

**Rationale**: Both at 80% for balanced audio experience

### Fade Timing

| Transition | Duration | Rationale |
|------------|----------|-----------|
| Music change | 1.0 sec | Smooth but quick |
| Music stop | 1.0 sec | Graceful exit |
| Instant (0 sec) | Available | For abrupt cuts |

### Audio Buses

```
Master (0 dB)
├── Music (-0 dB, controlled by music_volume)
└── SFX (-0 dB, controlled by sfx_volume)
```

**Why separate buses?**
- Independent volume control
- Future: Can add effects per bus (reverb on music, etc.)
- Future: Can implement audio ducking (lower music when SFX plays)

---

## Notes

**Decision**: SFX player pool (8 players)
- **Current**: 8 AudioStreamPlayer nodes in round-robin pool
- **Rationale**: Allows overlapping sounds (click + notification + footstep)
- **Pool size**: 8 simultaneous sounds (more than enough for typical gameplay)
- **Behavior**: If all busy, oldest sound replaced (extremely rare scenario)

**Decision**: Fade transitions for music only
- **Rationale**: Music changes should be smooth, SFX are instant
- **Implementation**: Tween on audio bus volume
- **Default**: 1 second fade (configurable per call)

**Decision**: Volume stored in Global.gd
- **Rationale**: Settings persistence already in Global
- **Benefit**: Single settings.json file for all settings
- **Alternative**: Separate audio_settings.json (rejected - unnecessary split)

**Decision**: Linear to dB conversion
- **Rationale**: Godot audio buses use decibels, sliders use 0-100%
- **Implementation**: `linear_to_db()` built-in function
- **Effect**: Volume slider feels linear to player

**Decision**: No audio ducking initially
- **Rationale**: Keep it simple for MVP
- **Future**: Can add if SFX need to stand out more
- **Implementation**: Would lower music bus when SFX plays

**Decision**: Music loops automatically
- **Rationale**: Godot AudioStreamPlayer loops by default for .ogg
- **Configuration**: Import settings set loop=true for music tracks
- **No code needed**: Handled by AudioStream import

---

**Last Updated**: 2025-12-01
**Maintainer**: Claude + User collaboration
