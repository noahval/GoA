# Notification History Panel

**Goal**: Create interactive notification history panel in play area with filtering, scrolling, and ability to return to previous content

**Success Criteria**:
- Panel opens in play area (66% width zone) when notification bar clicked
- Shows all notifications from Global.notification_history
- Filter by type (All, Info, Stat, Warning, Success)
- Scrollable list for 50+ notifications
- Close button returns play area to previous state
- Session persistence (history cleared on game restart, not scene change)
- Responsive scaling (works at 720p and 1080p)

**Prerequisites**:
- Phase 1.11 (Responsive Layout) - Play area defined
- Phase 1.13 (Notifications) - notification_history array populated

---

## Overview

Provides a comprehensive history view of all notifications received during the current game session. Opens as an overlay in the play area when the notification bar is clicked, allowing players to review past messages, filter by type, and return to gameplay. Designed to be unobtrusive yet informative.

### Key Design Principles

- **Non-modal overlay**: Doesn't block game, sits in play area
- **Session-only**: History clears on game restart (not scene change)
- **Filter-first design**: Type filters at top for quick access
- **Minimal chrome**: Clean list design, no unnecessary decoration
- **Scroll performance**: Efficient for 100+ notifications
- **Quick escape**: Prominent close button, ESC key support

---

## Architecture Overview

### Data Flow

```
Player clicks NotificationBar
    ↓
_on_notification_bar_clicked()
    ↓
Save current play area state (if gameplay active)
    ↓
Instantiate NotificationHistoryPanel.tscn
    ↓
Add to PlayArea (replaces current content)
    ↓
Load Global.notification_history
    ↓
Populate ScrollContainer with filtered list
    ↓
Player clicks Close or presses ESC
    ↓
Remove history panel
    ↓
Restore previous play area state
```

### Component Separation

- **This Plan (1.14)**: History panel UI, filtering, display logic
- **Plan 1.x-notifications**: Notification creation and history tracking
- **Plan 1.11**: Play area layout and positioning
- **Future gameplay plans**: What content gets replaced in play area

---

## Implementation Tasks

### 1. NotificationHistoryPanel Scene

**File**: `res://ui/notification_history_panel.tscn`

**Node Structure**:
```
NotificationHistoryPanel (Control, anchors fill PlayArea)
├── Background (ColorRect - semi-transparent)
├── VBoxContainer (main layout)
│   ├── TopBar (HBoxContainer)
│   │   ├── TitleLabel ("Notification History")
│   │   ├── Spacer (Control, expand)
│   │   └── CloseButton (Button, "X")
│   ├── FilterBar (HBoxContainer)
│   │   ├── AllButton (Button, "All")
│   │   ├── InfoButton (Button, "Info")
│   │   ├── StatButton (Button, "Stat")
│   │   ├── WarningButton (Button, "Warning")
│   │   └── SuccessButton (Button, "Success")
│   └── HistoryScrollContainer (ScrollContainer)
│       └── HistoryList (VBoxContainer)
│           └── (Notification entries added dynamically)
```

**Properties**:
- **NotificationHistoryPanel**: anchors (0,0,1,1), fills entire PlayArea
- **Background**: Dark, semi-transparent (Color(0.1, 0.1, 0.1, 0.7))
- **VBoxContainer**: Centered, 90% width of PlayArea
- **HistoryScrollContainer**: v_scroll enabled, fills vertical space

---

### 2. NotificationHistoryPanel Script

**File**: `res://ui/notification_history_panel.gd`

```gdscript
extends Control

# UI References
@onready var history_list: VBoxContainer = $VBoxContainer/HistoryScrollContainer/HistoryList
@onready var close_button: Button = $VBoxContainer/TopBar/CloseButton
@onready var filter_buttons: Dictionary = {
    Global.NotificationType.INFO: $VBoxContainer/FilterBar/InfoButton,
    Global.NotificationType.STAT: $VBoxContainer/FilterBar/StatButton,
    Global.NotificationType.WARNING: $VBoxContainer/FilterBar/WarningButton,
    Global.NotificationType.SUCCESS: $VBoxContainer/FilterBar/SuccessButton
}
@onready var all_button: Button = $VBoxContainer/FilterBar/AllButton

# State
var current_filter: int = -1  # -1 = show all types

func _ready():
    # Connect signals
    close_button.pressed.connect(_on_close_pressed)
    all_button.pressed.connect(func(): _set_filter(-1))

    # Connect filter buttons
    for type in filter_buttons:
        filter_buttons[type].pressed.connect(func(): _set_filter(type))

    # Handle ESC key
    set_process_input(true)

    # Load and display history
    _refresh_history()

func _input(event: InputEvent):
    if event.is_action_pressed("ui_cancel"):  # ESC key
        _on_close_pressed()
        get_viewport().set_input_as_handled()

func _set_filter(type: int):
    """Set active filter and refresh display."""
    current_filter = type

    # Update button states (highlight active filter)
    all_button.button_pressed = (type == -1)
    for filter_type in filter_buttons:
        filter_buttons[filter_type].button_pressed = (filter_type == type)

    _refresh_history()

func _refresh_history():
    """Clear and repopulate history list based on current filter."""
    # Clear existing entries
    for child in history_list.get_children():
        child.queue_free()

    # Get filtered notifications
    var filtered_notifications = _get_filtered_notifications()

    # Reverse order (newest first)
    filtered_notifications.reverse()

    # Create entry for each notification
    for notification_data in filtered_notifications:
        var entry = _create_history_entry(notification_data)
        history_list.add_child(entry)

    # Show empty message if no notifications
    if filtered_notifications.is_empty():
        var empty_label = Label.new()
        empty_label.text = "No notifications to display"
        empty_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
        history_list.add_child(empty_label)

func _get_filtered_notifications() -> Array:
    """Get notifications matching current filter."""
    if current_filter == -1:
        # Show all
        return Global.notification_history.duplicate()

    # Filter by type
    var filtered = []
    for notification in Global.notification_history:
        if notification.type == current_filter:
            filtered.append(notification)
    return filtered

func _create_history_entry(notification_data: Dictionary) -> Control:
    """Create a single history entry panel."""
    var entry_panel = Panel.new()
    entry_panel.custom_minimum_size = Vector2(0, 50)

    # Style entry
    var style_box = StyleBoxFlat.new()
    style_box.bg_color = _get_type_color(notification_data.type)
    style_box.corner_radius_top_left = 4
    style_box.corner_radius_top_right = 4
    style_box.corner_radius_bottom_left = 4
    style_box.corner_radius_bottom_right = 4
    style_box.content_margin_left = 10
    style_box.content_margin_right = 10
    style_box.content_margin_top = 5
    style_box.content_margin_bottom = 5
    entry_panel.add_theme_stylebox_override("panel", style_box)

    # Message label (fills panel)
    var message_label = Label.new()
    message_label.text = notification_data.message
    message_label.autowrap_mode = TextServer.AUTOWRAP_WORD_SMART
    message_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
    message_label.vertical_alignment = VERTICAL_ALIGNMENT_CENTER
    message_label.add_theme_color_override("font_color", Color(1, 1, 1, 1))

    # Anchor to fill panel
    message_label.anchor_left = 0
    message_label.anchor_right = 1
    message_label.anchor_top = 0
    message_label.anchor_bottom = 1

    entry_panel.add_child(message_label)

    return entry_panel

func _get_type_color(type: int) -> Color:
    """Get background color based on notification type."""
    match type:
        Global.NotificationType.INFO:
            return Color(0.15, 0.15, 0.15, 0.4)  # Dark grey
        Global.NotificationType.STAT:
            return Color(0.1, 0.2, 0.35, 0.4)    # Dark blue tint
        Global.NotificationType.WARNING:
            return Color(0.35, 0.2, 0.1, 0.4)    # Orange tint
        Global.NotificationType.SUCCESS:
            return Color(0.1, 0.3, 0.1, 0.4)     # Green tint
        _:
            return Color(0.15, 0.15, 0.15, 0.4)  # Default grey

func _on_close_pressed():
    """Close history panel and restore previous play area content."""
    # Signal to parent that panel should close
    queue_free()

    # Note: Parent (PlayArea manager) handles restoring previous content
```

---

### 3. PlayArea State Management

**Add to Global.gd or create new PlayAreaManager.gd**:

```gdscript
# In Global.gd

var play_area_stack: Array = []  # Stack of previous play area content

func show_notification_history():
    """
    Open notification history panel in play area.
    Called when notification bar is clicked.
    """
    var current_scene = get_tree().current_scene
    var play_area = current_scene.get_node_or_null("MainLayout/PlayArea")

    if not play_area:
        push_warning("No PlayArea found in current scene")
        return

    # Save current play area content (if any)
    if play_area.get_child_count() > 0:
        var current_content = play_area.get_child(0)
        play_area_stack.append(current_content)
        play_area.remove_child(current_content)

    # Load and add history panel
    var history_panel = preload("res://ui/notification_history_panel.tscn").instantiate()
    play_area.add_child(history_panel)

    # Connect close signal
    history_panel.tree_exited.connect(_on_history_panel_closed)

func _on_history_panel_closed():
    """Restore previous play area content when history panel closes."""
    var current_scene = get_tree().current_scene
    var play_area = current_scene.get_node_or_null("MainLayout/PlayArea")

    if not play_area:
        return

    # Restore previous content (if any)
    if play_area_stack.size() > 0:
        var previous_content = play_area_stack.pop_back()
        play_area.add_child(previous_content)
```

**Update notification bar click handler** (from Plan 1.x-notifications):

```gdscript
func _on_notification_bar_clicked() -> void:
    """Open notification history panel in play area."""
    Global.show_notification_history()
```

---

### 4. History Entry Visual Design

**Entry Panel Structure** (created dynamically):

```
┌─────────────────────────────────────────────┐
│                                             │
│         You feel stronger                   │  ← Message text (white, centered)
│                                             │
└─────────────────────────────────────────────┘
  ↑ Background color varies by type (slight tint)
```

**Color coding** (subtle tints, not garish):
- INFO: Dark grey (neutral)
- STAT: Dark blue tint (knowledge/growth)
- WARNING: Orange tint (caution)
- SUCCESS: Green tint (achievement)

**Spacing**: 5px between entries

---

## Testing Strategy

### Manual Test Criteria

**Panel Display**:
- [ ] Click notification bar - history panel opens
- [ ] Panel fills play area (66% width zone)
- [ ] Close button visible in top-right
- [ ] Press ESC - panel closes

**Filtering**:
- [ ] "All" button shows all notifications
- [ ] "Info" button shows only INFO type
- [ ] "Stat" button shows only STAT type
- [ ] Filter buttons highlight when active
- [ ] Empty filter shows "No notifications" message

**Content Display**:
- [ ] Newest notifications at top (reverse chronological)
- [ ] Message text wraps correctly
- [ ] Message text centered in panel
- [ ] Type colors subtle but distinguishable
- [ ] Scroll works with 20+ notifications

**State Management**:
- [ ] Opening history preserves play area content
- [ ] Closing history restores previous content
- [ ] Can open/close multiple times
- [ ] Notifications persist while panel open

**Scaling**:
- [ ] Panel works at 1280x720
- [ ] Panel works at 1920x1080
- [ ] Font sizes scale correctly
- [ ] Layout doesn't break at either resolution

---

## Files to Create

- `res://ui/notification_history_panel.tscn` - History panel scene
- `res://ui/notification_history_panel.gd` - Panel script (~150 lines)

## Files to Modify

- `global.gd` (~50 lines added)
  - play_area_stack variable
  - show_notification_history() function
  - _on_history_panel_closed() handler

- `scene_template.tscn` or `responsive_layout.gd`
  - Update notification bar click handler to call Global.show_notification_history()

---

## Design Values (Reference)

### Panel Dimensions

| Element | Size | Notes |
|---------|------|-------|
| Panel width | 90% of PlayArea | ~600px at 720p, ~900px at 1080p |
| Entry height | 50px minimum | Expands if message wraps |
| Entry spacing | 5px | Vertical gap between entries |
| Corner radius | 4px | Rounded entry panels |

### Colors

| Type | Background Color | Rationale |
|------|------------------|-----------|
| INFO | rgba(38, 38, 38, 0.4) | Neutral dark grey |
| STAT | rgba(26, 51, 89, 0.4) | Subtle blue (growth) |
| WARNING | rgba(89, 51, 26, 0.4) | Subtle orange (caution) |
| SUCCESS | rgba(26, 77, 26, 0.4) | Subtle green (achievement) |

**Panel background**: rgba(26, 26, 26, 0.7) - semi-transparent overlay

### Text

| Element | Size | Color |
|---------|------|-------|
| Message | 25px (base, scales) | White #FFFFFF |
| Title | 30px (base, scales) | White #FFFFFF |
| Filter buttons | 18px (base, scales) | White #FFFFFF |

---

## Dependencies & Integration

### Depends On:
- Phase 1.11 (Responsive Layout) - PlayArea structure
- Phase 1.13 (Notifications) - notification_history array, NotificationType enum

### Used By:
- **Players** - Access notification history during gameplay
- **Future UI** - Could add "History" button in menu

### Provides:
- Visual review of all session notifications
- Filter for specific notification types
- Timestamp reference for when events occurred

---

## Notes & Decisions

**Decision 1**: Session-only history (not persisted)
- **Rationale**: Keeps save files small, history less useful after restart
- **Benefit**: No save data bloat, no migration concerns
- **Alternative considered**: Persist last 100 (can add later if requested)

**Decision 2**: Opens in play area (not modal overlay)
- **Rationale**: Uses existing layout zone, consistent with game structure
- **Benefit**: No z-index conflicts, clean separation
- **Trade-off**: Replaces current content (but restores on close)

**Decision 3**: Newest first (reverse chronological)
- **Rationale**: Most recent notifications are most relevant
- **Benefit**: No scrolling to see latest
- **Alternative considered**: Oldest first (rejected - requires scroll to see new)

**Decision 4**: Subtle type colors (not bold)
- **Rationale**: Avoid visual noise, keep professional look
- **Benefit**: Information hierarchy, not garish
- **Alternative considered**: Bold colors (rejected - too distracting)

**Decision 5**: ESC key closes panel
- **Rationale**: Standard UI escape pattern
- **Benefit**: Quick exit, keyboard accessibility

**Decision 6**: Filter buttons always visible
- **Rationale**: Primary use case is filtering
- **Benefit**: One-click access to specific types
- **Alternative considered**: Dropdown filter (rejected - extra click)

---

## Implementation Checklist

Before marking this phase complete:

- [ ] notification_history_panel.tscn created
- [ ] notification_history_panel.gd script implemented
- [ ] Panel layout correct (fills PlayArea)
- [ ] Close button works
- [ ] ESC key closes panel
- [ ] Filter buttons implemented
- [ ] "All" filter shows all types
- [ ] Type-specific filters work
- [ ] Active filter button highlighted
- [ ] History entries created dynamically
- [ ] Reverse chronological order (newest first)
- [ ] Message text wraps correctly
- [ ] Message text centered vertically and horizontally
- [ ] Type color coding subtle but visible
- [ ] Scrolling works with many entries
- [ ] Empty filter shows appropriate message
- [ ] PlayArea state management implemented
- [ ] Previous content restored on close
- [ ] Notification bar click opens panel
- [ ] Panel works at 720p
- [ ] Panel works at 1080p
- [ ] Font scaling correct at both resolutions

---

**Last Updated**: 2025-11-30
**Maintainer**: Claude + User collaboration
