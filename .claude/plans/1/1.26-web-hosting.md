# Web Hosting Setup

**Goal**: Deploy GoA to the web at agoa.app using itch.io with automated GitHub Actions builds

**Success Criteria**:
- Game loads and runs correctly at agoa.app
- Automated deploys on push to main branch
- No file size limitations (can scale to 100MB+)
- Threading/COOP/COEP headers work correctly

## Overview

This plan sets up web hosting infrastructure for GoA. The game will be exported to HTML5/WebAssembly and deployed to itch.io using Butler CLI, accessible via the custom domain agoa.app purchased from Porkbun.

Key advantages of itch.io:
- No file size limits (Cloudflare Pages has 26MB limit, our WASM is 37MB)
- COOP/COEP headers work by default (no workarounds needed)
- Built for game hosting
- Custom domain support
- Built-in analytics
- Butler CLI for automated deployments

### Key Design Principles

- Automated deployments only - no manual upload process
- Keep build artifacts out of git repo
- Use free itch.io hosting
- Domain managed through Porkbun, CNAME points to itch.io

---

## Implementation Tasks

### 1. Godot Web Export Preset

**Status**: Already created in previous attempt

**Export preset location**: `game/v0.1/export_presets.cfg`

Current configuration:
- Name: "Web"
- Export path: `../../build/web/Agoa_V0.1.html`
- Thread support: Enabled
- Texture compression: Desktop (VRAM)
- Canvas resize: Adaptive

No changes needed - this works for itch.io deployment.

### 2. Create itch.io Project

**Manual setup required** (one-time)

1. **Create itch.io account** (if you don't have one)
   - Go to https://itch.io
   - Sign up or log in

2. **Create a new project**
   - Dashboard → Create new project
   - Title: `GoA` (or "A GoA" for proper title)
   - Project URL: Choose a URL slug (e.g., `goa` → yourname.itch.io/goa)
   - Kind of project: HTML
   - This file will be played in the browser: Check this box

3. **Configure project settings**
   - Viewport dimensions: 1280x720 (or your game's resolution)
   - Embed options:
     - Automatically start on page load: Yes
     - Fullscreen button: Yes
     - Mobile friendly: No (unless you optimize for mobile)
   - SharedArrayBuffer support: Enable (critical for threading)

4. **Get API credentials**
   - Dashboard → Settings → API keys
   - Generate a new API key
   - Copy and save securely (you'll need this for GitHub secrets)

5. **Note your itch.io username and project name**
   - Username: e.g., `noahval`
   - Project: e.g., `goa`
   - Full URL will be: `https://noahval.itch.io/goa`

### 3. GitHub Actions Workflow

**Create**: `.github/workflows/deploy-web.yml`

**Replace existing Cloudflare workflow with:**

```yaml
name: Deploy Web Build to itch.io

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  export-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: 4.5.0
          use-dotnet: false
          include-templates: true

      - name: Verify Godot installation
        run: |
          godot --version
          godot --help

      - name: Export for Web
        run: |
          mkdir -p build/web
          cd game/v0.1
          godot --headless --export-release "Web" ../../build/web/index.html

      - name: Verify build output
        run: |
          ls -lah build/web/
          echo "Build artifacts:"
          find build/web -type f
          du -sh build/web/*

      - name: Deploy to itch.io
        uses: manleydev/butler-publish-itchio-action@v1.0.3
        env:
          BUTLER_CREDENTIALS: ${{ secrets.ITCH_API_KEY }}
          CHANNEL: html5
          ITCH_GAME: ${{ secrets.ITCH_GAME }}
          ITCH_USER: ${{ secrets.ITCH_USER }}
          PACKAGE: build/web
          VERSION: ${{ github.sha }}
```

**Why these choices:**
- `manleydev/butler-publish-itchio-action` - Popular, maintained action for Butler uploads
- `CHANNEL: html5` - itch.io channel for web builds
- `VERSION: ${{ github.sha }}` - Uses git commit hash for versioning
- Verification steps - Catch export failures and show file sizes

**Potential issues:**
- Export preset name MUST match exactly "Web" (case-sensitive)
- Path resolution can break if working directory assumptions are wrong
- Godot version must match exactly (must be 4.5.0)
- itch.io project must exist before first deploy

### 4. GitHub Repository Secrets

**Required secrets** (Settings -> Secrets and variables -> Actions):

| Secret Name | Where to Get It | Purpose |
|-------------|-----------------|---------|
| `ITCH_API_KEY` | itch.io → Settings → API keys | Authenticate Butler uploads |
| `ITCH_USER` | Your itch.io username | Identify your account |
| `ITCH_GAME` | Your project slug | Identify which game to update |

**ITCH_API_KEY creation steps:**
1. Log into itch.io
2. Dashboard → Settings (top right)
3. API keys tab
4. Click "Generate new API key"
5. Description: "GitHub Actions deployment"
6. Copy the key IMMEDIATELY (shown once)
7. Add to GitHub repo secrets

**ITCH_USER:**
- Your itch.io username (e.g., `noahval`)
- Add to GitHub repo secrets

**ITCH_GAME:**
- Your project slug (e.g., `goa`)
- Add to GitHub repo secrets

**Critical**: API key cannot be viewed after creation. Store securely if needed elsewhere.

### 5. Custom Domain Configuration

**itch.io custom domain setup:**

1. **In itch.io project settings**
   - Go to your project page → Edit game
   - Scroll to "Custom domain"
   - Enter: `agoa.app`
   - Save

2. **In Porkbun DNS** (or Cloudflare if you're still using it for DNS)
   - Type: CNAME
   - Name: `@` (root domain)
   - Value: `[your-username].itch.io` (e.g., `noahval.itch.io`)
   - OR if using www subdomain:
     - Name: `www`
     - Value: `[your-username].itch.io`
     - Then redirect root to www

3. **Alternative: Use Cloudflare for DNS management**
   Since you already added agoa.app to Cloudflare:
   - Cloudflare DNS → agoa.app
   - Add CNAME record:
     - Type: CNAME
     - Name: `@` (or `agoa.app`)
     - Target: `[your-username].itch.io`
     - Proxy status: DNS only (orange cloud OFF for custom domains on itch.io)
   - Wait 5-10 minutes for propagation

4. **Verify in itch.io**
   - itch.io will check DNS records
   - Once verified, agoa.app will serve your game
   - SSL certificate auto-provisioned

**DNS propagation:**
- Usually 15 minutes to 2 hours
- Can take up to 24-48 hours (rare)
- Check: `nslookup agoa.app` should show itch.io CNAME

### 6. Testing & Verification

**After first deploy:**

1. **Check itch.io project page**
   - Go to https://[your-username].itch.io/goa
   - Game should load in embedded player
   - Test coal shoveling physics
   - Check browser console for errors (F12)

2. **Verify threading works**
   - Open browser console
   - No SharedArrayBuffer errors
   - Physics runs smoothly

3. **Test custom domain** (after DNS propagates)
   - Visit https://agoa.app
   - Should redirect to itch.io embed
   - OR show game directly if itch.io supports iframe removal

4. **Check file sizes**
   - itch.io dashboard → Analytics → Storage
   - Verify upload succeeded
   - Note total size for future reference

### 7. .gitignore Updates

**Already done** - No additional changes needed

Current .gitignore already excludes:
- `build/`
- `.godot/export/`
- `*.import`

---

## Testing Strategy

### Manual Test Criteria

**After workflow creation:**
- [ ] GitHub secrets added correctly (ITCH_API_KEY, ITCH_USER, ITCH_GAME)
- [ ] Push to main triggers workflow
- [ ] Workflow completes successfully (green checkmark)
- [ ] itch.io project page shows new build

**After first deployment:**
- [ ] https://[username].itch.io/goa loads game
- [ ] Game runs correctly in itch.io embed
- [ ] Coal physics simulation works
- [ ] No console errors about SharedArrayBuffer or CORS
- [ ] Audio plays correctly
- [ ] No missing assets

**After domain setup:**
- [ ] https://agoa.app resolves correctly
- [ ] SSL certificate is valid (no browser warnings)
- [ ] Game loads at custom domain
- [ ] Performance is acceptable

**Browser compatibility:**
- [ ] Chrome/Edge (latest) - game loads and runs
- [ ] Firefox (latest) - game loads and runs
- [ ] Safari (latest) - game loads and runs (if Mac available)
- [ ] Mobile browsers - may have performance issues (expected)

**Performance checks:**
- [ ] Game loads in <15 seconds on broadband
- [ ] Physics simulation runs at 60 FPS
- [ ] No stuttering during coal shoveling
- [ ] File download size reasonable (30-40MB is fine)

---

## Files to Create

- None - workflow file already exists, will be modified

## Files to Modify

- `.github/workflows/deploy-web.yml` - Replace Cloudflare deployment with itch.io Butler

---

## Design Values (Reference)

### Build Settings

- **Godot version**: 4.5.0 (must match across editor and CI)
- **Export preset name**: "Web" (exact match required)
- **Build output path**: `build/web/index.html`
- **Texture compression**: Desktop (VRAM optimized)
- **Canvas resize**: Adaptive
- **Current WASM size**: ~37MB (will grow)
- **No file size limit on itch.io**

### Deployment Settings

- **Platform**: itch.io
- **Deploy method**: Butler CLI via GitHub Actions
- **Channel**: html5
- **Domain**: agoa.app (custom domain)
- **Deploy branch**: main
- **Deploy trigger**: On push to main
- **Versioning**: Git commit SHA

---

## Notes & Decisions

**Decision 1:** Use itch.io instead of Cloudflare Pages
- **Rationale**:
  - Cloudflare Pages has 26.2MB file size limit
  - Our WASM export is 37.3MB and will grow larger
  - itch.io has no file size limits
  - COOP/COEP headers work by default (no workarounds)
  - Built for game hosting
- **Alternatives considered**:
  - Cloudflare Pages (rejected - file size limit)
  - Netlify (50MB limit - might work but still limiting)
  - GitHub Pages + Cloudflare Workers (too complex, adds latency)
  - Self-hosted (unnecessary complexity and cost)

**Decision 2:** Use Butler CLI via GitHub Action
- **Rationale**:
  - Official itch.io deployment tool
  - Maintained community action available
  - Simple, reliable
- **Alternatives considered**:
  - Manual uploads (defeats automation purpose)
  - itch.io API directly (more complex than Butler)

**Decision 3:** Keep thread support enabled
- **Rationale**:
  - Better performance for physics simulation
  - itch.io supports SharedArrayBuffer correctly
  - No file size constraint forcing us to disable it
- **Note**: With Cloudflare Pages we would have had to disable this

**Decision 4:** Use git commit SHA for versioning
- **Rationale**:
  - Unique per build
  - Traceable to exact code state
  - Automatic, no manual version bumping
- **Future consideration**: Could switch to semantic versioning later

**Open Questions:**
- [ ] Should we enable itch.io analytics tracking?
- [ ] Do we want to make the game public or unlisted initially?
- [ ] Should we set up a devlog on itch.io for updates?
- [ ] Do we want to configure itch.io's "Buy Now" / donations later?

---

## Implementation Checklist

- [x] Web export preset created
- [x] Local export tested and working
- [x] Create itch.io account
- [x] Create itch.io project for GoA
- [x] Configure itch.io project (HTML5, SharedArrayBuffer support)
- [x] Generate itch.io API key
- [x] Add ITCH_API_KEY to GitHub secrets
- [x] Add ITCH_USER to GitHub secrets
- [x] Add ITCH_GAME to GitHub secrets
- [x] Update GitHub Actions workflow for itch.io deployment
- [x] Delete Cloudflare Pages project (no longer needed)
- [x] Delete CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID secrets
- [x] Push workflow to main branch
- [ ] Verify workflow runs successfully
- [ ] Test game on itch.io project page
- [ ] Configure custom domain in itch.io settings
- [ ] Update DNS (CNAME to itch.io)
- [ ] Wait for DNS propagation
- [ ] Test https://agoa.app loads correctly
- [ ] Test game functionality on custom domain
- [ ] Test in multiple browsers
- [ ] Document deployment process for future reference

---

## Troubleshooting Guide

### Export fails in GitHub Actions

**Symptom**: Workflow fails on "Export for Web" step
**Causes:**
- Export preset name mismatch
- Working directory wrong
- Godot version mismatch

**Fix:**
1. Check preset name is exactly "Web" in export_presets.cfg
2. Verify working directory in YAML (cd game/v0.1)
3. Check chickensoft-games/setup-godot version matches 4.5.0

### Butler upload fails

**Symptom**: "Deploy to itch.io" step fails
**Causes:**
- Invalid API key
- itch.io project doesn't exist
- Username or game slug wrong

**Fix:**
1. Verify ITCH_API_KEY is correct in GitHub secrets
2. Check itch.io project exists and is HTML5 type
3. Verify ITCH_USER matches your exact username
4. Verify ITCH_GAME matches your project slug exactly
5. Check itch.io API key hasn't been revoked

### Game loads but crashes or is slow

**Symptom**: Game starts but has errors, performance issues
**Causes:**
- SharedArrayBuffer not enabled in itch.io settings
- Assets not loading correctly
- Memory issues

**Fix:**
1. itch.io project settings → Enable SharedArrayBuffer support
2. Check browser console for specific errors
3. Test in different browser to isolate issue
4. Verify all build files uploaded (check itch.io dashboard)

### Custom domain doesn't work

**Symptom**: agoa.app doesn't load or shows error
**Causes:**
- DNS not configured correctly
- DNS not propagated yet
- Cloudflare proxy interfering

**Fix:**
1. Check DNS: `nslookup agoa.app` should show CNAME to itch.io
2. If using Cloudflare, turn OFF orange cloud (proxy)
3. Wait longer - can take up to 24 hours
4. Verify CNAME target is correct: `[username].itch.io`
5. Check itch.io project settings → Custom domain is set correctly

### Game loads but threading doesn't work

**Symptom**: Console shows SharedArrayBuffer errors
**Causes:**
- SharedArrayBuffer not enabled in itch.io project
- Browser doesn't support it

**Fix:**
1. itch.io project → Edit → Embed options → Enable SharedArrayBuffer
2. Test in Chrome/Firefox (Safari has limited support)
3. Check browser version is recent (2020+)
4. Clear browser cache and reload

### File too large error

**Symptom**: Upload fails with size error
**Causes:**
- Should not happen with itch.io, but possible if extremely large

**Fix:**
1. Check actual build size: `du -sh build/web`
2. itch.io supports multi-GB files, contact support if issue persists
3. Consider optimizing assets if over 500MB
