# Web Hosting Setup

**Goal**: Deploy GoA to the web at agoa.app using Cloudflare Pages with automated GitHub Actions builds

**Success Criteria**:
- Game loads and runs correctly at agoa.app
- Automated deploys on push to main branch
- COOP/COEP headers properly configured for Godot 4.5 threading support
- SSL/HTTPS working correctly

## Overview

This plan sets up web hosting infrastructure for GoA. The game will be exported to HTML5/WebAssembly and deployed to Cloudflare Pages, accessible via the custom domain agoa.app purchased from Porkbun.

Key challenges:
- Godot 4.x requires Cross-Origin-Opener-Policy and Cross-Origin-Embedder-Policy headers for SharedArrayBuffer support (threading)
- GitHub Pages doesn't support custom headers, making Cloudflare Pages the better choice
- Export preset must be configured correctly for web deployment
- GitHub Actions needs Godot 4.5 export templates

### Key Design Principles

- Automated deployments only - no manual upload process
- Keep build artifacts out of git repo
- Use free tier services (Cloudflare Pages, GitHub Actions)
- Domain managed through Porkbun, DNS through Cloudflare

---

## Implementation Tasks

### 1. Godot Web Export Preset

**Problem**: No export_presets.cfg exists yet - need to create web export configuration

**Create**: `game/v0.1/export_presets.cfg`

This file must be created in the Godot editor, NOT manually written. However, here's what it should contain for reference:

```ini
[preset.0]

name="Web"
platform="Web"
runnable=true
dedicated_server=false
custom_features=""
export_filter="all_resources"
include_filter=""
exclude_filter=""
export_path="../../build/web/index.html"
encryption_include_filters=""
encryption_exclude_filters=""
encrypt_pck=false
encrypt_directory=false

[preset.0.options]

custom_template/debug=""
custom_template/release=""
variant/extensions_support=false
vram_texture_compression/for_desktop=true
vram_texture_compression/for_mobile=false
html/export_icon=true
html/custom_html_shell=""
html/head_include=""
html/canvas_resize_policy=2
html/focus_canvas_on_start=true
html/experimental_virtual_keyboard=false
progressive_web_app/enabled=false
progressive_web_app/offline_page=""
progressive_web_app/display=1
progressive_web_app/orientation=0
progressive_web_app/icon_144x144=""
progressive_web_app/icon_180x180=""
progressive_web_app/icon_512x512=""
progressive_web_app/background_color=Color(0, 0, 0, 1)
```

**Implementation steps:**
1. Open project in Godot 4.5 editor
2. Project -> Export
3. Add -> Web
4. Configure export path: `../../build/web/index.html`
5. Set "VRAM Texture Compression / For Desktop" to true
6. Set "Canvas Resize Policy" to "Adaptive" (value 2)
7. Set "Focus Canvas On Start" to true
8. Save preset as "Web"
9. Test export locally to verify it works

**Critical settings:**
- Export path MUST point outside the Godot project directory to avoid circular issues
- Canvas resize policy affects how the game scales in browser
- Texture compression for desktop ensures reasonable file sizes

### 2. GitHub Actions Workflow

**Problem**: Need automated build and deploy pipeline

**Create**: `.github/workflows/deploy-web.yml`

**Implementation details:**

```yaml
name: Deploy Web Build to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  export-web:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: 4.5
          use-dotnet: false
          include-templates: true

      - name: Verify Godot installation
        run: |
          godot --version
          godot --help

      - name: Export for Web
        run: |
          mkdir -p build/web
          cd game/v0.1
          godot --headless --export-release "Web" ../../build/web/index.html

      - name: Add COOP/COEP headers
        run: |
          cat > build/web/_headers << 'EOF'
          /*
            Cross-Origin-Opener-Policy: same-origin
            Cross-Origin-Embedder-Policy: require-corp
          EOF

      - name: Verify build output
        run: |
          ls -lah build/web/
          echo "Build artifacts:"
          find build/web -type f

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: goa
          directory: build/web
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
```

**Why these choices:**
- `chickensoft-games/setup-godot@v2` - Actively maintained Godot setup action with 4.5 support
- `ubuntu-22.04` - Stable LTS runner with good compatibility
- `--headless --export-release` - No GUI, optimized build
- `_headers` file - Cloudflare Pages reads this for custom headers
- Verification steps - Catch export failures early

**Potential issues:**
- Export preset name MUST match exactly "Web" (case-sensitive)
- Path resolution can break if working directory assumptions are wrong
- Godot version must match exactly (must be 4.5)

### 3. GitHub Repository Secrets

**Required secrets** (Settings -> Secrets and variables -> Actions):

| Secret Name | Where to Get It | Purpose |
|-------------|-----------------|---------|
| `CLOUDFLARE_API_TOKEN` | Cloudflare dashboard -> My Profile -> API Tokens | Authenticate deploy action |
| `CLOUDFLARE_ACCOUNT_ID` | Cloudflare dashboard -> Workers & Pages (in URL) | Target account |

**CLOUDFLARE_API_TOKEN creation steps:**
1. Go to Cloudflare dashboard
2. My Profile -> API Tokens -> Create Token
3. Use "Edit Cloudflare Workers" template
4. Permissions needed:
   - Account - Cloudflare Pages - Edit
5. Create token, copy IMMEDIATELY (shown once)
6. Add to GitHub repo secrets

**CLOUDFLARE_ACCOUNT_ID:**
1. Go to Cloudflare dashboard -> Workers & Pages
2. Account ID is in the right sidebar OR in the URL
3. Format: 32 character hex string
4. Add to GitHub repo secrets

**Critical**: These secrets cannot be viewed after creation. Store securely if needed elsewhere.

### 4. Cloudflare Pages Project Setup

**Create project** (before first deploy):

1. Cloudflare dashboard -> Workers & Pages -> Create Application -> Pages -> Connect to Git
2. **WAIT** - Don't connect to git. We're using direct upload via API
3. Instead: Create via Wrangler CLI or let the GitHub Action create it on first run

**OR manually create:**
1. Workers & Pages -> Create Application -> Pages
2. Select "Direct Upload"
3. Project name: `goa` (must match workflow YAML)
4. Upload a dummy index.html for now
5. Project created, ready for GitHub Actions

**The GitHub Action will handle subsequent deploys automatically**

### 5. Custom Domain Configuration

**Porkbun DNS setup:**

Domain: agoa.app
Nameservers: Point to Cloudflare

**Steps:**
1. Cloudflare dashboard -> Add Site -> Enter agoa.app
2. Cloudflare provides nameserver addresses (e.g., `alice.ns.cloudflare.com`, `bob.ns.cloudflare.com`)
3. Log into Porkbun
4. Domain management for agoa.app
5. Update nameservers to Cloudflare's nameservers
6. Wait for propagation (can take 24-48 hours, usually faster)

**Cloudflare Pages custom domain:**
1. Workers & Pages -> goa project -> Custom domains
2. Set up a custom domain
3. Enter: `agoa.app`
4. Cloudflare automatically creates DNS records
5. Optionally add `www.agoa.app` as well
6. SSL certificate auto-provisioned (via Let's Encrypt)

**DNS records created automatically:**
- `agoa.app` -> CNAME to `goa.pages.dev` (or similar)
- Cloudflare handles proxying and SSL

**Verification:**
- Wait 5-10 minutes after adding domain
- Visit https://agoa.app
- Should see deployed game
- Check certificate (should be valid, not self-signed)

### 6. Headers Verification

**Critical for Godot 4.5 web builds**: Must verify headers are served correctly

**Test after first deploy:**

```bash
curl -I https://agoa.app
```

**Expected response should include:**
```
cross-origin-opener-policy: same-origin
cross-origin-embedder-policy: require-corp
```

**If headers missing:**
- Check `_headers` file exists in build/web/ directory
- Verify Cloudflare Pages is processing the file (Pages dashboard -> Deployment details)
- Check Cloudflare Pages documentation for _headers file format

**Why this matters:**
- Without these headers, SharedArrayBuffer is disabled in browsers
- Godot 4.x uses SharedArrayBuffer for threading
- Game may load but have degraded performance or crash

### 7. .gitignore Updates

**Add to .gitignore:**

```gitignore
# Build outputs
build/
*.import

# Godot export
.godot/export/
export_presets.cfg.bak
```

**Why:**
- `build/` contains generated artifacts, should not be committed
- Export backups are created by Godot, not needed in git
- `.import` files are Godot's internal cache

---

## Testing Strategy

### Manual Test Criteria

**After export preset creation:**
- [ ] Export Web from Godot editor completes without errors
- [ ] build/web/index.html exists and is >1KB
- [ ] build/web/index.wasm exists and is >1MB
- [ ] build/web/index.pck exists (packed resources)
- [ ] Local test: Open index.html in Chrome/Firefox, game loads

**After GitHub Actions setup:**
- [ ] Push to main triggers workflow
- [ ] Workflow completes successfully (green checkmark)
- [ ] Cloudflare Pages shows new deployment
- [ ] Deployment preview URL loads game correctly

**After domain setup:**
- [ ] https://agoa.app loads (not http)
- [ ] SSL certificate is valid (no browser warnings)
- [ ] Game runs at full performance (no threading warnings in console)
- [ ] Headers verification: `curl -I https://agoa.app` shows COOP/COEP headers

**Browser compatibility:**
- [ ] Chrome/Edge (latest) - game loads and runs
- [ ] Firefox (latest) - game loads and runs
- [ ] Safari (latest) - game loads and runs (if Mac available)
- [ ] Mobile Chrome - game loads (may have performance issues)
- [ ] Mobile Safari - game loads (may have performance issues)

**Performance checks:**
- [ ] Game loads in <10 seconds on broadband
- [ ] No console errors about SharedArrayBuffer
- [ ] Physics simulation runs smoothly (coal shoveling)
- [ ] Audio plays correctly

---

## Files to Create

- `game/v0.1/export_presets.cfg` - Godot export configuration (created via editor)
- `.github/workflows/deploy-web.yml` - GitHub Actions workflow
- `.gitignore` updates - Ignore build artifacts

## Files to Modify

- `.gitignore` - Add build/, .godot/export/, export backup files

---

## Design Values (Reference)

### Build Settings

- **Godot version**: 4.5 (must match across editor and CI)
- **Export preset name**: "Web" (exact match required)
- **Build output path**: `build/web/index.html`
- **Texture compression**: Desktop (VRAM optimized)
- **Canvas resize**: Adaptive
- **Max build size estimate**: ~50-100MB (depends on assets)

### Deployment Settings

- **Cloudflare project name**: goa
- **Domain**: agoa.app
- **Deploy branch**: main
- **Deploy trigger**: On push to main
- **Preview deploys**: Disabled (only production deploys)

---

## Notes & Decisions

**Decision 1:** Use Cloudflare Pages instead of GitHub Pages
- **Rationale**: Godot 4.5 requires custom headers (COOP/COEP) that GitHub Pages cannot provide
- **Alternatives considered**:
  - GitHub Pages + Cloudflare Workers to inject headers (overly complex)
  - Netlify (viable but already have Cloudflare account)
  - Self-hosted (unnecessary complexity and cost)

**Decision 2:** Use chickensoft-games/setup-godot action
- **Rationale**: Actively maintained, supports Godot 4.5, includes export templates
- **Alternatives considered**:
  - firebelley/godot-export (hasn't been updated for 4.5)
  - abarichello/godot-ci Docker image (requires container setup)
  - Manual Godot installation (slower, more brittle)

**Decision 3:** Build on ubuntu-22.04
- **Rationale**: LTS stability, good Godot compatibility
- **Alternatives considered**:
  - ubuntu-latest (too unpredictable)
  - Custom Docker image (overkill for this use case)

**Decision 4:** No staging environment initially
- **Rationale**: Solo dev, low traffic, can test locally before pushing
- **Future consideration**: Add preview deploys for branches if needed

**Open Questions:**
- [ ] Should we add analytics? (Cloudflare Web Analytics is free)
- [ ] Do we want PWA support? (offline play capability)
- [ ] Should we add a loading screen customization?
- [ ] Do we need to configure CSP (Content Security Policy) headers?

---

## Implementation Checklist

- [ ] Create Web export preset in Godot editor
- [ ] Test local export - verify game runs in browser
- [ ] Create GitHub Actions workflow file
- [ ] Create CLOUDFLARE_API_TOKEN in Cloudflare dashboard
- [ ] Add CLOUDFLARE_API_TOKEN to GitHub secrets
- [ ] Add CLOUDFLARE_ACCOUNT_ID to GitHub secrets
- [ ] Create Cloudflare Pages project (or let action create it)
- [ ] Push workflow to main branch
- [ ] Verify workflow runs successfully
- [ ] Update Porkbun nameservers to Cloudflare
- [ ] Wait for DNS propagation
- [ ] Add agoa.app as custom domain in Cloudflare Pages
- [ ] Wait for SSL certificate provisioning
- [ ] Test https://agoa.app loads correctly
- [ ] Verify COOP/COEP headers with curl
- [ ] Test game functionality on deployed site
- [ ] Test in multiple browsers
- [ ] Update .gitignore to exclude build artifacts
- [ ] Document deployment process for future reference

---

## Troubleshooting Guide

### Export fails in Godot editor

**Symptom**: Export button does nothing or errors out
**Causes:**
- Export templates not installed
- Invalid export path
- Missing permissions on output directory

**Fix:**
1. Editor -> Manage Export Templates -> Download and Install
2. Verify export path is valid: `../../build/web/index.html`
3. Create build/web/ directories manually if needed
4. Check Godot console output for specific errors

### GitHub Action fails on export step

**Symptom**: Workflow fails with "Could not export" or similar
**Causes:**
- Export preset name mismatch
- Working directory wrong
- Godot version mismatch

**Fix:**
1. Check preset name is exactly "Web" in export_presets.cfg
2. Verify working directory in YAML (cd game/v0.1)
3. Check chickensoft-games/setup-godot version matches project Godot version

### Headers not being served

**Symptom**: curl doesn't show COOP/COEP headers
**Causes:**
- _headers file not in build output
- Cloudflare Pages not processing _headers file
- Cache showing old deployment

**Fix:**
1. Check GitHub Actions logs - verify "Add COOP/COEP headers" step ran
2. Check Cloudflare Pages deployment files - look for _headers
3. Clear Cloudflare cache: Caching -> Configuration -> Purge Everything
4. Wait 5 minutes and test again

### Game loads but crashes or is slow

**Symptom**: Game starts but has errors, performance issues
**Causes:**
- SharedArrayBuffer disabled (headers missing)
- Assets not loading (CORS issues)
- Texture compression mismatch

**Fix:**
1. Check browser console for SharedArrayBuffer errors
2. Verify COOP/COEP headers (see above)
3. Test in different browser to isolate issue
4. Check network tab - verify all assets load (200 status)

### Domain doesn't resolve

**Symptom**: agoa.app shows DNS error
**Causes:**
- Nameservers not updated in Porkbun
- DNS propagation not complete
- Custom domain not added in Cloudflare Pages

**Fix:**
1. Check nameservers: `dig agoa.app NS`
2. Should show Cloudflare nameservers
3. If not, update in Porkbun and wait 1-24 hours
4. Verify custom domain added in Cloudflare Pages dashboard

### SSL certificate invalid

**Symptom**: Browser shows security warning
**Causes:**
- Certificate provisioning still in progress
- Domain not fully propagated
- Cloudflare SSL mode incorrect

**Fix:**
1. Wait 15-30 minutes after adding custom domain
2. Check Cloudflare SSL/TLS settings -> Overview -> Encryption mode should be "Full"
3. If still failing after 1 hour, remove and re-add custom domain
