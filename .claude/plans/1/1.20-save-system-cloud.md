# Save System Cloud Storage

**IMPORTANT**: This plan focuses ONLY on save triggers (when to save). For implementation details of the save system, see plan [1.19-nakama-server.md](1.19-nakama-server.md).

## Overview
Define when and where to call `NakamaClient.save_game()` throughout the game. The actual save/load implementation is in plan 1.19-nakama-server.md.

## Purpose
Establish save triggers so that:
- Player progress saves automatically after significant events
- Progress is saved frequently to prevent data loss
- Saves are fire-and-forget (don't block gameplay)
- Game feels responsive (no waiting for saves to complete)

---

## Save Trigger Locations

### Trigger 1: After Major Purchases
**Location**: Shop system (shop.gd or equivalent)

**When**: After player spends currency on upgrades/items

**Implementation**:
```gdscript
# In shop.gd or wherever purchases happen
func _on_upgrade_purchased():
	# Deduct currency
	Level1Vars.currency.copper -= cost
	Level1Vars.shovel_lvl += 1

	# Save after spending currency (fire and forget)
	if NakamaClient.is_authenticated:
		NakamaClient.save_game()  # Don't await - let it save in background
```

**Note**: Copper era day phase upgrade purchases don't have a plan yet. When that mechanic is implemented, add save trigger there too:
```gdscript
# In copper era day phase upgrade system (location TBD)
func _on_copper_era_upgrade_purchased():
	# Existing upgrade logic...

	# Save after purchase
	if NakamaClient.is_authenticated:
		NakamaClient.save_game()  # Fire and forget
```

### Trigger 2: After Stat Level-Ups
**Location**: Global.gd in the experience system

**When**: After a stat gains enough experience to level up

**Implementation**:
```gdscript
# In Global.gd
func add_stat_exp(stat_name: String, amount: float):
	# Existing code to add exp...

	# Check if level increased
	var level_increased = false
	# ... existing level-up logic ...

	# Save if stat leveled up
	if level_increased:
		if NakamaClient.is_authenticated:
			NakamaClient.save_game()  # Fire and forget
```

### Trigger 3: Before Scene Changes
**Location**: Global.gd in scene management

**When**: Before transitioning to a new scene

**Implementation**:
```gdscript
# In Global.gd
func change_scene_with_check(scene_path: String):
	# Save current progress before leaving scene
	if NakamaClient.is_authenticated:
		await NakamaClient.save_game()  # Await this one to ensure save completes

	# Then change scene
	get_tree().change_scene_to_file(scene_path)
```

**Note**: Await save_game() here to ensure progress is saved before scene unloads.

### Trigger 4: Periodic Auto-Save
**Location**: Global.gd (or dedicated SaveManager if created)

**When**: Every 2 minutes of gameplay

**Implementation**:
```gdscript
# In Global.gd (or SaveManager.gd)
var autosave_timer: Timer

func _ready():
	# Setup autosave timer
	autosave_timer = Timer.new()
	autosave_timer.wait_time = 120.0  # 2 minutes
	autosave_timer.autostart = true
	autosave_timer.timeout.connect(_on_autosave)
	add_child(autosave_timer)

func _on_autosave():
	if NakamaClient.is_authenticated:
		NakamaClient.save_game()  # Fire and forget
		DebugLogger.info("Auto-saved to cloud")
```

**Note**: Start with 2 minutes, can optimize frequency later if needed.

### Trigger 5: On Game Exit
**Location**: Global.gd

**When**: Player closes the game

**Implementation**:
```gdscript
# In Global.gd
func _notification(what):
	if what == NOTIFICATION_WM_CLOSE_REQUEST:
		# Save before closing
		if NakamaClient.is_authenticated:
			await NakamaClient.save_game()  # Await to ensure save completes
		get_tree().quit()
```

**Note**: Await save_game() here to ensure progress is saved before game closes.

---

## Account Migration Triggers

Migration happens automatically when user switches authentication methods (device ID â†’ username/Google). See plan [1.19-nakama-server.md](1.19-nakama-server.md) Part 5 for implementation details.

### When Migration Happens
- User starts with device ID authentication
- User creates username/password account OR signs into Google
- Auth screen (plan 1.21) detects migration and calls `NakamaClient.check_for_migration_needed()`

### Migration Flow (High-Level)
1. **No Conflict**: Ask user "Upload your device ID progress to [account]?"
2. **Conflict**: Show both saves with timestamps + total play time, let user choose

**Implementation**: See plan 1.x-nakama-server.md Part 5 and plan 1.x-auth-screen.md migration UI section.

---

## Save Frequency Guidelines

**Current Strategy**: Save frequently for now
- Every 2 minutes (periodic)
- After purchases
- After stat level-ups
- Before scene changes
- On game exit

**Future Optimization**: If server load becomes too high, can:
- Increase periodic save interval (e.g., 5 minutes instead of 2)
- Remove some less critical triggers
- Add save batching/throttling

**Fire-and-Forget vs Await**:
- **Fire-and-forget** (most triggers): Don't await, let save happen in background
- **Await** (scene change, game exit): Wait for save to complete before proceeding

---

## Implementation Checklist

### Phase 1: Shop Purchases
- [ ] Add save trigger after shop upgrade purchases
- [ ] Add save trigger after copper era day phase upgrades (when mechanic exists)
- [ ] Test saves after purchase

### Phase 2: Stat Level-Ups
- [ ] Add save trigger in `Global.add_stat_exp()` when level increases
- [ ] Test saves after leveling up

### Phase 3: Scene Changes
- [ ] Add save trigger in `Global.change_scene_with_check()`
- [ ] Use `await` to ensure save completes before scene change
- [ ] Test saves before scene transitions

### Phase 4: Periodic Auto-Save
- [ ] Create autosave timer in Global.gd (or SaveManager)
- [ ] Set to 2 minute interval
- [ ] Test periodic saves during gameplay

### Phase 5: Game Exit
- [ ] Add save trigger in `Global._notification()` on WM_CLOSE_REQUEST
- [ ] Use `await` to ensure save completes before quit
- [ ] Test saves on game exit

---

## Integration Notes

### With Plan 1.x-nakama-server.md (Nakama Server)
- Plan 1.x-nakama-server.md provides `NakamaClient.save_game()` implementation
- This plan determines WHERE and WHEN to call that function
- All save triggers check `NakamaClient.is_authenticated` before saving

### With Plan 1.x-auth-screen.md (Auth Screen)
- Auth screen handles migration UI
- Migration happens automatically when switching from device ID to username/Google
- See plan 1.x-auth-screen.md for conflict resolution dialog implementation


---

## Files Modified

- `global.gd` - Add auto-save timer, save trigger in `change_scene_with_check()`, save trigger in `add_stat_exp()`
- `shop.gd` (or equivalent) - Add save trigger after purchases
- `level1_vars.gd` - Add save trigger in copper era day phase upgrades (when mechanic exists)

**No new files created** - this plan only adds function calls to existing files.

---

## Success Criteria

- [ ] Game saves after shop purchases
- [ ] Game saves after copper era day phase upgrades (when mechanic exists)
- [ ] Game saves after stat level-ups
- [ ] Game saves before scene changes
- [ ] Game auto-saves every 2 minutes
- [ ] Game saves on exit
- [ ] No gameplay blocking while saves happen (fire-and-forget)
- [ ] Scene changes and exit await saves before proceeding
- [ ] All save triggers check authentication before saving

---

## Notes

### Fire-and-Forget Philosophy
Most saves don't block gameplay:
- Shop purchases save in background
- Stat level-ups save in background
- Periodic auto-save runs in background

Only await saves when critical:
- Before scene change (ensure progress saved)
- Before game exit (ensure progress saved)

### Copper Era Mechanic
The "upgrade purchases during day phase in furnace (copper era)" mechanic doesn't have a plan yet. When implemented:
1. Find where upgrades are purchased
2. Add save trigger after purchase (same pattern as shop purchases)
3. Test that saves work correctly

### Save Frequency
Starting with frequent saves (every 2 minutes + all triggers) to prevent data loss. Can optimize later if:
- Server costs too high
- Too much network traffic
- Performance issues

Trade-off: More frequent saves = less data loss, but higher server load.

---
