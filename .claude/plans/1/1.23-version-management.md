# Version Management

**Goal**: Implement a version management system for tracking game versions, auto-migrating save files, and displaying changelogs to players.

**Success Criteria**:
- Version displays in debug/feedback panel
- Changelog panel accessible from settings
- Save files automatically migrate from old versions to current
- Patch version (Z) auto-increments on deployment
- Changelog auto-shows on first run after update

**Prerequisites**:
- Phase 1.x-settings-panel: Settings Panel
- Phase 1.x-save-system-cloud: Save System (Cloud)
- Phase 1.x-logging-debug-system: Logging/Debug System

---

## Overview

GoA is a web-based game where players always run the latest version. This version management system provides save file migration when the game structure changes, player-visible changelogs to show what's new, and version tracking for debug/feedback purposes.

The system uses semantic versioning (X.Y.Z format) where the patch number (Z) auto-increments on each deployment to main, while the minor version (Y) is manually bumped for significant feature additions. Version 0.0.0 represents the current prototype, 0.1.0 will be the first versioned release, and 1.0.0 will mark the official public launch.

### Key Design Principles

- **Single Source of Truth**: All version info comes from VersionManager autoload
- **Automatic Migration**: Save files auto-upgrade when game structure changes (no user intervention)
- **Web-First**: No support for "old versions" - players always run latest
- **Developer-Friendly**: Simple workflow for version bumps and changelog updates
- **Transparent**: Players can see what changed via changelog panel

---

## Implementation Tasks

### 1. Version Manager Autoload

Creates a centralized system for version tracking that all other systems reference.

**Variables needed**:
```gdscript
# In version_manager.gd
const VERSION_MAJOR: int = 0  # Major gameplay overhauls, breaking changes
const VERSION_MINOR: int = 1  # New features, significant additions
const VERSION_PATCH: int = 0  # Bug fixes, small tweaks (auto-increments)
```

**Implementation details:**
- Create autoload script with version constants
- Add `get_version_string()` function returning "X.Y.Z" format
- Add `get_version_number()` function returning comparable integer (e.g., 0.1.0 = 1000)
- Add `parse_version_string(version: String) -> int` utility for comparing versions
- Register in project.godot autoloads

### 2. Save Migration System

Automatically upgrades save files from older versions to current version.

**Implementation details:**
- Update `local_save_manager.gd` to use VersionManager version instead of hard-coded "1.0"
- Update `nakama_client.gd` with identical changes
- Add `migrate_save(save_data: Dictionary) -> Dictionary` function to both managers
- Add version comparison logic to detect old saves
- Create migration functions for each version (e.g., `migrate_to_0_1_0()`)
- Apply migrations sequentially (0.0.0 -> 0.1.0 -> 0.2.0 -> current)
- Update save version stamp after migration
- Log migration actions for debugging

**Migration function pattern:**
```gdscript
func migrate_to_0_1_0(data: Dictionary) -> Dictionary:
    # Add new fields introduced in 0.1.0
    if not data.has("last_seen_version"):
        data["last_seen_version"] = "0.0.0"

    # Ensure global stats exist
    if not data.has("global"):
        data["global"] = {}

    return data
```

### 3. Changelog Data System

Stores all version changelogs in a centralized, easy-to-update format.

**Implementation details:**
- Create `changelog_data.gd` as static class (no instantiation needed)
- Store changelogs as Dictionary with version keys
- Use BBCode formatting for rich text (bold, colors, bullet points)
- Add `get_current_changelog() -> String` function
- Add `get_changelog_for_version(version: String) -> String` function
- Add `get_all_versions() -> Array` for version history view (future enhancement)
- Add version comparison utility for sorting

**Changelog format:**
```gdscript
const CHANGELOGS = {
    "0.1.0": """[b]Version 0.1.0 - Initial Systems[/b]

[b]New Features:[/b]
- Version management system
- Changelog panel with auto-display
- Save file migration
- Debug panel version display

[b]Fixes:[/b]
- Improved save/load reliability

[b]Technical:[/b]
- Centralized version tracking via VersionManager autoload
""",

    "0.0.0": """[b]Version 0.0.0 - Prototype[/b]
- Initial game prototype with core systems
"""
}
```

### 4. Changelog Panel UI

Displays "What's New" information to players after updates.

**Scene structure** (changelog_panel.tscn):
```
PanelContainer (changelog_panel)
├─ MarginContainer (margin: 20px all sides)
   ├─ VBoxContainer (spacing: 10)
      ├─ HBoxContainer (header)
      │  ├─ Label (text: "What's New - v0.1.0", theme: heading)
      │  ├─ Control (size_flags: expand/fill - spacer)
      │  └─ Button (text: "X", connects to: _on_close_pressed)
      ├─ HSeparator
      ├─ ScrollContainer (size_flags: expand/fill, min_size: 600x400)
         └─ RichTextLabel (bbcode_enabled: true, fit_content: true)
```

**Implementation details** (changelog_panel.gd):
- Load changelog content from ChangelogData on _ready()
- Check if this is first run after update (compare last_seen_version)
- Auto-show panel if version changed since last run
- Update last_seen_version in Global after showing
- Close button hides panel
- ESC key also closes panel

### 5. Settings Panel Integration

Adds "View Changelog" button to existing settings overlay.

**Implementation details:**
- Open settings_overlay.tscn in editor
- Add new Button to VBoxContainer (after existing buttons)
- Set button text: "View Changelog"
- Connect pressed signal to new function in settings_overlay.gd
- Function instantiates and adds changelog_panel scene to tree
- Position panel centered on screen

**Code addition to settings_overlay.gd:**
```gdscript
func _on_changelog_button_pressed():
    var changelog_panel = preload("res://changelog_panel.tscn").instantiate()
    get_tree().root.add_child(changelog_panel)
    changelog_panel.popup_centered()
```

### 6. Debug Panel Version Display

Shows current version in debug/feedback panel for bug reports.

**Implementation details:**
- Locate existing debug/feedback panel scene
- Add Label node (positioned at bottom or top of panel)
- Set text in _ready(): `"Version: %s" % VersionManager.get_version_string()`
- Style: smaller font, subtle color (gray/dimmed)

### 7. Global.gd Version Tracking

Tracks the last version the player saw for changelog auto-display logic.

**Variables needed:**
```gdscript
# In global.gd
var last_seen_version: String = "0.0.0"  # Last version player saw changelog for
```

**Implementation details:**
- Add last_seen_version variable
- Add to save data structure in both save managers
- Load during game initialization
- Update when changelog panel is shown
- Getter/setter functions for access from changelog panel

---

## Code Examples

### Version Manager Core

```gdscript
# version_manager.gd
extends Node

const VERSION_MAJOR: int = 0
const VERSION_MINOR: int = 1
const VERSION_PATCH: int = 0

func get_version_string() -> String:
    return "%d.%d.%d" % [VERSION_MAJOR, VERSION_MINOR, VERSION_PATCH]

func get_version_number() -> int:
    # Convert to comparable number: 0.1.0 = 1000, 0.1.5 = 1005, 1.2.3 = 1002003
    return VERSION_MAJOR * 1000000 + VERSION_MINOR * 1000 + VERSION_PATCH

func parse_version_string(version: String) -> int:
    var parts = version.split(".")
    if parts.size() != 3:
        push_warning("Invalid version format: %s" % version)
        return 0

    var major = int(parts[0])
    var minor = int(parts[1])
    var patch = int(parts[2])
    return major * 1000000 + minor * 1000 + patch

func compare_versions(v1: String, v2: String) -> int:
    # Returns: -1 if v1 < v2, 0 if equal, 1 if v1 > v2
    var n1 = parse_version_string(v1)
    var n2 = parse_version_string(v2)
    if n1 < n2: return -1
    if n1 > n2: return 1
    return 0
```

**Explanation:** Centralized version tracking that all systems reference. Version number conversion allows for simple integer comparison (0.1.0 vs 0.2.0).

### Save Migration Logic

```gdscript
# In local_save_manager.gd and nakama_client.gd
func migrate_save(save_data: Dictionary) -> Dictionary:
    var save_version = save_data.get("version", "0.0.0")
    var save_ver_num = VersionManager.parse_version_string(save_version)
    var current_ver_num = VersionManager.get_version_number()

    if save_ver_num < current_ver_num:
        print("[SaveMigration] Migrating save from %s to %s" % [save_version, VersionManager.get_version_string()])

        # Apply migrations sequentially
        if save_ver_num < 1000:  # < 0.1.0
            save_data = migrate_to_0_1_0(save_data)
            save_ver_num = 1000

        if save_ver_num < 2000:  # < 0.2.0 (future)
            save_data = migrate_to_0_2_0(save_data)
            save_ver_num = 2000

        # Add more migrations here as versions increase

        # Update version stamp
        save_data["version"] = VersionManager.get_version_string()
        print("[SaveMigration] Migration complete")

    return save_data

func migrate_to_0_1_0(data: Dictionary) -> Dictionary:
    print("[SaveMigration] Applying 0.1.0 migration")

    # Add last_seen_version if missing
    if not data.has("last_seen_version"):
        data["last_seen_version"] = "0.0.0"

    # Ensure global section exists
    if not data.has("global"):
        data["global"] = {}

    # Add any new fields introduced in 0.1.0
    if not data["global"].has("some_new_stat"):
        data["global"]["some_new_stat"] = 0

    return data
```

**Explanation:** Detects old save version, applies all necessary migrations in sequence, then updates version stamp. Each migration function is self-contained and handles one version's changes.

### Changelog Panel Logic

```gdscript
# changelog_panel.gd
extends PanelContainer

@onready var version_label = $MarginContainer/VBoxContainer/HBoxContainer/Label
@onready var changelog_text = $MarginContainer/VBoxContainer/ScrollContainer/RichTextLabel

func _ready():
    # Update version in title
    version_label.text = "What's New - v%s" % VersionManager.get_version_string()

    # Load changelog content
    var changelog = ChangelogData.get_current_changelog()
    changelog_text.bbcode_text = changelog

    # Check if this is first run after update
    check_and_mark_version_seen()

func check_and_mark_version_seen():
    var last_seen = Global.get_last_seen_version()
    var current = VersionManager.get_version_string()

    if last_seen != current:
        # First run after update - auto-show
        show()
        Global.set_last_seen_version(current)
    else:
        # Not first run - hide by default (opened manually)
        hide()

func _on_close_pressed():
    queue_free()

func _input(event):
    if event.is_action_pressed("ui_cancel"):  # ESC key
        _on_close_pressed()
```

**Explanation:** Auto-shows on first run after update, then hides until manually opened. Uses BBCode for rich formatting in changelog text.

---

## Testing Strategy

### Unit Tests (Headless)

Create `tests/test_version_management.gd`:

```gdscript
extends GutTest

func before_each():
    # Reset version state
    pass

# Test: Version string formatting
func test_version_string_format():
    var version = VersionManager.get_version_string()
    assert_true(version.match("*.*.*"), "Version should be in X.Y.Z format")

# Test: Version number conversion
func test_version_number_conversion():
    assert_eq(VersionManager.parse_version_string("0.0.0"), 0)
    assert_eq(VersionManager.parse_version_string("0.1.0"), 1000)
    assert_eq(VersionManager.parse_version_string("1.0.0"), 1000000)
    assert_eq(VersionManager.parse_version_string("1.2.3"), 1002003)

# Test: Version comparison
func test_version_comparison():
    assert_lt(VersionManager.parse_version_string("0.0.1"), VersionManager.parse_version_string("0.1.0"))
    assert_gt(VersionManager.parse_version_string("0.2.0"), VersionManager.parse_version_string("0.1.5"))
    assert_eq(VersionManager.parse_version_string("1.0.0"), VersionManager.parse_version_string("1.0.0"))

# Test: Save migration detection
func test_save_migration_detection():
    var old_save = {"version": "0.0.0", "global": {}}
    var migrated = LocalSaveManager.migrate_save(old_save)
    assert_eq(migrated["version"], VersionManager.get_version_string())

# Test: Migration adds missing fields
func test_migration_adds_fields():
    var old_save = {"version": "0.0.0"}
    var migrated = LocalSaveManager.migrate_save(old_save)
    assert_has(migrated, "last_seen_version")
```

**Test Cases:**
- [ ] Version string format is correct (X.Y.Z)
- [ ] Version number conversion works for all formats
- [ ] Version comparison logic (older vs newer)
- [ ] Save migration detects old versions
- [ ] Migration functions add missing fields
- [ ] Migration updates version stamp
- [ ] No migration occurs for current version saves

**Run tests:**
```bash
godot --headless --script res://tests/test_runner.gd
```

### Integration Tests

**Test Scenarios:**

| Scenario | Setup | Action | Expected Result |
|----------|-------|--------|-----------------|
| First launch (new player) | No save file exists | Start game | Creates save with current version |
| Load old save locally | Save with version 0.0.0 | Load game | Migrates to current version |
| Load old save from cloud | Cloud save version 0.0.0 | Sync from cloud | Migrates to current version |
| Changelog first view | last_seen_version != current | Game starts | Changelog auto-shows |
| Changelog subsequent view | last_seen_version == current | Game starts | Changelog doesn't show |
| Manual changelog open | Any state | Click "View Changelog" button | Changelog opens |
| Version display | Any state | Open debug panel | Shows current version |

### Manual Test Criteria

- [ ] Version displays correctly in debug/feedback panel
- [ ] "View Changelog" button appears in settings panel
- [ ] Changelog panel opens when button clicked
- [ ] Changelog shows correct version number in title
- [ ] Changelog content displays with proper formatting (bold, lists)
- [ ] Changelog auto-shows on first run after version change
- [ ] Changelog doesn't auto-show on subsequent runs
- [ ] ESC key closes changelog panel
- [ ] Close button closes changelog panel
- [ ] Old save (0.0.0) loads and migrates without errors
- [ ] New save creates with current version stamp
- [ ] UI layout looks correct at 1438x817

---

## Files to Create

- `version_manager.gd` - Centralized version constants and utilities
- `changelog_data.gd` - Changelog content storage (static class)
- `changelog_panel.tscn` - UI scene for changelog display
- `changelog_panel.gd` - Logic for changelog panel behavior
- `tests/test_version_management.gd` - Unit tests for version system

## Files to Modify

- `global.gd` - Add last_seen_version tracking variable and getter/setter functions
- `local_save_manager.gd` - Replace hard-coded version, add migration system, update save/load functions
- `nakama_client.gd` - Replace hard-coded version, add identical migration system as local manager
- `settings_overlay.tscn` - Add "View Changelog" button to button list
- `settings_overlay.gd` - Add button handler function to instantiate changelog panel
- `project.godot` - Register VersionManager autoload
- Debug/feedback panel files - Add version label display

---

## Design Values (Reference)

### Version Numbering

- **Current version**: 0.0.0 (pre-versioning prototype)
- **Next version**: 0.1.0 (first versioned release with this system)
- **Official release**: 1.0.0 (public launch milestone)

### Version Increment Rules

- **Patch (Z)**: Auto-increments on every deployment to main branch (0.1.0 -> 0.1.1)
- **Minor (Y)**: Manual increment for significant feature additions (0.1.5 -> 0.2.0)
- **Major (X)**: Manual increment for major overhauls or breaking changes (0.9.0 -> 1.0.0)

### Migration Strategy

- **Version comparison**: Integer conversion (0.1.0 = 1000, 1.2.3 = 1002003)
- **Sequential migrations**: Always apply in order (0.0.0 -> 0.1.0 -> 0.2.0 -> current)
- **Default version**: "0.0.0" if version field missing in save

---

## UI Mockups

### Changelog Panel

```
+-----------------------------------------------------+
| What's New - v0.1.0                            [X] |
+-----------------------------------------------------+
| Version 0.1.0 - Initial Systems                    |
|                                                     |
| New Features:                                       |
| - Version management system                         |
| - Changelog panel with auto-display                 |
| - Save file migration                               |
| - Debug panel version display                       |
|                                                     |
| Fixes:                                              |
| - Improved save/load reliability                    |
|                                                     |
| Technical:                                          |
| - Centralized version tracking via VersionManager   |
+-----------------------------------------------------+
```

### Settings Panel (Updated)

```
+-----------------------------------------------------+
| Settings                                       [X] |
+-----------------------------------------------------+
| [Existing settings buttons...]                      |
|                                                     |
| [ View Changelog ]  <-- NEW                         |
|                                                     |
| [ Reset Save ]                                      |
| [ Close ]                                           |
+-----------------------------------------------------+
```

---

## Dependencies & Integration

**Depends On:**
- Phase 1.x-settings-panel: Settings Panel - Need button location for changelog access
- Phase 1.x-save-system-cloud: Save System (Cloud) - Both local and cloud saves need migration
- Phase 1.x-logging-debug-system: Logging/Debug System - Version display in debug panel

**Used By:**
- Phase 1.x-deployment-pipeline: Deployment Pipeline - Auto-increment patch version on deploy
- All future phases - Every feature update will add migration code and changelog entry

**Conflicts:**
- None known

---

## Balance Tuning Notes

Not applicable for this technical system.

---

## Notes & Decisions

**Decision 1: Use Semantic Versioning (X.Y.Z)**
- **Rationale**: Industry standard, clear meaning for each number, easy to parse and compare
- **Alternatives considered**:
  - Date-based (YYYY.MM.DD) - Rejected: Less meaningful for features
  - Single incrementing number - Rejected: No significance levels
  - Leading zeros (00.01.00) - Rejected: Non-standard, harder to compare

**Decision 2: Auto-increment Patch on Deploy, Manual Minor/Major**
- **Rationale**: Every deploy gets tracked, but developer controls "significance" via Y/X bumps
- **Alternatives considered**:
  - Fully manual - Rejected: Easy to forget, inconsistent
  - Fully auto - Rejected: No control over feature significance
  - Git commit count - Rejected: Arbitrary, not meaningful

**Decision 3: Web-Based, Always Latest Version**
- **Rationale**: Simplifies everything - no backward compatibility beyond save migration
- **Alternatives considered**:
  - Support multiple versions - Rejected: Complex, unnecessary for web game
  - Allow players to rollback - Rejected: Not feasible for web deployment

**Decision 4: Changelog Auto-Shows Once Per Version**
- **Rationale**: Inform players of changes without being annoying
- **Alternatives considered**:
  - Never auto-show - Rejected: Players miss updates
  - Always show on launch - Rejected: Annoying for frequent players
  - Show on major/minor only - Rejected: Patch notes still useful

**Decision 5: Version Only in Debug Panel and Changelog**
- **Rationale**: Not cluttering main UI, but accessible when needed for bug reports
- **Alternatives considered**:
  - Main menu corner - Rejected: Visual clutter
  - Always visible - Rejected: Unnecessary for players
  - Hidden entirely - Rejected: Hard to reference in bug reports

**Open Questions:**
- [ ] Should we add a "Version History" view showing all past changelogs?
- [ ] Should migration failures show error to player or just log?
- [ ] Should we track version analytics (how many players on each version)?

---

## Implementation Checklist

- [ ] VersionManager autoload created with constants and utilities
- [ ] ChangelogData class created with initial changelogs
- [ ] Changelog panel scene and script created
- [ ] Settings panel updated with "View Changelog" button
- [ ] Debug panel updated with version display
- [ ] Global.gd updated with last_seen_version tracking
- [ ] LocalSaveManager updated with migration system
- [ ] NakamaClient updated with migration system
- [ ] Migration function for 0.0.0 -> 0.1.0 implemented
- [ ] All unit tests passing
- [ ] All integration tests passing
- [ ] Manual tests completed
- [ ] UI tested at target resolution (1438x817)
- [ ] Save migration tested with old save file
- [ ] Changelog auto-display tested
- [ ] Documentation updated
