# Level 1 Variables Autoload

**Goal**: Create a level-specific autoload script for managing state and variables unique to Level 1 gameplay

**Success Criteria**: level_1_vars.gd exists as an autoload, contains stamina and focus resources, and is accessible from any scene

## Overview

The Level 1 Variables Autoload (level_1_vars.gd) provides centralized management of gameplay resources and state specific to Level 1 (copper/silver/gold eras). This separates level-specific concerns from the global game state, making the architecture more modular and allowing for distinct mechanics per level.

This autoload manages resources like stamina and focus that are consumed during gameplay actions (shoveling coal, making decisions, etc.) and regenerate during breaks or rest periods.

### Key Design Principles

- Level-specific state should live in level_1_vars, not Global.gd
- Resources use integer values for simplicity (no decimals)
- All resource changes should emit signals for UI updates
- Resources should be included in save/load system
- Default values should support immediate gameplay without grinding

---

## Implementation Tasks

### 1. Autoload Script Creation

Create the level_1_vars.gd script as an autoload that manages Level 1-specific gameplay resources.

**Variables needed**:
```gdscript
# In level_1_vars.gd
var stamina: int = 50          # Current stamina (consumed by physical actions)
var stamina_max: int = 100      # Maximum stamina capacity
var focus: int = 50            # Current focus (consumed by mental actions)
var focus_max: int = 100        # Maximum focus capacity
```

**Implementation details:**
- Create res://level1/level_1_vars.gd
- Add to project autoloads in project.godot as "Level1Vars"
- Include @tool annotation if needed for editor access
- Initialize all variables with default starting values

### 2. Resource Management Functions

Implement functions to modify stamina and focus with validation and feedback.

```gdscript
func modify_stamina(amount: int) -> bool:
    # Adds or removes stamina (negative for consumption)
    # Returns false if insufficient stamina
    pass

func modify_focus(amount: int) -> bool:
    # Adds or removes focus (negative for consumption)
    # Returns false if insufficient focus
    pass

func restore_all_resources():
    # Restores stamina and focus to maximum
    # Useful for break periods or rest events
    pass
```

**Implementation details:**
- Validate stamina/focus don't go below 0 or above max
- Return bool to indicate success/failure of resource consumption
- Emit signals when resources change
- Consider adding optional parameter for whether to show notifications

### 3. Signal System

Define signals for UI and system updates when resources change.

```gdscript
signal stamina_changed(new_value: int, max_value: int)
signal focus_changed(new_value: int, max_value: int)
signal resource_depleted(resource_name: String)
```

**Implementation details:**
- Emit stamina_changed whenever stamina is modified
- Emit focus_changed whenever focus is modified
- Emit resource_depleted when a resource reaches 0
- UI elements can connect to these signals for live updates

### 4. Save/Load Integration

Integrate level_1_vars state into the game's save/load system.

```gdscript
func get_save_data() -> Dictionary:
    # Returns dictionary of all level_1_vars state
    return {
        "stamina": stamina,
        "stamina_max": stamina_max,
        "focus": focus,
        "focus_max": focus_max
    }

func load_save_data(data: Dictionary):
    # Restores level_1_vars state from save data
    stamina = data.get("stamina", 50)
    stamina_max = data.get("stamina_max", 50)
    focus = data.get("focus", 50)
    focus_max = data.get("focus_max", 50)
    # Emit signals to update UI
    emit_signal("stamina_changed", stamina, stamina_max)
    emit_signal("focus_changed", focus, focus_max)
```

**Implementation details:**
- Create save/load helper functions
- Integrate with Global.gd save system (see 1.x-nakama-server.md)
- Use .get() with defaults for backward compatibility
- Emit signals after loading to update UI

### 5. Reset Function

Provide a way to reset level_1_vars to initial state (for new game or prestige).

```gdscript
func reset_to_defaults():
    # Resets all level_1_vars to initial values
    stamina = 50
    stamina_max = 50
    focus = 50
    focus_max = 50
    # Emit signals
    emit_signal("stamina_changed", stamina, stamina_max)
    emit_signal("focus_changed", focus, focus_max)
```

**Implementation details:**
- Called when starting new game
- May be called during prestige (depending on 1.x-prestige-system.md design)
- Emit all relevant signals after reset

---

## Code Examples

### Basic Resource Consumption

```gdscript
# In level_1_vars.gd
func modify_stamina(amount: int) -> bool:
    var new_value = stamina + amount

    # Check if we have enough for consumption (negative amount)
    if amount < 0 and new_value < 0:
        emit_signal("resource_depleted", "stamina")
        return false

    # Clamp to valid range
    stamina = clampi(new_value, 0, stamina_max)
    emit_signal("stamina_changed", stamina, stamina_max)
    return true
```

**Explanation:** Safely modifies stamina, validates bounds, emits signals, and returns success status

### Using Resources from Gameplay Code

```gdscript
# In shop.gd or other gameplay scene
func shovel_coal():
    if not Level1Vars.modify_stamina(-5):
        print("Not enough stamina to shovel!")
        return

    # Continue with shoveling logic
    coal_count += 1
    Global.add_stat_exp("STR", 1)
```

**Explanation:** Gameplay code checks if resource consumption succeeds before executing action

---

## Testing Strategy

### Unit Tests (Headless)

Create `tests/test_level_1_vars.gd`:

```gdscript
# Test: Resource modification with valid amounts
func test_modify_stamina_valid():
    Level1Vars.reset_to_defaults()
    var result = Level1Vars.modify_stamina(-10)
    assert_eq(result, true)
    assert_eq(Level1Vars.stamina, 40)

# Test: Resource consumption when insufficient
func test_modify_stamina_insufficient():
    Level1Vars.reset_to_defaults()
    var result = Level1Vars.modify_stamina(-60)
    assert_eq(result, false)
    assert_eq(Level1Vars.stamina, 50)  # Should not change

# Test: Resource clamping at maximum
func test_modify_focus_clamp_max():
    Level1Vars.reset_to_defaults()
    Level1Vars.modify_focus(100)
    assert_eq(Level1Vars.focus, 50)  # Should clamp to max

# Test: Restore all resources
func test_restore_all_resources():
    Level1Vars.reset_to_defaults()
    Level1Vars.modify_stamina(-30)
    Level1Vars.modify_focus(-20)
    Level1Vars.restore_all_resources()
    assert_eq(Level1Vars.stamina, 50)
    assert_eq(Level1Vars.focus, 50)

# Test: Save/load data persistence
func test_save_load_data():
    Level1Vars.reset_to_defaults()
    Level1Vars.modify_stamina(-15)
    Level1Vars.modify_focus(-25)

    var save_data = Level1Vars.get_save_data()
    Level1Vars.reset_to_defaults()
    Level1Vars.load_save_data(save_data)

    assert_eq(Level1Vars.stamina, 35)
    assert_eq(Level1Vars.focus, 25)
```

**Test Cases:**
- [x] Stamina modification with valid amounts
- [x] Focus modification with valid amounts
- [x] Resource consumption fails when insufficient
- [x] Resources clamp to 0 minimum
- [x] Resources clamp to max maximum
- [x] restore_all_resources() works correctly
- [x] Signals emit on resource changes
- [x] Save data includes all variables
- [x] Load data restores state correctly
- [x] Load with missing keys uses defaults

**Run tests:**
```bash
godot --headless --script res://tests/test_runner.gd
```

### Integration Tests

**Test Scenarios:**

| Scenario | Setup | Action | Expected Result |
|----------|-------|--------|-----------------|
| Autoload accessible | Launch game | Access Level1Vars from any scene | Variables exist and are readable |
| Signal connection | Connect UI to signals | Modify stamina | UI updates with new value |
| Cross-scene persistence | Set stamina to 30, change scene | Load new scene, check stamina | Stamina still 30 |
| Save/load integration | Modify resources, save, close game | Load save file | Resources restored correctly |

### Manual Test Criteria

- [ ] Level1Vars is accessible from any scene via Level1Vars.stamina
- [ ] Modifying stamina in one scene persists to another scene
- [ ] UI elements update when resources change
- [ ] Save/load preserves all level_1_vars state
- [ ] Reset function returns all values to defaults

---

## Files to Create

- `res://level1/level_1_vars.gd` - Level 1 autoload script with stamina/focus management
- `tests/test_level_1_vars.gd` - Unit test suite for level_1_vars

## Files to Modify

- `project.godot` - Add Level1Vars autoload entry
- `global.gd` - Integrate level_1_vars into save/load system (call get_save_data/load_save_data)

---

## Design Values (Reference)

### Resource Starting Values

- **Starting stamina**: 50 - Enough for ~10 basic shoveling actions (assuming 5 stamina per shovel)
- **Max stamina**: 50 - Can be increased through upgrades in later plans
- **Starting focus**: 50 - Enough for decision-making and mental tasks
- **Max focus**: 50 - Can be increased through upgrades in later plans

### Resource Consumption (Placeholder - defined in later plans)

- **Stamina per shovel**: 5 (base, before stats/equipment) - See 1.x-manual-coal-shoveling.md
- **Focus per decision**: TBD - See 1.x-break-activities.md
- **Stamina regeneration**: During breaks - See 1.x-break-timer-system.md

---

## Balance Tuning Notes

**Tuneable Parameters:**
- `stamina` starting value in level_1_vars.gd - Initial player resource pool
- `stamina_max` starting value in level_1_vars.gd - Resource capacity
- `focus` starting value in level_1_vars.gd - Initial mental resource pool
- `focus_max` starting value in level_1_vars.gd - Mental resource capacity

**Expected Player Experience:**
- Resources should feel abundant at first (50 is comfortable starting point)
- Players should experience resource scarcity during intensive work periods
- Break periods provide clear relief through resource restoration
- Upgrades that increase max stamina/focus should feel meaningful

**Warning Signs:**
- If players constantly run out of stamina too early, increase starting stamina or reduce consumption rates
- If resources never feel scarce, decrease starting values or increase consumption
- If break periods feel unnecessary, reduce regeneration or increase consumption

---

## Notes & Decisions

**Decision 1:** Use separate stamina and focus resources
- **Rationale**: Provides mechanical depth - physical actions (shoveling) vs mental actions (decisions, focus tasks) use different resources, creating interesting strategic choices
- **Alternatives considered**: Single "energy" resource was simpler but less interesting mechanically

**Decision 2:** Start both resources at 50
- **Rationale**: Round number that's easy to understand, provides enough buffer for initial gameplay without feeling overly generous
- **Alternatives considered**: 100 felt too large for early game numbers, 25 felt too restrictive

**Decision 3:** Use integer values, not floats
- **Rationale**: Simpler to display in UI, easier to reason about, avoids floating-point precision issues
- **Alternatives considered**: Floats would allow more granular tuning but add complexity

**Decision 4:** Place in level1/ folder structure
- **Rationale**: Clearly indicates this is Level 1-specific, sets pattern for level2/level3 autoloads in future
- **Alternatives considered**: Root-level placement was considered but loses organizational clarity

**Open Questions:**
- [ ] Should stamina/focus regenerate slowly over time during work, or only during breaks?
- [ ] Should max values be upgradeable in copper era, or wait until silver/gold?
- [ ] Do we need separate signals for stamina_depleted vs generic resource_depleted?
- [ ] Should resource modifications show notifications, or only via UI updates?

---

## Implementation Checklist

- [ ] level_1_vars.gd script created in res://level1/
- [ ] Stamina variables implemented (stamina, stamina_max)
- [ ] Focus variables implemented (focus, focus_max)
- [ ] Autoload registered in project.godot as "Level1Vars"
- [ ] modify_stamina() function implemented with validation
- [ ] modify_focus() function implemented with validation
- [ ] restore_all_resources() function implemented
- [ ] Signals defined (stamina_changed, focus_changed, resource_depleted)
- [ ] Signals emit correctly on all resource changes
- [ ] get_save_data() function implemented
- [ ] load_save_data() function implemented
- [ ] reset_to_defaults() function implemented
- [ ] Save/load integration with Global.gd
- [ ] All unit tests created
- [ ] All unit tests passing
- [ ] Integration tests completed
- [ ] Manual tests completed
- [ ] Accessible from any scene via Level1Vars
- [ ] Code reviewed
- [ ] Documentation updated
