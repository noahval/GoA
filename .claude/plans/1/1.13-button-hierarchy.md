# Button Hierarchy System

**Goal**: Implement automatic button ordering system that sorts buttons by type (Action, Forward Nav, Back Nav) for consistent UX across all scenes

**Success Criteria**:
- ButtonHierarchy autoload created with button type detection
- Automatic sorting integrated into ResponsiveLayout.apply_to_scene()
- Action buttons appear at top, Forward Nav in middle, Back Nav at bottom
- Theme variations applied automatically (ForwardNavButton, BackNavButton)
- Works across all scenes without per-scene code

**Prerequisites**:
- Phase 1.11 (Responsive Layout Guide) - ResponsiveLayout autoload exists
- Phase 1.10 (Default Theme) - Theme variations for nav buttons exist

---

## Overview

Creates a centralized button ordering system that automatically sorts menu buttons based on their type. Ensures consistent, predictable button placement across all game scenes. Action buttons (gameplay) appear first, Forward Navigation (explore/advance) in middle, Back Navigation (return) at bottom.

### Key Design Principles

- **Automatic enforcement**: ResponsiveLayout sorts buttons at runtime
- **Type-based ordering**: Buttons categorized by purpose (Action, Forward Nav, Back Nav)
- **Theme integration**: Nav buttons get visual distinction via theme variations
- **Zero per-scene code**: Works automatically for all scenes calling apply_to_scene()
- **Centralized config**: Change hierarchy in one place, all scenes update

---

## Implementation Tasks

### 1. Create ButtonHierarchy Autoload

**File**: `res://button_hierarchy.gd`

**Enum definition**:
```gdscript
extends Node

enum ButtonType {
    ACTION,      # Gameplay actions (shovel, buy, bribe)
    FORWARD_NAV, # Navigate deeper (To Shop, Enter Passage)
    BACK_NAV,    # Return to previous (To Bar, Back)
    SETTINGS,    # Settings button (always at bottom)
}

# Lower number = higher priority = appears higher in menu
# 10-unit increments allow adding new types between existing ones
const BUTTON_ORDER = {
    ButtonType.ACTION: 3,
    ButtonType.FORWARD_NAV: 6,
    ButtonType.BACK_NAV: 8,
    ButtonType.SETTINGS: 15,  # Way at bottom, lots of room for new types
}
```

**Button type detection**:
```gdscript
func get_button_type(button: Button) -> ButtonType:
    """
    Detect button type based on theme variation and text patterns
    """
    var theme_var = button.theme_type_variation
    var text = button.text.to_lower()

    # Check theme variation first (most reliable)
    if theme_var == &"ForwardNavButton":
        return ButtonType.FORWARD_NAV
    elif theme_var == &"BackNavButton":
        return ButtonType.BACK_NAV

    # Check text patterns for navigation
    if text.begins_with("to ") or text.begins_with("enter ") or text.begins_with("approach "):
        return ButtonType.FORWARD_NAV
    elif text.begins_with("back to ") or text.contains("return"):
        return ButtonType.BACK_NAV

    # Check for settings button
    if text == "settings" or button.name.to_lower().contains("settings"):
        return ButtonType.SETTINGS

    # Default: action button
    return ButtonType.ACTION

func get_sort_priority(button: Button) -> int:
    """
    Returns sort priority for button (lower = higher priority)
    """
    var type = get_button_type(button)
    return BUTTON_ORDER.get(type, 999)
```

**Sorting function**:
```gdscript
func sort_buttons_in_container(container: Node) -> void:
    """
    Sort all button children of container by hierarchy
    Called by ResponsiveLayout.apply_to_scene()
    """
    if not container:
        return

    # Get all button children
    var buttons: Array[Button] = []
    for child in container.get_children():
        if child is Button:
            buttons.append(child)

    # Sort by priority
    buttons.sort_custom(func(a, b): return get_sort_priority(a) < get_sort_priority(b))

    # Reorder in scene tree
    for i in range(buttons.size()):
        container.move_child(buttons[i], i)
```

### 2. Integrate with ResponsiveLayout

**Modify**: `res://responsive_layout.gd`

Add button sorting to apply_to_scene():
```gdscript
func apply_to_scene(scene_root: Control) -> void:
    """
    Apply responsive layout to a scene.
    Now includes automatic button hierarchy sorting.
    """
    call_deferred("_apply_layout", scene_root)

func _apply_layout(scene_root: Control) -> void:
    calculate_scale()

    # Existing layout code...
    var main_layout = scene_root.get_node_or_null("MainLayout")
    var menu = scene_root.get_node_or_null("MainLayout/Menu")

    # ... sizing code ...

    # NEW: Sort buttons in menu
    if menu:
        ButtonHierarchy.sort_buttons_in_container(menu)

    # Apply font scaling, mouse filters, etc.
    _apply_font_scaling(scene_root)
    _set_mouse_filters(scene_root)
```

### 3. Register ButtonHierarchy Autoload

**Modify**: `project.godot`

```ini
[autoload]

ButtonHierarchy="*res://button_hierarchy.gd"
ResponsiveLayout="*res://responsive_layout.gd"
```

### 4. Apply Theme Variations to Nav Buttons

Buttons with Forward/Back Nav types should have theme variations applied:

**In button_hierarchy.gd**, add function:
```gdscript
func apply_theme_variations(container: Node) -> void:
    """
    Apply theme variations based on button type
    Called after sorting
    """
    for child in container.get_children():
        if not child is Button:
            continue

        var button = child as Button
        var type = get_button_type(button)

        # Apply theme variation if not already set
        if type == ButtonType.FORWARD_NAV and button.theme_type_variation != &"ForwardNavButton":
            button.theme_type_variation = &"ForwardNavButton"
        elif type == ButtonType.BACK_NAV and button.theme_type_variation != &"BackNavButton":
            button.theme_type_variation = &"BackNavButton"
```

Update sort function to call this:
```gdscript
func sort_buttons_in_container(container: Node) -> void:
    # ... existing sorting code ...

    # Apply theme variations after sorting
    apply_theme_variations(container)
```

---

## Button Type Classification

### Action Buttons
**Purpose**: Primary gameplay actions
**Theme**: Default (orange)
**Examples**:
- "Shovel Coal"
- "Buy Auto Shovel"
- "Bribe Overseer: 5"
- "Assemble Component"
- Developer buttons

**Detection**:
- No specific theme variation
- Action verbs (Shovel, Buy, Bribe, Assemble, Convert, etc.)
- Default case when not nav or settings

### Forward Navigation Buttons
**Purpose**: Navigate to new/deeper scenes
**Theme**: ForwardNavButton (light blue, 2px border)
**Examples**:
- "To Crankshaft's"
- "Enter Secret Passage"
- "Approach Hidden Door"
- "To Workshop"

**Detection**:
- Theme variation: `ForwardNavButton`
- Text starts with: "To ", "Enter ", "Approach "
- Advances game progression

### Back Navigation Buttons
**Purpose**: Return to previous scenes
**Theme**: BackNavButton (dark blue, 1px border)
**Examples**:
- "To Blackbore Bar"
- "To Coppersmith Carriage"
- "Back to Workshop"

**Detection**:
- Theme variation: `BackNavButton`
- Text starts with: "To ", "Back to ", "Return to "
- Returns to parent/previous scene

### Settings Button
**Purpose**: Open settings panel
**Theme**: Default or custom
**Position**: Always last (bottom)
**Detection**:
- Text equals "Settings" or "settings"
- Button name contains "settings"

---

## Testing

**Button Sorting:**
- [ ] Create test scene with mixed button order
- [ ] Buttons automatically reorder: Action → Forward Nav → Back Nav → Settings
- [ ] Order persists across scene changes
- [ ] Sorting works in all scenes inheriting from scene_template

**Theme Application:**
- [ ] Forward Nav buttons get ForwardNavButton theme
- [ ] Back Nav buttons get BackNavButton theme
- [ ] Action buttons keep default theme
- [ ] Settings button appears last

**Pattern Recognition:**
- [ ] "To Shop" detected as Forward Nav
- [ ] "To Bar" detected as Back Nav (context matters)
- [ ] "Buy Shovel" detected as Action
- [ ] "Settings" detected as Settings type

**Edge Cases:**
- [ ] Empty menu (no buttons) doesn't error
- [ ] Single button works correctly
- [ ] Dynamically added buttons get sorted
- [ ] Hidden buttons maintain position when shown

---

## Files to Create

- `res://button_hierarchy.gd` - ButtonHierarchy autoload with sorting logic

## Files to Modify

- `project.godot` - Register ButtonHierarchy autoload
- `responsive_layout.gd` - Call ButtonHierarchy.sort_buttons_in_container() in apply_to_scene()

---

## Design Values

### Button Order Priority

| Type | Priority | Visual Position |
|------|----------|----------------|
| Action | 10 | Top |
| Forward Nav | 20 | Middle-Top |
| Back Nav | 30 | Middle-Bottom |
| Settings | 100 | Bottom |

**Note**: 10-unit spacing allows adding new button types between existing ones (e.g., SHOP = 15, DEVELOPER = 25)

### Text Pattern Matching

**Forward Navigation**:
- Starts with: "To ", "Enter ", "Approach ", "Explore "
- Theme: ForwardNavButton

**Back Navigation**:
- Starts with: "To ", "Back to ", "Return to "
- Theme: BackNavButton
- **Note**: "To X" can be forward OR back depending on context

**Action**:
- Contains: Action verbs (Shovel, Buy, Bribe, Assemble, Convert, Steal, etc.)
- Theme: Default

---

## Notes

**Decision**: Automatic runtime sorting vs manual .tscn ordering
- **Rationale**: Runtime sorting ensures consistency even if .tscn files are wrong
- **Benefit**: Single source of truth, no per-scene maintenance
- **Trade-off**: Minimal runtime overhead (only runs once per scene load)

**Decision**: Settings button always last
- **Rationale**: Universal access, consistent position across all scenes
- **Benefit**: Players always know where to find settings
- **Implementation**: Highest priority number (3) puts it at bottom

**Decision**: Theme variation auto-application
- **Rationale**: Developers shouldn't need to manually set theme variations
- **Benefit**: Nav buttons automatically get correct visual style
- **Safety**: Only applies if not already set (respects manual overrides)

**Decision**: Text pattern matching as fallback
- **Rationale**: Works even if theme variation not set
- **Benefit**: Robust detection, forgiving of incomplete setup
- **Limitation**: "To X" ambiguity (could be forward or back) - relies on theme variation for accuracy

---

**Last Updated**: 2025-12-01
**Maintainer**: Claude + User collaboration
