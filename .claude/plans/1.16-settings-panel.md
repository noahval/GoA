# Phase 1.16: Settings Button & Panel

**Goal**: Create settings button in menu and settings panel in play area with UI scale, audio volume, dev speed mode, and save reset

**Success Criteria**:
- Settings button appears in menu (right side) of every scene
- Clicking settings shows panel filling entire PlayArea
- Panel contains: UI Scale slider, Music Volume slider, SFX Volume slider, Dev Speed Mode toggle, Save Reset button
- X button in corner closes panel
- Escape key closes panel
- Clicking outside panel closes panel
- Settings auto-save on change (combined with game progress in save.json)

**Prerequisites**:
- Phase 1.13 (Scene Template) - Scene template with Menu and PlayArea
- Phase 1.14 (Button Hierarchy) - Settings button sorted to bottom
- Phase 1.12 (UI Scale Slider) - UI scale system exists
- Phase 1.15 (Audio System) - Audio volume system exists

---

## Overview

Adds a Settings button to every scene's menu that opens a settings panel in the play area. Panel includes all player preferences (UI scale, audio volumes, dev mode) and game management (save reset). Uses combined save system where settings and game progress share save.json file. Prestige/reset operations surgically preserve settings while resetting game progress.

### Key Design Principles

- **Always accessible**: Settings button in every scene's menu
- **Full-screen panel**: Fills entire PlayArea, hides gameplay
- **Multiple close methods**: X button, Escape key, click outside
- **Auto-save**: Settings save immediately on change
- **Combined save**: Settings and game progress in same save.json
- **Surgical prestige**: Reset game vars, preserve settings vars

---

## Implementation Tasks

### 1. Create Settings Panel Scene

**File**: `res://settings_panel.tscn`

**Structure**:
```
SettingsPanel (Panel)
├── MarginContainer
│   └── VBoxContainer
│       ├── HeaderHBox
│       │   ├── TitleLabel ("Settings")
│       │   └── CloseButton ("X")
│       ├── UIScaleContainer (HBoxContainer)
│       │   ├── Label ("UI Scale:")
│       │   ├── UIScaleSlider (HSlider, 0.8-1.2, step 0.05)
│       │   └── UIScaleValueLabel ("100%")
│       ├── MusicVolumeContainer (HBoxContainer)
│       │   ├── Label ("Music Volume:")
│       │   ├── MusicVolumeSlider (HSlider, 0-100)
│       │   └── MusicVolumeValueLabel ("80%")
│       ├── SFXVolumeContainer (HBoxContainer)
│       │   ├── Label ("SFX Volume:")
│       │   ├── SFXVolumeSlider (HSlider, 0-100)
│       │   └── SFXVolumeValueLabel ("80%")
│       ├── DevSpeedContainer (HBoxContainer)
│       │   ├── Label ("Dev Speed Mode:")
│       │   └── DevSpeedCheckBox (CheckBox)
│       ├── HSeparator
│       └── SaveResetButton (Button, "Reset Save")
```

**Panel properties**:
- Full screen (anchors 0,0,1,1)
- 30% opacity dark background (gameplay visible behind)
- Centered content with margins
- Content area opaque (100% opacity)
- Z-index higher than gameplay

### 2. Settings Panel Script

**File**: `res://settings_panel.gd`

```gdscript
extends Panel

signal panel_closed

@onready var close_button = $MarginContainer/VBoxContainer/HeaderHBox/CloseButton
@onready var ui_scale_slider = $MarginContainer/VBoxContainer/UIScaleContainer/UIScaleSlider
@onready var ui_scale_value = $MarginContainer/VBoxContainer/UIScaleContainer/UIScaleValueLabel
@onready var music_slider = $MarginContainer/VBoxContainer/MusicVolumeContainer/MusicVolumeSlider
@onready var music_value = $MarginContainer/VBoxContainer/MusicVolumeContainer/MusicVolumeValueLabel
@onready var sfx_slider = $MarginContainer/VBoxContainer/SFXVolumeContainer/SFXVolumeSlider
@onready var sfx_value = $MarginContainer/VBoxContainer/SFXVolumeContainer/SFXVolumeValueLabel
@onready var dev_speed_checkbox = $MarginContainer/VBoxContainer/DevSpeedContainer/DevSpeedCheckBox
@onready var save_reset_button = $MarginContainer/VBoxContainer/SaveResetButton

func _ready():
    # Load current settings
    ui_scale_slider.value = Global.ui_scale
    music_slider.value = Global.music_volume * 100
    sfx_slider.value = Global.sfx_volume * 100
    dev_speed_checkbox.button_pressed = Global.dev_speed_mode

    update_value_labels()

    # Connect signals
    close_button.pressed.connect(_on_close_pressed)
    ui_scale_slider.value_changed.connect(_on_ui_scale_changed)
    music_slider.value_changed.connect(_on_music_volume_changed)
    sfx_slider.value_changed.connect(_on_sfx_volume_changed)
    dev_speed_checkbox.toggled.connect(_on_dev_speed_toggled)
    save_reset_button.pressed.connect(_on_save_reset_pressed)

func _input(event):
    if event.is_action_pressed("ui_cancel"):  # Escape key
        _close_panel()
        get_viewport().set_input_as_handled()

func _on_close_pressed():
    _close_panel()

func _close_panel():
    panel_closed.emit()
    queue_free()

func _on_ui_scale_changed(value: float):
    Global.ui_scale = value
    update_value_labels()
    Global.save()
    ResponsiveLayout.apply_to_scene(get_tree().current_scene)

func _on_music_volume_changed(value: float):
    Global.music_volume = value / 100.0
    AudioManager.set_music_volume(Global.music_volume)
    update_value_labels()
    Global.save()

func _on_sfx_volume_changed(value: float):
    Global.sfx_volume = value / 100.0
    AudioManager.set_sfx_volume(Global.sfx_volume)
    update_value_labels()
    Global.save()

func _on_dev_speed_toggled(pressed: bool):
    Global.dev_speed_mode = pressed
    Global.save()

func _on_save_reset_pressed():
    # Confirmation dialog
    var confirm = ConfirmationDialog.new()
    confirm.dialog_text = "Reset all game progress? Settings will be preserved."
    confirm.confirmed.connect(_perform_save_reset)
    add_child(confirm)
    confirm.popup_centered()

func _perform_save_reset():
    Global.reset_save()
    _close_panel()

func update_value_labels():
    ui_scale_value.text = "%d%%" % int(Global.ui_scale * 100)
    music_value.text = "%d%%" % int(Global.music_volume * 100)
    sfx_value.text = "%d%%" % int(Global.sfx_volume * 100)
```

### 3. Add Settings Button to Scene Template

**Modify**: `res://level1/scene_template.tscn`

Add settings button to Menu container:
```
[node name="SettingsButton" type="Button" parent="MainLayout/Menu"]
layout_mode = 2
text = "Settings"
```

**Note**: ButtonHierarchy will automatically sort this to bottom (ButtonType.SETTINGS)

### 4. Settings Button Handler (in scene_template)

**Add script to scene_template**: `res://level1/scene_template.gd`

```gdscript
extends Control

@onready var settings_button = $MainLayout/Menu/SettingsButton
@onready var play_area = $MainLayout/PlayArea

func _ready():
    ResponsiveLayout.apply_to_scene(self)

    # Connect settings button (works for all inherited scenes)
    if settings_button:
        settings_button.pressed.connect(_on_settings_pressed)

func _on_settings_pressed():
    # Singleton pattern - only one settings panel exists
    if Global.settings_panel_instance:
        return  # Already open

    # Create settings panel
    var settings_scene = load("res://settings_panel.tscn")
    Global.settings_panel_instance = settings_scene.instantiate()
    Global.settings_panel_instance.panel_closed.connect(_on_settings_closed)

    # Hide current play area content (keep it in tree but invisible)
    for child in play_area.get_children():
        child.visible = false

    # Add settings panel to PlayArea
    play_area.add_child(Global.settings_panel_instance)

func _on_settings_closed():
    # Restore play area content visibility
    for child in play_area.get_children():
        if child != Global.settings_panel_instance:
            child.visible = true

    Global.settings_panel_instance = null
```

**Benefits**:
- Works automatically for all scenes inheriting from scene_template
- No per-scene code needed
- Singleton ensures only one panel exists
- Play area content hidden while settings open

### 5. Click Outside to Close

**Modify**: `res://settings_panel.gd`

Add click detection:
```gdscript
func _gui_input(event):
    if event is InputEventMouseButton and event.pressed:
        # Check if click is on panel background (not children)
        var local_pos = event.position
        var content = $MarginContainer

        # If click outside content area, close
        if not content.get_rect().has_point(local_pos):
            _close_panel()
```

### 6. Combined Save System in Global

**Modify**: `res://global.gd`

```gdscript
# Singleton settings panel instance
var settings_panel_instance = null

# Save data structure (settings + game progress)
var save_data = {
    # Settings (preserved during prestige/reset)
    "ui_scale": 1.0,
    "music_volume": 0.8,
    "sfx_volume": 0.8,
    "dev_speed_mode": false,

    # Game progress (reset by prestige, cleared by save reset)
    "copper_current": 0,
    "copper_lifetime": 0,
    "strength": 1,
    "dexterity": 1,
    "constitution": 1,
    "intelligence": 1,
    "wisdom": 1,
    "charisma": 1,
    # ... other game vars
}

# Convenience accessors (use like: Global.ui_scale = 1.2)
var ui_scale: float:
    get: return save_data.ui_scale
    set(value): save_data.ui_scale = value

var music_volume: float:
    get: return save_data.music_volume
    set(value): save_data.music_volume = value

var sfx_volume: float:
    get: return save_data.sfx_volume
    set(value): save_data.sfx_volume = value

var dev_speed_mode: bool:
    get: return save_data.dev_speed_mode
    set(value): save_data.dev_speed_mode = value

var copper_current: int:
    get: return save_data.copper_current
    set(value): save_data.copper_current = value

# ... add getters/setters for other save_data fields

const SAVE_FILE_PATH = "user://save.json"

func save():
    """
    Save all settings and game progress.
    Called automatically on setting changes and after technique/upgrade selections.
    """
    var file = FileAccess.open(SAVE_FILE_PATH, FileAccess.WRITE)
    if file:
        file.store_string(JSON.stringify(save_data, "\t"))
        file.close()

func load_save():
    """Load settings and game progress"""
    if not FileAccess.file_exists(SAVE_FILE_PATH):
        return  # Use defaults

    var file = FileAccess.open(SAVE_FILE_PATH, FileAccess.READ)
    if file:
        var json = JSON.new()
        if json.parse(file.get_as_text()) == OK:
            var data = json.data
            # Merge loaded data with defaults (handles new fields gracefully)
            for key in data:
                if save_data.has(key):
                    save_data[key] = data[key]
        file.close()

func reset_save():
    """Reset game progress, preserve settings (called from settings panel)"""
    # Save current settings
    var settings_backup = {
        "ui_scale": save_data.ui_scale,
        "music_volume": save_data.music_volume,
        "sfx_volume": save_data.sfx_volume,
        "dev_speed_mode": save_data.dev_speed_mode,
    }

    # Reset to default game state
    save_data = {
        # Restore settings
        "ui_scale": settings_backup.ui_scale,
        "music_volume": settings_backup.music_volume,
        "sfx_volume": settings_backup.sfx_volume,
        "dev_speed_mode": settings_backup.dev_speed_mode,

        # Reset game progress
        "copper_current": 0,
        "copper_lifetime": 0,
        "strength": 1,
        "dexterity": 1,
        "constitution": 1,
        "intelligence": 1,
        "wisdom": 1,
        "charisma": 1,
        # ... etc
    }

    save()
    get_tree().reload_current_scene()

func _ready():
    load_save()
```

**Save triggers**:
- Settings sliders/toggles changed → `Global.save()`
- Technique selected (Phase 2.3) → `Global.save()`
- Upgrade purchased → `Global.save()`
- Major game events → `Global.save()`

---

## Testing

**Settings Button:**
- [ ] Settings button appears in every scene's menu
- [ ] Settings button is at bottom of menu (after nav buttons)
- [ ] Clicking button opens settings panel

**Settings Panel:**
- [ ] Panel fills entire PlayArea
- [ ] Panel has semi-transparent dark background
- [ ] All sliders and controls visible and labeled
- [ ] Panel appears above gameplay content

**UI Scale:**
- [ ] Slider shows current UI scale (default 100%)
- [ ] Moving slider changes UI scale immediately
- [ ] Value label updates (80%-120%)
- [ ] Changes persist after closing panel

**Audio Volume:**
- [ ] Music slider shows current volume (default 80%)
- [ ] SFX slider shows current volume (default 80%)
- [ ] Moving sliders changes volume immediately
- [ ] Value labels update (0%-100%)
- [ ] Volume changes audible in real-time

**Dev Speed Mode:**
- [ ] Checkbox shows current state (default off)
- [ ] Toggling checkbox changes Global.dev_speed_mode
- [ ] State persists after closing panel

**Save Reset:**
- [ ] Button shows confirmation dialog
- [ ] Confirming resets game progress
- [ ] Settings preserved after reset (UI scale, volumes, dev mode)
- [ ] Scene reloads after reset

**Close Methods:**
- [ ] X button closes panel
- [ ] Escape key closes panel
- [ ] Clicking outside panel content closes panel
- [ ] Panel properly removed from scene tree

**Persistence:**
- [ ] Change settings, close panel, reopen - settings match
- [ ] Change settings, restart game - settings persist
- [ ] Reset save - settings persist, game progress reset

---

## Files to Create

- `res://settings_panel.tscn` - Settings panel UI
- `res://settings_panel.gd` - Settings panel script
- `res://level1/scene_template.gd` - Settings button handler script

## Files to Modify

- `res://level1/scene_template.tscn` - Add SettingsButton to Menu, attach scene_template.gd script
- `res://global.gd` - Add settings_panel_instance singleton, save_data dictionary, save(), load_save(), reset_save()

---

## Design Values

### Settings Panel Sizing

- **Full screen**: Anchors (0,0,1,1) in PlayArea
- **Content margins**: 50px all sides
- **Background opacity**: 30% (gameplay visible behind)
- **Content area opacity**: 100% (fully opaque)

### Slider Ranges

| Setting | Min | Max | Default | Step |
|---------|-----|-----|---------|------|
| UI Scale | 0.8 | 1.2 | 1.0 | 0.05 |
| Music Volume | 0 | 100 | 80 | 1 |
| SFX Volume | 0 | 100 | 80 | 1 |

### Save Structure

```json
{
    "ui_scale": 1.0,
    "music_volume": 0.8,
    "sfx_volume": 0.8,
    "dev_speed_mode": false,
    "copper_current": 150,
    "strength": 5
}
```

**Settings** (top 4): Preserved during prestige/reset
**Game progress** (rest): Reset by prestige, cleared by save reset

---

## Notes

**Decision**: Combined save file (save.json) with save_data dictionary
- **Rationale**: Simpler than separate settings.json + save.json
- **Benefit**: One save/load system, one autosave, single source of truth
- **Dictionary approach**: All saveable data in `save_data` dict, convenience getters/setters
- **Prestige safety**: Prestige is surgical, won't accidentally wipe settings
- **Reset safety**: reset_save() explicitly preserves settings

**Decision**: Settings panel fills PlayArea with 30% opacity
- **Rationale**: Focus on settings, but gameplay still visible
- **Benefit**: Player maintains context, can see background
- **Implementation**: Panel fills PlayArea, hides other children, 30% dark overlay

**Decision**: Singleton settings panel via Global
- **Rationale**: Only one settings panel should exist at any time
- **Implementation**: `Global.settings_panel_instance` tracks current panel
- **Benefit**: Prevents duplicate panels, clean state management

**Decision**: Multiple close methods
- **Rationale**: Different users prefer different interactions
- **Options**: X button (mouse), Escape (keyboard), click outside (mouse)
- **UX**: Familiar patterns from other applications

**Decision**: Settings button and handler in scene_template
- **Rationale**: Universal access from every scene, zero per-scene code
- **Implementation**: scene_template.gd handles button connection automatically
- **ButtonHierarchy**: Automatically sorts to bottom (priority 100)
- **Consistency**: Works identically in all inherited scenes

**Decision**: Auto-save on change
- **Rationale**: No save button needed, changes persist immediately
- **Implementation**: Each slider/toggle change calls Global.save()
- **Trade-off**: Slightly more disk writes (negligible for small JSON)

**Decision**: Confirmation for save reset
- **Rationale**: Destructive action, prevent accidents
- **Implementation**: ConfirmationDialog built into Godot
- **Message**: Clear about what's reset vs preserved

---

**Last Updated**: 2025-12-01
**Maintainer**: Claude + User collaboration
