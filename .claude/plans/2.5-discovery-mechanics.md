# Phase 2.5: Discovery Mechanics (Rations & Overseer Bias)

**Goal**: Hidden mechanics that reward experimentation and create grimdark tone.

**Success Criteria**: Hidden mechanics discoverable, overseer feels arbitrary

**Prerequisites**: Phases 2.1-2.4 complete

---

## Implementation Tasks

### 1. Ration Choice Mechanic

Add to evening scene:
- Ration plate on table (visual: bread + water)
- Click to eat (default behavior)
- Can ignore and go straight to sleep
- **No tutorial or explanation**

#### Warning Before Sleep (If Unfed)
- Message: "You're starving. Go to the mess hall to eat before sleeping."
- Allow player to proceed anyway (discovery mechanic)

#### Effects of Skipping Rations

**Benefit**: Keep 50% of technique effects into next day
- Technique effects reduced to 50% strength
- Persist through morning phase
- Stack with new techniques acquired during next shift

**Cost**: Start next day with 35% stamina/focus
- Max stamina/focus * 0.35
- Example: 160 max stamina -> start with 56 stamina

#### Overseer Detection System
- Track last 4 days' coal output
- If current day output is 30%+ different (better OR worse):
  - **Caught**: Force-fed in evening, drugged, lose evening phase
  - **Message**: "You passed out from not eating."
  - **Wake up**: Next morning, full stamina/focus, no techniques retained
- Encourages consistent performance to avoid detection

---

### 2. Overseer Cognitive Bias System

Implement hidden payment calculation based on "Thinking Fast and Slow" biases.

#### Recency Bias
- Last 20% of shift weighted 2x more than first 80%
- Track coal_per_minute in 5-minute windows
- Most recent window's performance heavily affects final pay

#### Peak-End Rule
- Find highest coal_per_minute window in shift
- Find final 5-minute window performance
- Average these two: `(peak_performance + end_performance) / 2`
- This average affects 40% of payment

#### Anchoring
- First 10 minutes set "anchor" expectation
- If later performance exceeds anchor by 20%+: +15% pay
- If later performance below anchor by 20%+: -15% pay

#### Affect Heuristic (Overseer Mood)
- Mood scale: 0-100 (starts at 50)
- Bribes: +10 mood per bribe
- Spills: -2 mood per visible spill
- Demand event success: +5 mood
- Demand event failure: -8 mood
- **Mood effect on pay**: `payment_multiplier = 0.7 + (mood / 100) * 0.6`
  - At 0 mood: 0.7x pay
  - At 50 mood: 1.0x pay
  - At 100 mood: 1.3x pay

#### Availability Bias
- Recent mistakes weighted heavily:
  - Spill in last 5 minutes: -10% pay
  - 3+ spills in a row anytime: -15% pay
- Visible events (shakes causing spills) penalized more than quiet work

#### Time-of-Day Effects
- Morning shift (8am-12pm): Overseer well-rested, +5% base pay
- Afternoon shift (12pm-4pm): Overseer hungry/irritable, -10% base pay
- Evening shift (4pm-8pm): Overseer tired, mood volatility +50%
- (Time-of-day is cosmetic, based on in-game shift number)

#### Payment Formula Integration
```gdscript
func calculate_payment():
    var base_rate = 0.05  # copper per coal
    var coal_value = RunState.coal_count * base_rate

    # Bias multipliers
    var recency_mult = calculate_recency_multiplier()
    var peak_end_mult = calculate_peak_end_multiplier()
    var anchor_mult = calculate_anchor_multiplier()
    var mood_mult = calculate_mood_multiplier()
    var availability_mult = calculate_availability_multiplier()

    # Combine all biases (multiplicative)
    var total_mult = recency_mult * peak_end_mult * anchor_mult * mood_mult * availability_mult

    # Apply break penalty from Phase 2.4
    var break_penalty = 1.0 - (RunState.total_break_time * 0.005)

    # Apply demand bonus from Phase 2.4
    var demand_bonus = RunState.demand_coal_count * (RunState.demand_multiplier - 1.0) * base_rate

    var total = (coal_value * total_mult * break_penalty) + demand_bonus
    return max(1, total)  # Always earn at least 1 copper
```

#### Vague Feedback Only
- After payment: "Good work." or "Disappointing." or "Adequate."
- Based on mood and performance
- NO numbers or explanations

---

### 3. Bribery System Expansion

Add to furnace scene and evening:
- **Better Mood** (8c): +15 overseer mood this shift
- **Rush Order Tip-off** (12c): 10s warning before next demand event
- **Look the Other Way** (15c): Next 3 spills don't affect mood/payment
- **Extended Break** (10c): +30s break time, double stamina recovery rate

Track total bribes spent:
- Add to `Global.gd`: `var total_bribes_spent = 0`
- Required for Silver Era: 1000c total spent on bribes

---

### 4. Furnace Selection (Morning Phase)

Create `res://level1/morning.tscn`:
- Scene after waking up
- Display available furnaces (start with 1, unlock more)
- Show furnace info (vague descriptions, no numbers):
  - "Close to coal pile, calm overseer" (easy)
  - "Moderate distance, fair overseer" (medium)
  - "Far from pile, demanding overseer" (hard)

#### Furnace Differences (3-5 furnaces for Copper Era)
```gdscript
const FURNACES = [
    {
        "name": "Training Furnace",
        "distance": 200,  # pixels from coal pile
        "base_rate": 0.05,  # copper per coal
        "overseer_mood_base": 60,
        "shake_frequency": 30,  # seconds between shakes
        "unlock": "always"
    },
    {
        "name": "East Wing Furnace",
        "distance": 350,
        "base_rate": 0.07,
        "overseer_mood_base": 50,
        "shake_frequency": 25,
        "unlock": "50_lifetime_coal"
    },
    {
        "name": "Boiler Room",
        "distance": 500,
        "base_rate": 0.10,
        "overseer_mood_base": 40,
        "shake_frequency": 20,
        "unlock": "200_lifetime_coal"
    }
]
```

#### Unlock System
- Tied to lifetime coal shoveled (tracked in Global.gd)
- Unlocks persist across days
- Morning scene shows locked furnaces with unlock requirements (vague)

---

### 5. Discovery Documentation (For Testing Only)

Create `res://DEBUG_HIDDEN_MECHANICS.md` (not visible to players):
- Document all hidden formulas
- Explain bias calculations
- List ration choice effects
- For internal testing and balance only

---

## TDD Requirements (Headless Tests)

Create `tests/test_phase_2_5.gd`:

```gdscript
# Test: Skipping rations retains 50% techniques
func test_ration_skip_technique_retention():
    TechniqueManager.active_techniques = {"balance": {"effect": {"spill_reduction": 0.15}}}
    skip_rations()
    start_new_day()
    var retained_effect = TechniqueManager.active_techniques["balance"].effect.spill_reduction
    assert_eq(retained_effect, 0.075)  # 50% of 0.15

# Test: Skipping rations reduces starting stamina
func test_ration_skip_stamina_penalty():
    Global.constitution = 3  # Max stamina = 160
    skip_rations()
    start_new_day()
    assert_eq(RunState.stamina, 56)  # 160 * 0.35

# Test: Overseer detection on performance variance
func test_overseer_detection():
    set_last_4_days_coal([50, 52, 48, 51])
    RunState.coal_count = 80  # 30%+ increase
    var detected = check_overseer_detection()
    assert_true(detected)

# Test: Recency bias calculation
func test_recency_bias():
    set_coal_windows([10, 10, 10, 10, 20])  # Last window 2x better
    var multiplier = calculate_recency_multiplier()
    assert_true(multiplier > 1.0)

# Test: Mood affects payment
func test_mood_payment_multiplier():
    RunState.overseer_mood = 100
    var mult = calculate_mood_multiplier()
    assert_eq(mult, 1.3)  # Max mood = 1.3x

# Test: Bribe total tracking
func test_bribe_tracking():
    Global.total_bribes_spent = 500
    purchase_bribe("better_mood", 8)
    assert_eq(Global.total_bribes_spent, 508)

# Test: Furnace unlock by lifetime coal
func test_furnace_unlock():
    Global.lifetime_coal_shoveled = 250
    var unlocked = get_unlocked_furnaces()
    assert_true("Boiler Room" in unlocked)
```

---

## Manual Test Criteria

- [ ] Can skip rations in evening (warning appears)
- [ ] Skipping rations: Start next day with low stamina + retained techniques
- [ ] Overseer catches player if performance varies too much
- [ ] Payment feels arbitrary and hard to predict
- [ ] Higher mood = better pay (test with bribes)
- [ ] Recency matters (shovel more at end = better pay)
- [ ] Different furnaces have noticeably different pay rates
- [ ] Furnaces unlock as lifetime coal increases
- [ ] Play 15-20 days, experiment with ration skipping and bribes

---

## Files to Create

- `res://level1/morning.gd/.tscn` (furnace selection)
- `res://systems/overseer_bias_calculator.gd` (bias formulas)
- `res://DEBUG_HIDDEN_MECHANICS.md` (internal docs)
- `res://tests/test_phase_2_5.gd`

## Files to Modify

- `res://level1/evening.gd`: Add ration choice, bribe options
- `res://level1/evening.tscn`: Add ration plate visual, bribe UI
- `res://level1/furnace_work.gd`: Apply furnace differences
- `res://autoloads/run_state.gd`: Add performance tracking (windows, spills, etc.)
- `global.gd`: Add total_bribes_spent, lifetime_coal_shoveled

---

## Design Values (Reference)

### Ration Choice
- Benefit: Retain 50% technique effects
- Cost: Start with 35% stamina/focus
- Detection threshold: 30% variance from 4-day average

### Overseer Mood
- Range: 0-100 (starts at 50)
- Bribe: +10 mood
- Spill: -2 mood
- Demand success: +5 mood
- Demand failure: -8 mood

### Bribes (New)
- Better Mood: 8c
- Rush Order Tip-off: 12c
- Look the Other Way: 15c
- Extended Break: 10c

### Furnaces
- Training: 0.05 copper/coal, always unlocked
- East Wing: 0.07 copper/coal, 50 lifetime coal
- Boiler Room: 0.10 copper/coal, 200 lifetime coal

---

**Phase Status**: Ready for implementation
**Estimated Time**: 20-25 hours
**Previous Phase**: [2.4-breaks-and-demand.md](2.4-breaks-and-demand.md)
**Next Phase**: [2.6-content-and-balance.md](2.6-content-and-balance.md)
