# 1.39 Nakama Server Integration Plan

## Overview
Nakama server is the cloud backend for GoA, providing authentication, cloud saves, and data storage. The server is already deployed and operational.

## Server Status
- **URL**: `https://nakama.goasso.xyz`
- **Status**: Live and operational
- **Server Key**: `hijbtdhbgiunhyojunbghijnhytgfrde`
- **Port**: 443 (HTTPS)
- **Database**: PostgreSQL

## What Already Exists

### Infrastructure
- Nakama 3.x running in Docker on Unraid server
- Cloudflare Tunnel for secure HTTPS access
- PostgreSQL database for data persistence
- Google OAuth configured (for web builds)

### Game Integration
- **nakama_client.gd** - Autoload managing connection and auth
- **Nakama plugin** - In `addons/com.heroiclabs.nakama/`
- **Authentication methods**: Device ID, Email/Password, Google OAuth
- **Storage methods**: Generic read/write + game-specific save/load

---

## Plan Purpose

This plan documents what needs to be verified/tested to ensure Nakama integration is production-ready for the rewrite.

---

## Part 1: Verify Existing Setup

### 1.1 Server Health Check
```bash
# Test server is accessible
curl https://nakama.goasso.xyz/healthcheck
# Expected: {}

curl https://nakama.goasso.xyz/v2/status
# Expected: Server version info
```

### 1.2 Plugin Installation
- [ ] Verify Nakama plugin exists in `addons/com.heroiclabs.nakama/`
- [ ] Check project.godot has plugin enabled
- [ ] Confirm all plugin scripts compile without errors

### 1.3 Autoload Configuration
- [ ] Verify `NakamaClient` is in project.godot autoload section
- [ ] Check nakama_client.gd has correct SERVER_HOST and SERVER_KEY
- [ ] Ensure SERVER_PORT = 443 and SERVER_SCHEME = "https"

---

## Part 2: Authentication Testing

### 2.1 Device ID Auth (Simplest)
Test basic connectivity:
```gdscript
# In test scene
func _ready():
	var success = await NakamaClient.authenticate_device()
	if success:
		print("Connected! User ID: ", NakamaClient.user_id)
	else:
		print("Auth failed")
```

**Expected Result**: Creates/logs into account automatically

### 2.2 Email/Password Auth
Test account creation and login:
```gdscript
# Create account
var created = await NakamaClient.authenticate_email("testuser", "password123", true)

# Login to existing
var logged_in = await NakamaClient.authenticate_email("testuser", "password123", false)
```

**Expected Result**: Account created on first call, login succeeds on second

### 2.3 Google OAuth (Web Only)
- [ ] Document that Google auth only works in web builds
- [ ] Note that it requires Google Sign-In JavaScript integration
- [ ] Mark as "future feature" for now

---

## Part 3: Storage Testing

### 3.1 Basic Write/Read
Test generic storage operations:
```gdscript
# Write test data
var test_data = {"coins": 100, "level": 5}
await NakamaClient.write_storage("test_collection", "test_key", test_data)

# Read it back
var loaded = await NakamaClient.read_storage("test_collection", "test_key")
print("Loaded: ", loaded)
```

**Expected Result**: Data saved and retrieved successfully

### 3.2 Game Save/Load
Test full game state persistence:
```gdscript
# Modify some game state
Global.strength = 10.0
Level1Vars.currency.copper = 500.0

# Save
var saved = await NakamaClient.save_game()
print("Saved: ", saved)

# Reset state
Global.strength = 1.0
Level1Vars.currency.copper = 0.0

# Load
var loaded = await NakamaClient.load_game()
print("Loaded: ", loaded)
print("Strength now: ", Global.strength)  # Should be 10.0
print("Copper now: ", Level1Vars.currency.copper)  # Should be 500.0
```

**Expected Result**: All game state saved and restored correctly

---

## Part 4: Error Handling

### 4.1 Offline Handling
What happens when server is unreachable:
```gdscript
# Test with server down or no internet
var success = await NakamaClient.authenticate_device()
# Should fail gracefully, not crash
```

**Expected Behavior**:
- Authentication fails with error message
- `authentication_failed` signal emitted
- Game continues (offline mode)

### 4.2 Invalid Credentials
Test bad login attempts:
```gdscript
# Try to login to non-existent account
var result = await NakamaClient.authenticate_email("baduser", "wrongpass", false)
# Should return false
```

**Expected Behavior**:
- Returns false
- Error logged
- No crash

### 4.3 Unauthenticated Storage Access
Test storage without auth:
```gdscript
# Don't authenticate first
var data = await NakamaClient.read_storage("test", "key")
# Should return null with error logged
```

**Expected Behavior**:
- Returns null
- Error logged: "Cannot read storage: Not authenticated"
- No crash

---

## Part 5: Signal Integration

### 5.1 Authentication Signals
Connect to auth signals for UI feedback:
```gdscript
func _ready():
	NakamaClient.authentication_succeeded.connect(_on_auth_success)
	NakamaClient.authentication_failed.connect(_on_auth_failed)

func _on_auth_success(session_data):
	print("Welcome, ", session_data.username)
	# Show success message, load game

func _on_auth_failed(error):
	print("Login failed: ", error)
	# Show error popup, offer retry or skip
```

**Expected Result**: Signals fire correctly, UI updates appropriately

---

## Part 6: Documentation Updates

### 6.1 Update Existing Docs
- [ ] Review `.claude/docs/nakama-integration.md` for accuracy
- [ ] Update any outdated information
- [ ] Add new usage patterns if needed

### 6.2 Create Quick Reference
Document common operations developers need:
- How to authenticate
- How to save/load game
- How to add new storage collections
- Error handling patterns

---

## Part 7: Future Features (Not Now)

Document planned but not yet needed:

### Realtime Socket
- Connect to WebSocket for realtime features
- Useful for multiplayer, chat, leaderboards
- Not needed for single-player game yet

### Leaderboards
- Nakama has built-in leaderboard support
- Could track fastest completion times, highest stats, etc.
- Implement when competitive features desired

### Matchmaking
- For any future multiplayer modes
- Not relevant for current game design

---

## Implementation Checklist

### Phase 1: Verification (Do First)
- [ ] Run server health checks
- [ ] Test device ID authentication
- [ ] Test basic storage write/read
- [ ] Verify error handling doesn't crash game

### Phase 2: Documentation (Do Second)
- [ ] Review and update nakama-integration.md
- [ ] Add code examples for common patterns
- [ ] Document troubleshooting steps

### Phase 3: Integration (Do Third)
- [ ] Add authentication to loading screen
- [ ] Implement skip/offline mode for players who don't want accounts
- [ ] Add cloud save option to settings menu
- [ ] Test save/load with real game data

---

## Success Criteria

- [ ] Server responds to health checks
- [ ] Device auth creates accounts successfully
- [ ] Storage write/read works reliably
- [ ] Game state saves and loads correctly
- [ ] Offline mode works (skip login, local saves only)
- [ ] Error handling prevents crashes
- [ ] Documentation is accurate and helpful

---

## Notes

- Server is already operational - focus on testing, not setup
- Most code already exists - verify it works correctly
- Offline mode is critical - not all players want accounts
- Keep authentication optional to reduce friction
- Cloud saves should enhance, not replace, local saves

---

## Dependencies

**Before This**:
- Global.gd stats system
- Level1Vars autoload
- Currency system

**After This**:
- Save System Cloud Storage (uses Nakama for persistence)
- Logging System (will use Nakama to store bug reports)

---

## Files Involved

- `nakama_client.gd` - Main Nakama interface
- `addons/com.heroiclabs.nakama/` - Nakama plugin
- `project.godot` - Autoload configuration
- `.claude/docs/nakama-integration.md` - Documentation
- `NAKAMA_STATUS.md` - Server status reference
