# 2.1 ATM Scene: Currency Exchange & Purse Management UI

**Status**: Ready for Implementation
**Created**: 2025-01-27
**Priority**: Foundation (implement after 2. Economy Backend)
**Dependencies**: [2. Base System: Economy & Currencies](polymorphic-leaping-quail.md)

---

## Overview

ATM scene UI for currency exchange and purse management. This plan covers FRONTEND ONLY - all backend logic is in the Economy Backend plan.

**Core Functions:**
- Currency exchange interface (convert between copper/silver/gold/platinum)
- Market rates display (current exchange rates)
- Purse upgrade purchasing
- Capacity monitoring and warnings

---

## 1. Scene Structure

### File Location
- **Scene**: `res://scenes/atm.tscn`
- **Script**: `res://scenes/atm.gd`

### Node Hierarchy

```
ATM (Control)
├── MarginContainer
│   └── VBoxContainer
│       ├── TitleLabel ("Currency Exchange")
│       ├── HSeparator
│       ├── HBoxContainer (Main Content)
│       │   ├── LeftPanel (VBoxContainer)
│       │   │   ├── MarketRatesPanel
│       │   │   │   ├── RatesLabel
│       │   │   │   └── UpdateTimer (shows time to next rate update)
│       │   │   ├── Spacer
│       │   │   └── PursePanel
│       │   │       ├── PurseLabel ("Current Purse: Torn Pocket")
│       │   │       ├── CapacityBar (ProgressBar)
│       │   │       ├── CapacityLabel ("450 / 1000 coins")
│       │   │       └── UpgradeButton
│       │   └── RightPanel (VBoxContainer)
│       │       ├── ExchangePanel
│       │       │   ├── FromLabel ("From:")
│       │       │   ├── FromDropdown (OptionButton)
│       │       │   ├── AmountLabel ("Amount:")
│       │       │   ├── AmountInput (LineEdit)
│       │       │   ├── ToLabel ("To:")
│       │       │   ├── ToDropdown (OptionButton)
│       │       │   └── PreviewLabel (RichTextLabel)
│       │       ├── ExchangeButton
│       │       └── BackButton
│       └── NotificationBar (VBoxContainer for notifications)
```

---

## 2. Market Rates Display

### UI Component: MarketRatesPanel

**Purpose**: Show current exchange rates in human-readable format

**Display Format** (inverted for intuition):
```
Market Rates:
1 silver = 950 copper
1 gold = 1050 silver
1 platinum = 980 gold
```

**Implementation**:
```gdscript
func update_market_rates_display():
    var rates = CurrencyManager.get_market_rates_display()
    var rates_text = "Market Rates:\n"

    for rate in rates:
        rates_text += rate.display + "\n"

    market_rates_label.text = rates_text
```

**Update Triggers**:
- On scene entry (`_ready()`)
- Every market update (subscribe to CurrencyManager signals if available)
- Manual refresh button (optional)

**Visual Style**:
- Monospace font for alignment
- Subtle background panel
- Green/red highlights for favorable/unfavorable rates (optional discovery element)

---

## 3. Currency Exchange Interface

### Conversion Visibility Rules

**CRITICAL**: Conversion options only appear when player has enough coins

```gdscript
func should_show_conversion(from_type: int, to_type: int) -> bool:
    var player_amount = CurrencyManager._get_player_currency(from_type)

    # Copper <-> Silver: Need 700+ copper coins
    if from_type == CurrencyManager.CurrencyType.COPPER:
        if to_type == CurrencyManager.CurrencyType.SILVER:
            return player_amount >= 700

    # Silver <-> Gold: Need 700+ silver coins
    if from_type == CurrencyManager.CurrencyType.SILVER:
        if to_type == CurrencyManager.CurrencyType.GOLD:
            return player_amount >= 700

    # Gold <-> Platinum: Need 700+ gold coins
    if from_type == CurrencyManager.CurrencyType.GOLD:
        if to_type == CurrencyManager.CurrencyType.PLATINUM:
            return player_amount >= 700

    # Reverse conversions (silver->copper, gold->silver, etc.) always available
    return true
```

### From/To Dropdown Population

```gdscript
func populate_currency_dropdowns():
    from_dropdown.clear()
    to_dropdown.clear()

    var currencies = [
        {"type": CurrencyManager.CurrencyType.COPPER, "name": "Copper"},
        {"type": CurrencyManager.CurrencyType.SILVER, "name": "Silver"},
        {"type": CurrencyManager.CurrencyType.GOLD, "name": "Gold"},
        {"type": CurrencyManager.CurrencyType.PLATINUM, "name": "Platinum"}
    ]

    for curr in currencies:
        # Only add if currency is unlocked
        if CurrencyManager.is_currency_unlocked(curr.type):
            from_dropdown.add_item(curr.name, curr.type)
            to_dropdown.add_item(curr.name, curr.type)
```

### Exchange Preview Display

**Purpose**: Show player exactly what they'll get before confirming

**Format**:
```
100 copper → 0.92 silver
(broker takes 8 copper)
```

**Implementation**:
```gdscript
func update_exchange_preview():
    if amount_input.text.is_empty() or amount_input.text.to_float() <= 0:
        preview_label.text = "[center]Enter amount to exchange[/center]"
        exchange_button.disabled = true
        return

    var from_type = from_dropdown.get_selected_id()
    var to_type = to_dropdown.get_selected_id()
    var amount = amount_input.text.to_float()

    # Check if this conversion should be visible
    if not should_show_conversion(from_type, to_type):
        preview_label.text = "[center][color=red]Need 700+ coins to unlock this conversion[/color][/center]"
        exchange_button.disabled = true
        return

    # Get preview from backend
    var preview = CurrencyManager.preview_exchange(from_type, to_type, amount)

    if not preview.valid:
        if preview.error == "insufficient_funds":
            preview_label.text = "[center][color=red]Insufficient funds[/color][/center]"
        else:
            preview_label.text = "[center][color=red]Invalid exchange[/color][/center]"
        exchange_button.disabled = true
        return

    # Format preview display
    var from_name = CurrencyManager.CURRENCY_NAMES[from_type].to_lower()
    var to_name = CurrencyManager.CURRENCY_NAMES[to_type].to_lower()

    preview_label.text = "[center]%.1f %s → %.2f %s\n[color=gray](broker takes %.1f %s)[/color][/center]" % [
        preview.amount, from_name,
        preview.received, to_name,
        preview.fee, from_name
    ]

    exchange_button.disabled = false
```

**Update Triggers**:
- Amount input changes (real-time)
- From/To dropdown changes
- On currency balance changes

### Exchange Execution

```gdscript
func _on_exchange_button_pressed():
    var from_type = from_dropdown.get_selected_id()
    var to_type = to_dropdown.get_selected_id()
    var amount = amount_input.text.to_float()

    var result = CurrencyManager.exchange_currency_with_fee(from_type, to_type, amount)

    if result.success:
        # Success feedback
        var to_name = CurrencyManager.CURRENCY_NAMES[to_type]
        Global.show_stat_notification("Exchange complete: received %.2f %s" % [
            result.received,
            to_name.to_lower()
        ])

        # Reset form
        amount_input.text = ""
        update_exchange_preview()
        update_capacity_display()
        update_purse_panel()

        # Check if new conversions unlocked
        populate_currency_dropdowns()
    else:
        # Error feedback
        Global.show_stat_notification("Exchange failed: " + result.error)
```

---

## 4. Purse Upgrade Interface

### PursePanel Display

**Shows**:
- Current purse tier name
- Capacity bar (visual fill percentage)
- Coin count (X / Y coins)
- Upgrade button (with cost)

**Implementation**:
```gdscript
func update_purse_panel():
    var capacity_info = CurrencyManager.get_capacity_info()
    var purse_tier = Level1Vars.PURSE_TIERS[Level1Vars.purse_level]

    # Purse name
    purse_label.text = "Purse: " + purse_tier.name

    # Capacity bar (visual)
    capacity_bar.max_value = capacity_info.max_capacity
    capacity_bar.value = capacity_info.current_value

    # Color coding based on warning level
    match capacity_info.warning_level:
        0:  # Safe (< 80%)
            capacity_bar.modulate = Color.GREEN
        1:  # Caution (80-90%)
            capacity_bar.modulate = Color.YELLOW
        2:  # Warning (90%+)
            capacity_bar.modulate = Color.ORANGE
        3:  # Full (100%)
            capacity_bar.modulate = Color.RED

    # Numerical display
    capacity_label.text = "%d / %d coins (%.0f%%)" % [
        capacity_info.current_value,
        capacity_info.max_capacity,
        capacity_info.percent_full
    ]

    # Upgrade button
    var upgrade_cost = Level1Vars.get_purse_upgrade_cost()
    if upgrade_cost.can_upgrade:
        upgrade_button.text = "Upgrade to %s (%d %s)" % [
            upgrade_cost.name,
            upgrade_cost.cost,
            upgrade_cost.currency_type
        ]
        upgrade_button.disabled = not Level1Vars.can_afford_purse_upgrade()
        upgrade_button.visible = true
    else:
        upgrade_button.visible = false  # Max tier reached
```

### Purse Upgrade Purchase

```gdscript
func _on_upgrade_button_pressed():
    if Level1Vars.purchase_purse_upgrade():
        # Success - notification handled by backend
        update_purse_panel()
        update_capacity_display()

        # Check if new capacity allows previously blocked exchanges
        populate_currency_dropdowns()
    else:
        Global.show_stat_notification("Cannot afford purse upgrade")
```

---

## 5. Capacity Display System

### Coin Count Calculation

**CRITICAL**: Capacity is COIN COUNT, not value

```gdscript
func get_total_coin_count() -> int:
    var total = 0
    total += int(Level1Vars.currency.copper)
    total += int(Level1Vars.currency.silver)
    total += int(Level1Vars.currency.gold)
    total += int(Level1Vars.currency.platinum)
    return total

func get_capacity_info() -> Dictionary:
    var coin_count = get_total_coin_count()
    var max_capacity = Level1Vars.PURSE_TIERS[Level1Vars.purse_level].cap
    var percent = (float(coin_count) / float(max_capacity)) * 100.0

    var warning_level = 0
    if percent >= 100.0:
        warning_level = 3  # Full
    elif percent >= 90.0:
        warning_level = 2  # Warning
    elif percent >= 80.0:
        warning_level = 1  # Caution

    return {
        "current_value": coin_count,
        "max_capacity": max_capacity,
        "percent_full": percent,
        "warning_level": warning_level,
        "space_remaining": max_capacity - coin_count
    }
```

### Warning Notifications

**Triggers**:
- 80% capacity: Caution (yellow bar)
- 90% capacity: Warning (orange bar) + notification
- 100% capacity: Full (red bar) + urgent notification

**Implementation** (in capacity_info update):
```gdscript
# Show warning notification when crossing 90% threshold
if new_percent >= 90.0 and old_percent < 90.0:
    Global.show_stat_notification("Purse nearly full: consider exchange or upgrade")
elif new_percent >= 100.0:
    Global.show_stat_notification("Purse completely full: upgrade needed!")
```

---

## 6. Visual Design

### Color Scheme

**Market Rates Panel**:
- Background: Dark gray (0.2, 0.2, 0.2, 0.8)
- Text: White
- Border: Subtle light gray

**Exchange Panel**:
- Background: Medium gray (0.25, 0.25, 0.25, 0.9)
- Preview text: White
- Fee text: Light gray
- Error text: Red (1.0, 0.3, 0.3)

**Purse Panel**:
- Capacity bar colors: Green/Yellow/Orange/Red (based on fill %)
- Background: Matches exchange panel
- Upgrade button: Highlight color when affordable

### Font Sizes

- Title: 32px
- Section headers: 24px
- Body text: 18px
- Preview/details: 16px
- Capacity numbers: 20px (monospace)

### Responsive Layout

**Portrait Mode Adjustments**:
- Stack panels vertically instead of horizontally
- Reduce font sizes by PORTRAIT_FONT_SCALE
- Adjust button heights by PORTRAIT_ELEMENT_HEIGHT

---

## 7. Signal Connections

### Scene Setup

```gdscript
func _ready():
    # Connect dropdown signals
    from_dropdown.item_selected.connect(_on_from_selected)
    to_dropdown.item_selected.connect(_on_to_selected)

    # Connect input signal
    amount_input.text_changed.connect(_on_amount_changed)

    # Connect button signals
    exchange_button.pressed.connect(_on_exchange_button_pressed)
    upgrade_button.pressed.connect(_on_upgrade_button_pressed)
    back_button.pressed.connect(_on_back_button_pressed)

    # Initial population
    populate_currency_dropdowns()
    update_market_rates_display()
    update_purse_panel()
    update_exchange_preview()

func _on_from_selected(index: int):
    update_exchange_preview()

func _on_to_selected(index: int):
    update_exchange_preview()

func _on_amount_changed(new_text: String):
    update_exchange_preview()

func _on_back_button_pressed():
    # Return to previous scene (evening scene, shop, etc.)
    Global.change_scene_with_check(get_tree(), "res://scenes/evening.tscn")
```

---

## 8. Discovery Elements

### Hidden Thresholds

**Players discover through gameplay:**
- 700 coin threshold for conversion unlocks (not explicitly stated)
- Market timing patterns (rates change every 15-30 min, but exact timing hidden)
- Fee scaling with transaction size (not shown, but observable)

### Observable Patterns

**Players can observe:**
- "I had 650 copper, couldn't convert. Got 50 more, now I can!" (discover 700 threshold)
- "Larger exchanges seem to have better rates" (fee scaling discovery)
- "Market rates change periodically" (volatility discovery)
- "Extreme market events correlate with notifications" (flavor text as gameplay hint)

---

## 9. Implementation Checklist

### Phase 1: Scene Structure (2-3h)
- [ ] Create atm.tscn with node hierarchy
- [ ] Set up panels, labels, buttons
- [ ] Apply visual styling and responsive layout
- [ ] Test scene loads without errors

### Phase 2: Market Rates Display (2h)
- [ ] Implement update_market_rates_display()
- [ ] Call CurrencyManager.get_market_rates_display()
- [ ] Format and display rates
- [ ] Test rates update on scene load

### Phase 3: Exchange Interface (4-5h)
- [ ] Implement should_show_conversion() with 700 coin thresholds
- [ ] Implement populate_currency_dropdowns()
- [ ] Implement update_exchange_preview()
- [ ] Implement _on_exchange_button_pressed()
- [ ] Test all conversion directions
- [ ] Test visibility thresholds (699 coins vs 700 coins)

### Phase 4: Purse Upgrade UI (3h)
- [ ] Implement update_purse_panel()
- [ ] Implement get_total_coin_count()
- [ ] Implement get_capacity_info() for UI
- [ ] Implement _on_upgrade_button_pressed()
- [ ] Test capacity bar colors
- [ ] Test upgrade button states

### Phase 5: Integration & Polish (2-3h)
- [ ] Connect all signals
- [ ] Test full exchange flow (select, preview, execute)
- [ ] Test purse upgrade flow
- [ ] Test capacity warnings
- [ ] Test responsive layout (portrait/landscape)
- [ ] Polish animations and transitions

**Total Estimate:** 13-16 hours

---

## 10. Critical Files

### Files to Create

**scenes/atm.tscn** (new scene file)
- Complete UI hierarchy
- Visual styling
- Responsive layout configuration

**scenes/atm.gd** (~400 lines new)
- Market rates display
- Exchange interface logic
- Purse upgrade UI
- Capacity monitoring
- Signal handling
- Discovery-based visibility rules

### Files to Reference (Read-Only)

**currency_manager.gd**
- get_market_rates_display()
- preview_exchange()
- exchange_currency_with_fee()
- is_currency_unlocked()
- _get_player_currency()

**level1/level_1_vars.gd**
- PURSE_TIERS constant
- purse_level variable
- currency dictionary
- can_afford_purse_upgrade()
- get_purse_upgrade_cost()
- purchase_purse_upgrade()

**global.gd**
- show_stat_notification()
- change_scene_with_check()

---

## 11. Testing Strategy

### Unit Tests

Not applicable (UI-focused, manual testing required)

### Manual Test Cases

**Test 1: Conversion Visibility Thresholds**
- [ ] Start with 0 copper
- [ ] Add copper up to 699 → copper->silver conversion NOT visible
- [ ] Add 1 more copper (700 total) → copper->silver conversion NOW visible
- [ ] Repeat for silver->gold and gold->platinum thresholds

**Test 2: Exchange Flow**
- [ ] Select copper->silver, enter 100 copper
- [ ] Preview shows "100 copper → 0.92 silver (broker takes 8 copper)"
- [ ] Click Exchange → success notification
- [ ] Copper decreases by 100, silver increases by ~0.92
- [ ] Form resets, capacity updates

**Test 3: Purse Capacity**
- [ ] Fill purse to 80% → yellow bar
- [ ] Fill to 90% → orange bar + notification
- [ ] Fill to 100% → red bar + urgent notification
- [ ] Try to earn more → "Purse full" message, coins spill

**Test 4: Purse Upgrade**
- [ ] Insufficient funds → upgrade button disabled
- [ ] Sufficient funds → upgrade button enabled
- [ ] Click upgrade → purse tier increases, capacity expands
- [ ] Capacity bar updates to show new max

**Test 5: Market Rates Display**
- [ ] Rates show on scene load
- [ ] Rates display in inverted format ("1 silver = X copper")
- [ ] Platinum always shows stable rate (1000.0)
- [ ] Rates update when market changes

---

## 12. Design Rationale

### Why 700 Coin Threshold?

- **Discovery moment**: Player must accumulate significant currency before unlocking higher tiers
- **Not arbitrary**: High enough to feel like achievement, low enough to reach in reasonable time
- **Capacity pressure**: Forces purse upgrades (initial cap is 150, need 700 to unlock silver)
- **Era alignment**: By time player has 700 copper, they're ready for silver era content

### Why Transparent Exchange Preview?

- **User requirement**: "Player should know cost/payout when converting"
- **Reduces frustration**: Hidden costs feel unfair
- **Maintains discovery**: Formulas hidden, but results observable
- **Learning through use**: Players infer fee patterns from repeated use

### Why Coin Count (not Value) for Capacity?

- **User requirement**: "A coin is a coin, whether copper, silver, gold, or platinum"
- **Simpler mental model**: 1000 capacity = 1000 coins (any mix)
- **Strategic depth**: Hold many cheap coins vs few valuable coins?
- **Thematic**: Physical purse size, not value-based vault

### Why Color-Coded Capacity Bar?

- **Immediate feedback**: Red bar = urgent action needed
- **No numbers needed**: Visual signal works for discovery-based design
- **Accessibility**: Color + position convey same information
- **Encourages action**: Yellow/orange warnings prompt player decisions

---

**Status:** Ready for implementation
**Dependencies:** Must implement [2. Economy Backend](polymorphic-leaping-quail.md) first
**Next Steps:** Implement ATM scene after economy backend is complete
