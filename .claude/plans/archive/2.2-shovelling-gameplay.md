# Shovelling Gameplay Mechanic

**Goal**: Implement a physics-based coal shovelling mechanic where players scoop coal from a pile and deliver it to a furnace opening.

**Success Criteria**:
- Players can scoop coal onto a shovel by dipping into the coal pile
- Coal has physics and can fall off if moved too fast
- Coal delivered past the furnace line is tracked separately from dropped coal
- All tracking values update correctly in level1vars

## Overview

The shovelling mechanic is the core gameplay loop taking place in the furnace scene's playarea. Players control a shovel (represented as a curved black line following the mouse) to transfer coal from a pile in the bottom left to a furnace opening on the right side. Coal pieces are physics-managed lumpy orbs that can be scooped and will fall off if the player moves too quickly. The game tracks both dropped coal (between pile and furnace) and successfully delivered coal (past the furnace line).

**Implementation Philosophy**: This plan prioritizes simplicity and clarity over complexity. Collision shapes are simple (rectangles, not exact curve matching). Tracking uses straightforward position + velocity checks instead of complex multi-condition logic. Shared resources prevent waste. The result: easier to debug, tune, and understand, with physics behavior that feels natural through friction and damping rather than manual state management.

### Key Design Principles

- **Physics-driven feel**: Coal should feel weighty and responsive to player movement
- **Risk/reward trade-off**: Moving faster risks dropping coal, moving slower is safer but takes longer
- **Clear visual feedback**: All elements (pile, furnace, shovel, coal) should be visually distinct
- **Precise tracking**: Every piece of coal must be accounted for (scooped, dropped, or delivered)
- **Simplicity first**: Use simple collision shapes, shared resources, and clear logic over premature optimization

---

## Implementation Tasks

### 1. Coal Pile (Source)

A pile of coal positioned in the bottom left of the playarea that serves as the source for scooping.

**Variables needed**:
```gdscript
# In level1/furnace.gd (or dedicated coal_pile.gd)
var coal_pile_position: Vector2  # Bottom-left position of pile
var coal_pile_radius: float = 100.0  # Pile size for collision detection
```

**Implementation details:**
- Create a visual representation (polygon or sprite) for the coal pile
- Position at bottom-left of playarea
- Use Area2D for detecting when shovel enters pile area
- Track shovel position and motion direction to detect scoop gestures

### 2. Furnace Opening (Target)

A vertical line on the right side of the screen with an opening, rendered as a physical obstacle.

**Variables needed**:
```gdscript
# In level1/furnace.gd
var furnace_line_x: float  # X position of vertical line
var furnace_opening_top: float  # Top Y of opening
var furnace_opening_bottom: float  # Bottom Y of opening
```

**Implementation details:**
- Render vertical line on right side of screen (use Line2D or polygon)
- Create physical obstacles (StaticBody2D with RectangleShape2D) above and below the opening
- Obstacle thickness: 40px (ensures no tunneling: max expected velocity 2000 px/sec / physics 60Hz = 33px/frame, +20% margin)
- Opening should be 200px tall, centered vertically
- Use Area2D inside opening zone to detect coal delivery with signal
- Coal that hits the obstacle portions should bounce/stop

### 3. Shovel Physical Surface (Player Control)

A curved black line representing a cross-section of the shovel head that follows the mouse, with a physical collision surface for coal to rest on.

**Variables needed**:
```gdscript
# In level1/furnace.gd or shovel.gd
var shovel_curve: PackedVector2Array  # Points defining shovel curve
var shovel_position: Vector2  # Current position (follows mouse)
var shovel_previous_position: Vector2  # Previous frame position for velocity calculation
var shovel_width: float = 80.0  # Width of shovel head
var shovel_depth: float = 8.0  # Depth of curve at center
var shovel_body: AnimatableBody2D  # Physics body for coal interaction
var scoop_cooldown_timer: float = 0.0  # Prevents scoop spam
var scoop_cooldown_duration: float = 0.4  # Time between scoops in seconds
```

**Implementation details:**
- Create an AnimatableBody2D (kinematic body that moves programmatically but affects physics)
- Use simple RectangleShape2D tilted slightly upward (width: 80px, height: 12px, rotated -5 degrees)
- Visual: Draw curved line using Line2D node for aesthetics
- Collision shape doesn't need to match visual exactly - simple rectangle is sufficient for physics
- Update position in `_physics_process()` by following mouse
- Apply shared PhysicsMaterial (preloaded .tres resource) with friction 0.7 and bounce 0.1
- Track previous position to calculate motion direction for scoop detection

### 4. Coal Physics (Lumpy Orbs)

Physics-managed black orbs with friction that resist sliding and naturally balance on the shovel and each other.

**Variables needed**:
```gdscript
# In coal_piece.gd (separate scene)
var has_been_tracked: bool = false  # Prevent duplicate tracking
var settle_timer: float = 0.0  # Time spent below velocity threshold

# In level1/furnace.gd
var active_coal_pieces: Array[Node] = []  # Track all coal pieces in play
const COAL_PHYSICS_MAT = preload("res://level1/coal_physics_material.tres")  # Shared physics material
```

**Implementation details:**
- Create a coal_piece.tscn scene with RigidBody2D
- Use CircleShape2D (10px radius) for collision
- Visual: black filled circle (or slightly irregular polygon for lumpy look)
- **Physics properties (critical for natural balancing):**
  - Gravity scale: 1.0 (standard Godot gravity)
  - Mass: 0.8 (light but not weightless)
  - Use shared PhysicsMaterial resource (coal_physics_material.tres):
    - Friction: 0.7 (grips shovel surface and resists sliding)
    - Bounce: 0.15 (minimal bounce)
  - Linear damp: 0.8 (helps coal settle faster)
  - Angular damp: 1.5 (reduces spinning for stable stacking)
- **Coal-to-coal interaction:**
  - PhysicsMaterial friction creates resistance to sliding - coal won't easily slide apart once settled
  - Linear/angular damping makes pieces settle into stable configurations quickly
  - NOTE: Friction is NOT adhesion - coal pieces don't stick together, they just resist sliding
- When shovel dips into pile and scoops, spawn coal pieces that rest on the shovel surface
- Coal naturally falls off when physics determines (fast movement, tilting, etc.)
- Each piece monitors position to determine state (delivered, dropped, or still in play)

### 5. Scooping Mechanism

Detect when shovel enters coal pile and spawn coal pieces that rest naturally on the shovel surface.

**Implementation details:**
- Use Area2D to detect overlap between shovel and coal pile area
- Track shovel position delta to determine motion direction (upward vs downward)
- Scoop detection triggers when:
  - Shovel was inside pile area previous frame
  - Shovel has exited pile area current frame
  - Motion was upward (current Y < previous Y by at least 20px)
  - Cooldown timer has expired
- When scoop triggered:
  - Spawn 5 coal pieces positioned along the shovel curve surface
  - Place them 10px above the shovel surface with initial downward velocity (100 px/sec)
  - Space evenly along X axis: positions at -30, -15, 0, 15, 30 relative to shovel center
  - Reset scoop cooldown to 0.4 seconds
- Coal pieces are **never attached** to shovel - they are pure RigidBody2D objects
- Physics engine handles all interaction:
  - Coal rests on shovel due to friction from PhysicsMaterial
  - Fast shovel movement creates acceleration that overcomes friction
  - Tilting the shovel causes coal to slide/roll off naturally
  - No manual velocity checks or force-detach logic needed

### 6. Coal Tracking System

Track dropped and delivered coal in level1vars by monitoring coal piece zones.

**Variables needed**:
```gdscript
# In autoloads/level1_vars.gd
# Autoload name in project.godot: Level1Vars
var coal_dropped: int = 0  # Coal that fell between pile and furnace
var coal_delivered: int = 0  # Coal that made it into furnace
```

**Implementation details:**
- Use Area2D zones for detection:
  - **Delivery zone**: Area2D inside furnace opening, triggers on body_entered (PRIORITY 1)
  - **Boundary zone**: Area2D around entire playarea edge for cleanup
- **Delivery detection (highest priority):**
  - When coal enters delivery zone Area2D, signal triggers immediately
  - Check has_been_tracked flag to prevent duplicates
  - Null-safe increment: `if Level1Vars: Level1Vars.coal_delivered += 1`
  - Set has_been_tracked = true
  - queue_free() coal piece immediately
- **Dropped detection (position-based, simpler than Area2D):**
  - In coal's _physics_process(), check if Y position is below furnace opening bottom
  - Check if velocity < 50 px/sec
  - Must be settled for 0.5 seconds continuously
  - Null-safe increment: `if Level1Vars: Level1Vars.coal_dropped += 1`
  - Mark has_been_tracked = true
  - Schedule queue_free() after 1 second delay for visual feedback
- **Boundary cleanup:**
  - When coal leaves playarea boundary, queue_free() without tracking
  - Prevents lost coal pieces from accumulating off-screen
- **Zone priority:** Delivery zone check happens in signal handler (immediate), dropped check happens in _physics_process() (deferred), so delivery always wins
- Emit signals for tracking events to update UI or play effects

---

## Code Examples

### Shovel Physical Surface Following Mouse

```gdscript
# In furnace.gd or shovel.gd
extends AnimatableBody2D

const SHOVEL_WIDTH: float = 80.0
const SHOVEL_PHYSICS_MAT = preload("res://level1/shovel_physics_material.tres")

var shovel_curve: PackedVector2Array
var shovel_previous_position: Vector2
var line_2d: Line2D
var scoop_cooldown_timer: float = 0.0

func _ready():
    # Define shovel visual curve (for aesthetics only)
    shovel_curve = PackedVector2Array([
        Vector2(-40, -5),   # Left edge, slightly raised
        Vector2(-20, 5),    # Left-center, deeper
        Vector2(0, 8),      # Center, deepest point
        Vector2(20, 5),     # Right-center, deeper
        Vector2(40, -5)     # Right edge, slightly raised
    ])

    # Setup simple rectangle collision (doesn't need to match visual)
    var collision_shape = CollisionShape2D.new()
    var rect_shape = RectangleShape2D.new()
    rect_shape.size = Vector2(80, 12)
    collision_shape.shape = rect_shape
    collision_shape.rotation_degrees = -5  # Slight upward tilt
    add_child(collision_shape)

    # Setup visual curved line
    line_2d = Line2D.new()
    line_2d.points = shovel_curve
    line_2d.default_color = Color.BLACK
    line_2d.width = 3.0
    add_child(line_2d)

    # Apply shared physics material
    physics_material_override = SHOVEL_PHYSICS_MAT

    # Initialize position tracking
    shovel_previous_position = get_global_mouse_position()
    global_position = shovel_previous_position

func _physics_process(delta):
    # Store previous position for scoop detection
    shovel_previous_position = global_position

    # Move to mouse position (AnimatableBody2D handles physics sync)
    global_position = get_global_mouse_position()

    # Update cooldown timer
    if scoop_cooldown_timer > 0.0:
        scoop_cooldown_timer -= delta
```

**Explanation:** The shovel is an AnimatableBody2D that follows the mouse. Simple RectangleShape2D provides sufficient physics interaction. Visual curve is just aesthetics. Shared PhysicsMaterial resource prevents redundant instantiation.

### Coal Piece Zone Tracking with Area2D Signals

```gdscript
# In coal_piece.gd (attached to RigidBody2D)
extends RigidBody2D

signal coal_delivered
signal coal_dropped

var has_been_tracked: bool = false
var settle_timer: float = 0.0
var furnace_opening_bottom: float  # Set by furnace.gd when spawned

const VELOCITY_THRESHOLD: float = 50.0  # px/sec - below this is "slow"
const SETTLE_DURATION: float = 0.5  # seconds - must be still this long
const COAL_PHYSICS_MAT = preload("res://level1/coal_physics_material.tres")

func _ready():
    # Setup physics properties
    mass = 0.8
    gravity_scale = 1.0
    linear_damp = 0.8
    angular_damp = 1.5

    # Use shared physics material
    physics_material_override = COAL_PHYSICS_MAT

func _physics_process(delta):
    # Don't track if already counted
    if has_been_tracked:
        return

    # Simple dropped detection: below furnace opening and barely moving
    if global_position.y > furnace_opening_bottom:
        var current_speed = linear_velocity.length()

        if current_speed < VELOCITY_THRESHOLD:
            settle_timer += delta
            if settle_timer >= SETTLE_DURATION:
                # Confirmed dropped
                if Level1Vars:
                    Level1Vars.coal_dropped += 1
                has_been_tracked = true
                coal_dropped.emit()
                # Schedule deletion after delay (don't use await - use timer signal)
                get_tree().create_timer(1.0).timeout.connect(queue_free)
        else:
            settle_timer = 0.0  # Reset if still moving

# Called by Area2D signal when entering delivery zone
func _on_entered_delivery_zone():
    if has_been_tracked:
        return
    if Level1Vars:
        Level1Vars.coal_delivered += 1
    has_been_tracked = true
    coal_delivered.emit()
    queue_free()

# Called by Area2D signal when leaving playarea
func _on_exited_playarea():
    queue_free()  # Cleanup without tracking
```

**Explanation:** Simplified dropped detection uses position + velocity only (no acceleration check). Null-safe Level1Vars access. Fixed await pattern using signal connection. Shared PhysicsMaterial resource.

### Coal Spawning and Signal Connection

```gdscript
# In furnace.gd - spawning coal and connecting signals
extends Node2D

@onready var delivery_zone: Area2D = $DeliveryZone
@onready var boundary_zone: Area2D = $BoundaryZone

var coal_piece_scene = preload("res://level1/coal_piece.tscn")
var furnace_opening_bottom: float

func _ready():
    # Calculate furnace opening bottom position
    furnace_opening_bottom = get_viewport_rect().size.y / 2 + 100  # Example value

func spawn_coal_at_shovel(shovel_position: Vector2):
    # Spawn positions relative to shovel
    var spawn_offsets = [-30, -15, 0, 15, 30]

    for offset_x in spawn_offsets:
        var coal = coal_piece_scene.instantiate()
        add_child(coal)

        # Set position slightly above shovel
        coal.global_position = shovel_position + Vector2(offset_x, -10)

        # Set initial downward velocity
        coal.linear_velocity = Vector2(0, 100)

        # Pass furnace data to coal
        coal.furnace_opening_bottom = furnace_opening_bottom

        # Connect delivery zone signal
        delivery_zone.body_entered.connect(
            func(body):
                if body == coal:
                    coal._on_entered_delivery_zone()
        )

        # Connect boundary zone signal
        boundary_zone.body_exited.connect(
            func(body):
                if body == coal:
                    coal._on_exited_playarea()
        )
```

**Explanation:** Furnace scene is responsible for connecting Area2D signals to coal pieces when spawned. Each coal gets the furnace_opening_bottom value to perform dropped detection. Lambdas ensure each signal targets the correct coal instance.

---

## Testing Strategy

### Unit Tests (Headless)

Create `tests/test_phase_2_2_shovelling.gd`:

```gdscript
# Test: Coal tracking increments correctly via signal
func test_coal_delivered_tracking():
    # Setup
    Level1Vars.coal_delivered = 0
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child(coal_piece)

    # Execute - simulate delivery zone entry
    coal_piece._on_entered_delivery_zone()

    # Assert
    assert_eq(Level1Vars.coal_delivered, 1)
    assert_true(coal_piece.has_been_tracked)

# Test: Coal dropped tracking increments after settle duration
func test_coal_dropped_tracking():
    Level1Vars.coal_dropped = 0
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child(coal_piece)

    # Set furnace opening position so coal is below it
    coal_piece.furnace_opening_bottom = 0
    coal_piece.global_position.y = 100  # Below opening

    # Simulate being still for required duration
    coal_piece.linear_velocity = Vector2.ZERO
    for i in range(6):  # 0.5 seconds at 0.1s per frame
        coal_piece._physics_process(0.1)

    assert_eq(Level1Vars.coal_dropped, 1)

# Test: Coal physics properties are correct
func test_coal_physics_properties():
    var coal = preload("res://level1/coal_piece.tscn").instantiate()
    add_child(coal)

    assert_eq(coal.mass, 0.8)
    assert_eq(coal.physics_material_override.friction, 0.7)
    assert_eq(coal.physics_material_override.bounce, 0.15)
    assert_eq(coal.gravity_scale, 1.0)
    assert_eq(coal.linear_damp, 0.8)
    assert_eq(coal.angular_damp, 1.5)

# Test: Coal doesn't double-count
func test_coal_no_double_tracking():
    Level1Vars.coal_delivered = 0
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child(coal_piece)

    coal_piece._on_entered_delivery_zone()
    coal_piece._on_entered_delivery_zone()  # Try again

    assert_eq(Level1Vars.coal_delivered, 1)  # Should still be 1
```

**Test Cases:**
- [ ] Coal delivered counter increments when coal enters delivery zone
- [ ] Coal dropped counter increments when coal settles below furnace for required duration
- [ ] Coal only increments counters once per piece (via has_been_tracked flag)
- [ ] Coal doesn't count as dropped if still moving above velocity threshold
- [ ] Coal doesn't count as dropped if above furnace opening line
- [ ] Multiple coal pieces track independently
- [ ] Coal uses shared physics material (not creating new instances)
- [ ] Coal friction allows it to rest on shovel surface (integration test)
- [ ] Coal falls off shovel naturally when moved too fast (integration test)
- [ ] Coal leaving playarea bounds cleans up without tracking
- [ ] Delivery zone takes priority over dropped detection (zone overlap test)
- [ ] Null-safe Level1Vars access doesn't crash when Level1Vars is missing

**Run tests:**
```bash
godot --headless --script res://tests/test_runner.gd
```

### Integration Tests

**Test Scenarios:**

| Scenario | Setup | Action | Expected Result |
|----------|-------|--------|-----------------|
| Scoop and deliver | Fresh furnace scene | Scoop coal, slowly move to furnace, coal slides into opening | `coal_delivered` increases, pieces removed |
| Drop coal mid-transit | Coal resting on shovel | Move shovel rapidly or tilt it | Coal slides/rolls off due to physics, falls, `coal_dropped` increases |
| Hit furnace obstacle | Coal on shovel | Aim for area above/below opening | Coal bounces off obstacle, falls back, eventually `coal_dropped` increases |
| Multiple pieces | Scoop 5+ coal pieces | Carefully deliver some, drop others via fast movement | Delivered and dropped counts update correctly |
| Coal friction resistance | Coal pieces on shovel | Move shovel at moderate speed | Coal pieces resist sliding off due to friction, stay clustered |

### Manual Test Criteria

- [ ] Coal pile is visible and positioned in bottom-left of playarea
- [ ] Furnace opening vertical line renders on right side with clear gap
- [ ] Shovel curve (visual) follows mouse smoothly with no lag
- [ ] Shovel is a physical surface that coal can rest on
- [ ] Coal pieces have physics and respond to gravity naturally
- [ ] Coal can be scooped by dipping shovel into pile and lifting
- [ ] Coal pieces grip the shovel surface via friction (don't slide off immediately)
- [ ] Coal pieces resist sliding past each other when clustered (due to friction)
- [ ] Moving shovel rapidly causes coal to slide/roll off naturally via physics
- [ ] Tilting shovel (by moving mouse in an arc) causes coal to slide toward lower side
- [ ] Coal pieces that cross furnace line into opening disappear and increment delivered counter
- [ ] Coal pieces that settle below furnace opening increment dropped counter after 0.5s
- [ ] Visual feedback is clear: can distinguish pile, shovel, coal, furnace
- [ ] No coal pieces get "lost" without being tracked
- [ ] Physics feels satisfying and realistic (coal has weight and friction resistance)
- [ ] No attachment/detachment logic - all interactions are pure physics
- [ ] Shovel collision doesn't need to perfectly match visual curve

---

## Files to Create

- `res://level1/coal_piece.gd` - Coal piece physics and state management
- `res://level1/coal_piece.tscn` - RigidBody2D scene for individual coal pieces
- `res://level1/coal_physics_material.tres` - Shared PhysicsMaterial resource (friction: 0.7, bounce: 0.15)
- `res://level1/shovel.gd` - Shovel visual and mouse following logic (if separated)
- `res://level1/shovel_physics_material.tres` - Shared PhysicsMaterial resource (friction: 0.7, bounce: 0.1)
- `tests/test_phase_2_2_shovelling.gd` - Test suite for shovelling mechanics

## Files to Modify

- `level1/furnace.gd` - Add shovelling mechanic, coal spawning, tracking integration
- `level1/furnace.tscn` - Add coal pile visual, furnace line obstacles, shovel node
- `autoloads/level1_vars.gd` - Add `coal_dropped` and `coal_delivered` variables
- `project.godot` - Ensure level1_vars autoload is registered (if not already)

---

## Design Values (Reference)

### Shovel Properties

- **Shovel width**: 80px - Width of the shovel curve
- **Shovel curve depth**: 8px - How deep the center dips
- **Shovel line thickness**: 3px - Visual thickness of the black line
- **Shovel friction**: 0.7 - How well coal grips the shovel surface
- **Shovel bounce**: 0.1 - Minimal bounce when coal lands on shovel

### Coal Physics

- **Coal piece radius**: 10px - Size of individual coal lumps (CircleShape2D)
- **Coal pieces per scoop**: 5 pieces - Fixed amount per scoop
- **Coal mass**: 0.8 - Light but not weightless
- **Gravity scale**: 1.0 - Standard physics gravity
- **Coal friction**: 0.7 - Grips shovel and resists sliding against other coal
- **Coal bounce**: 0.15 - Minimal bounce for stable behavior
- **Linear damp**: 0.8 - Helps coal settle faster
- **Angular damp**: 1.5 - Reduces spinning for stable stacking

### Shovelling Mechanics

- **Scoop cooldown**: 0.4 seconds - Time between scoops (tune via playtesting)
- **Scoop detection threshold**: 20px upward motion - Minimum Y delta to trigger scoop
- **Coal spawn height**: 10px above shovel - Initial spawn offset for natural settling
- **Coal spawn velocity**: 100 px/sec downward - Initial velocity when spawned
- **Coal spawn positions**: [-30, -15, 0, 15, 30] - X offsets from shovel center
- **Settle velocity threshold**: 50 px/sec - Below this speed, considered settled (tune via playtesting)
- **Settle duration**: 0.5 seconds - Time coal must be still before counting as dropped (tune via playtesting)

### Layout

- **Coal pile position**: Bottom-left corner, approximately (100, viewport_height - 100)
- **Coal pile radius**: 100px - Size of scoop detection area
- **Furnace line X**: viewport_width - 50px - Right side of screen
- **Furnace opening height**: 200px - Vertical size of the gap
- **Furnace opening center**: viewport_height / 2 - Center vertically
- **Furnace obstacle thickness**: 40px - Prevents tunneling (max velocity 2000px/s ÷ 60fps = 33px/frame + 20% margin)
- **Playarea boundary**: Entire viewport rect - For coal cleanup detection

---

## UI Mockups (Optional)

```
+--------------------------------------------------+
|                                        [########]|
|                                        [########]|
|                                        [#FURNACE|
|                              [SHOVEL]  [########]|
|                        (coal) o        [  OPEN  ]|
|                       (coal) o         [        ]|
|                     (coal) o           [        ]|
|                                        [########]|
|                                        [########]|
|  [COAL PILE]                           [########]|
|   ########                             [########]|
+--------------------------------------------------+

Legend:
- [COAL PILE]: Source of coal in bottom-left
- [SHOVEL]: Curved line following mouse
- (coal) o: Individual coal pieces with physics
- [FURNACE]: Vertical line obstacle with opening in middle
```

---

## Balance Tuning Notes

**Tuneable Parameters (priority order):**

1. **Coal friction (0.7)** - Most impactful: higher = coal grips better, lower = slides off easier
2. **Furnace opening height (200px)** - Affects precision requirement and difficulty
3. **Coal mass (0.8)** - Affects inertia and how coal responds to shovel acceleration
4. **Linear damp (0.8)** - Affects how quickly coal settles; higher = stops faster
5. **Scoop cooldown (0.4s)** - Affects pacing and rhythm of gameplay
6. **Settle velocity threshold (50 px/sec)** - How easily coal counts as "stopped"

**Secondary parameters (tune only if primary adjustments insufficient):**
- `shovel_friction` (0.7) - Usually keep matched with coal friction
- `angular_damp` (1.5) - Affects spinning; rarely needs tuning
- `settle_duration` (0.5s) - How long before dropped coal counts
- `coal_bounce` (0.15) - How bouncy coal feels; lower = more sticky feeling

**Expected Player Experience:**
- **First 30 seconds**: Learning the feel - scooping, moving, discovering physics behavior
- **30 sec - 2 min**: Getting consistent - finding optimal movement speed and arc
- **2 min+**: Mastery - smooth efficient movements, minimal drops, muscle memory

**Warning Signs:**
- If coal never stays on shovel, increase friction values (too slippery)
- If coal never falls off, decrease friction or increase coal mass (too much grip)
- If coal bounces around chaotically, increase damping or decrease bounce
- If furnace opening feels too small, increase `furnace_opening_height`
- If mechanic feels too slow, increase `coal_pieces_per_scoop`
- If coal doesn't grip enough, increase friction and/or damping

---

## Notes & Decisions

**Decision 1: Pure physics vs attachment system**
- **Rationale**: Using pure physics with friction and PhysicsMaterial instead of manual attach/detach logic creates more natural, emergent gameplay. Players discover the "feel" through experimentation.
- **Alternatives considered**: Attachment system with velocity threshold would be more predictable but less satisfying and requires more manual state management.
- **Implementation**: AnimatableBody2D for shovel allows it to participate in physics while following mouse precisely.

**Decision 2: Shovel as AnimatableBody2D vs RigidBody2D**
- **Rationale**: AnimatableBody2D moves programmatically (follows mouse) but still affects other physics bodies. RigidBody2D would be affected by coal weight and feel unresponsive.
- **Alternatives considered**: Static/kinematic body wouldn't transfer momentum to coal as realistically.

**Decision 3: Individual coal pieces vs single mass**
- **Rationale**: Each piece of coal is a separate RigidBody2D, allowing them to fall individually and creating more dynamic, skill-based gameplay. Pieces can stick to each other via friction.
- **Alternatives considered**: A single "coal blob" would be simpler but less interesting and removes the emergent stacking/sliding behavior.

**Decision 4: Tracking dropped vs delivered coal**
- **Rationale**: Both metrics matter - dropped coal might reduce efficiency/score, delivered coal drives progression.
- **Use case**: Could show efficiency rating, unlock achievements for low drop rate, or penalize excessive drops.

**Decision 5: Physical obstacles vs invisible lines**
- **Rationale**: Furnace opening is rendered as actual collision obstacles above and below the gap, making the physics interactions feel more real.
- **Alternatives considered**: Invisible detection zones would work but feel less satisfying when coal bounces off.

**Decision 6: Friction-based grip vs joints**
- **Rationale**: PhysicsMaterial friction creates resistance to sliding, which is sufficient for coal gripping the shovel and resting against other coal pieces. This is simpler than joints and creates natural emergent behavior.
- **Clarification**: Friction is not adhesion - coal won't actively stick together, but won't easily slide apart once settled. Combined with damping, this creates satisfying physics without complex joint management.
- **Future consideration**: If stronger coal-to-coal clustering is needed, could add DampedSpringJoint2D between nearby pieces.

**Decision 7: Zone detection method**
- **Rationale**: Delivery zone uses Area2D signal (efficient for single check). Dropped detection uses position polling (simpler than Area2D + settle timer combo).
- **Tradeoff**: Delivery is event-based (no CPU when idle), dropped is polled (small CPU cost while coal exists, but simpler code).

**Decision 8: Boundary cleanup**
- **Rationale**: Coal that goes off-screen is removed without tracking to prevent accumulation of lost pieces. Players shouldn't be penalized for physics glitches or edge cases.
- **Implementation**: Playarea boundary Area2D with `queue_free()` on exit.

**Decision 9: Simple shovel collision vs exact curve matching**
- **Rationale**: A simple tilted RectangleShape2D provides sufficient physics interaction. Coal doesn't need pixel-perfect curve collision - friction and damping create the desired behavior.
- **Benefit**: Simpler to debug, better performance, easier to tune. Visual curve is purely aesthetic.
- **Tradeoff**: Collision doesn't match visual exactly, but players won't notice in practice.

**Decision 10: Shared PhysicsMaterial resources**
- **Rationale**: Creating new PhysicsMaterial instances for every coal piece wastes memory. Preloaded .tres resources are shared across all instances.
- **Benefit**: Lower memory usage, easier to tune (edit one file affects all coal), follows Godot best practices.
- **Implementation**: `coal_physics_material.tres` and `shovel_physics_material.tres` as project resources.

**Decision 11: Simplified settle detection (velocity only, no acceleration)**
- **Rationale**: Acceleration check added complexity with edge cases (bouncing coal, slow rolling). Position + velocity check is sufficient and more predictable.
- **Removed complexity**: No tracking of last_velocity, no per-frame acceleration calculation, no edge cases from acceleration threshold.
- **Result**: Clearer logic - if coal is below furnace opening and barely moving for 0.5s, it's dropped.

**Resolved Questions:**
- **Coal pile depletion**: NOT implemented in this phase - fixed spawn amount keeps mechanics simple
- **Coal limit on shovel**: NO limit - physics naturally prevents excessive stacking
- **Coal falling back into pile**: Not tracked or recycled - pile zone doesn't count as dropped
- **Particle effects**: NOT in this phase - add in polish/juice phase if desired
- **Sound effects**: NOT in this phase - add in audio implementation phase

---

## Implementation Checklist

- [ ] Coal pile visual and position (bottom-left) implemented with Area2D for scoop detection
- [ ] Furnace opening with physical obstacles (StaticBody2D + RectangleShape2D, 40px thick)
- [ ] Furnace delivery zone (Area2D inside opening) with body_entered signal
- [ ] Playarea boundary zone (Area2D around edges) for cleanup
- [ ] Shovel implemented as AnimatableBody2D with simple RectangleShape2D collision (80x12px, -5° tilt)
- [ ] Shovel visual (Line2D with 5 points curved) follows mouse smoothly
- [ ] Shovel tracks previous position for scoop detection
- [ ] Shovel uses shared PhysicsMaterial resource (shovel_physics_material.tres)
- [ ] Created coal_physics_material.tres (friction 0.7, bounce 0.15)
- [ ] Created shovel_physics_material.tres (friction 0.7, bounce 0.1)
- [ ] Coal piece scene created with RigidBody2D, CircleShape2D (10px radius)
- [ ] Coal pieces use shared PhysicsMaterial resource (not creating new instances)
- [ ] Coal pieces have mass 0.8, linear_damp 0.8, angular_damp 1.5
- [ ] Scooping mechanism detects upward motion from pile with cooldown (0.4s)
- [ ] Scooping spawns exactly 5 coal pieces at defined positions with initial velocity
- [ ] Coal rests on shovel naturally via physics friction (no attachment code)
- [ ] Coal falls off shovel when moved too fast (pure physics, no manual detach)
- [ ] Dropped coal tracking uses position + velocity check (below furnace opening + speed < 50px/s)
- [ ] Dropped coal requires 0.5s settle time before counting
- [ ] Delivered coal tracking triggers on delivery zone entry signal (takes priority)
- [ ] Each coal piece only increments counters once (has_been_tracked flag)
- [ ] Coal leaving playarea boundary cleans up without tracking
- [ ] Level1Vars access is null-safe (if Level1Vars: ...)
- [ ] Furnace.gd connects delivery zone and boundary zone signals to coal pieces when spawning
- [ ] Furnace.gd passes furnace_opening_bottom value to each coal piece
- [ ] All unit tests passing (including no-double-count, null-safety tests)
- [ ] All integration tests passing
- [ ] Manual tests completed
- [ ] Physics feels satisfying and realistic (weight, friction resistance, natural motion)
- [ ] Visual clarity: pile, shovel, coal, furnace are distinguishable
- [ ] Performance acceptable with multiple coal pieces (10+ simultaneous)
- [ ] No attachment/detachment logic present - all pure physics with signals
- [ ] Code reviewed
