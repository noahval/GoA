# Phase 1.25: Deployment Pipeline & Git Workflow

**Goal**: Establish a safe, automated deployment pipeline with dev/production environments and version auto-incrementing.

**Success Criteria**:
- Two-branch git workflow (dev/main) functioning correctly
- Automatic builds on push via GitHub Actions
- Auto-increment patch version (Z) on main deployment
- Game deploys to your server automatically
- Can test changes in dev before production release
- Clear documentation for git workflow

**Prerequisites**:
- Phase 1.24: Version Management (needs VersionManager to auto-increment)
- GitHub repository exists
- Server access configured

---

## Overview

This establishes a professional deployment workflow for GoA that allows safe testing before production release. The system uses a two-branch git strategy (dev for testing, main for live players) with automated builds via GitHub Actions. When code is pushed to main, the patch version auto-increments, the game builds, and deploys to your server automatically.

The workflow is designed for solo development - simple enough to not be overwhelming, but professional enough to prevent bugs from reaching players.

### Key Design Principles

- **Two Environments**: Dev (testing) and Production (live players)
- **Safety First**: Test in dev before merging to main
- **Automation**: Builds and deploys happen automatically
- **Version Control**: Patch auto-increments, but you control significance (minor/major)
- **Simple Branching**: Only two branches - no complex git flow
- **Rollback Capable**: Can revert to previous commit if needed

---

## Implementation Tasks

### 1. Git Branch Structure

Sets up the two-branch workflow for development and production.

**Branch setup:**
```
main (production)
  - Live players access this version
  - Auto-deploys to production server
  - Protected branch (only merge via PR or direct merge)
  - Patch version auto-increments on push

dev (development/testing)
  - Your testing environment
  - Deploy to dev server or test locally
  - Merge to main when ready for release
  - No version auto-increment (or optional for tracking)
```

**Implementation details:**
- Create `dev` branch from current `main`
- Set `main` as default branch in GitHub settings
- Configure branch protection rules (optional):
  - Require pull request reviews (optional for solo dev)
  - Require status checks to pass before merging
- Set up local git to track both branches
- Document workflow in README or .github/WORKFLOW.md

### 2. GitHub Actions - Dev Environment

Builds and optionally deploys when pushing to dev branch.

**Create `.github/workflows/deploy-dev.yml`:**

```yaml
name: Deploy to Dev

on:
  push:
    branches: [dev]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v1
        with:
          version: 4.5.0
          use-dotnet: false

      - name: Export game (Web)
        run: |
          mkdir -p build/web
          godot --headless --export-release "Web" build/web/index.html

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: goa-dev-build
          path: build/web/

      # Optional: Deploy to dev server
      # - name: Deploy to dev server
      #   run: |
      #     # rsync or scp to dev environment
      #     # Example: rsync -avz build/web/ user@dev.server.com:/path/to/dev/
```

**Implementation details:**
- Creates web export when dev branch receives push
- Saves build as artifact (downloadable from GitHub)
- Optional deployment to dev server (commented out initially)
- No version incrementing on dev builds
- Fast feedback for testing

### 3. GitHub Actions - Production Environment with Auto-Version

Builds, auto-increments version, and deploys when pushing to main.

**Create `.github/workflows/deploy-production.yml`:**

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v1
        with:
          version: 4.5.0
          use-dotnet: false

      - name: Auto-increment patch version
        id: version
        run: |
          # Read current version from version_manager.gd
          MAJOR=$(grep "const VERSION_MAJOR" version_manager.gd | grep -oP '\d+')
          MINOR=$(grep "const VERSION_MINOR" version_manager.gd | grep -oP '\d+')
          PATCH=$(grep "const VERSION_PATCH" version_manager.gd | grep -oP '\d+')

          # Increment patch
          NEW_PATCH=$((PATCH + 1))

          # Update version_manager.gd
          sed -i "s/const VERSION_PATCH: int = $PATCH/const VERSION_PATCH: int = $NEW_PATCH/" version_manager.gd

          # Output new version for later steps
          echo "version=$MAJOR.$MINOR.$NEW_PATCH" >> $GITHUB_OUTPUT

          # Commit version bump
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add version_manager.gd
          git commit -m "Auto-increment version to $MAJOR.$MINOR.$NEW_PATCH [skip ci]"
          git push

      - name: Export game (Web)
        run: |
          mkdir -p build/web
          godot --headless --export-release "Web" build/web/index.html

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: goa-production-v${{ steps.version.outputs.version }}
          path: build/web/

      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Deploy via rsync
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            build/web/ $SERVER_USER@$SERVER_HOST:$SERVER_PATH/

      - name: Create release tag
        run: |
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"
```

**Implementation details:**
- Auto-increments VERSION_PATCH in version_manager.gd
- Commits version bump back to repo (with [skip ci] to prevent loop)
- Builds game with new version
- Deploys to production server via rsync
- Creates git tag for this release version
- Requires GitHub secrets for server access

### 4. Godot Export Presets

Configures Godot to export web builds correctly.

**Create/update `export_presets.cfg`:**

```ini
[preset.0]

name="Web"
platform="Web"
runnable=true
dedicated_server=false
custom_features=""
export_filter="all_resources"
include_filter=""
exclude_filter=""
export_path="build/web/index.html"
encryption_include_filters=""
encryption_exclude_filters=""
encrypt_pck=false
encrypt_directory=false

[preset.0.options]

custom_template/debug=""
custom_template/release=""
variant/extensions_support=false
vram_texture_compression/for_desktop=true
vram_texture_compression/for_mobile=false
html/export_icon=true
html/custom_html_shell=""
html/head_include=""
html/canvas_resize_policy=2
html/focus_canvas_on_start=true
html/experimental_virtual_keyboard=false
progressive_web_app/enabled=false
progressive_web_app/offline_page=""
progressive_web_app/display=1
progressive_web_app/orientation=0
progressive_web_app/icon_144x144=""
progressive_web_app/icon_180x180=""
progressive_web_app/icon_512x512=""
progressive_web_app/background_color=Color(0, 0, 0, 1)
```

**Implementation details:**
- Defines "Web" export preset for GitHub Actions
- Sets output path to build/web/index.html
- Configures HTML5 export options
- Can be created in Godot Editor: Project > Export > Add > Web

### 5. GitHub Secrets Configuration

Stores sensitive server credentials for deployment.

**Required secrets** (set in GitHub repo settings):

1. **SSH_PRIVATE_KEY**: Private SSH key for server access
   - Generate: `ssh-keygen -t ed25519 -C "github-actions"`
   - Add public key to server's `~/.ssh/authorized_keys`
   - Copy private key to GitHub secret

2. **SERVER_USER**: Username for SSH connection
   - Example: `ubuntu`, `root`, or your server username

3. **SERVER_HOST**: Server hostname or IP address
   - Example: `game.yourdomain.com` or `123.45.67.89`

4. **SERVER_PATH**: Path on server where game files go
   - Example: `/var/www/goa` or `/home/user/public_html/goa`

**Implementation details:**
- Go to GitHub repo > Settings > Secrets and variables > Actions
- Add each secret with corresponding value
- Secrets are encrypted and only accessible to GitHub Actions
- Never commit secrets to git

### 6. Developer Workflow Documentation

Clear instructions for daily development workflow.

**Create `.github/WORKFLOW.md`:**

```markdown
# GoA Development Workflow

## Daily Development

1. **Start work on dev branch:**
   ```bash
   git checkout dev
   git pull origin dev
   ```

2. **Make changes and test locally:**
   - Edit code in Godot
   - Test in Godot editor (F5)
   - Commit changes: `git commit -m "Description"`

3. **Push to dev for CI testing:**
   ```bash
   git push origin dev
   ```
   - GitHub Actions builds dev version
   - Download artifact to test web build (optional)

4. **Ready for production release?**
   ```bash
   git checkout main
   git merge dev
   git push origin main
   ```
   - Patch version auto-increments (0.1.0 -> 0.1.1)
   - Builds and deploys to production automatically
   - Players get update immediately

## Bumping Minor/Major Versions

When you've added significant features (not just fixes):

1. **Edit version_manager.gd manually:**
   ```gdscript
   const VERSION_MINOR = 2  # was 1 (for new features)
   # or
   const VERSION_MAJOR = 1  # was 0 (for major release)
   ```

2. **Update changelog_data.gd:**
   - Add new version entry with changes

3. **Commit and push:**
   ```bash
   git add version_manager.gd changelog_data.gd
   git commit -m "Bump version to 0.2.0 - Added worker system"
   git push origin dev
   ```

4. **Merge to main when ready**

## Emergency Rollback

If production has a critical bug:

1. **Revert to previous commit:**
   ```bash
   git checkout main
   git revert HEAD  # or git reset --hard HEAD~1
   git push origin main --force  # be careful!
   ```

2. **Or deploy specific older version:**
   ```bash
   git checkout main
   git reset --hard <commit-hash>
   git push origin main --force
   ```

## Branch Management

- **dev**: Your testing ground, push frequently
- **main**: Production, only push when ready for release
- **Never work directly on main** (work on dev, then merge)

## Troubleshooting

**Build failing on GitHub Actions:**
- Check Actions tab for error logs
- Test export locally: `godot --headless --export-release "Web" build/web/index.html`

**Merge conflicts:**
- Usually happens if you edited main directly
- Solution: Always work on dev, only merge to main

**Version not incrementing:**
- Check version_manager.gd syntax
- Check GitHub Actions logs for sed errors
```

### 7. Local Development Setup

Ensures your local git is configured for this workflow.

**Implementation details:**

```bash
# Ensure you're on main
git checkout main
git pull origin main

# Create and switch to dev branch
git checkout -b dev

# Push dev branch to remote
git push -u origin dev

# Verify branches
git branch -a

# Set up git aliases for easier workflow (optional)
git config alias.to-dev "checkout dev"
git config alias.to-main "checkout main"
git config alias.deploy "!git checkout main && git merge dev && git push origin main && git checkout dev"
```

**Git aliases usage:**
- `git to-dev` - Switch to dev branch
- `git to-main` - Switch to main branch
- `git deploy` - Deploy dev to production (merge, push, return to dev)

---

## Code Examples

### Version Auto-Increment Script (in GitHub Actions)

```bash
#!/bin/bash
# This runs in GitHub Actions to bump patch version

# Read current version from version_manager.gd
MAJOR=$(grep "const VERSION_MAJOR" version_manager.gd | grep -oP '\d+')
MINOR=$(grep "const VERSION_MINOR" version_manager.gd | grep -oP '\d+')
PATCH=$(grep "const VERSION_PATCH" version_manager.gd | grep -oP '\d+')

# Increment patch
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

echo "Bumping version from $MAJOR.$MINOR.$PATCH to $NEW_VERSION"

# Update version_manager.gd
sed -i "s/const VERSION_PATCH: int = $PATCH/const VERSION_PATCH: int = $NEW_PATCH/" version_manager.gd

# Commit and push
git config user.name "GitHub Actions"
git config user.email "actions@github.com"
git add version_manager.gd
git commit -m "Auto-increment version to $NEW_VERSION [skip ci]"
git push

echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
```

**Explanation:** Extracts current version numbers, increments patch, updates file, commits back to repo. The `[skip ci]` prevents infinite loop of builds.

### Manual Version Bump (Developer)

```bash
#!/bin/bash
# Helper script for bumping minor version manually
# Save as scripts/bump-minor.sh

# Read current version
MAJOR=$(grep "const VERSION_MAJOR" version_manager.gd | grep -oP '\d+')
MINOR=$(grep "const VERSION_MINOR" version_manager.gd | grep -oP '\d+')

# Increment minor, reset patch
NEW_MINOR=$((MINOR + 1))
NEW_VERSION="$MAJOR.$NEW_MINOR.0"

echo "Bumping version to $NEW_VERSION"

# Update version_manager.gd
sed -i "s/const VERSION_MINOR: int = $MINOR/const VERSION_MINOR: int = $NEW_MINOR/" version_manager.gd
sed -i "s/const VERSION_PATCH: int = .*/const VERSION_PATCH: int = 0/" version_manager.gd

echo "Don't forget to update changelog_data.gd!"
echo "Commit with: git commit -m 'Bump version to $NEW_VERSION'"
```

**Explanation:** Helper script for manually bumping minor version when adding significant features. Resets patch to 0.

---

## Testing Strategy

### Manual Test Criteria

**Dev Workflow:**
- [ ] Can create dev branch from main
- [ ] Can push to dev branch
- [ ] GitHub Actions builds dev version
- [ ] Dev build artifact downloadable
- [ ] Can test dev build locally

**Production Workflow:**
- [ ] Can merge dev to main
- [ ] Push to main triggers production workflow
- [ ] Patch version auto-increments in version_manager.gd
- [ ] Version bump commits back to repo
- [ ] Production build artifact created
- [ ] Game deploys to production server
- [ ] Git tag created for version

**Version Incrementing:**
- [ ] Patch increments: 0.1.0 -> 0.1.1
- [ ] Manual minor bump works: 0.1.5 -> 0.2.0 (resets patch to 0)
- [ ] Manual major bump works: 0.9.0 -> 1.0.0 (resets minor and patch)

**Rollback:**
- [ ] Can revert to previous commit
- [ ] Previous version deploys correctly
- [ ] No data loss or corruption

**Security:**
- [ ] GitHub secrets configured correctly
- [ ] SSH key authentication works
- [ ] No secrets in git history or logs

---

## Files to Create

- `.github/workflows/deploy-dev.yml` - Dev environment CI/CD
- `.github/workflows/deploy-production.yml` - Production CI/CD with auto-version
- `.github/WORKFLOW.md` - Developer workflow documentation
- `export_presets.cfg` - Godot export configuration (if not exists)
- `scripts/bump-minor.sh` - Helper script for manual minor version bumps
- `scripts/bump-major.sh` - Helper script for manual major version bumps

## Files to Modify

- None (this is all new infrastructure)

---

## Design Values (Reference)

### Branch Strategy

- **main**: Production branch, protected, auto-deploys
- **dev**: Development branch, unprotected, testing ground

### Deployment Triggers

- **Push to dev**: Build only (or optional dev server deploy)
- **Push to main**: Build, version bump, production deploy, tag creation

### Version Increment Timing

- **Patch auto-increment**: Every push to main
- **Minor manual bump**: When adding significant features (before merging to main)
- **Major manual bump**: Major overhauls, breaking changes, official release milestones

---

## Dependencies & Integration

**Depends On:**
- Phase 1.24: Version Management - Requires VersionManager autoload to exist

**Used By:**
- All future development - Every feature uses this workflow

**Conflicts:**
- None known

**External Dependencies:**
- GitHub Actions (free for public repos)
- SSH access to your server
- Godot 4.5 export templates

---

## Phase Status

**Status**: Planning

**Estimated Time**: 3-4 hours (initial setup)

**Dependencies Complete**:
- Phase 1.24 (Version Management): Required

**Previous Phase**: Phase 1.24: Version Management

**Next Phase**: N/A (infrastructure for all future work)

---

## Notes & Decisions

**Decision 1: Two-Branch Strategy (dev/main)**
- **Rationale**: Simple enough for solo dev, safe enough to prevent production bugs
- **Alternatives considered**:
  - Git Flow (dev/feature/release/main) - Rejected: Too complex for solo dev
  - Single branch (main only) - Rejected: No safe testing environment
  - Three branches (dev/staging/main) - Rejected: Overkill for small project

**Decision 2: Auto-Increment Patch on Main Push**
- **Rationale**: Every production deploy gets tracked automatically, no manual work
- **Alternatives considered**:
  - Manual all versions - Rejected: Easy to forget, inconsistent
  - Auto-increment on every commit - Rejected: Too granular, includes dev work
  - Version bump via PR title parsing - Rejected: Too fragile, easy to mess up

**Decision 3: GitHub Actions for CI/CD**
- **Rationale**: Free, well-integrated with GitHub, widely used
- **Alternatives considered**:
  - GitLab CI - Rejected: Would require moving repo
  - Jenkins - Rejected: Need to host yourself, complex setup
  - Manual deployment - Rejected: Error-prone, slow

**Decision 4: Rsync for Deployment**
- **Rationale**: Fast, efficient, only transfers changed files, widely supported
- **Alternatives considered**:
  - SCP - Rejected: Slower, transfers everything every time
  - FTP - Rejected: Insecure, no SSH
  - Git pull on server - Rejected: Exposes .git directory, security risk

**Decision 5: SSH Key Authentication**
- **Rationale**: More secure than password, required for automated deployment
- **Alternatives considered**:
  - Password auth - Rejected: Insecure, can't automate
  - GitHub Deploy Keys - Rejected: Doesn't help with server SSH

**Open Questions:**
- [ ] Should we add staging environment between dev and production?
- [ ] Should we keep build artifacts for longer (archiving old versions)?
- [ ] Should we add automated testing before production deploy?
- [ ] Should we add Discord/Slack notifications on successful deploy?

---

## Implementation Checklist

- [ ] Create dev branch from main
- [ ] Push dev branch to GitHub
- [ ] Create .github/workflows/deploy-dev.yml
- [ ] Create .github/workflows/deploy-production.yml
- [ ] Create export_presets.cfg (if not exists)
- [ ] Configure GitHub secrets (SSH_PRIVATE_KEY, SERVER_USER, SERVER_HOST, SERVER_PATH)
- [ ] Test dev workflow (push to dev, verify build)
- [ ] Test production workflow (merge to main, verify deploy)
- [ ] Verify version auto-increment works
- [ ] Verify deployment to server works
- [ ] Create .github/WORKFLOW.md documentation
- [ ] Create helper scripts (bump-minor.sh, bump-major.sh)
- [ ] Test manual version bumps
- [ ] Test rollback procedure
- [ ] Configure git aliases locally
- [ ] Update main README with workflow link
- [ ] Test full cycle: dev work -> test -> deploy -> verify live

---

## Security Considerations

**SSH Key Management:**
- Generate dedicated key for GitHub Actions (not personal key)
- Use ed25519 algorithm (modern, secure)
- Never commit private keys to git
- Rotate keys periodically (every 6-12 months)

**Server Security:**
- Limit GitHub Actions SSH user permissions (can only write to game directory)
- Consider using dedicated deploy user (not root)
- Keep server SSH port non-standard (not 22)
- Use firewall to limit SSH access

**GitHub Security:**
- Enable two-factor authentication on GitHub account
- Review Actions logs for suspicious activity
- Use branch protection rules to prevent accidental force pushes

**Secrets Management:**
- Regularly audit GitHub secrets
- Remove unused secrets
- Never log secrets in Actions output
- Use minimal permission scopes

---

## Troubleshooting Guide

**Problem: GitHub Actions failing to push version bump**
- **Cause**: Insufficient permissions for GITHUB_TOKEN
- **Solution**: Use `token: ${{ secrets.GITHUB_TOKEN }}` in checkout action

**Problem: SSH connection failing in deployment**
- **Cause**: Invalid SSH key or host key verification
- **Solution**: Check SSH_PRIVATE_KEY secret, use `-o StrictHostKeyChecking=no` in rsync

**Problem: Godot export failing**
- **Cause**: Missing export templates or invalid export_presets.cfg
- **Solution**: Verify export preset name matches exactly ("Web")

**Problem: Merge conflicts between dev and main**
- **Cause**: Edited main directly or version bump conflicts
- **Solution**: Always merge main into dev after auto-increment: `git checkout dev && git pull origin main`

**Problem: Infinite build loop**
- **Cause**: Missing [skip ci] in version bump commit message
- **Solution**: Verify commit message includes `[skip ci]` tag

**Problem: Wrong version deployed**
- **Cause**: Version incremented but build used old version
- **Solution**: Ensure version bump commit happens before export step

---

## Future Enhancements

- **Automated Testing**: Run tests before allowing deploy
- **Staging Environment**: Add third environment between dev and prod
- **Deploy Notifications**: Discord/Slack notifications on successful deploy
- **Performance Monitoring**: Track build times, deploy times
- **Artifact Archiving**: Keep last N production builds for emergency rollback
- **Preview Deployments**: Deploy dev builds to preview URL
- **Health Checks**: Verify game loads after deployment
- **Changelog Automation**: Generate changelog from commit messages
