# Phase 1.12: UI Scale Slider

**Goal**: Add user-adjustable UI scale slider to allow players to customize interface size on top of automatic resolution scaling

**Success Criteria**:
- UI scale slider in settings overlay (range 0.8x - 1.2x)
- Scale preference saved to local storage
- Scale applies to fonts, buttons, panels, and all UI elements
- Works independently from automatic resolution scaling
- Changes take effect immediately (no restart required)

**Prerequisites**:
- Phase 1.10 (Default Theme) - Theme system exists
- Phase 1.11 (Responsive Layout Guide) - Automatic scaling system exists

---

## Overview

Provides player control over UI size through a slider in the settings menu. This works **on top of** automatic resolution scaling - if automatic scaling makes text 37px at 1080p, a 0.9x user preference would result in 33px. Addresses accessibility needs and personal preference for information density vs readability.

### Key Design Principles

- **Multiplicative scaling**: User scale multiplies automatic resolution scale
- **Persistent preference**: Saved separately from game save data (settings/preferences)
- **Immediate feedback**: Changes apply in real-time as slider moves
- **Sensible range**: 0.8x - 1.2x prevents extreme sizes
- **Simple UI**: Single slider, no complex options

---

## Implementation Tasks

### 1. Settings Storage

**File**: New file `res://settings.gd` (or add to existing settings system)

**Variables needed**:
```gdscript
# In settings.gd or global.gd
var ui_scale: float = 1.0  # Default: no adjustment (range 0.8 - 1.2)
const UI_SCALE_MIN: float = 0.8
const UI_SCALE_MAX: float = 1.2
const SETTINGS_FILE_PATH: String = "user://settings.json"
```

**Implementation details**:
- Load settings on game start
- Save settings immediately when changed (not tied to game save)
- Use JSON for human-readable settings file
- Settings include: ui_scale, volume, fullscreen, etc.

### 2. Settings File Save/Load

**Functions needed**:
```gdscript
func save_settings() -> void:
    var settings_data = {
        "ui_scale": ui_scale,
        # Add other settings here (volume, etc.)
    }
    var file = FileAccess.open(SETTINGS_FILE_PATH, FileAccess.WRITE)
    if file:
        file.store_string(JSON.stringify(settings_data, "\t"))
        file.close()

func load_settings() -> void:
    if not FileAccess.file_exists(SETTINGS_FILE_PATH):
        return  # Use defaults

    var file = FileAccess.open(SETTINGS_FILE_PATH, FileAccess.READ)
    if file:
        var json_string = file.get_as_text()
        file.close()

        var json = JSON.new()
        var parse_result = json.parse(json_string)
        if parse_result == OK:
            var data = json.data
            ui_scale = data.get("ui_scale", 1.0)
            # Load other settings
```

### 3. UI Scale Application

**Modify ResponsiveLayout.gd**:

```gdscript
# Add to responsive_layout.gd
func get_final_scale() -> float:
    """
    Returns: automatic_resolution_scale * user_preference_scale
    """
    var auto_scale = calculate_automatic_scale()  # Based on resolution
    var user_scale = Global.ui_scale  # User preference from settings
    return auto_scale * user_scale

func calculate_automatic_scale() -> float:
    """
    Automatic scaling based on resolution (1280x720 base)
    """
    var viewport = get_viewport()
    if not viewport:
        return 1.0

    var viewport_width = viewport.get_visible_rect().size.x
    var scale = viewport_width / 1280.0
    return clamp(scale, 1.0, 1.5)  # Cap at 1.5x for automatic scaling

func apply_ui_scale_to_node(node: Node) -> void:
    """
    Apply final scale (auto * user) to a node tree
    """
    var final_scale = get_final_scale()

    # Apply to Control nodes
    if node is Control:
        # Scale fonts
        if node.has_theme_font_size_override("font_size"):
            var base_size = 25  # Base font size
            node.add_theme_font_size_override("font_size", int(base_size * final_scale))

    # Recursively apply to children
    for child in node.get_children():
        apply_ui_scale_to_node(child)
```

### 4. Settings UI - Slider

**Modify settings_overlay.tscn/gd** to add slider:

**UI Structure**:
```
Settings Panel
├── Label: "UI Scale"
├── HSlider: ui_scale_slider (min=0.8, max=1.2, step=0.05, value=1.0)
└── Label: scale_value_label ("100%")
```

**Slider logic**:
```gdscript
# In settings_overlay.gd
@onready var ui_scale_slider: HSlider = $SettingsPanel/UIScaleSlider
@onready var scale_value_label: Label = $SettingsPanel/ScaleValueLabel

func _ready():
    # Load current scale from settings
    ui_scale_slider.value = Global.ui_scale
    update_scale_label()

    # Connect slider signal
    ui_scale_slider.value_changed.connect(_on_ui_scale_changed)

func _on_ui_scale_changed(value: float) -> void:
    Global.ui_scale = value
    Global.save_settings()  # Save immediately
    update_scale_label()
    apply_scale_to_all_scenes()

func update_scale_label() -> void:
    var percent = int(Global.ui_scale * 100)
    scale_value_label.text = str(percent) + "%"

func apply_scale_to_all_scenes() -> void:
    # Refresh current scene with new scale
    var root = get_tree().current_scene
    ResponsiveLayout.apply_ui_scale_to_node(root)
```

---

## Code Examples

### Complete Settings System Integration

```gdscript
# In global.gd or settings.gd
extends Node

var ui_scale: float = 1.0
const SETTINGS_FILE_PATH = "user://settings.json"

func _ready():
    load_settings()

func save_settings() -> void:
    var settings = {
        "ui_scale": ui_scale
    }
    var file = FileAccess.open(SETTINGS_FILE_PATH, FileAccess.WRITE)
    if file:
        file.store_string(JSON.stringify(settings, "\t"))
        file.close()

func load_settings() -> void:
    if not FileAccess.file_exists(SETTINGS_FILE_PATH):
        return

    var file = FileAccess.open(SETTINGS_FILE_PATH, FileAccess.READ)
    if file:
        var json = JSON.new()
        if json.parse(file.get_as_text()) == OK:
            var data = json.data
            ui_scale = data.get("ui_scale", 1.0)
        file.close()
```

---

## Testing Strategy

### Manual Test Criteria

**Settings Persistence:**
- [ ] Change UI scale to 0.9x, close game, reopen - scale persists
- [ ] Change UI scale to 1.2x, close game, reopen - scale persists
- [ ] Delete settings.json, reopen game - defaults to 1.0x

**Visual Scaling:**
- [ ] Set scale to 0.8x - all text/buttons visibly smaller
- [ ] Set scale to 1.0x - default size (matches automatic scaling)
- [ ] Set scale to 1.2x - all text/buttons visibly larger
- [ ] Slider moves smoothly from 0.8 to 1.2
- [ ] Label shows correct percentage (80% - 120%)

**Interaction with Resolution Scaling:**
- [ ] At 1280x720, base resolution with 1.0x user scale - 25px font
- [ ] At 1920x1080, automatic 1.5x scale, 1.0x user scale - 37px font
- [ ] At 1920x1080, automatic 1.5x scale, 0.8x user scale - 30px font (37 * 0.8)
- [ ] At 1920x1080, automatic 1.5x scale, 1.2x user scale - 44px font (37 * 1.2)

**Cross-Scene Consistency:**
- [ ] Change scale in settings, navigate to shop - scale applies
- [ ] Change scale in settings, navigate to ATM - scale applies
- [ ] All UI elements scale proportionally (not just fonts)

---

## Files to Create

- `res://settings.gd` - Settings autoload (if doesn't exist) for persistent preferences

## Files to Modify

- `project.godot` - Add Settings autoload if creating new file
- `global.gd` - Add ui_scale variable and settings save/load (if not creating separate settings.gd)
- `responsive_layout.gd` - Add get_final_scale() and apply_ui_scale_to_node() functions
- `settings_overlay.tscn` - Add UI scale slider widget
- `settings_overlay.gd` - Add slider logic and real-time scale application

---

## Design Values (Reference)

### UI Scale Range

- **Minimum**: 0.8x (80%) - Smaller UI, more screen space
- **Default**: 1.0x (100%) - No adjustment to automatic scaling
- **Maximum**: 1.2x (120%) - Larger UI, better readability
- **Step**: 0.05 (5%) - Smooth increments, 9 total positions

**Why this range?**
- Below 0.8x: Text becomes hard to read
- Above 1.2x: UI takes too much screen space
- Provides ~50% total range (0.8 to 1.2 = 1.5x difference)

### Scale Application Formula

```
final_font_size = base_font_size * automatic_scale * user_scale
```

**Example** (at 1920x1080):
- Base font: 25px
- Automatic scale: 1.5x (1920/1280)
- User scale: 0.9x (player preference)
- Final: 25 * 1.5 * 0.9 = **33.75px** (rounded to 34px)

---

## Phase Status

**Status**: Ready for Implementation

**Estimated Time**: 2 hours
- 30 min: Settings save/load system
- 30 min: Add slider to settings UI
- 30 min: Integrate with ResponsiveLayout
- 30 min: Testing at multiple scales and resolutions

**Dependencies Complete**:
- Phase 1.10 (Default Theme) - Required for theme system
- Phase 1.11 (Responsive Layout) - Required for scaling system

**Previous Phase**: [1.11-responsive-layout-guide.md](1.11-responsive-layout-guide.md)

**Next Phase**: Audio System (planned)

---

## Notes & Decisions

**Decision 1**: Separate settings file from game save
- **Rationale**: UI scale is a preference, not game state. Should persist across save resets.
- **Implementation**: settings.json in user:// directory

**Decision 2**: Real-time application (no restart)
- **Rationale**: Better UX - players can immediately see impact of changes
- **Implementation**: Slider value_changed signal triggers immediate re-scale

**Decision 3**: 0.8x - 1.2x range
- **Rationale**: Balances customization with preventing extreme/unreadable sizes
- **Alternative considered**: 0.5x - 2.0x range (rejected - too extreme, hard to use)

**Decision 4**: Multiplicative scaling (not additive)
- **Rationale**: User scale should work with automatic scaling, not override it
- **Example**: At 4K, automatic scale might be 3.0x. User 0.8x makes it 2.4x (still scaled up, just less)

---

## Implementation Checklist

Before marking this phase complete:

- [ ] Settings save/load system created
- [ ] ui_scale variable added to settings
- [ ] get_final_scale() function in ResponsiveLayout
- [ ] apply_ui_scale_to_node() function in ResponsiveLayout
- [ ] UI scale slider added to settings_overlay.tscn
- [ ] Slider connected to settings system
- [ ] Real-time scale application working
- [ ] Settings persist across game restarts
- [ ] Scale works at 1280x720
- [ ] Scale works at 1920x1080
- [ ] All UI elements scale proportionally
- [ ] Slider range tested (0.8x - 1.2x)
- [ ] Label shows correct percentage
- [ ] Cross-scene scaling verified

---

**Last Updated**: 2025-11-30
**Maintainer**: Claude + User collaboration
