# Coal Physics & Spawning (Shovelling Phase 2)

**Goal**: Implement coal pieces with physics properties and automatic spawning from a coal tap into a container.

**Success Criteria**:
- Coal pieces are RigidBody2D with proper physics properties
- Coal pieces use PhysicsMaterial created programmatically from Level1Vars
- Coal container with walls (bottom, left, right) holds coal in bottom-left 25% x 15% of play area
- Left wall is 30% height (2x container height) to prevent coal escaping over left side
- Coal tap spawns coal at 4/second until 100 coal exist in play area
- Coal rests on shovel naturally via physics friction
- Coal falls off shovel when moved too fast or tilted (pure physics, no attachment logic)

## Overview

This phase implements the coal pieces and automatic coal tap spawning system. Coal pieces are physics objects that interact with the shovel through friction and damping - no manual attachment logic. Coal spawns continuously from a tap position at 4 pieces per second, falling into a container in the bottom-left of the play area, until 100 total coal pieces exist.

**Dependencies**:
- **REQUIRED**: [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md) must be complete
- **REQUIRED**: [1.x-level-1-variables-autoload.md](../1/1.x-level-1-variables-autoload.md) for physics variables
- Uses Level1Vars.coal_radius (default: 5.0), coal_friction (default: 0.7), coal_bounce (default: 0.15) for coal properties
- Uses Level1Vars.coal_spilled and coal_shovelled for tracking stats (both start at 0)
- Uses `Shovel` RigidBody2D from 2.x-physics-objects-setup.md with 3-segment bowl collision
- **CRITICAL**: Shovel MUST use velocity-based movement (not direct position setting) for collision to work
- **NOTE**: Shovel tilt mechanic (hold left/right mouse) is already implemented in 2.x-physics-objects-setup.md
- **NOTE**: Shovel has concave bowl collision (3 line segments) that naturally contains coal

**ACTUAL DEFAULTS FROM LEVEL1VARS**:
- shovel_mass: 80.0 (not 100.0 as some plans show)
- shovel_max_rotation_degrees: 90.0 (not 45.0 as some plans show)
- shovel_follow_speed: 10.0
- shovel_linear_damp: 15.0
- shovel_tilt_torque: 108000.0
- coal_radius: 5.0
- coal_friction: 0.7
- coal_bounce: 0.15

---

## Physics Layers Configuration

**Layer Setup** (extends 2.x-physics-objects-setup.md):
- Layer 1: World objects (furnace walls, container walls)
- Layer 2: Shovel
- Layer 3: Coal pieces (NEW - added in this phase)

**Collision Configuration**:
- Container walls: Layer 1 - acts as world collision
- Shovel: Layer 2, Mask [1, 3] - collides with world and coal
- Coal: Layer 3, Mask [1, 2, 3] - collides with world, shovel, and other coal

---

## Implementation Tasks

### 1. Create Coal Container with Walls

Create a container in the bottom-left of the play area (25% width x 15% height) with collision walls on bottom, left, and right sides.

**In furnace.tscn:**
1. Remove old `CoalPile` node and its children (Polygon2D visual and CoalPileArea)
2. Create new `CoalContainer` Node2D under PlayArea
3. Add three StaticBody2D children (LeftWall, BottomWall, RightWall):
   - Each has a RectangleShape2D CollisionShape2D
   - Each has a Line2D for visual representation (3px width, black)
   - All on collision_layer = 1 (world objects)

**In furnace.gd setup_physics_objects():**
- Position container at bottom-left: `Vector2(0, playarea_size.y - container_height)`
- Calculate container dimensions: 25% width, 15% height of play area
- Calculate left wall height: 30% of play area height (2x container height)
- Setup collision shapes and visual lines for each wall
- Wall thickness: 5px
- **LEFT WALL SPECIAL SIZING**: Left wall is 30% height (double container height) to catch coal that might escape over the left side
  ```gdscript
  var left_wall_height = playarea_size.y * left_wall_height_percent  # 0.30 = 30%
  var left_shape = RectangleShape2D.new()
  left_shape.size = Vector2(wall_thickness, left_wall_height)
  left_collision.shape = left_shape
  # Position so bottom aligns with container bottom, extends upward
  left_collision.position = Vector2(wall_thickness / 2, container_height - (left_wall_height / 2))
  ```
- **CRITICAL**: Create NEW RectangleShape2D instances for each wall (don't modify shared SubResource)
- Each wall needs its own shape instance with correct dimensions

**Why container?** Holds coal pieces in a defined area at spawn location, preventing them from scattering across the entire play area.

**Why taller left wall?** Coal pieces can bounce or fly out of the container during spawning or scooping. The left wall being 2x the container height (30% vs 15%) provides extra protection against coal escaping over the left edge.

### 2. Coal Piece Scene

Create reusable coal piece with physics properties and visual.

**Create res://level1/coal_piece.tscn:**
1. Root node: `RigidBody2D` (name: CoalPiece)
2. Add child: `CollisionShape2D`
   - Shape: CircleShape2D
   - Radius: Will be set programmatically from Level1Vars.coal_radius (default 5px)
3. Add child: `Polygon2D` (name: Visual)
   - Polygon points: Create 6-8 sided irregular shape for lumpy look
   - Design polygon for 10px radius (will be scaled at runtime based on Level1Vars.coal_radius)
   - Example points (10px radius design, relative to center):
     ```
     [Vector2(-8, -6), Vector2(-4, -10), Vector2(4, -9),
      Vector2(9, -3), Vector2(7, 6), Vector2(2, 10),
      Vector2(-6, 8), Vector2(-10, 2)]
     ```
   - Color: Black `#000000` or very dark gray `#1a1a1a`
4. Add child to Visual: `Line2D` (name: Outline)
   - Points: Same as polygon points, plus first point repeated at end to close the loop
     ```
     [Vector2(-8, -6), Vector2(-4, -10), Vector2(4, -9),
      Vector2(9, -3), Vector2(7, 6), Vector2(2, 10),
      Vector2(-6, 8), Vector2(-10, 2), Vector2(-8, -6)]
     ```
   - Width: 1.8px
   - Color: 50% grey `Color(0.5, 0.5, 0.5, 1)`
   - Joint mode: 2 (round)
   - Begin/End cap mode: 2 (round)
   - Antialiased: true

**Visual Design Notes**:
- CircleShape2D for physics (radius set from Level1Vars.coal_radius, default 5px)
- Polygon2D for visuals (slightly irregular, lumpy coal look)
- Line2D outline (1.8px wide, 50% grey) drawn around polygon for visibility
- Polygon designed for 10px radius, then scaled at runtime: `scale = Level1Vars.coal_radius / 10.0`
- Outline is a child of Visual node, so it scales with the polygon
- This allows upgrading coal size by changing Level1Vars.coal_radius
- Black or near-black color for coal appearance with grey outline for contrast

### 3. Coal Piece Script

**Create res://level1/coal_piece.gd:**
```gdscript
extends RigidBody2D

func _ready():
	# Setup physics properties
	mass = 0.8
	gravity_scale = 1.0
	linear_damp = 0.8
	angular_damp = 1.5

	# Collision layers
	collision_layer = 3  # Coal on layer 3
	collision_mask = 7   # Binary 111 = collides with layers 1, 2, 3

	# Create physics material programmatically (upgradable at runtime)
	var physics_mat = PhysicsMaterial.new()
	physics_mat.friction = Level1Vars.coal_friction
	physics_mat.bounce = Level1Vars.coal_bounce
	physics_material_override = physics_mat

	# Set collision shape radius from Level1Vars
	var collision_shape = $CollisionShape2D
	if collision_shape and collision_shape.shape:
		collision_shape.shape.radius = Level1Vars.coal_radius

	# Scale visual to match collision radius (default polygon is designed for 10px radius)
	var visual = $Visual
	if visual:
		var scale_factor = Level1Vars.coal_radius / 10.0
		visual.scale = Vector2(scale_factor, scale_factor)
```

**In coal_piece.tscn:**
- Attach `coal_piece.gd` to root RigidBody2D node

**Physics Properties**:
- Mass 0.8: Light but has weight
- Gravity scale 1.0: Normal gravity
- Linear damp 0.8: Settles quickly, not too bouncy
- Angular damp 1.5: Reduces spinning
- Friction: Level1Vars.coal_friction (default 0.7) - created programmatically
- Bounce: Level1Vars.coal_bounce (default 0.15) - created programmatically

### 4. Coal Tap Spawning System

Continuously spawn coal from a tap position into the container at 2 pieces per second until 100 total coal exist.

**In furnace.gd** (add to existing file from [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md)):

**Add @onready variables** (add near top with other @onready vars):
```gdscript
@onready var coal_container: Node2D = $AspectContainer/MainContainer/mainarea/PlayArea/CoalContainer
@onready var shovel_body: RigidBody2D = $AspectContainer/MainContainer/mainarea/PlayArea/Shovel/RigidBody2D
```

**Add spawning variables** (add near top with other variables):
```gdscript
# Preload coal scene
var coal_piece_scene = preload("res://level1/coal_piece.tscn")

# Coal tap spawning
var coal_spawn_timer: float = 0.0
const COAL_SPAWN_RATE: float = 0.25  # Spawn every 0.25 seconds (4 per second)
var coal_tap_position: Vector2
var active_coal_count: int = 0
const MAX_COAL_PIECES: int = 100  # Performance limit

var container_width_percent: float = 0.25  # 25% of play area width
var container_height_percent: float = 0.15  # 15% of play area height
```

**In setup_physics_objects()** (calculate tap position after container setup):
```gdscript
# Calculate coal tap position (just above top-left of container)
coal_tap_position = coal_container.global_position + Vector2(container_width * 0.15, -10)
```

**Add to existing _process() function** (or create if doesn't exist):
```gdscript
func _process(delta):
	# Spawn coal from tap continuously if below max count
	if active_coal_count < MAX_COAL_PIECES:
		coal_spawn_timer += delta
		if coal_spawn_timer >= COAL_SPAWN_RATE:
			coal_spawn_timer = 0.0
			spawn_coal_from_tap()
```

**Add spawning functions** (add at end of file):
```gdscript
func spawn_coal_from_tap():
	# Spawn single coal piece at tap position
	var coal = coal_piece_scene.instantiate()
	get_node("AspectContainer/MainContainer/mainarea/PlayArea").add_child(coal)

	# Track coal lifetime
	active_coal_count += 1
	coal.tree_exited.connect(_on_coal_destroyed)

	# Spawn at tap position
	coal.global_position = coal_tap_position

func _on_coal_destroyed():
	active_coal_count -= 1
```

**Tap Spawning Logic**:
1. Timer accumulates delta time in `_process()`
2. Every 0.25 seconds (4/second), spawn single coal piece
3. Coal spawns at tap position (15% into container width, 10px above top)
4. Gravity pulls coal down into container
5. Spawning stops when `active_coal_count >= 100`

**Design Values**:
- Spawn rate: 4 per second (0.25s interval)
- Tap position: 15% into container width from left, 10px above container top
- Max coal: 100 pieces (performance cap)

### 5. Expected Physics Behavior

No manual attachment code - pure physics interaction.

**How coal stays on shovel**:
- Friction (0.7) between coal and shovel prevents sliding
- Linear damp (0.8) makes coal settle quickly
- Mass (0.8) gives coal weight but doesn't overpower friction
- Shovel bowl shape (3-segment concave collision) provides angled walls that contain coal
- Bottom line (36 units wide) creates stable resting surface

**How coal falls off**:
- Fast shovel movement: Coal's inertia overcomes friction → slides off
- Shovel tilt: Gravity component pulls coal toward lower side → slides off
- More tilt = steeper slope = faster sliding
- Creates skill challenge: balance speed vs tilt angle

**Edge Cases**:
- **Tilted shovel spawn**: If shovel is tilted when coal spawns, coal will immediately start sliding toward lower side (intended - creates challenge)
- **Multiple coal stacking**: Coal pieces can rest against each other via friction
- **Fast spawn**: Y offset -60px prevents tunneling even with rapid scooping

---

## Testing Checklist

### Setup Verification
- [ ] CoalContainer exists under `PlayArea/`
- [ ] CoalContainer has LeftWall, BottomWall, RightWall StaticBody2D children
- [ ] Each wall has CollisionShape2D with RectangleShape2D
- [ ] Each wall has VisualLine Line2D child
- [ ] All walls on collision_layer = 1
- [ ] Container positioned at bottom-left (flush with edges)
- [ ] Container dimensions: 25% width x 15% height of play area
- [ ] Left wall height: 30% of play area height (2x container height)
- [ ] Left wall bottom-aligned with container bottom, extends upward
- [ ] Shovel structure is `Shovel (Node2D) -> RigidBody2D (child)`
- [ ] Shovel RigidBody2D collision layer is 2
- [ ] Shovel RigidBody2D collision mask includes layer 3 (collides with coal)
- [ ] PhysicsMaterial created programmatically in coal_piece.gd _ready()

### Coal Piece Scene
- [ ] `coal_piece.tscn` exists
- [ ] Root is RigidBody2D named CoalPiece
- [ ] Has CircleShape2D collision (radius set from Level1Vars.coal_radius, default 5px)
- [ ] Has Polygon2D visual (black/dark gray, irregular shape)
- [ ] Has Line2D outline child (1.8px width, 50% grey, round joints/caps, antialiased)
- [ ] Outline points match polygon points with first point repeated to close loop
- [ ] Script `coal_piece.gd` attached
- [ ] Mass = 0.3, gravity_scale = 1.0
- [ ] linear_damp = 1.5, angular_damp = 3.0
- [ ] collision_layer = 3, collision_mask = 7
- [ ] Creates PhysicsMaterial programmatically using Level1Vars.coal_friction and coal_bounce

### Coal Tap Spawning
- [ ] `coal_piece_scene` preloaded in furnace.gd
- [ ] Coal tap spawning variables declared
- [ ] `coal_tap_position` calculated in setup_physics_objects()
- [ ] Tap position at top-left of container (15% into width, 10px above)
- [ ] Spawn timer increments in _process()
- [ ] Coal spawns every 0.25 seconds (4/second)
- [ ] Max 100 coal pieces enforced
- [ ] Coal spawns at tap position
- [ ] `active_coal_count` increments/decrements correctly
- [ ] Spawning stops when count reaches 100
- [ ] Spawning resumes when coal cleanup reduces count below 100

### Physics Behavior
- [ ] Coal falls onto shovel from spawn position (gravity working)
- [ ] Coal rests on level, stationary shovel (friction working)
- [ ] Coal stays on shovel during slow movement
- [ ] Coal slides off during fast movement
- [ ] Coal slides toward lower side on tilted shovel
- [ ] More tilt = faster sliding
- [ ] Coal pieces can stack/cluster without sliding apart
- [ ] Coal settles quickly (damping working)
- [ ] Coal doesn't spin excessively
- [ ] No attachment/detachment code exists

### Integration
- [ ] Coal spawns automatically from tap into container
- [ ] Container walls hold coal (bottom, left, right)
- [ ] Coal can be scooped from container with shovel
- [ ] 100 piece cap enforced - spawning stops
- [ ] No console errors during gameplay
- [ ] Shovel tilt (via holding mouse buttons) causes coal to slide naturally
- [ ] Tilt interaction works smoothly - coal responds to shovel angle changes

---

## Manual Testing Guide

**Test 1: Automatic Coal Spawning**
1. Start the game
2. Observe bottom-left container area
3. Expected: Coal spawns from tap at 4 pieces per second
4. Expected: Coal falls into container and accumulates
5. Expected: Spawning continues until 100 pieces exist

**Test 2: Container Walls**
1. Wait for coal to accumulate in container
2. Expected: Coal is held by bottom, left, and right walls
3. Expected: Coal does not escape container
4. Try moving shovel through container
5. Expected: Coal interacts with shovel physics

**Test 3: Performance Cap**
1. Wait for 100 coal pieces to spawn
2. Expected: Spawning stops at 100 pieces

**Test 4: Tilt Interaction**
1. Scoop coal
2. Hold left mouse button to tilt shovel left
3. Expected: Coal slides toward right (lower side)
4. Hold right mouse button to tilt shovel right
5. Expected: Coal slides toward left (lower side)

**Test 5: Movement Speed**
1. Scoop coal from container
2. Move shovel slowly - coal stays on
3. Move shovel rapidly - coal slides/falls off

---

## Troubleshooting

**Coal not spawning:**
- Check `coal_tap_position` is calculated correctly in setup_physics_objects()
- Verify `coal_spawn_timer` increments in _process()
- Debug print `active_coal_count` to verify it's below 100
- Check `coal_piece_scene` is loaded correctly
- Verify PlayArea node exists at expected path

**Coal spawns but doesn't fall into container:**
- Check container walls have collision_layer = 1
- Verify coal collision_mask includes layer 1 (mask = 7)
- Check coal gravity_scale = 1.0
- Verify tap position is above container, not inside it

**Coal escapes container:**
- Verify all three walls (left, bottom, right) exist and have collision shapes
- Check wall collision shapes are sized correctly
- **CRITICAL**: Ensure each wall creates its own RectangleShape2D instance (not modifying shared SubResource)
- Verify shapes are assigned: `wall_collision.shape = new_shape_instance`
- Increase wall thickness if needed (current: 5px)
- Check collision shapes are positioned correctly relative to walls

**Coal tunnels through walls or shovel:**
- Verify shovel collision_mask includes layer 3
- Verify coal collision_layer = 3
- Consider enabling Continuous Collision Detection (CCD) on coal RigidBody2D if needed
- Reduce spawn rate if too many pieces spawn at once

**Coal too slippery (slides off immediately):**
- Increase Level1Vars.coal_friction (try 0.8-0.9)
- Increase coal linear_damp (try 1.0-1.2)
- Decrease coal mass (try 0.6-0.7)
- Check shovel isn't tilted (tilt causes sliding)

**Coal too sticky (never falls off):**
- Decrease friction (try 0.5-0.6)
- Decrease linear_damp (try 0.6-0.7)
- Increase coal mass (try 1.0-1.2)

**Performance issues:**
- Check `active_coal_count` caps at 100
- Check coal cleanup (offscreen/lifetime)
- Reduce MAX_COAL_PIECES if needed (try 50)
- Reduce spawn rate if needed (increase COAL_SPAWN_RATE to 1.0 for 1/second)

**Container not visible:**
- Check Line2D visual lines exist on each wall
- Verify Line2D points are set correctly in setup_physics_objects()
- Check Line2D width (3.0) and color (black)
- Container position might be off-screen - verify calculation

---

## Balance Tuning

Adjust these values if physics behavior doesn't feel right:

**Coal slips too easily:**
- Level1Vars.coal_friction: 0.7 → 0.8-0.9
- `coal_piece.gd` linear_damp: 0.8 → 1.0-1.2
- `coal_piece.gd` mass: 0.8 → 0.6-0.7

**Coal too sticky:**
- Friction: 0.7 → 0.5-0.6
- Linear damp: 0.8 → 0.6-0.7
- Mass: 0.8 → 1.0-1.2

**Coal bounces too much:**
- Level1Vars.coal_bounce: 0.15 → 0.05-0.1
- Angular damp: 1.5 → 2.0-2.5

**Coal spins excessively:**
- Angular damp: 1.5 → 2.0-2.5

**Spawn rate too slow/fast:**
- COAL_SPAWN_RATE: 0.25s (4/sec) → slower: 0.5s (2/sec), faster: 0.125s (8/sec)

---

## Files Modified

- [level1/furnace.gd](../../level1/furnace.gd) - Added scoop detection, coal spawning, count tracking
- [level1/furnace.tscn](../../level1/furnace.tscn) - Updated CoalPileArea collision settings

## Files Created

- [level1/coal_piece.tscn](../../level1/coal_piece.tscn) - Coal RigidBody2D scene with visual
- [level1/coal_piece.gd](../../level1/coal_piece.gd) - Coal physics and cleanup script

## Files Referenced

- [level1/shovel_physics_material.tres](../../level1/shovel_physics_material.tres) - From [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md)

---

## GDScript Error Prevention

**Common pitfalls specific to this phase:**

### Variable Naming in Coal Tracking
When iterating over coal-related arrays, avoid built-in function names:
```gdscript
# WRONG - 'error' shadows built-in function
for error in error_logs:
    print(error.message)

# CORRECT
for error_entry in error_logs:
    print(error_entry.message)
```

### Reference the Correct Node
Shovel structure from [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md):
```
Shovel (Node2D)
└── RigidBody2D (child)
```

**CRITICAL:** Reference the RigidBody2D child, NOT the parent:
```gdscript
# CORRECT
@onready var shovel_body: RigidBody2D = $path/Shovel/RigidBody2D

# WRONG - references Node2D parent instead of RigidBody2D child
@onready var shovel_body = $path/Shovel
```

### See Also
Refer to [1.x-simple-logging.md](../1/1.x-simple-logging.md) for comprehensive GDScript common pitfalls (iterator names, output parameters, type formatting, etc.).

---

## Design Notes

**Why spawn coal from tap (no player interaction)?**
- Ensures consistent coal supply without requiring player to manually scoop
- Simpler game mechanic - focus is on transporting coal, not gathering it
- Automatic spawning creates time pressure (container fills up)
- Players can focus on shoveling skill rather than scoop timing

**Why container in bottom-left?**
- Natural starting point for scooping coal
- Out of the way of furnace (right side)
- Clear visual separation between coal source and coal destination
- 25% x 15% size provides enough space without dominating screen

**Why 4 coal per second spawn rate?**
- Fast enough to keep container well-supplied
- Not so fast that it overwhelms physics or creates lag
- Reaches 100 coal cap in 25 seconds (reasonable time to fill)
- Tunable based on gameplay feel

**Why pure physics (no attachment)?**
- More emergent gameplay - players discover optimal techniques
- Simpler code - no attach/detach state management
- Feels natural and satisfying
- RigidBody2D-to-RigidBody2D friction works reliably
- Tilt mechanic creates natural sliding via gravity
- Bowl-shaped collision provides physical containment without attachment logic

**Why 100 coal max?**
- Prevents physics engine overload
- Tune down if performance issues occur
- With 4/second spawn rate, fills in 25 seconds

**Shovel tilt gameplay** (implemented in 2.x-physics-objects-setup.md):
- Hold left/right mouse buttons to apply continuous rotation torque
- Tilt creates gravity component perpendicular to surface
- Coal naturally slides "downhill" on tilted shovel via physics
- Skill challenge: balance movement speed vs tilt angle
- Too much tilt = coal falls off
- Tilt mechanic uses Level1Vars.shovel_tilt_torque = 108000.0 for responsive rotation
- Shovel mass = Level1Vars.shovel_mass = 80.0 prevents coal from pushing it around
- Max rotation = Level1Vars.shovel_max_rotation_degrees = 90.0 degrees

**Container wall design**:
- Open top allows coal to fall in from tap
- Open top allows player to scoop coal out with shovel
- Three walls (left, bottom, right) prevent coal escape
- Left wall is 30% height (double container height at 15%) to catch bouncing/escaping coal
- Left wall bottom-aligned with container, extends upward beyond container top
- 5px wall thickness provides solid collision without being visually bulky
- Walls are both visual (Line2D) and physical (StaticBody2D)
- Each wall requires its own RectangleShape2D instance created at runtime (shared SubResource from .tscn is placeholder only)

**No delivery tracking yet**:
- This phase only spawns coal
- Phase 2.4 will add delivery/drop detection
- Keeps this phase focused on core physics
- Level1Vars.coal_spilled and coal_shovelled variables exist but are not yet incremented
- These will be used in Phase 2.4 for tracking coal delivery success/failure

**Next Phase**: Phase 2.4 implements coal tracking - counting delivered vs dropped coal using Level1Vars.coal_shovelled and coal_spilled.
