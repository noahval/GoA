# Dishwash: Rack Completion & Rewards

**Goal**: Validate mug state before rack placement, award currency for completed mugs

**Success Criteria**: Rack only accepts DRY mugs with error feedback for invalid states; player earns 1 Hole per 3 mugs completed

## Overview

Implements the full rack completion flow. First validates mug state (only DRY accepted), showing contextual error messages for DIRTY/WET attempts. Then tracks completed mugs and awards Holes currency via batch payment system.

### Key Design Principles

- Clear feedback for invalid actions (contextual error messages)
- Errors disappear automatically after 1 second
- Batch payment: 3 mugs = 1 Hole
- Real-time currency updates (no session-end payment)
- Lifetime counter for mastery unlock tracking

---

## Implementation Tasks

### 1. Add Tracking Variables

Add to `dishwash_minigame.gd`:

```gdscript
var mugs_this_session: int = 0  # Total mugs completed this session
var mugs_toward_hole: int = 0  # Progress toward next Hole (0-2)

const MUGS_PER_HOLE: int = 3  # 3 mugs = 1 Hole

# Add to texture preloads
const MUG_CLEAN_TEXTURE = preload("res://level1/icons/mug-clean.png")
```

**Implementation details:**
- `mugs_this_session` tracks total for statistics
- `mugs_toward_hole` cycles 0->1->2->0 (resets on payment)
- Both reset when session starts

### 2. Update Session Start/Stop

Modify existing functions:

```gdscript
func start_washing():
	mugs_this_session = 0
	mugs_toward_hole = 0
	visible = true
	wash_mugs_button.disabled = true
	stop_washing_button.visible = true

func stop_washing():
	# (existing cleanup)
	if mug_bound_to_cursor:
		unbind_mug()

	# Reset session stats
	mugs_this_session = 0
	mugs_toward_hole = 0

	visible = false
	wash_mugs_button.disabled = false
	stop_washing_button.visible = false
```

**Explanation**: Session counters reset when starting/stopping washing. Fresh slate each session.

### 3. Implement Rack Validation & Completion

Update `dishwash_minigame.gd`:

```gdscript
func _on_rack_clicked(_viewport, event, _shape_idx):
	if event is InputEventMouseButton and event.pressed and event.button_index == MOUSE_BUTTON_LEFT:
		if mug_bound_to_cursor:
			attempt_rack_placement()  # Validates before completing

func attempt_rack_placement():
	if current_mug_state == MugState.DIRTY:
		show_error_notification("Clean it first!")
		return
	elif current_mug_state == MugState.WET:
		show_error_notification("Dry it first!")
		return
	elif current_mug_state == MugState.DRY:
		complete_mug()

func complete_mug():
	# Increment counters
	mugs_this_session += 1
	mugs_toward_hole += 1
	Level1Vars.mugs_washed += 1

	# Unbind mug
	unbind_mug()

	# Award Holes if batch complete
	if mugs_toward_hole >= MUGS_PER_HOLE:
		mugs_toward_hole = 0
		Level1Vars.add_currency("holes", 1.0)
		# TODO: Play coin sound, flash UI (future polish)

# (show_error_notification already exists from 2.19.1)
```

**Explanation**: Validates state first - DIRTY and WET show errors, only DRY proceeds to completion. Tracks progress and awards Hole every 3 mugs.

### 4. Add Debug Helper for Testing

Since drying logic doesn't exist yet (comes in 2.19.6), add temporary debug helper:

```gdscript
func _input(event):
	# TEMPORARY DEBUG: Press D to force DRY state for testing
	if event is InputEventKey and event.pressed and event.keycode == KEY_D:
		if mug_bound_to_cursor and current_mug_state == MugState.WET:
			transition_to_dry()

func transition_to_dry():
	current_mug_state = MugState.DRY
	$BoundMug/MugSprite.texture = MUG_CLEAN_TEXTURE
```

**Explanation**: Debug key allows testing rack completion before drying timer exists. Press D to manually dry WET mug. Remove when 2.19.6 completes.

### 5. Reset State Between Mugs

Ensure `unbind_mug()` resets all state:

```gdscript
func unbind_mug():
	mug_bound_to_cursor = false
	$BoundMug.visible = false

	# Reset state for next mug
	current_mug_state = MugState.DIRTY
	basin_soak_time = 0.0
	soak_movement_bonus = 0.0
	mug_in_basin = false
	# Note: Dry timer variables reset in 2.19.6
```

**Explanation**: Clean slate for next mug. Prevents state leakage between cycles.

---

## Testing Strategy

### Manual Test Criteria - Validation

- [ ] Clicking rack with DIRTY mug shows "Clean it first!" error
- [ ] Clicking rack with WET mug shows "Dry it first!" error
- [ ] Error notification appears centered above rack
- [ ] Error disappears automatically after 1 second
- [ ] Multiple error clicks don't stack notifications (only one visible)
- [ ] Mug stays bound to cursor after error (doesn't unbind)
- [ ] Pressing D key with WET mug transitions to DRY state (debug helper)
- [ ] Clicking rack with DRY mug successfully unbinds (no error)

### Manual Test Criteria - Rewards

- [ ] Completing 1 mug: No Hole awarded, progress saved
- [ ] Completing 2 mugs: No Hole awarded, progress saved
- [ ] Completing 3 mugs: 1 Hole awarded, progress resets to 0/3
- [ ] Completing 6 mugs: 2 Holes awarded total
- [ ] Level1Vars.mugs_washed increments by 1 per mug completed
- [ ] Currency display updates immediately when Hole awarded
- [ ] mugs_toward_hole cycles: 0->1->2->0->1->2->0
- [ ] Stopping session resets mugs_this_session and mugs_toward_hole
- [ ] Lifetime mug count (Level1Vars.mugs_washed) persists across sessions

### Test Flow

1. Start washing session
2. Click dirty stack (bind DIRTY mug)
3. Click rack -> "Clean it first!" error
4. Move mug into basin, wait 4 seconds (becomes WET)
5. Click rack -> "Dry it first!" error
6. Press D key (debug: becomes DRY)
7. Click rack -> Success, mug unbinds, counter increments
8. Repeat 2 more times -> Hole awarded on 3rd completion

### Reward Test Scenarios

| Mugs Completed | Holes Awarded | mugs_toward_hole | Level1Vars.mugs_washed |
|----------------|---------------|------------------|------------------------|
| 1 | 0 | 1 | 1 |
| 2 | 0 | 2 | 2 |
| 3 | 1 | 0 | 3 |
| 4 | 1 | 1 | 4 |
| 5 | 1 | 2 | 5 |
| 6 | 2 | 0 | 6 |

---

## Files to Modify

- `c:\Goa\game\v0.1\level1\dishwash_minigame.gd` - Add validation, completion, and reward logic

---

## Design Values (Reference)

### Error Messages

- **DIRTY mug**: "Clean it first!"
- **WET mug**: "Dry it first!"
- **Error duration**: 1.0 seconds (auto-hide)

### Reward Formula

- **Mugs per Hole**: 3 (MUGS_PER_HOLE constant)
- **Payment timing**: Immediate (not session-end)

### Debug Controls (Temporary)

- **D key**: Force WET -> DRY transition for testing
- **Remove in**: 2.19.6 when auto-dry timer implemented

---

## Notes & Decisions

**Decision: Mug stays bound after error**
- Rationale: Player can immediately try again after fixing mistake
- No punishment for failed placement
- More forgiving UX

**Decision: Contextual error messages**
- Rationale: Tells player exactly what's wrong
- "Clean it first!" clearly states need to soak
- "Dry it first!" clearly states need to dry
- Better than generic "Can't place mug here"

**Decision: 1 second auto-hide for errors**
- Rationale: Long enough to read, short enough not to annoy
- No manual dismiss needed

**Decision: Real-time payment over session-end**
- Rationale: Immediate feedback more satisfying
- Player sees reward as soon as 3rd mug placed
- Clearer cause-and-effect

**Decision: Direct currency increment**
- Rationale: Level1Vars.add_currency() already handles signals
- Currency display auto-updates via existing signal system

**Decision: Separate session vs lifetime counters**
- Rationale: mugs_this_session for statistics/display
- Level1Vars.mugs_washed for mastery unlock (150 mugs threshold)
- Different purposes, different scopes

**Decision: Debug key for testing**
- Rationale: Allows testing completion flow before drying timer exists
- Marked as TEMPORARY in comments
- Will be removed when 2.19.6 completes

---

**Last Updated**: 2026-01-16
