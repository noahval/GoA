# Dishwash: State Machine & Basin Logic

**Goal**: Implement mug state transitions (DIRTY → WET) with basin soaking and movement acceleration

**Success Criteria**: Mug changes from dirty to wet after 4 seconds in basin (or faster with movement), progress persists if mug leaves basin early

## Overview

Adds the core state machine with DIRTY and WET states. Tracks time spent in basin with movement-based speedup. Progress accumulates and persists - leaving basin early doesn't reset progress.

### Key Design Principles

- 4-second base soak requirement in basin
- Moving mug in basin speeds up soaking (200px = 1 second saved)
- Progress persists if mug leaves basin (doesn't reset)
- Can dunk multiple times to accumulate progress
- Texture changes to reflect state (dirty → wet)

---

## Implementation Tasks

### 1. Add State Machine

Add to `dishwash_minigame.gd`:

```gdscript
enum MugState { DIRTY, WET, DRY }

var current_mug_state: MugState = MugState.DIRTY
var basin_soak_time: float = 0.0  # Accumulated time in basin
var soak_movement_bonus: float = 0.0  # Seconds saved by movement
var mug_in_basin: bool = false  # Track current basin overlap
var last_mug_position: Vector2 = Vector2.ZERO  # For distance tracking

const REQUIRED_SOAK_TIME: float = 4.0  # Base time needed in basin
const PIXELS_PER_SECOND_SAVED: float = 200.0  # Movement speedup rate

# Add to texture preloads
const MUG_WET_TEXTURE = preload("res://level1/icons/mug-wet.png")
```

**Implementation details:**
- `basin_soak_time` accumulates only while in basin (doesn't reset when leaving)
- `soak_movement_bonus` tracks seconds saved by moving in basin
- Total progress = basin_soak_time + soak_movement_bonus
- State transitions when total >= REQUIRED_SOAK_TIME

### 2. Convert BoundMug to Area2D

Modify BoundMug node structure:

```
BoundMug (Area2D) # was Sprite2D, now Area2D for collision
├── CollisionShape2D # CircleShape2D roughly matching mug size
└── MugSprite (Sprite2D) # moved texture here
    # texture = mug-dirty.png
    # scale = Vector2(0.3, 0.3)
```

**Implementation details:**
- BoundMug becomes Area2D for basin overlap detection
- Visual moved to child MugSprite
- CollisionShape2D sized to approximate mug bounds
- Update all script references from `$BoundMug` to `$BoundMug/MugSprite` for texture access

### 3. Convert Basin to Area2D with Overlap Detection

Modify Basin node:

```
Basin (Area2D) # was Node2D, now Area2D for collision
├── CollisionShape2D # RectangleShape2D covering basin visual area
└── WaterVisual (ColorRect) # existing brown water
```

**Implementation details:**
- Basin collision covers the water visual area
- Enable monitoring and monitorable on Basin Area2D
- Will detect when BoundMug enters/exits

### 4. Implement Basin Soaking Logic

Add to `dishwash_minigame.gd`:

```gdscript
func _ready():
	# ... (existing button signals)

	# Basin collision signals
	$Basin.area_entered.connect(_on_basin_area_entered)
	$Basin.area_exited.connect(_on_basin_area_exited)

func _process(delta):
	if not visible:
		return

	# Update mug position (existing)
	if mug_bound_to_cursor:
		$BoundMug.global_position = get_global_mouse_position()

	# Basin soaking progress (only when in basin)
	if current_mug_state == MugState.DIRTY and mug_in_basin:
		basin_soak_time += delta

		# Movement speedup while in basin
		var current_pos = get_global_mouse_position()
		var distance_moved = current_pos.distance_to(last_mug_position)
		soak_movement_bonus += distance_moved / PIXELS_PER_SECOND_SAVED
		last_mug_position = current_pos

		# Check if ready to transition
		var total_progress = basin_soak_time + soak_movement_bonus
		if total_progress >= REQUIRED_SOAK_TIME:
			transition_to_wet()

func _on_basin_area_entered(area: Area2D):
	# Only respond to BoundMug entering basin
	if area == $BoundMug and mug_bound_to_cursor and current_mug_state == MugState.DIRTY:
		mug_in_basin = true
		last_mug_position = get_global_mouse_position()

func _on_basin_area_exited(area: Area2D):
	# Only respond to BoundMug leaving basin
	if area == $BoundMug:
		mug_in_basin = false
		# Progress persists - don't reset basin_soak_time or soak_movement_bonus

func transition_to_wet():
	current_mug_state = MugState.WET
	$BoundMug/MugSprite.texture = MUG_WET_TEXTURE
	# Note: Don't reset basin progress here - will be reset on next mug bind
```

**Explanation**: Tracks time in basin and movement distance. Both contribute to progress. Leaving basin pauses progress but doesn't reset it. Can dunk multiple times to finish soaking.

### 5. Update Bind/Unbind Functions

Modify existing functions:

```gdscript
func bind_mug_to_cursor():
	mug_bound_to_cursor = true
	current_mug_state = MugState.DIRTY  # Always start dirty
	basin_soak_time = 0.0  # Reset progress for new mug
	soak_movement_bonus = 0.0
	mug_in_basin = false
	$BoundMug.visible = true
	$BoundMug/MugSprite.texture = MUG_DIRTY_TEXTURE
	$BoundMug.global_position = get_global_mouse_position()
	last_mug_position = get_global_mouse_position()

func unbind_mug():
	mug_bound_to_cursor = false
	$BoundMug.visible = false
	# Don't reset state here - will be reset on next bind
```

**Explanation**: Each new mug starts fresh with DIRTY state and zero progress. Old state doesn't carry over between mugs.

---

## Testing Strategy

### Manual Test Criteria

- [ ] Clicking stack binds DIRTY mug (gray/brown texture)
- [ ] Moving mug into basin area starts accumulating progress
- [ ] After 4 seconds in basin (stationary), mug transitions to WET state
- [ ] WET mug shows wet texture (blue tint)
- [ ] Moving mug rapidly in basin speeds up transition (visible acceleration)
- [ ] Can leave basin early - progress persists when re-entering
- [ ] Can dunk mug multiple times to accumulate to 4 seconds total
- [ ] Placing WET mug on rack unbinds it (no validation yet - that's in 2.22)
- [ ] Next mug always starts DIRTY with zero progress (doesn't inherit state)
- [ ] Movement speedup feels responsive (200px = 1 second is noticeable)

### Manual Test Scenarios

| Scenario | Expected Behavior |
|----------|-------------------|
| Hold mug still in basin 4s | Transitions to WET after 4 seconds |
| Swirl mug rapidly in basin | Transitions to WET in under 2 seconds |
| Dunk 2s, leave, dunk 2s more | Transitions to WET on second dunk (progress saved) |
| Leave basin at 3.9s, re-enter | Transitions to WET almost instantly on re-entry |

---

## Files to Create

- `c:\Goa\game\v0.1\level1\icons\mug-wet.png` - Wet mug sprite (if not exists - can use mug-clean.png with blue tint as temp solution)

## Files to Modify

- `c:\Goa\game\v0.1\level1\bar.tscn` - Convert BoundMug to Area2D structure, convert Basin to Area2D
- `c:\Goa\game\v0.1\level1\dishwash_minigame.gd` - Add all state machine logic

---

## Design Values (Reference)

### Soaking Parameters

- **Base soak time**: 4.0 seconds (REQUIRED_SOAK_TIME)
- **Movement speedup rate**: 200 pixels per second saved (PIXELS_PER_SECOND_SAVED)
- **Max speedup potential**: ~800 pixels = 4 seconds saved = instant wet (theoretical limit)
- **Typical player speedup**: Circular swirling motion reduces 4s to ~2s

### State Transitions

- **DIRTY → WET**: When (basin_soak_time + soak_movement_bonus) >= 4.0
- **Progress persistence**: Never resets until new mug bound

---

## Notes & Decisions

**Decision: Progress persists when leaving basin**
- Rationale: More forgiving than resetting progress
- Allows multi-dunk strategy
- Reduces frustration from accidental exits
- Matches user request explicitly

**Decision: Movement bonus only while in basin**
- Rationale: Thematically makes sense (water sloshing)
- Prevents exploits like moving in air
- Concentrates player action in basin area
- Simpler to understand

**Decision: 4 seconds base instead of 2**
- Rationale: User requested longer soak time
- Gives more room for movement speedup to feel impactful
- Can still be fast with swirling (~2 seconds)

**Decision: BoundMug as Area2D**
- Rationale: Needed for basin overlap detection
- Enables area_entered/area_exited signals
- Cleaner than position-based collision detection
- Sprite moved to child MugSprite node

**Decision: Total progress = time + movement**
- Rationale: Additive system is clearest
- 1 second in basin = 1 second of progress
- 200 pixels moved = 1 second of progress
- Both contribute equally to reaching 4-second goal

---

## Asset Requirements

**mug-wet.png sprite needed**:
- If asset doesn't exist, can temporarily use mug-clean.png with blue ColorRect overlay
- Should show water droplets or blue tint
- Same dimensions as mug-dirty.png
- Will be used in $BoundMug/MugSprite.texture when WET

---

**Last Updated**: 2026-01-14
