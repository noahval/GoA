# Dishwash Offline Job

**Goal**: Integrate dishwashing as an offline job with mug-based idle rate improvement

**Success Criteria**: Players can assign dishwashing as idle job, earn holes while offline, improve idle rate by washing mugs actively

## Overview

Registers dishwashing as an idle job in the Job Board system (2.x-job-board.md). Implements progression system where active play (washing mugs) improves offline efficiency by reducing the time per hole earned. Tracks mugs washed to decrease earning interval from 100 seconds to floor of 20 seconds.

### Key Design Principles

- Active play improves offline performance (washing mugs reduces offline timer)
- Floor prevents infinite optimization (20 seconds minimum)
- 1 hole per interval (frequency improves, not amount)
- Linear progression (every 5 mugs = 1 second faster)
- Simple, single progression system (no complex mastery tiers)

---

## Dependencies

- **2.x-offline-earnings.md**: Provides OfflineEarningsManager and timestamp verification
- **2.x-job-board.md**: Provides JobBoardManager and job assignment UI
- **2.x-dishwash.md**: Provides dishwash minigame where mugs are washed

---

## Core Mechanics

### Offline Earnings Rate

**Base Rate**: 1 hole per 100 seconds (starting rate)

This improves with mug-washing progression down to a floor of 20 seconds per hole.

### Mug-Based Timer Reduction

**Level1Vars**:
- `offline_dishwash_seconds`: Current interval between holes (starts at 100, floor at 20)
- `mugs_washed`: Total mugs washed in dishwash minigame (lifetime counter)

**Progression Formula**:
```gdscript
offline_dishwash_seconds = max(100 - floor(mugs_washed / 5), 20)
```

**Examples**:
| Mugs Washed | Reduction | Interval | Holes per Hour |
|-------------|-----------|----------|----------------|
| 0-4 | 0 seconds | 100s | 36 holes/hour |
| 5-9 | 1 second | 99s | ~36.4 holes/hour |
| 25-29 | 5 seconds | 95s | ~37.9 holes/hour |
| 100-104 | 20 seconds | 80s | 45 holes/hour |
| 400+ | 80 seconds | 20s | 180 holes/hour (max) |

**Design Intent**:
- Simple, single progression system
- Active play directly improves idle rate
- Clear milestone at 400 mugs (floor reached)
- 5x improvement from start to finish (100s â†’ 20s)

---

## Implementation Tasks

### 1. Add Level1Vars

**File**: `level1/level_1_vars.gd`

```gdscript
# Dishwash offline job progression
var offline_dishwash_seconds: int = 100  # Current interval (improves with mugs_washed)
var mugs_washed: int = 0  # Lifetime counter of mugs washed

# Constants
const MIN_DISHWASH_SECONDS: int = 20  # Floor for offline rate
const MUGS_PER_SECOND_REDUCTION: int = 5  # Every 5 mugs = 1 second faster
```

**Implementation details:**
- Add to save/load system
- Initialize to defaults if not present in save data

### 2. Create Dishwash Job Data Resource

**File**: `resources/jobs/dishwash.tres`

Create JobData resource with:
- `job_id`: "dishwash"
- `display_name`: "Dishwashing"
- `icon`: [dishwash icon texture]
- `scene_path`: "res://level1/dishwash_minigame.tscn"

**Note**: This resource is used by JobBoardManager for job assignment and navigation.

### 3. Increment Mugs Washed Counter

**File**: `level1/dishwash_minigame.gd`

Update `transition_to_dry()` function (when mug completes drying):

```gdscript
func transition_to_dry():
	current_mug_state = MugState.DRY
	dry_timer_start = 0.0
	dry_movement_bonus = 0.0
	$BoundMug/MugSprite.texture = MUG_CLEAN_TEXTURE

	# NEW: Increment mug counter
	Level1Vars.mugs_washed += 1
	_update_offline_dishwash_rate()

# NEW: Calculate and update offline rate based on mugs washed
func _update_offline_dishwash_rate():
	var reduction = floor(Level1Vars.mugs_washed / Level1Vars.MUGS_PER_SECOND_REDUCTION)
	Level1Vars.offline_dishwash_seconds = max(
		100 - reduction,
		Level1Vars.MIN_DISHWASH_SECONDS
	)
```

**Explanation**: Every time a mug transitions to DRY (completed), increment counter and recalculate offline rate.

### 4. Display Progression in Dishwash Scene

**File**: `level1/dishwash_minigame.gd`

Add UI label showing progression:

```gdscript
# In Menu section (right side)
@onready var progression_label = $AspectContainer/MainContainer/mainarea/Menu/ProgressionLabel

func update_ui():
	# Update mugs washed display
	var mugs = Level1Vars.mugs_washed
	var interval = Level1Vars.offline_dishwash_seconds
	var remaining_to_next = Level1Vars.MUGS_PER_SECOND_REDUCTION - (mugs % Level1Vars.MUGS_PER_SECOND_REDUCTION)

	progression_label.text = "Mugs Washed: %d\nIdle Rate: %ds/hole\n(%d mugs to next upgrade)" % [
		mugs,
		interval,
		remaining_to_next if interval > Level1Vars.MIN_DISHWASH_SECONDS else 0
	]
```

**Explanation**: Shows current progress and countdown to next improvement.

### 5. Register Dishwash Job with JobBoardManager

**File**: `job_board/job_board_manager.gd`

Ensure dishwash.tres is loaded and registered:

```gdscript
# In JobBoardManager initialization
func _ready():
	_load_jobs()

func _load_jobs():
	var dishwash_job = load("res://resources/jobs/dishwash.tres")
	registered_jobs["dishwash"] = dishwash_job
	# ... other jobs
```

**Explanation**: Makes dishwash available in Job Board UI and offline earnings system.

### 6. Unlock Dishwash Job on First Visit

**File**: `level1/dishwash_minigame.gd`

```gdscript
func _ready():
	ResponsiveLayout.apply_to_scene(self)

	# NEW: Unlock dishwash job on first visit
	if not Level1Vars.job_progress.has("dishwash"):
		Level1Vars.job_progress["dishwash"] = {
			"unlocked": true,
		}

	update_ui()
```

**Explanation**: First time player enters dishwash scene, unlock it in Job Board system.

---

## Integration with Job Board System

### How It Works Together

**Job Board (2.18) owns**:
- Job assignment UI (`Level1Vars.current_idle_job = "dishwash"`)
- Job unlocking and discovery
- Routing to job-specific earning functions
- `_process_dishwash_earnings()` - implemented in JobBoardManager

**This plan (2.19.8) owns**:
- Dishwash job data resource (dishwash.tres)
- Mug wash counter (`mugs_washed`)
- Dishwash-specific timer reduction (`offline_dishwash_seconds`)
- Integration with dishwash minigame

**Flow on Game Load** (player assigned dishwashing as idle job):

1. OfflineEarningsManager calls JobBoardManager.process_offline_session(7200)  # 2 hour cap
2. JobBoardManager routes to `_process_dishwash_earnings(7200)`
3. Calculates: `7200 seconds / offline_dishwash_seconds = holes earned`
4. Awards holes to player
5. Returns result to OfflineEarningsManager for notification

**Example Calculation** (100 mugs washed, 80s interval, 2 hour offline):
- `offline_dishwash_seconds = 80` (from mugs_washed progression)
- `7200 / 80 = 90 holes earned`

---

## Testing Strategy

### Manual Test Criteria

- [ ] Dishwash appears in Job Board after first visit to dishwash scene
- [ ] Can assign dishwashing as idle job
- [ ] Offline earnings calculate correctly (1 hole per 100s initially)
- [ ] Washing mugs increments `mugs_washed` counter
- [ ] Offline interval decreases every 5 mugs washed
- [ ] Offline interval stops at 20 second floor (after 400 mugs)
- [ ] UI shows current progression and countdown to next upgrade
- [ ] Save/load preserves mugs_washed and offline_dishwash_seconds
- [ ] Job Board notification shows dishwash earnings correctly

### Progression Test Scenarios

| Test | Setup | Action | Expected Result |
|------|-------|--------|-----------------|
| Initial unlock | First visit dishwash | Navigate to job board | Dishwash appears unlocked |
| Initial offline earnings | Set idle job, close 1 hour | Reopen game | 36 holes earned (3600/100) |
| Mug progression | Wash 5 mugs | Check offline_dishwash_seconds | Reduced to 99s |
| Floor test | Wash 400 mugs | Check offline_dishwash_seconds | Capped at 20s |
| Max earnings | 400 mugs washed, 1 hour offline | Reopen game | 180 holes (3600/20) |

---

## Files to Create

- `resources/jobs/dishwash.tres` - JobData resource for dishwashing

## Files to Modify

- `level1/level_1_vars.gd` - Add `offline_dishwash_seconds` and `mugs_washed` variables
- `level1/dishwash_minigame.gd` - Increment mug counter, unlock job, display progression
- `job_board/job_board_manager.gd` - Implement `_process_dishwash_earnings()` function

---

## Design Values (Reference)

### Offline Earnings

- **Starting rate**: 100 seconds per hole
- **Currency**: Holes
- **Floor rate**: 20 seconds per hole (after 400 mugs)

### Mug Progression

- **Starting interval**: 100 seconds
- **Reduction rate**: 1 second per 5 mugs washed
- **Total reduction**: 80 seconds (100 - 20)
- **Mugs to floor**: 400 mugs (80 * 5)
- **Improvement factor**: 5x (from 100s to 20s)

---

## Balance Tuning Notes

**Tuneable Parameters:**

- `MUGS_PER_SECOND_REDUCTION` in level_1_vars.gd - How many mugs per 1s reduction (currently 5)
- `MIN_DISHWASH_SECONDS` in level_1_vars.gd - Floor for offline rate (currently 20)
- Starting interval: 100 seconds (hardcoded in level_1_vars.gd initialization)

**Expected Player Progression:**

- **First 5 minutes**: Unlock dishwash, wash first few mugs, see idle rate improving
- **First 30 minutes**: Wash ~20 mugs, reduce idle rate to ~96s (4s improvement)
- **First hour**: Wash ~50 mugs, reduce idle rate to ~90s (10s improvement)
- **Long-term goal**: Wash 400 mugs to reach 20s floor (max optimization)

**Warning Signs:**

- If players ignore active dishwashing, reduce mug requirements or increase reduction per mug
- If progression feels too slow, decrease MUGS_PER_SECOND_REDUCTION (e.g., 3 mugs per reduction)
- If floor reached too quickly, increase mugs requirement or raise floor to 30s

---

## Notes & Decisions

**Decision: Single, simple progression system**
- **Rationale**: Direct connection between active play (washing mugs) and idle improvement
- **Alternatives considered**: Complex mastery tier system (rejected - unnecessary complexity)
- Mug counter is thematic and easy to understand
- Clear goal: reach 400 mugs for maximum efficiency
- Can add different progression systems for other jobs without conflicts

**Decision: Linear reduction (1s per 5 mugs)**
- **Rationale**: Simple, predictable progression
- **Alternatives considered**: Exponential reduction, tier-based thresholds
- Linear is easier to communicate and balance
- Players can calculate exactly how many mugs to next upgrade

**Decision: Floor at 20 seconds**
- **Rationale**: Prevents infinite optimization, maintains value of active play
- 20s = 3 holes per minute = 180 holes per hour (at floor + 1.0x efficiency)
- Combined with Master tier (0.5x): ~360 holes per hour max idle rate
- Still much worse than active play (encourages engagement)

**Decision: Unlock on first visit**
- **Rationale**: Immediate availability once discovered
- **Alternatives considered**: Require completing first rack, story unlock
- First visit is sufficient discovery
- Reduces friction to start earning offline

**Decision: Lifetime counter (never resets)**
- **Rationale**: Permanent progression feels rewarding
- `mugs_washed` is cumulative across all sessions
- Reaching 400 mugs is a long-term achievement
- Matches other permanent progression systems in the game

**Open Questions:**
- [ ] Should there be notifications when offline rate improves? (every 5 mugs)
- [ ] Should Job Board UI show dishwash-specific progression stats?
- [ ] Should the dishwash scene show estimated offline earnings per hour?

---

## Implementation Checklist

- [ ] Add offline_dishwash_seconds and mugs_washed to Level1Vars
- [ ] Create dishwash.tres JobData resource
- [ ] Implement `_process_dishwash_earnings()` in JobBoardManager
- [ ] Increment mugs_washed counter in transition_to_dry()
- [ ] Update offline_dishwash_seconds calculation after each mug
- [ ] Unlock dishwash job on first scene visit
- [ ] Add progression UI to dishwash scene
- [ ] Test offline earnings with dishwash assigned (36 holes/hour initially)
- [ ] Test mug progression (0 -> 5 -> 400 mugs)
- [ ] Test floor behavior (doesn't go below 20s)
- [ ] Test save/load preservation of mugs_washed
- [ ] Verify Job Board notification displays correctly
- [ ] Balance tuning pass on mug requirements and reduction rate

---

**Last Updated**: 2026-01-16
