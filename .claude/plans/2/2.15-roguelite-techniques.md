# Roguelite Techniques

**Goal**: Run-based variety through technique levelup system.

**Success Criteria**: Technique variety creates different run experiences

**Prerequisites**: Phase 2.1 and 2.2 complete

---

## Implementation Tasks

### 1. Internal Resource System
Add to `RunState.gd`:
```gdscript
var insight = 0
var experience = 0
var passion = 0
var drive = 0
var levelup_threshold = 25  # XP needed for levelup
```

### 2. Resource Earning

#### Experience (Primary)
- +1 per coal successfully shoveled
- Levelup triggers at 25, 50, 75, 100 experience, etc.

#### Insight (Discovery)
- +5 for first spill
- +10 for first demand event completion
- +15 for first time skipping rations (Phase 2.5)
- +5 for discovering new mechanic (shake patterns, etc.)

#### Passion (Excellence)
- +3 per demand event completion
- +1 per shovel during demand event
- +5 for exceeding coal quota

#### Drive (Adversity)
- +1 per shovel when stamina < 30%
- +2 when working with lactic acid > 50
- +3 for recovering from big mistake (3+ spills in a row)

### 3. Technique Data Structure

Create `res://data/techniques.gd`:

```gdscript
const TECHNIQUES = {
    # Emotional techniques (Insight + Passion)
    "inner_peace": {
        "name": "Inner Peace",
        "rarity": "rare",
        "cost": {"insight": 10, "passion": 5},
        "description": "Focus drains 20% slower",
        "effect": {"focus_efficiency": 0.2},
        "category": "emotional"
    },
    "determination": {
        "name": "Determination",
        "rarity": "rare",
        "cost": {"insight": 8, "passion": 8},
        "description": "Stamina drains 15% slower",
        "effect": {"stamina_efficiency": 0.15},
        "category": "emotional"
    },

    # Mental techniques (Insight + Experience)
    "pattern_recognition": {
        "name": "Pattern Recognition",
        "rarity": "rare",
        "cost": {"insight": 12, "experience": 10},
        "description": "See shake warnings 1s earlier",
        "effect": {"shake_warning_time": 1.0},
        "category": "mental"
    },
    "rhythm": {
        "name": "Rhythm",
        "rarity": "common",
        "cost": {"insight": 5, "experience": 5},
        "description": "+10% stamina if consistent pace (+-0.5s timing)",
        "effect": {"rhythm_bonus": 0.1},
        "category": "mental"
    },

    # Proprioceptive techniques (Experience + Drive)
    "balance": {
        "name": "Balance",
        "rarity": "common",
        "cost": {"experience": 8, "drive": 4},
        "description": "-15% spill chance",
        "effect": {"spill_reduction": 0.15},
        "category": "proprioceptive"
    },
    "economy_of_motion": {
        "name": "Economy of Motion",
        "rarity": "rare",
        "cost": {"experience": 12, "drive": 8},
        "description": "-12% stamina per shovel",
        "effect": {"stamina_per_shovel": -0.12},
        "category": "proprioceptive"
    },

    # ZONE-OUT TECHNIQUES (Action-Based Automation)
    # These stack with permanent zone-out progression from Phase 2.2

    "zone_out": {
        "name": "Zone Out",
        "rarity": "rare",
        "cost": {"experience": 15, "drive": 10},
        "description": "+35% chance to auto-shovel after each manual shovel",
        "effect": {"zone_out_chance": 0.35},
        "category": "proprioceptive"
    },
    "muscle_memory": {
        "name": "Muscle Memory",
        "rarity": "rare",
        "cost": {"experience": 12, "drive": 8},
        "description": "Auto-shovels cost 40% stamina (instead of 75%)",
        "effect": {"auto_shovel_stamina_mult": 0.40},
        "category": "proprioceptive"
    },
    "flow_state": {
        "name": "Flow State",
        "rarity": "epic",
        "cost": {"experience": 20, "passion": 15},
        "description": "Auto-shovels can chain (30% chance to trigger another)",
        "effect": {"auto_shovel_chain": 0.30},
        "category": "mental"
    },
    "autopilot": {
        "name": "Autopilot",
        "rarity": "legendary",
        "cost": {"experience": 25, "insight": 20, "drive": 15},
        "description": "Auto-shovels never spill, cost 25% stamina",
        "effect": {"auto_shovel_perfect": true, "auto_shovel_stamina_mult": 0.25},
        "category": "proprioceptive"
    },

    # Start with 10-14 techniques, expand to 30+ in Phase 2.6
}
```

### 4. Technique Levelup System

Create `res://systems/technique_manager.gd`:
- Track active techniques (max 2 slots initially)
- Offer 3 random techniques on levelup
- Rarity weights:
  - Common: 50%
  - Rare: 35%
  - Epic: 12%
  - Legendary: 3%
- **Intelligence effect**: +2% Epic chance, +1% Legendary chance per intelligence level
- When picked again: Strengthen effect by 50% (e.g., 10% -> 15%)

### 5. Technique Selection UI

Create `res://ui/technique_levelup_popup.tscn`:
- Pause work shift when levelup triggered
- Show 3 technique cards with:
  - Name, description, rarity (color-coded)
  - Cost (insight/experience/passion/drive)
  - Current effect (if owned)
  - "Choose" button
- After selection: Resume work, apply effect immediately
- Can open technique menu anytime during shift to view active techniques

### 6. Meta-Progression (Technique Slots)

Add to evening shop:
- **Technique Slot +1** (50c, 100c, 200c, 400c for slots 3-6)
- **Reroll** (10c): Reroll technique choices once per levelup
- **Banish** (15c): Remove unwanted technique from pool permanently

### 7. Technique Effects Implementation

Integrate into furnace_work.gd calculations:
- Stamina efficiency: Reduce cost per shovel
- Focus efficiency: Reduce focus drain
- Spill reduction: Lower spill chance
- Shake warning: Extend warning time before shake
- Rhythm bonus: Track shovel timing, apply bonus
- Special effects: Screen overlays, visual feedback

#### Zone-Out Integration Example
```gdscript
# After successful manual shovel in furnace_work.gd
func on_manual_shovel_complete():
    # Award coal, XP, etc.
    RunState.coal_count += get_shovel_capacity()
    Global.add_stat_exp("strength", 1)
    RunState.experience += 1
    Global.shovel_repetitions += 1

    # Check for auto-shovel trigger
    check_and_trigger_auto_shovel()

func check_and_trigger_auto_shovel():
    var total_chance = get_total_zone_out_chance()

    if randf() < total_chance:
        perform_auto_shovel()

func get_total_zone_out_chance() -> float:
    var chance = 0.0

    # Permanent progression (Phase 2.2)
    chance += Global.get_zone_out_chance()  # Max 45% from repetitions

    # Technique bonuses
    if TechniqueManager.has_active_technique("zone_out"):
        chance += 0.35

    # Cap at 95% (always some manual control)
    return min(chance, 0.95)

func perform_auto_shovel():
    # Visual: Semi-transparent shovel animates automatically
    var auto_shovel_anim = preload("res://effects/auto_shovel.tscn").instantiate()
    add_child(auto_shovel_anim)

    # Calculate stamina cost
    var base_cost = calculate_shovel_stamina_cost()
    var auto_cost_mult = Global.get_auto_shovel_stamina_mult()  # Default 75%

    # Technique override
    if TechniqueManager.has_active_technique("muscle_memory"):
        auto_cost_mult = 0.40
    if TechniqueManager.has_active_technique("autopilot"):
        auto_cost_mult = 0.25

    RunState.stamina -= base_cost * auto_cost_mult
    # NO focus cost for auto-shovels

    # Spill chance (reduced for auto-shovels)
    var spill_chance = calculate_spill_chance() * 0.5

    # Autopilot technique = perfect
    if TechniqueManager.has_active_technique("autopilot"):
        spill_chance = 0.0

    # Process coal
    if randf() > spill_chance:
        RunState.coal_count += get_shovel_capacity()
        Global.add_stat_exp("strength", 1)
        RunState.experience += 1
        Global.shovel_repetitions += 1

        # Check for chain (Flow State or Dissociation path)
        check_auto_shovel_chain()
    else:
        show_spill_effect()

func check_auto_shovel_chain():
    var chain_chance = 0.0

    # Permanent progression (Dissociation path)
    chain_chance += Global.get_auto_shovel_chain_chance()

    # Flow State technique
    if TechniqueManager.has_active_technique("flow_state"):
        chain_chance += 0.30

    if randf() < chain_chance:
        perform_auto_shovel()  # Recursive call creates chain
```

---

## TDD Requirements (Headless Tests)

Create `tests/test_phase_2_3.gd`:

```gdscript
# Test: Experience triggers levelup at threshold
func test_experience_levelup_trigger():
    RunState.experience = 24
    add_experience(1)
    assert_true(RunState.is_levelup_pending)

# Test: Technique selection applies effect
func test_technique_effect_application():
    select_technique("balance")  # -15% spill
    var base_spill = 10.0
    var modified_spill = apply_technique_effects(base_spill, "spill")
    assert_eq(modified_spill, 8.5)  # 10 * 0.85

# Test: Intelligence affects rarity chances
func test_intelligence_rarity_boost():
    Global.intelligence = 5
    var chances = calculate_rarity_chances()
    assert_true(chances.epic > 0.12)  # Base 12% + 5*2% = 22%

# Test: Technique strengthening on duplicate pick
func test_technique_strengthening():
    select_technique("balance")  # -15% spill
    var initial_effect = TechniqueManager.active_techniques["balance"].effect.spill_reduction
    select_technique("balance")  # Pick again
    var new_effect = TechniqueManager.active_techniques["balance"].effect.spill_reduction
    assert_eq(new_effect, initial_effect * 1.5)

# Test: Resource costs deducted on selection
func test_resource_cost_deduction():
    RunState.insight = 10
    RunState.passion = 5
    select_technique("inner_peace")  # Costs 10 insight, 5 passion
    assert_eq(RunState.insight, 0)
    assert_eq(RunState.passion, 0)

# Test: Max technique slots enforced
func test_technique_slot_limit():
    TechniqueManager.max_slots = 2
    select_technique("balance")
    select_technique("rhythm")
    var can_select = can_select_technique()
    assert_false(can_select)

# Test: Zone-out technique stacks with permanent progression
func test_zone_out_stacking():
    Global.shovel_repetitions = 5000  # 25% permanent
    select_technique("zone_out")  # +35% technique
    var total_chance = get_total_zone_out_chance()
    assert_eq(total_chance, 0.60)  # 25% + 35% = 60%

# Test: Auto-shovel chains with Flow State
func test_auto_shovel_chain():
    select_technique("flow_state")  # 30% chain chance
    var chained = false
    for i in range(50):
        if check_auto_shovel_chain():
            chained = true
            break
    assert_true(chained)

# Test: Autopilot prevents spills
func test_autopilot_no_spills():
    select_technique("autopilot")
    perform_auto_shovel()
    var spill_chance = calculate_auto_shovel_spill_chance()
    assert_eq(spill_chance, 0.0)

# Test: Muscle Memory reduces stamina cost
func test_muscle_memory_stamina():
    select_technique("muscle_memory")
    var base_cost = 5.0
    var auto_mult = get_auto_shovel_stamina_mult()
    assert_eq(auto_mult, 0.40)  # 40% cost
```

---

## Manual Test Criteria

- [ ] Levelup popup appears at 25 experience during shift
- [ ] 3 techniques offered with appropriate rarities
- [ ] Selected technique effect visible immediately
- [ ] Technique menu shows all active techniques
- [ ] Intelligence levelup increases Epic/Legendary chances
- [ ] Picking same technique twice strengthens it
- [ ] Can purchase additional technique slots in evening
- [ ] Reroll changes the 3 offered techniques
- [ ] Play 5-10 runs, verify technique variety
- [ ] Zone Out technique triggers auto-shovels frequently (35% + permanent)
- [ ] Muscle Memory makes auto-shovels very stamina-efficient
- [ ] Flow State creates satisfying auto-shovel chains
- [ ] Autopilot technique (legendary) creates perfect auto-shovels
- [ ] Zone-out build (Zone Out + Muscle Memory + Flow State) feels powerful

---

## Files to Create

- `res://data/techniques.gd` (technique definitions)
- `res://systems/technique_manager.gd` (autoload)
- `res://ui/technique_levelup_popup.gd/.tscn` (levelup UI)
- `res://ui/technique_menu.gd/.tscn` (view active techniques)
- `res://tests/test_phase_2_3.gd`

## Files to Modify

- `res://level1/furnace_work.gd`: Integrate technique effects, trigger levelups
- `res://level1/evening.gd`: Add meta-progression purchases
- `res://autoloads/run_state.gd`: Add internal resources
- `project.godot`: Add TechniqueManager autoload

---

## Design Values (Reference)

### Levelup System
- Trigger: Every 25 experience points
- Starting slots: 2
- Max slots: 6-8 (purchased with copper)
- Strengthening: +50% effect when picked again

### Rarity Distribution (Base)
- Common: 50%
- Rare: 35%
- Epic: 12%
- Legendary: 3%

### Intelligence Bonus
- +2% Epic chance per intelligence level
- +1% Legendary chance per intelligence level

### Internal Resources
Four resources earned during runs - used to unlock techniques when offered.

---
