# Dishwash: Auto-Dry Timer

**Goal**: Implement automatic drying after 7 seconds when WET mug leaves basin

**Success Criteria**: WET mug transitions to DRY after 7 seconds outside basin, completing the wash cycle

## Overview

Adds the final state transition: WET → DRY. After mug leaves basin in WET state, starts 7-second countdown timer. When timer completes, mug becomes DRY and can be racked. This completes the full manual wash cycle.

### Key Design Principles

- Timer starts only when WET mug exits basin (not DIRTY)
- 7-second countdown gives player time to move/position
- No movement acceleration yet (added in 2.25)
- Completes the full cycle: pick → soak → wait → rack

---

## Implementation Tasks

### 1. Add Timer Variables

Add to `dishwash_minigame.gd`:

```gdscript
var dry_timer_start: float = 0.0  # Timestamp when drying started

const AUTO_DRY_DURATION: float = 7.0  # Dry after 7 seconds
```

**Implementation details:**
- `dry_timer_start` stores timestamp from Time.get_ticks_msec()
- Value of 0.0 means timer not active
- Set when WET mug leaves basin

### 2. Start Timer on Basin Exit

Modify `_on_basin_area_exited()`:

```gdscript
func _on_basin_area_exited(area: Area2D):
	if area == $BoundMug:
		mug_in_basin = false
		$Basin/WaterParticles.emitting = false

		# NEW: Start dry timer only if mug is WET
		if current_mug_state == MugState.WET:
			dry_timer_start = Time.get_ticks_msec() / 1000.0  # Convert to seconds
```

**Explanation**: Timer only starts for WET mugs. DIRTY mugs leaving basin don't start timer (they need more soaking first).

### 3. Check Timer in _process()

Add to `_process()` function:

```gdscript
func _process(delta):
	if not visible:
		return

	# Update mug position (existing)
	if mug_bound_to_cursor:
		$BoundMug.global_position = get_global_mouse_position()

	# Basin soaking progress (existing)
	if current_mug_state == MugState.DIRTY and mug_in_basin:
		basin_soak_time += delta
		# (existing movement speedup logic)
		var current_pos = get_global_mouse_position()
		var distance_moved = current_pos.distance_to(last_mug_position)
		soak_movement_bonus += distance_moved / PIXELS_PER_SECOND_SAVED
		last_mug_position = current_pos

		var total_progress = basin_soak_time + soak_movement_bonus
		if total_progress >= REQUIRED_SOAK_TIME:
			transition_to_wet()

	# NEW: Auto-dry timer check
	if current_mug_state == MugState.WET and dry_timer_start > 0.0:
		var elapsed = (Time.get_ticks_msec() / 1000.0) - dry_timer_start
		if elapsed >= AUTO_DRY_DURATION:
			transition_to_dry()
```

**Explanation**: Checks elapsed time since timer started. When 7 seconds pass, transitions to DRY.

### 4. Implement transition_to_dry()

Add function (update from 2.22 debug version):

```gdscript
func transition_to_dry():
	current_mug_state = MugState.DRY
	dry_timer_start = 0.0  # Reset timer
	$BoundMug/MugSprite.texture = MUG_CLEAN_TEXTURE
```

**Explanation**: Changes state to DRY, resets timer, updates texture. Now rack placement will succeed.

### 5. Reset Timer Between Mugs

Update `bind_mug_to_cursor()`:

```gdscript
func bind_mug_to_cursor():
	mug_bound_to_cursor = true
	current_mug_state = MugState.DIRTY
	basin_soak_time = 0.0
	soak_movement_bonus = 0.0
	mug_in_basin = false
	dry_timer_start = 0.0  # NEW: Reset dry timer
	$BoundMug.visible = true
	$BoundMug/MugSprite.texture = MUG_DIRTY_TEXTURE
	$BoundMug.global_position = get_global_mouse_position()
	last_mug_position = get_global_mouse_position()
```

**Explanation**: Each new mug starts with clean state. No timer carryover.

### 6. Remove Debug Helper

Remove temporary debug code from 2.22:

```gdscript
# DELETE THIS:
func _input(event):
	if event is InputEventKey and event.pressed and event.keycode == KEY_D:
		if mug_bound_to_cursor and current_mug_state == MugState.WET:
			transition_to_dry()
```

**Explanation**: No longer needed - auto-dry timer now handles WET → DRY transition.

---

## Testing Strategy

### Manual Test Criteria

- [ ] Complete full cycle: pick → soak 4s → leave basin → wait 7s → rack
- [ ] Mug transitions from WET to DRY after 7 seconds outside basin
- [ ] Texture changes from wet to clean when DRY
- [ ] Timer doesn't start if DIRTY mug leaves basin
- [ ] Timer resets between mugs (doesn't carry over)
- [ ] Can rack DRY mug successfully (completes cycle)
- [ ] Hole awarded after 3 complete cycles
- [ ] Debug D key no longer works (removed)

### Full Cycle Test

1. Start washing session
2. Click dirty stack (bind DIRTY mug)
3. Move into basin, wait ~4 seconds (becomes WET, blue texture)
4. Move out of basin (particles stop, timer starts)
5. Wait 7 seconds while holding mug
6. Observe texture change to clean
7. Click rack (success - mug places, unbinds)
8. Repeat 2 more times
9. Verify 1 Hole awarded after 3rd cycle

---

## Files to Modify

- `c:\Goa\game\v0.1\level1\dishwash_minigame.gd` - Add timer logic, remove debug code

---

## Design Values (Reference)

### Timing Parameters

- **Auto-dry duration**: 7.0 seconds (AUTO_DRY_DURATION)
- **Timer precision**: Millisecond (Time.get_ticks_msec())
- **Timer activation**: Only when WET mug exits basin
- **Timer reset**: On new mug bind, on transition to DRY

### Full Cycle Timing

- **Pick mug**: Instant (click stack)
- **Soak**: ~4 seconds in basin (or faster with movement)
- **Dry**: 7 seconds outside basin
- **Rack**: Instant (click rack)
- **Total**: ~11-12 seconds per mug (optimal play)

---

## Notes & Decisions

**Decision: 7 seconds instead of shorter**
- Rationale: Gives player time to position for next mug
- Not punishing if player is slow
- Movement acceleration in 2.25 can shorten this
- Matches original plan specification

**Decision: Timer only for WET mugs leaving basin**
- Rationale: DIRTY mugs shouldn't start drying
- Prevents edge case of dirty → dry without wet
- Clearer state machine (must go through WET)
- More intuitive behavior

**Decision: Timestamp-based timer over accumulator**
- Rationale: Immune to pausing or delta fluctuations
- More accurate for longer durations
- Simpler to reason about
- Matches Godot best practices

**Decision: Reset timer on new mug**
- Rationale: Each mug independent
- Prevents carryover bugs
- Consistent with other state resets
- Clearer mental model

**Decision: Remove debug helper**
- Rationale: Auto-dry timer makes it unnecessary
- Reduces code complexity
- No longer needed for testing
- Cleaner codebase

**Decision: Timer check in _process() not Timer node**
- Rationale: Already have _process() running
- No need for separate Timer node
- Less scene hierarchy
- Simpler to manage state

**Decision: Timer stored as timestamp not duration**
- Rationale: Easier to check "time since" calculation
- Handles game pause correctly (if implemented later)
- Standard pattern for elapsed time checks
- More flexible for future modifications

---

**Last Updated**: 2026-01-14
