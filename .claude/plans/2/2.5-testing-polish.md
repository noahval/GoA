# Testing & Polish (Shovelling Phase 4)

**Goal**: Create comprehensive tests for the shovelling mechanic and tune physics values for satisfying gameplay.

**Success Criteria**:
- Unit test suite covers all tracking logic
- Integration tests verify multi-piece scenarios
- Manual test checklist completed
- Physics values tuned for satisfying feel
- No known bugs or edge cases

## Overview

This phase adds automated tests, performs manual testing, and tunes the physics values to achieve the desired gameplay feel. The focus is on ensuring correctness, catching regressions, and polishing the experience.

**Dependencies**:
- Requires Phase 2.2.3 (tracking system) to be complete
- All previous phases must be functional

---

## Implementation Tasks

### 1. Unit Test Suite

Create comprehensive unit tests for coal tracking logic.

**Create res://tests/test_phase_2_2_shovelling.gd:**
```gdscript
extends GutTest

# Setup helper - reset Level1Vars before each test
func before_each():
    if Level1Vars:
        Level1Vars.coal_delivered = 0
        Level1Vars.coal_dropped = 0

# Test: Coal delivered tracking increments correctly
func test_coal_delivered_tracking():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    # Set furnace position so coal is in valid area
    coal_piece.furnace_opening_bottom = 1000
    coal_piece.global_position.y = 500

    # Simulate delivery zone entry
    coal_piece._on_entered_delivery_zone()

    assert_eq(Level1Vars.coal_delivered, 1, "Should increment delivered counter")
    assert_true(coal_piece.has_been_tracked, "Should set tracked flag")

# Test: Coal dropped tracking increments after settle duration
func test_coal_dropped_tracking():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    # Set furnace opening position so coal is below it
    coal_piece.furnace_opening_bottom = 100
    coal_piece.global_position.y = 200  # Below opening

    # Simulate being still for required duration
    coal_piece.linear_velocity = Vector2.ZERO

    # Run physics process for 0.6 seconds (6 frames at 0.1s each)
    for i in range(6):
        coal_piece._physics_process(0.1)

    assert_eq(Level1Vars.coal_dropped, 1, "Should increment dropped counter")
    assert_true(coal_piece.has_been_tracked, "Should set tracked flag")

# Test: Coal doesn't count as dropped if moving too fast
func test_coal_not_dropped_if_moving():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    coal_piece.furnace_opening_bottom = 100
    coal_piece.global_position.y = 200

    # Set velocity above threshold
    coal_piece.linear_velocity = Vector2(100, 100)  # Speed: 141 px/sec > 50 threshold

    # Run physics process
    for i in range(10):
        coal_piece._physics_process(0.1)

    assert_eq(Level1Vars.coal_dropped, 0, "Should not count as dropped while moving")
    assert_false(coal_piece.has_been_tracked, "Should not set tracked flag")

# Test: Coal doesn't count as dropped if above furnace opening
func test_coal_not_dropped_if_above_opening():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    coal_piece.furnace_opening_bottom = 500
    coal_piece.global_position.y = 300  # Above opening
    coal_piece.linear_velocity = Vector2.ZERO

    # Run physics process
    for i in range(10):
        coal_piece._physics_process(0.1)

    assert_eq(Level1Vars.coal_dropped, 0, "Should not count as dropped if above opening")

# Test: Coal only increments counters once per piece
func test_coal_no_double_tracking():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    coal_piece.furnace_opening_bottom = 1000

    # Try to deliver twice
    coal_piece._on_entered_delivery_zone()
    coal_piece._on_entered_delivery_zone()

    assert_eq(Level1Vars.coal_delivered, 1, "Should only count once")

# Test: Coal physics properties are correct
func test_coal_physics_properties():
    var coal = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal)

    assert_eq(coal.mass, 0.8, "Mass should be 0.8")
    assert_eq(coal.gravity_scale, 1.0, "Gravity scale should be 1.0")
    assert_eq(coal.linear_damp, 0.8, "Linear damp should be 0.8")
    assert_eq(coal.angular_damp, 1.5, "Angular damp should be 1.5")

    # Check physics material
    assert_not_null(coal.physics_material_override, "Should have physics material")
    assert_eq(coal.physics_material_override.friction, 0.7, "Friction should be 0.7")
    assert_eq(coal.physics_material_override.bounce, 0.15, "Bounce should be 0.15")

# Test: Coal uses shared physics material (not creating new instances)
func test_coal_uses_shared_material():
    var coal1 = preload("res://level1/coal_piece.tscn").instantiate()
    var coal2 = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal1)
    add_child_autofree(coal2)

    # Check that both use the exact same resource instance
    assert_same(coal1.physics_material_override, coal2.physics_material_override,
                "Should share physics material resource")

# Test: Null-safe Level1Vars access doesn't crash
func test_null_safe_level1vars():
    # Temporarily remove Level1Vars reference (simulated)
    var original_level1vars = Level1Vars

    # Create coal without Level1Vars
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    coal_piece.furnace_opening_bottom = 1000

    # This should not crash
    coal_piece._on_entered_delivery_zone()

    # Restore Level1Vars
    # (Note: This test is illustrative - actual implementation depends on test framework)

# Test: Settle timer resets when coal starts moving again
func test_settle_timer_resets_on_movement():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    coal_piece.furnace_opening_bottom = 100
    coal_piece.global_position.y = 200

    # Start settling
    coal_piece.linear_velocity = Vector2.ZERO
    for i in range(3):  # 0.3 seconds
        coal_piece._physics_process(0.1)

    # Check timer accumulated
    assert_gt(coal_piece.settle_timer, 0.2, "Settle timer should accumulate")

    # Start moving again
    coal_piece.linear_velocity = Vector2(100, 0)
    coal_piece._physics_process(0.1)

    # Timer should reset
    assert_eq(coal_piece.settle_timer, 0.0, "Settle timer should reset on movement")
```

**Run tests:**
```bash
# If using GUT (Godot Unit Testing)
godot --headless --script res://addons/gut/gut_cmdln.gd -gtest=res://tests/test_phase_2_2_shovelling.gd
```

### 2. Integration Test Scenarios

Manual integration tests to verify complete system behavior.

**Test scenarios checklist:**

- [ ] **Scoop and deliver all coal**
  - Scoop 5 coal pieces
  - Slowly move to furnace
  - Tilt shovel to slide all coal into opening
  - Verify: coal_delivered = 5, coal_dropped = 0

- [ ] **Drop all coal mid-transit**
  - Scoop 5 coal pieces
  - Move shovel rapidly to make all coal fall
  - Wait for coal to settle
  - Verify: coal_dropped = 5, coal_delivered = 0

- [ ] **Mixed delivery and drops**
  - Scoop 5 coal pieces
  - Lose 2 pieces while moving (rapid movement)
  - Deliver remaining 3 pieces
  - Verify: coal_delivered = 3, coal_dropped = 2

- [ ] **Hit furnace obstacle**
  - Scoop coal
  - Aim for area above/below opening (obstacles)
  - Coal bounces off
  - Verify: Coal bounces naturally, eventually drops or can be re-scooped

- [ ] **Multiple scoops**
  - Scoop coal 3 times (total 15 pieces)
  - Deliver some, drop others
  - Verify: Counters accumulate correctly across multiple scoops

- [ ] **Boundary cleanup**
  - Scoop coal
  - Move shovel outside playarea bounds
  - Verify: Coal disappears, counters don't change

- [ ] **Scoop cooldown**
  - Rapidly attempt to scoop 5 times
  - Verify: Only scoops occur every 0.4+ seconds (not every attempt)

- [ ] **Coal stacking**
  - Scoop multiple times to accumulate coal on shovel
  - Verify: Coal pieces stack on each other, friction prevents sliding apart

### 3. Physics Tuning

Adjust physics values based on manual testing feedback.

**Tuning parameters (priority order):**

1. **Coal friction** (current: 0.7)
   - Test: Does coal grip the shovel naturally?
   - Too slippery: Increase to 0.8 or 0.9
   - Too sticky: Decrease to 0.5 or 0.6

2. **Furnace opening height** (current: 200px)
   - Test: Is the target too hard or too easy?
   - Too hard: Increase to 250px or 300px
   - Too easy: Decrease to 150px or 180px

3. **Coal mass** (current: 0.8)
   - Test: Does coal feel weighty or floaty?
   - Too floaty: Increase to 1.0 or 1.2
   - Too heavy: Decrease to 0.6 or 0.7

4. **Linear damp** (current: 0.8)
   - Test: Does coal settle quickly or bounce endlessly?
   - Too bouncy: Increase to 1.0 or 1.2
   - Too dead: Decrease to 0.6 or 0.7

5. **Scoop cooldown** (current: 0.4s)
   - Test: Does scooping feel responsive or sluggish?
   - Too sluggish: Decrease to 0.2s or 0.3s
   - Too spammy: Increase to 0.5s or 0.6s

6. **Settle velocity threshold** (current: 50 px/sec)
   - Test: Does coal count as dropped appropriately?
   - Counts too soon: Decrease to 30 or 40 px/sec
   - Counts too late: Increase to 70 or 80 px/sec

**Tuning process:**
1. Play the game for 5-10 minutes
2. Note specific issues ("coal falls off too easily", "opening too small")
3. Adjust ONE parameter at a time
4. Test again for 2-3 minutes
5. Repeat until feel is satisfying

### 4. Manual Test Checklist

Complete visual and interaction verification.

**Visual elements:**
- [ ] Coal pile visible in bottom-left
- [ ] Coal pile is visually distinct (dark gray mound)
- [ ] Furnace line visible on right side
- [ ] Furnace opening gap clear and centered
- [ ] Shovel curve renders smoothly
- [ ] Shovel follows mouse with no visible lag
- [ ] Coal pieces visible (black circles/lumps)
- [ ] All elements distinguishable from each other

**Interaction:**
- [ ] Shovel enters coal pile area (visual feedback if added)
- [ ] Scooping motion (down then up) spawns coal
- [ ] Coal appears on shovel in expected positions
- [ ] Coal rests on shovel when stationary
- [ ] Slow shovel movement keeps coal on shovel
- [ ] Fast shovel movement causes coal to fall off
- [ ] Tilting shovel causes coal to slide toward lower side
- [ ] Coal bounces off furnace obstacles naturally
- [ ] Coal entering opening disappears (delivered)
- [ ] Coal settling below opening disappears after delay (dropped)
- [ ] Scoop cooldown prevents spam (not instantaneous re-scoop)

**Physics feel:**
- [ ] Coal has weight (not floaty)
- [ ] Coal grips shovel surface (friction)
- [ ] Coal pieces cluster together (friction between pieces)
- [ ] Coal settles quickly (doesn't bounce endlessly)
- [ ] Coal doesn't spin excessively
- [ ] Fast movement feels risky (coal slides off)
- [ ] Slow movement feels safe (coal stays on)
- [ ] Overall feel is satisfying and skill-based

**Edge cases:**
- [ ] No coal gets "lost" (all accounted for)
- [ ] No console errors during normal play
- [ ] No console errors when coal leaves boundary
- [ ] No console errors when rapid scooping
- [ ] Performance acceptable with 20+ coal pieces

---

## Files Created

- `tests/test_phase_2_2_shovelling.gd` - Unit test suite

## Files Modified

- `level1/coal_physics_material.tres` - Physics tuning adjustments
- Potentially other files based on tuning results

---

## Performance Benchmarks

**Target performance:**
- 60 FPS with 20 simultaneous coal pieces
- No stuttering during scooping
- No physics tunneling (coal phasing through objects)

**Monitor:**
- Frame time (should stay below 16ms for 60 FPS)
- Physics tick time
- Number of active RigidBody2D nodes

**Optimization if needed:**
- Reduce coal pieces per scoop (5 â†’ 3 or 4)
- Increase linear/angular damp (faster settling = fewer active physics)
- Use simpler collision shapes (already using circles - simplest)

---

## Known Limitations & Future Improvements

**Current limitations:**
- Coal pile doesn't deplete (infinite source)
- No visual feedback for scoop cooldown
- No particle effects or juice
- No sound effects
- No score or efficiency rating
- Counters not displayed in UI (debug only)

**Future enhancements (post-Phase 2.2):**
- Coal pile depletion and refill mechanics
- Cooldown indicator (visual cue when can scoop)
- Particle effects (coal dust, furnace glow)
- Sound effects (scoop sound, coal landing, furnace whoosh)
- UI panel showing delivered/dropped counts
- Efficiency rating (e.g., "95% delivery rate")
- Score/time tracking for competitive play
- Combo system (consecutive deliveries)

---

## Definition of Done

**This phase is complete when:**
- [ ] All unit tests pass
- [ ] All integration test scenarios verified
- [ ] Manual test checklist 100% complete
- [ ] Physics values tuned and documented
- [ ] No known bugs or edge cases
- [ ] Performance benchmarks met (60 FPS with 20+ coal)
- [ ] Code reviewed for clarity and maintainability
- [ ] All debug print statements removed or commented

**Shovelling mechanic is ready for:**
- Integration with day cycle system
- Integration with shop/upgrade system
- Addition of UI panels
- Addition of audio/visual polish

---

## Notes

**Why unit tests before integration tests?**
- Catches logic errors early
- Easier to debug isolated components
- Faster feedback loop during development
- Prevents regressions when adding features

**Why manual testing is still important:**
- Feel and satisfaction can't be automated
- Edge cases may not be covered by scripts
- Player experience requires human judgment
- Physics interactions are emergent and complex

**Tuning philosophy:**
- Start with conservative values (current plan values)
- Adjust based on feel, not theory
- Prioritize satisfying gameplay over realism
- Accept that perfect balance takes iteration

**Test coverage priorities:**
1. Correctness (tracking logic, no duplicates)
2. Null-safety (no crashes)
3. Edge cases (boundary cleanup, rapid actions)
4. Feel (physics tuning, qualitative assessment)

---

## Completion Checklist

- [ ] test_phase_2_2_shovelling.gd created and passing
- [ ] Integration test scenarios completed
- [ ] Manual test checklist completed
- [ ] Physics tuning complete and documented
- [ ] Performance benchmarks met
- [ ] No console errors during extended play session (10+ minutes)
- [ ] Code reviewed
- [ ] Debug helpers removed
- [ ] Phase 2.2 implementation complete
