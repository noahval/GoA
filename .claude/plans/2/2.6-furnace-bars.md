# Furnace Progress Bars

**Goal**: Add visual progress bars to the furnace scene menu to track stamina (green), focus (blue), and XP (dark orange) resources in real-time

**Success Criteria**:
- Three progress bars visible in furnace scene menu
- Stamina bar displays current/max stamina in green
- Focus bar displays current/max focus in blue
- XP bar displays progress to next level in dark orange
- Bars update automatically when stats change via signals
- Bars follow theme design guidelines from [1.9-default-theme.md](../1/1.9-default-theme.md)

## Overview

The furnace scene currently has no visual feedback for stamina, focus consumption, and XP progression. Players need to see their resource levels while performing physical (stamina) and mental (focus) actions, as well as track their progress toward the next level. This feature adds three horizontal progress bars to the existing Menu area in the furnace scene, connected to the Level1Vars autoload signals for automatic updates.

### Key Design Principles

- Use ProgressBar template from [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar) (lines 316-333)
- Use named progress bars from [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar-variables):
  - "stamina" (yellow-green) - already defined
  - "focus" (light blue) - already defined
  - "player_xp" (dark orange) - new, defined in this plan
- Use signal-based updates (no polling) for performance
- Positioned in Menu VBoxContainer per [1.10-responsive-layout.md](../1/1.10-responsive-layout.md#layout-structure) (vertically stacked)

---

## Implementation Tasks

### 1. Add ProgressBar Nodes

**Scene tree structure:**
```
AspectContainer/MainContainer/mainarea/Menu/
  -> StaminaBar (ProgressBar) - exists in scene
  -> FocusBar (ProgressBar) - exists in scene
  -> XPBar (ProgressBar) - created programmatically
  -> ToMindButton (existing)
```

**StaminaBar and FocusBar** (existing nodes in furnace.tscn):
- Already set up in scene with proper styling
- Reference: Plan 2.6 original implementation

**XPBar** (created programmatically in code):
- No manual scene editing required
- Created in `furnace.gd` via `setup_xp_bar()` function
- Automatically positioned between FocusBar and ToMindButton
- Styled with dark orange fill color

**Why programmatic creation for XPBar?**
- Consistent with other dynamic elements (camera, delivery zones, etc.)
- No risk of scene file conflicts
- Styling defined in code is easier to maintain
- Can be easily modified without opening Godot Editor

### 2. Create XP Bar Programmatically

**File**: [furnace.gd](../../game/v0.1/level1/furnace.gd)

Add `setup_xp_bar()` function that creates and styles the XP bar:

```gdscript
func setup_xp_bar():
	# Create XP bar programmatically
	var menu = $AspectContainer/MainContainer/mainarea/Menu
	if not menu:
		push_error("Menu node not found - cannot create XP bar")
		return

	# Create ProgressBar
	xp_bar = ProgressBar.new()
	xp_bar.name = "XPBar"
	xp_bar.custom_minimum_size = Vector2(0, 20)  # Match StaminaBar/FocusBar height
	xp_bar.min_value = 0
	xp_bar.max_value = 100
	xp_bar.value = 0
	xp_bar.show_percentage = false

	# Create and style background
	var bg_style = StyleBoxFlat.new()
	bg_style.bg_color = Color(0.2, 0.2, 0.2, 0)  # Transparent dark grey
	bg_style.border_width_left = 1
	bg_style.border_width_right = 1
	bg_style.border_width_top = 1
	bg_style.border_width_bottom = 1
	bg_style.border_color = Color(0.3, 0.3, 0.3, 0.5)
	bg_style.corner_radius_top_left = 2
	bg_style.corner_radius_top_right = 2
	bg_style.corner_radius_bottom_left = 2
	bg_style.corner_radius_bottom_right = 2

	# Create and style fill (dark orange)
	var fill_style = StyleBoxFlat.new()
	fill_style.bg_color = Color(0.7, 0.35, 0.05, 0.3)  # Dark orange, 30% opacity
	fill_style.corner_radius_top_left = 2
	fill_style.corner_radius_top_right = 2
	fill_style.corner_radius_bottom_left = 2
	fill_style.corner_radius_bottom_right = 2

	# Apply styles
	xp_bar.add_theme_stylebox_override("background", bg_style)
	xp_bar.add_theme_stylebox_override("fill", fill_style)

	# Add to menu (will be positioned by VBoxContainer)
	# Insert after FocusBar (index 1), before ToMindButton
	menu.add_child(xp_bar)
	menu.move_child(xp_bar, 2)  # Position: StaminaBar(0), FocusBar(1), XPBar(2), ToMindButton(3)
```

**Call in _ready():**
```gdscript
func _ready():
	# ... existing setup ...
	setup_xp_bar()  # Create XP bar before connecting signals
	connect_resource_bars()
	# ... rest of setup ...
```

**Styling follows Plan 1.9 theme:**
- Background: Transparent dark grey with subtle border
- Fill: Dark orange `Color(0.7, 0.35, 0.05, 0.3)` - 30% opacity
- Corner radius: 2px (all corners)
- Matches existing StaminaBar and FocusBar style

### 3. Connect Signal Handlers in furnace.gd

Add signal connections and update handlers to [furnace.gd](../../game/v0.1/level1/furnace.gd):

**Variables needed:**
```gdscript
# In furnace.gd
@onready var stamina_bar: ProgressBar = $AspectContainer/MainContainer/mainarea/Menu/StaminaBar
@onready var focus_bar: ProgressBar = $AspectContainer/MainContainer/mainarea/Menu/FocusBar

# XP bar created programmatically (not @onready)
var xp_bar: ProgressBar = null
```

**Connect signals in _ready():**
```gdscript
func _ready():
	ResponsiveLayout.apply_to_scene(self)  # REQUIRED (existing)
	connect_navigation()  # Existing

	# Connect resource signals from level_1_vars
	connect_resource_bars()

	# Defer physics setup until after layout is applied
	await get_tree().process_frame
	setup_physics_objects()

func connect_resource_bars():
	# Connect to Level1Vars signals
	Level1Vars.stamina_changed.connect(_on_stamina_changed)
	Level1Vars.focus_changed.connect(_on_focus_changed)
	Level1Vars.player_exp_changed.connect(_on_player_exp_changed)

	# Initialize bars with current values
	_on_stamina_changed(Level1Vars.stamina, Level1Vars.stamina_max)
	_on_focus_changed(Level1Vars.focus, Level1Vars.focus_max)
	_on_player_exp_changed(Level1Vars.player_exp, Level1Vars.get_xp_for_next_level())

func _on_stamina_changed(new_value: float, max_value: float):
	stamina_bar.max_value = max_value
	stamina_bar.value = new_value

func _on_focus_changed(new_value: int, max_value: int):
	focus_bar.max_value = max_value
	focus_bar.value = new_value

func _on_player_exp_changed(new_value: float, xp_for_next_level: float):
	xp_bar.max_value = xp_for_next_level
	xp_bar.value = new_value
```

**Implementation details:**
- Signals are already defined in [level_1_vars.gd](../../game/v0.1/level1/level_1_vars.gd)
- `stamina_changed` and `focus_changed` emit (new_value, max_value)
- `player_exp_changed` needs to be added to Level1Vars (see notes below)
- Bars automatically update when `modify_stamina()`, `modify_focus()`, or `add_player_exp()` are called
- Initial values set on scene load to display current state
- **Note**: The autoload is named `Level1Vars` (not `level_1_vars`) per project.godot

**NEW SIGNAL REQUIRED in Level1Vars**:
```gdscript
# Add to level_1_vars.gd signals section (around line 78):
signal player_exp_changed(new_exp: float, xp_for_next_level: float)

# Emit in add_player_exp() function after updating player_exp:
func add_player_exp(amount: float) -> void:
	if amount <= 0:
		return

	player_exp += amount
	emit_signal("player_exp_changed", player_exp, get_xp_for_next_level())  # ADD THIS

	# Check for level-up(s)
	while player_exp >= get_xp_for_next_level():
		player_exp -= get_xp_for_next_level()
		player_level += 1
		_show_levelup_notification()
		emit_signal("player_exp_changed", player_exp, get_xp_for_next_level())  # ADD THIS (after level-up)
```

### 4. Add Optional Labels (Future Enhancement)

Consider adding Label nodes to display numeric values:

**Structure:**
```
StaminaBar
  -> StaminaLabel (Label) - "Stamina: 50/100"
FocusBar
  -> FocusLabel (Label) - "Focus: 50/100"
```

**Implementation (optional):**
```gdscript
@onready var stamina_label: Label = $AspectContainer/MainContainer/mainarea/Menu/StaminaBar/StaminaLabel
@onready var focus_label: Label = $AspectContainer/MainContainer/mainarea/Menu/FocusBar/FocusLabel

func _on_stamina_changed(new_value: int, max_value: int):
	stamina_bar.max_value = max_value
	stamina_bar.value = new_value
	stamina_label.text = "Stamina: %d/%d" % [new_value, max_value]

func _on_focus_changed(new_value: int, max_value: int):
	focus_bar.max_value = max_value
	focus_bar.value = new_value
	focus_label.text = "Focus: %d/%d" % [new_value, max_value]
```

**Note**: Labels are optional. Start with visual bars only, add labels if players request numeric feedback.

---

## Code Examples

### Complete Signal Flow

**How bars update when stamina is consumed:**

```gdscript
# Somewhere in game logic (e.g., when shoveling coal):
Level1Vars.modify_stamina(-5)  # Consume 5 stamina

# Inside level_1_vars.gd (existing code):
func modify_stamina(amount: int) -> bool:
    stamina = clampi(stamina + amount, 0, stamina_max)
    emit_signal("stamina_changed", stamina, stamina_max)  # Signal emitted
    return true

# Inside furnace.gd (new code):
func _on_stamina_changed(new_value: int, max_value: int):
    stamina_bar.max_value = max_value  # Update bar capacity
    stamina_bar.value = new_value      # Update bar fill
```

**Result**: Bar automatically updates without polling or manual refresh.

---

## Testing Strategy

### Manual Test Criteria

**Visual appearance:**
- [ ] StaminaBar visible in furnace scene Menu area
- [ ] FocusBar visible in furnace scene Menu area
- [ ] XPBar visible in furnace scene Menu area
- [ ] StaminaBar fill is yellow-green color (matches theme)
- [ ] FocusBar fill is light blue color (matches theme)
- [ ] XPBar fill is dark orange color `Color(0.7, 0.35, 0.05, 0.3)`
- [ ] All bars have transparent background with subtle border
- [ ] Corner radius is 2px (rounded corners)
- [ ] Bars are approximately 20px height
- [ ] Bars positioned clearly, not overlapping navigation buttons

**Functionality:**
- [ ] All bars display correct initial values on scene load
- [ ] StaminaBar updates when `Level1Vars.modify_stamina()` is called
- [ ] FocusBar updates when `Level1Vars.modify_focus()` is called
- [ ] XPBar updates when `Level1Vars.add_player_exp()` is called
- [ ] XPBar empties and max value updates on level-up
- [ ] Bars correctly handle max value changes (e.g., stamina_max increases)
- [ ] Bars clamp at 0 (empty) and max value (full)
- [ ] No console errors on scene load

**Interactive testing:**
- [ ] Open Debug Console (F3 or similar)
- [ ] Test stamina change: `Level1Vars.modify_stamina(-20)` -> Bar decreases
- [ ] Test stamina restore: `Level1Vars.modify_stamina(30)` -> Bar increases
- [ ] Test focus change: `Level1Vars.modify_focus(-15)` -> Bar decreases
- [ ] Test focus restore: `Level1Vars.modify_focus(25)` -> Bar increases
- [ ] Test XP gain: `Level1Vars.add_player_exp(5.0)` -> XP bar increases
- [ ] Test level-up: `Level1Vars.add_player_exp(20.0)` -> XP bar resets, max updates
- [ ] Test full restore: `Level1Vars.restore_all_resources()` -> Stamina and focus bars full

**Edge cases:**
- [ ] Set stamina to 0: `Level1Vars.stamina = 0` + emit signal -> Bar empty
- [ ] Set stamina to max: `Level1Vars.stamina = 100` + emit signal -> Bar full
- [ ] Modify beyond bounds: `modify_stamina(-200)` -> Bar stays at 0, no crash
- [ ] Modify beyond bounds: `modify_stamina(200)` -> Bar stays at max, no crash

---

## Files to Create

None - all changes are modifications to existing files

## Files to Modify

- [furnace.tscn](../../game/v0.1/level1/furnace.tscn) - Add StaminaBar and FocusBar ProgressBar nodes to Menu area with theme styling
- [furnace.gd](../../game/v0.1/level1/furnace.gd) - Add @onready references, signal connections, and update handlers

---

## Design Values (Reference)

### Progress Bar Styling

**ALL styling values are defined in [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar).**

**Quick reference for this implementation:**
- **Stamina bar**: `progress_bars["stamina"]` - `Color(0.2, 0.9, 0.3, 0.3)` yellow-green
- **Focus bar**: `progress_bars["focus"]` - `Color(0.3, 0.6, 1, 0.3)` light blue
- **XP bar**: `progress_bars["player_xp"]` - `Color(0.7, 0.35, 0.05, 0.3)` dark orange
- **Template structure**: Lines 316-333 in [1.9-default-theme.md](../1/1.9-default-theme.md)
- **Height**: ~20px scaled with resolution per [1.10-responsive-layout.md](../1/1.10-responsive-layout.md)

### Resource Stats (From level_1_vars.gd)

- **Stamina starting value**: 50
- **Stamina max**: 100
- **Focus starting value**: 50
- **Focus max**: 100
- **Player XP starting value**: 0.0
- **Player level starting value**: 1
- **Signal names**: `stamina_changed`, `focus_changed`, `player_exp_changed`
- **Signal parameters**:
  - `stamina_changed(new_value: float, max_value: float)`
  - `focus_changed(new_value: int, max_value: int)`
  - `player_exp_changed(new_exp: float, xp_for_next_level: float)`

---

## UI Mockups

**Furnace Scene Menu Area (with progress bars):**

```
+----------------------------------------+
|  Menu Area (top-left of screen)       |
|                                        |
| Stamina: [########----------] 50/100   | <- Green bar
| Focus:   [######------------] 40/100   | <- Blue bar
| XP:      [###---------------] 5/17     | <- Dark orange bar
|                                        |
| [ To Mind ]  (navigation button)       |
+----------------------------------------+
```

**Visual appearance:**
- Green bar: Translucent yellow-green fill on dark grey background
- Blue bar: Translucent light blue fill on dark grey background
- Dark orange bar: Translucent dark orange fill on dark grey background
- All bars: Subtle grey border, 2px rounded corners
- Bars resize with responsive layout

## Balance Tuning Notes

Not applicable for this feature - pure UI display with no gameplay balance implications.

**Note**: Balance tuning for stamina/focus consumption rates should be documented in the plans where those mechanics are implemented (e.g., shovel actions, puzzle solving).

---

## Notes & Decisions

**Decision 1:** Use signal-based updates instead of polling
- **Rationale**: More performant and reactive. Bars update immediately when stats change without constantly checking values in _process()
- **Benefit**: Signals already exist in level_1_vars.gd, no additional infrastructure needed

**Decision 2:** Use existing named progress bars from [1.9-default-theme.md](../1/1.9-default-theme.md)
- **Rationale**:
  - Stamina and focus bars already defined in theme progress_bars dictionary
  - Yellow-green for stamina = positive resource (standard game UI convention)
  - Light blue for focus = mental/magic resource (standard game UI convention)
  - Hierarchical updates: changes to template in plan 1.9 automatically apply to all progress bars
- **Benefit**: No styling duplication, consistent with future progress bars

**Decision 3:** Place bars in Menu VBoxContainer (vertical stack)
- **Rationale**:
  - Menu is VBoxContainer per [1.10-responsive-layout.md](../1/1.10-responsive-layout.md) (line 99)
  - Items stack vertically, not side-by-side
  - Menu area is UI space, separate from gameplay/physics space (PlayArea)
  - Menu already contains navigation buttons - natural location for status displays
- **Benefit**: Clean separation of UI and gameplay elements, consistent with responsive layout structure

**Decision 4:** Start with visual-only bars, add numeric labels later if needed
- **Rationale**:
  - Visual bars provide quick at-a-glance feedback during fast-paced gameplay
  - Numeric values might clutter UI or distract from action
  - Easy to add labels later if players request precise numbers
- **Alternatives considered**:
  - Labels from start (rejected - test visual-only first)
  - Percentage display (rejected - raw values more meaningful)

**Decision 5:** Reference global theme definitions instead of duplicating styling
- **Rationale**:
  - Progress bar template and named bars already defined in [1.9-default-theme.md](../1/1.9-default-theme.md)
  - Hierarchical approach: changes to template propagate to all progress bars automatically
  - Prevents style drift and inconsistency across scenes
- **Benefit**: Single source of truth for progress bar styling, easier to maintain

**Open Questions:**
- [ ] Should bars have labels showing numeric values? (Test without first)
- [ ] Should bars animate when values change? (Implement smooth transitions or instant updates? - Critical for game feel)
- [ ] Do bars need tooltips explaining what stamina/focus do? (Wait for playtesting feedback)

---

## Implementation Checklist

**Scene setup:**
- [ ] StaminaBar ProgressBar node exists in furnace.tscn Menu area (already done)
- [ ] FocusBar ProgressBar node exists in furnace.tscn Menu area (already done)
- [ ] XPBar created programmatically via setup_xp_bar() (no scene editing needed)

**Code implementation:**
- [ ] player_exp_changed signal added to Level1Vars
- [ ] Signal emission added to add_player_exp() in Level1Vars (after XP gain and after level-up)
- [ ] xp_bar variable declared in furnace.gd (regular var, not @onready)
- [ ] setup_xp_bar() function created in furnace.gd
- [ ] XPBar created with ProgressBar.new()
- [ ] XPBar styled with StyleBoxFlat (background and fill)
- [ ] XPBar added to Menu VBoxContainer at correct position
- [ ] setup_xp_bar() called in _ready() before connect_resource_bars()
- [ ] @onready references for StaminaBar and FocusBar remain unchanged
- [ ] connect_resource_bars() function connects all three bar signals
- [ ] Signal connections to Level1Vars.stamina_changed added
- [ ] Signal connections to Level1Vars.focus_changed added
- [ ] Signal connections to Level1Vars.player_exp_changed added
- [ ] _on_stamina_changed() handler implemented
- [ ] _on_focus_changed() handler implemented
- [ ] _on_player_exp_changed() handler implemented
- [ ] Initial bar values set on scene load

**Testing:**
- [ ] All bars visible in furnace scene
- [ ] Bars display correct colors (green/blue/dark orange)
- [ ] Bars show correct initial values
- [ ] Stamina bar updates when modify_stamina() called
- [ ] Focus bar updates when modify_focus() called
- [ ] XP bar updates when add_player_exp() called
- [ ] XP bar resets on level-up and updates max value
- [ ] Bars handle edge cases (0, max, overflow) correctly
- [ ] No console errors on scene load
- [ ] Responsive layout doesn't break bar display

**Polish:**
- [ ] Bars resize appropriately with resolution changes
- [ ] Bar positioning looks good at target resolution (1438x817)
- [ ] Optional: Add numeric labels if visual feedback insufficient
- [ ] Optional: Add smooth animation to bar value changes

---

**Last Updated**: 2025-12-14
**Status**: Planning complete - ready for implementation
