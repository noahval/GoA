# Day End & Pay Scene

**Goal**: Transition from furnace scene to pay scene when stamina or focus reaches 0, display run statistics, calculate pay, and navigate to dorm

**Success Criteria**:
- Day ends immediately when stamina reaches 0 during furnace scene (focus drain not implemented yet)
- Transition from furnace scene to new pay scene
- Pay scene displays coal delivered and coal dropped stats
- Pay calculated using simple formula: 1 copper per 25 coal delivered (integer division rounds down)
- Pay formula includes validation to prevent crashes from invalid values
- Pay formula uses adjustable variables in level_1_vars for easy tuning
- Light blue nav button labeled "Dorm" transitions to dorm scene
- Pay scene uses pay.jpg or pay.png background from backgrounds folder

## Overview

The furnace scene currently has no end condition - players can shovel coal indefinitely. This creates the day cycle end mechanic: when stamina or focus hits 0, the work day ends. The game transitions to a pay scene showing performance stats (coal delivered vs dropped) and calculates payment based on delivery performance. From there, the player navigates to the dorm scene to rest and prepare for the next day.

### Key Design Principles

- **Immediate transition on resource depletion**: No delay, no warning dialog - 0 stamina/focus = instant scene transition
- **Simple pay formula initially**: Keep math basic and tuneable for early balancing
- **Non-interactive summary scene**: Pay scene is pure information display + navigation, no gameplay
- **Background follows scene template pattern**: Uses background auto-loading from [1.12-scene-template.md](../1/1.12-scene-template.md#background-auto-loading)
- **Light blue nav button**: Uses ForwardNavButton theme from [1.9-default-theme.md](../1/1.9-default-theme.md#3-forwardnavbutton-light-blue)

**Dependencies**:
- Requires [2.6-furnace-bars.md](2.6-furnace-bars.md) for stamina and focus bar display
- Requires [2.7-stamina-drain.md](2.7-stamina-drain.md) for stamina depletion mechanic
- Requires Level1Vars.coal_delivered and coal_dropped tracking (from [2.5-coal-delivery-drop.md](2.5-coal-delivery-drop.md))
- Requires [1.12-scene-template.md](../1/1.12-scene-template.md) for background auto-loading reference
- Requires [1.9-default-theme.md](../1/1.9-default-theme.md) for ForwardNavButton theme
- Creates new pay.tscn and pay.gd files
- Modifies furnace.gd to detect resource depletion and trigger transition
- Adds pay formula variables to level_1_vars.gd

---

## Implementation Tasks

### 1. Add Pay Formula Variables to Level1Vars

Track currency and define pay calculation formula.

**In level_1_vars.gd:**

Add currency tracking after existing coal tracking variables (after line 35):
```gdscript
# Currency
var copper_current: int = 0  # Current copper pieces owned

# Pay formula variables (tuneable for balance)
var pay_coal_per_copper: int = 25  # How many coal pieces = 1 copper
var pay_drop_penalty_percent: float = 0.0  # Percentage reduction per dropped coal (0-1.0, currently disabled)
```

Add pay calculation function after existing resource functions:
```gdscript
func calculate_pay() -> int:
	# Validate pay_coal_per_copper to prevent division errors
	if pay_coal_per_copper <= 0:
		push_error("Invalid pay_coal_per_copper: %d" % pay_coal_per_copper)
		return 0

	# Base formula: 1 copper per 25 coal delivered
	# Integer division rounds down (24 coal = 0 copper, 25 coal = 1 copper)
	var base_pay = coal_delivered / pay_coal_per_copper

	# Future modifications can be added here:
	# - Drop penalties (if pay_drop_penalty_percent > 0)
	# - Bonuses from upgrades/equipment
	# - Event modifiers (double pay days, etc.)
	# - Combo/streak bonuses

	# Ensure non-negative result
	return max(0, int(base_pay))

func award_pay(amount: int):
	copper_current += amount
	# Future: emit signal for UI updates if needed
```

**Design notes:**
- `pay_coal_per_copper = 25`: Very low initial pay - 75 coal delivered (good run) = 3 copper
- `pay_drop_penalty_percent = 0.0`: No penalty for dropped coal - disabled for now
- Formula uses integer division which rounds down (24 coal = 0 copper, 25 coal = 1 copper)
- This creates "dead zones" where extra effort doesn't increase pay until next threshold
- Variables are in Level1Vars for easy tweaking without code changes
- **Pay calculation is mysterious**: UI only shows final pay amount, not the formula
- Pay can be modified by other factors (future upgrades, bonuses, events)
- Validation prevents crashes from invalid pay_coal_per_copper values

---

### 2. Detect Resource Depletion in Furnace Scene

Monitor stamina and focus bars for 0 values and trigger scene transition.

**In furnace.gd:**

Add flag to prevent double-triggering when both resources deplete:
```gdscript
var day_ended: bool = false

func _ready():
	# Reset flag when scene starts
	day_ended = false
	# ... other initialization code

func connect_resource_bars():
	# Connect to Level1Vars signals
	Level1Vars.stamina_changed.connect(_on_stamina_changed)
	Level1Vars.focus_changed.connect(_on_focus_changed)

	# Initialize bars with current values
	_on_stamina_changed(Level1Vars.stamina, Level1Vars.stamina_max)
	_on_focus_changed(Level1Vars.focus, Level1Vars.focus_max)

func _on_stamina_changed(new_value: float, max_value: float):
	stamina_bar.max_value = max_value
	stamina_bar.value = new_value

	# Check for depletion
	if new_value <= 0.0:
		end_day("stamina")

func _on_focus_changed(new_value: int, max_value: int):
	focus_bar.max_value = max_value
	focus_bar.value = new_value

	# Check for depletion (future: when focus drain implemented)
	if new_value <= 0:
		end_day("focus")

func end_day(reason: String):
	# Prevent double-triggering if both resources hit 0 in same frame
	if day_ended:
		return
	day_ended = true

	# Transition to pay scene
	# Note: reason parameter allows future expansion (different messages/bonuses)
	get_tree().change_scene_to_file("res://level1/pay.tscn")
```

**Implementation notes:**
- `day_ended` flag prevents scene transition from being called twice if both resources hit 0 simultaneously
- Flag is reset in `_ready()` when furnace scene loads
- Depletion check happens in signal handlers - immediate response
- Stamina uses float comparison (<=0.0), focus uses int comparison (<=0)
- Focus drain not implemented yet - focus depletion check is prepared for future implementation
- `reason` parameter currently unused but allows future features (e.g., bonus for full focus day)
- No confirmation dialog - instant transition on depletion
- Scene transition clears physics state automatically (Godot handles cleanup)

---

### 3. Create Pay Scene Structure

Build pay scene using scene_template.tscn for proper background loading.

**Create: res://level1/pay.tscn**

This scene inherits from scene_template.tscn to ensure ResponsiveLayout can properly detect the required node structure (mainarea, PlayArea, Menu) and auto-load the background image.

**Node structure:**
```
Pay (Control) [instance of scene_template.tscn]
├── Background (ColorRect - black letterbox) [inherited]
├── AspectContainer (AspectRatioContainer - 16:9) [inherited]
│   └── MainContainer (Control) [inherited]
│       ├── Background (TextureRect - pay.jpg/pay.png auto-loaded) [inherited]
│       ├── mainarea (HBoxContainer) [inherited]
│       │   ├── PlayArea (Control) [inherited]
│       │   │   └── StatsPanel (PanelContainer - centered) [added]
│       │   │       └── VBoxContainer
│       │   │           ├── TitleLabel (Label - "Day Complete")
│       │   │           ├── CoalDeliveredLabel (Label - "Coal Delivered: 75")
│       │   │           ├── CoalDroppedLabel (Label - "Coal Dropped: 12")
│       │   │           ├── Spacer (Control - adds vertical spacing)
│       │   │           └── PayLabel (Label - "Pay: 3 copper")
│       │   └── Menu (VBoxContainer) [inherited]
│       │       ├── SettingsButton (Button) [inherited from template]
│       │       └── DormButton (Button - "Dorm", ForwardNavButton theme) [added]
│       └── NotificationBar (VBoxContainer) [inherited]
```

**Node setup:**

1. **Pay (Control)**:
   - Root node
   - Full screen (anchors 0,0 to 1,1)
   - Theme: default_theme.tres (inherited globally)

2. **Background (ColorRect)**:
   - Black background for letterboxing
   - Anchors: 0,0 to 1,1
   - Color: `Color(0, 0, 0, 1)` (solid black)

3. **AspectContainer (AspectRatioContainer)**:
   - Ratio: 1.77778 (16:9)
   - Stretch mode: FIT
   - Alignment: CENTER
   - Anchors: 0,0 to 1,1

4. **MainContainer (Control)**:
   - Child of AspectContainer
   - Full size within aspect ratio

5. **Background (TextureRect)** [inherited]:
   - Name must be exactly "Background" for auto-loading
   - Stretch mode: KEEP_ASPECT_COVERED
   - Anchors: 0,0 to 1,1
   - Texture: Auto-loaded by ResponsiveLayout (pay.jpg or pay.png)

6. **StatsPanel (PanelContainer)** [added to PlayArea]:
   - Centered in PlayArea
   - Size: ~400x300 (adjust to fit content)
   - Position: Centered (anchor 0.5, 0.5)
   - StyleBoxFlat background:
     - bg_color: `Color(0.58, 0.247, 0.012, 0.3)` (orange panel, 30% opacity)
     - corner_radius: 4px (all corners)
   - Contains VBoxContainer with:
     - Alignment: Center (for child labels)
     - Separation: 10px (spacing between labels)

7. **Labels** (all Label nodes):
   - Horizontal alignment: CENTER
   - Auto-wrap mode: OFF
   - Font size: Scaled by ResponsiveLayout (25px base)
   - Text color: White (inherited from theme)

8. **DormButton (Button)** [added to Menu]:
   - Text: "Dorm"
   - Theme type variation: "ForwardNavButton" (light blue nav button)
   - Minimum size: 120x50 (from [1.9-default-theme.md](../1/1.9-default-theme.md))
   - Appears below SettingsButton in Menu VBoxContainer

**Background auto-loading:**
- Scene path: `res://level1/pay.tscn`
- Root node name: "Pay"
- Background search paths:
  1. `res://level1/backgrounds/pay.jpg` (checked first)
  2. `res://level1/backgrounds/pay.png` (checked second)
- If neither exists: Background TextureRect remains empty (transparent)
- See [1.12-scene-template.md](../1/1.12-scene-template.md#background-auto-loading) lines 150-186 for full details

---

### 4. Implement Pay Scene Script

Calculate pay, display stats, handle navigation.

**Create: res://level1/pay.gd**

```gdscript
extends Control

@onready var coal_delivered_label: Label = $AspectContainer/MainContainer/mainarea/PlayArea/StatsPanel/VBoxContainer/CoalDeliveredLabel
@onready var coal_dropped_label: Label = $AspectContainer/MainContainer/mainarea/PlayArea/StatsPanel/VBoxContainer/CoalDroppedLabel
@onready var pay_label: Label = $AspectContainer/MainContainer/mainarea/PlayArea/StatsPanel/VBoxContainer/PayLabel
@onready var dorm_button: Button = $AspectContainer/MainContainer/mainarea/Menu/DormButton

var pay_amount: int = 0

func _ready():
	# Apply responsive layout (handles background auto-loading, font scaling)
	ResponsiveLayout.apply_to_scene(self)

	# Calculate pay from run stats
	pay_amount = Level1Vars.calculate_pay()

	# Award pay to player
	Level1Vars.award_pay(pay_amount)

	# Update UI labels
	update_stats_display()

	# Connect navigation
	dorm_button.pressed.connect(_on_dorm_button_pressed)

func update_stats_display():
	# Display raw stats only - keep pay calculation mysterious
	coal_delivered_label.text = "Coal Delivered: %d" % Level1Vars.coal_delivered
	coal_dropped_label.text = "Coal Dropped: %d" % Level1Vars.coal_dropped

	# Just show final pay amount - no formula explanation
	pay_label.text = "Pay: %d copper" % pay_amount

func _on_dorm_button_pressed():
	# Stats will be reset when furnace scene starts next run
	# NOT reset here - dorm scene may want to display last run stats

	# Transition to dorm scene
	get_tree().change_scene_to_file("res://level1/dorm.tscn")
```

**Implementation details:**
- ResponsiveLayout.apply_to_scene() handles background auto-loading and font scaling
- Pay calculated once on scene load, not recalculated
- Pay awarded immediately (added to copper_current)
- Stats NOT reset in pay scene - will be reset when furnace scene starts again
- This preserves stats for potential dorm scene display or debugging
- Simple linear flow: Pay → Dorm (no back button, no replay)

---

### 5. Verify Dorm Scene Exists

The dorm scene already exists - no placeholder needed.

**Existing files:**
- `res://level1/dorm.tscn` - Already exists
- `res://level1/dorm.gd` - Already exists
- `res://level1/backgrounds/dorm.jpg` - Already exists

**Notes:**
- Pay scene navigates to existing dorm scene on button press
- No modifications needed to dorm scene for this feature
- Full dorm scene functionality will be implemented in a separate plan

---

### 6. Add Dev-Speed-Mode Debug Buttons

Add debug buttons to furnace scene menu when Global.dev_speed_mode is enabled.

**In furnace.tscn:**

Add two debug buttons to the Menu VBoxContainer, hidden by default:

1. **Debug25CoalButton**:
   - Text: "[DEBUG] +25 Coal"
   - Visible: false (set in code based on dev_speed_mode)
   - Node path: `AspectContainer/MainContainer/mainarea/Menu/Debug25CoalButton`

2. **DebugDrainStaminaButton**:
   - Text: "[DEBUG] Drain Stamina"
   - Visible: false (set in code based on dev_speed_mode)
   - Node path: `AspectContainer/MainContainer/mainarea/Menu/DebugDrainStaminaButton`

**In furnace.gd:**

Add button references and connection logic:

```gdscript
# Add to @onready declarations (optional - can use get_node instead):
@onready var debug_25_coal_button: Button = $AspectContainer/MainContainer/mainarea/Menu/Debug25CoalButton
@onready var debug_drain_stamina_button: Button = $AspectContainer/MainContainer/mainarea/Menu/DebugDrainStaminaButton

func _ready():
	# ... existing code ...

	# Show/hide and connect debug buttons based on dev_speed_mode
	setup_debug_buttons()

func setup_debug_buttons():
	# Get buttons (use get_node_or_null for safety if @onready not used)
	var coal_btn = get_node_or_null("AspectContainer/MainContainer/mainarea/Menu/Debug25CoalButton")
	var stamina_btn = get_node_or_null("AspectContainer/MainContainer/mainarea/Menu/DebugDrainStaminaButton")

	if not coal_btn or not stamina_btn:
		return  # Buttons don't exist (shouldn't happen)

	# Show buttons only if dev_speed_mode enabled
	var dev_mode = Global.dev_speed_mode
	coal_btn.visible = dev_mode
	stamina_btn.visible = dev_mode

	if dev_mode:
		# Connect signals (only when visible)
		if not coal_btn.pressed.is_connected(_on_debug_25_coal_pressed):
			coal_btn.pressed.connect(_on_debug_25_coal_pressed)
		if not stamina_btn.pressed.is_connected(_on_debug_drain_stamina_pressed):
			stamina_btn.pressed.connect(_on_debug_drain_stamina_pressed)

func _on_debug_25_coal_pressed():
	# Add 25 to delivered coal count
	Level1Vars.coal_delivered += 25
	print("[DEBUG] Added 25 coal - total delivered: %d" % Level1Vars.coal_delivered)

func _on_debug_drain_stamina_pressed():
	# Reduce stamina to 1.0 (triggers day end when next shovel action drains it)
	Level1Vars.stamina = 1.0
	print("[DEBUG] Stamina drained to 1.0")
```

**Design notes:**
- Buttons hidden by default (visible = false in scene)
- Only shown when Global.dev_speed_mode = true
- +25 Coal button helps quickly test pay calculations without grinding
- Drain Stamina button helps quickly test day-end transition
- Stamina set to 1.0 (not 0) so player can still see the transition happen on next action
- Debug prefix "[DEBUG]" makes it clear these are dev tools

---

## Testing Strategy

### Manual Test Criteria

**Resource depletion detection:**
- [ ] Stamina reaches 0 in furnace scene → immediate transition to pay scene
- [ ] Focus reaches 0 in furnace scene → immediate transition to pay scene (when focus drain implemented)
- [ ] No delay or confirmation dialog on transition
- [ ] No double-transition when both resources hit 0 simultaneously

**Pay scene display:**
- [ ] Pay scene loads without errors
- [ ] Background loads (pay.jpg or pay.png if present)
- [ ] Title label displays "Day Complete"
- [ ] Coal delivered count matches Level1Vars.coal_delivered
- [ ] Coal dropped count matches Level1Vars.coal_dropped
- [ ] Pay amount calculated correctly (delivered / 25, but formula not shown to player)
- [ ] Spacer creates visual separation between stats and pay
- [ ] StatsPanel centered and visible
- [ ] All labels readable (proper font scaling)

**Pay calculation:**
- [ ] 0 coal delivered → 0 copper pay
- [ ] 24 coal delivered → 0 copper pay (rounds down)
- [ ] 25 coal delivered → 1 copper pay
- [ ] 50 coal delivered → 2 copper pay
- [ ] 75 coal delivered → 3 copper pay
- [ ] Copper added to Level1Vars.copper_current

**Navigation:**
- [ ] Dorm button visible and styled (light blue ForwardNavButton)
- [ ] Dorm button press transitions to dorm scene
- [ ] Coal stats NOT reset on dorm transition (will be reset when furnace starts next run)
- [ ] Copper persists after transition (not reset)

**Edge cases:**
- [ ] Both stamina AND focus hit 0 simultaneously → only one end_day() call
- [ ] Negative stamina/focus (if possible) → still triggers transition
- [ ] Very high coal counts (1000+) → pay calculation doesn't overflow

**Visual polish:**
- [ ] Pay scene looks good at 1438x817 resolution
- [ ] Responsive layout scales correctly at 1920x1080
- [ ] StatsPanel background has correct opacity (30%)
- [ ] Text is readable against background image

---

## Code Examples

### Complete Day End Flow

**Furnace scene (stamina drains to 0):**
```gdscript
# In shovel.gd _physics_process():
Level1Vars.modify_stamina(-drain_rate * delta)  # Stamina goes from 0.1 → 0.0

# In level_1_vars.gd:
func modify_stamina(amount: float) -> bool:
	stamina = clampf(stamina + amount, 0.0, stamina_max)  # Clamped to 0.0
	emit_signal("stamina_changed", stamina, stamina_max)  # Signal emitted
	return true

# In furnace.gd:
func _on_stamina_changed(new_value: float, max_value: float):
	stamina_bar.value = new_value
	if new_value <= 0.0:
		end_day("stamina")  # Triggered

func end_day(reason: String):
	get_tree().change_scene_to_file("res://level1/pay.tscn")  # Scene transition
```

**Pay scene loads:**
```gdscript
# In pay.gd _ready():
pay_amount = Level1Vars.calculate_pay()  # 75 delivered / 25 = 3 copper
Level1Vars.award_pay(pay_amount)  # copper_current += 3
update_stats_display()  # Labels updated
```

**Player clicks Dorm button:**
```gdscript
# In pay.gd:
func _on_dorm_button_pressed():
	# Stats NOT reset here - preserved for potential dorm scene display
	# Will be reset when furnace scene starts next run
	get_tree().change_scene_to_file("res://level1/dorm.tscn")
```

---

## Files to Create

- `res://level1/pay.tscn` - Pay scene with stats display and navigation
- `res://level1/pay.gd` - Pay scene script (calculate pay, display stats, navigation)
- `res://level1/backgrounds/pay.jpg` or `pay.png` - Background image for pay scene (create/source art)

**Note:** Dorm scene files already exist (dorm.tscn, dorm.gd, dorm.jpg) - no creation needed

## Files to Modify

- [level_1_vars.gd](../../game/v0.1/level1/level_1_vars.gd) - Add copper currency, pay formula variables, calculate_pay() and award_pay() functions
- [furnace.gd](../../game/v0.1/level1/furnace.gd) - Add depletion checks to _on_stamina_changed() and _on_focus_changed(), add end_day() function

---

## Design Values (Reference)

### Pay Formula Variables

```gdscript
# In level_1_vars.gd
pay_coal_per_copper = 25  # Coal pieces needed for 1 copper
pay_drop_penalty_percent = 0.0  # Currently disabled (no penalty)
```

### Pay Calculation Examples

| Coal Delivered | Coal Dropped | Base Pay (÷25) | Penalty | Final Pay |
|----------------|--------------|----------------|---------|-----------|
| 0 | 0 | 0 copper | - | 0 copper |
| 24 | 5 | 0 copper | - | 0 copper |
| 25 | 0 | 1 copper | - | 1 copper |
| 50 | 10 | 2 copper | - | 2 copper |
| 75 | 12 | 3 copper | - | 3 copper |
| 100 | 20 | 4 copper | - | 4 copper |

**Note:** Currently no penalty for dropped coal (pay_drop_penalty_percent = 0.0). Formula ignores coal_dropped entirely.

### Tuning Knobs for Future Balancing

**Problem: Pay is too low (progression too slow)**
- Decrease `pay_coal_per_copper` (15 instead of 25) - more copper per run
- Add flat bonus: `base_pay + 1` - guaranteed minimum pay

**Problem: Pay is too high (progression too fast)**
- Increase `pay_coal_per_copper` (35 instead of 25) - less copper per run
- Enable drop penalty: `pay_drop_penalty_percent = 0.01` (1% reduction per dropped coal)

**Problem: No incentive to avoid dropping coal**
- Enable `pay_drop_penalty_percent` (start at 0.02 = 2% per drop)
- Formula becomes: `base_pay * (1.0 - (coal_dropped * penalty_percent))`
- Example: 75 delivered (3 copper), 10 dropped, 2% penalty → 3 * (1.0 - 0.2) = 2.4 copper (rounds to 2)

**Problem: Players expect minimum pay even on bad runs**
- Add guaranteed minimum: `max(calculate_pay(), 1)` - always get at least 1 copper
- Or add participation bonus: `base_pay + floor(coal_delivered / 100)` - small bonus for effort

---

## UI Mockups

**Pay Scene (centered stats panel):**

```
+------------------------------------------------------------------+
|                        [Background Image]                        |
|                                                                  |
|                  +--------------------------------+              |
|                  |      Day Complete              |              |
|                  |                                |              |
|                  |  Coal Delivered: 75            |              |
|                  |  Coal Dropped: 12              |              |
|                  |                                |              |
|                  |  Pay: 3 copper                 |              |
|                  |                                |              |
|                  |        [ Dorm ]                |              |
|                  +--------------------------------+              |
|                                                                  |
+------------------------------------------------------------------+
```

**Visual elements:**
- Background: pay.jpg/pay.png (full screen, covered)
- StatsPanel: Orange translucent panel (30% opacity)
- Labels: White text, centered, 25px base font (scaled)
- Dorm button: Light blue ForwardNavButton (2px border, shadow)

---

## Balance Tuning Notes

### Initial Pay Rate

**Target performance (from [2.7-stamina-drain.md](2.7-stamina-drain.md)):**
- 25 deliveries × 3 coal avg = 75 coal delivered
- 75 coal / 25 per copper = **3 copper per run**

**Intentionally low for early game:**
- Creates upgrade pressure (need better stamina/shovel to earn more)
- Makes each copper feel valuable
- Progression curve: 3 copper → 6 copper → 12 copper as player improves

### Expected Upgrade Path (Future)

Players should be able to increase pay per run by:
1. **Stamina upgrades**: 50 → 100 → 150 max (more deliveries per run)
2. **Shovel upgrades**: Better balance → fewer drops → higher delivered count
3. **Pay rate upgrades**: 25 per copper → 20 → 15 → 10 (more copper per delivery)
4. **Bonus multipliers**: 1x → 1.25x → 1.5x → 2x (late-game scaling)

---

## Notes & Decisions

### Why immediate transition instead of end-of-run summary in furnace?

**Immediate transition advantages:**
- Clear cause-and-effect: "stamina hit 0 → scene changed"
- No lingering in failed state (player can't try to keep playing)
- Clean separation: furnace = gameplay, pay = results
- Prevents edge cases (what if focus also hits 0 while viewing summary?)

**Alternative (summary overlay in furnace):**
- Would require popup/panel system
- Player might try to click things in background
- More complex state management (disable shoveling, pause physics?)
- Rejected - scene transition is simpler and clearer

### Why NOT reset coal stats in pay scene?

**Stats preserved until next furnace run:**
- Stats visible throughout entire pay scene (player can review)
- Dorm scene could potentially display last run stats if desired
- Prevents bugs if pay scene somehow reloads
- Clear lifecycle: furnace creates stats → pay reads stats → furnace resets stats for next run
- Stats reset when starting new work shift (when player returns to furnace)

**Alternative (reset in pay scene dorm button):**
- Would destroy data before dorm scene could use it
- Less flexible for future features
- Rejected - reset when starting new run is more logical

### Why no replay/retry button in pay scene?

**Single path forward (Pay → Dorm) advantages:**
- Simpler flow, less decision paralysis
- Encourages progression (go to dorm, upgrade, try again)
- Prevents grinding same run conditions (forces day progression)

**Alternative (add "Try Again" button):**
- Would need to reset resources (stamina, focus) without advancing time
- Unclear if stats reset or accumulate
- Might encourage repetitive grinding instead of strategic upgrades
- Rejected - linear progression is clearer for now

### Why separate pay scene instead of dorm scene with stats?

**Separate pay scene advantages:**
- Clear visual transition: Furnace (work) → Pay (results) → Dorm (rest)
- Pay scene can have unique background art (factory office, pay window, etc.)
- Stats are focal point without distraction
- Player has moment to process performance before next decisions

**Alternative (show stats in dorm scene):**
- Stats compete for attention with dorm UI (upgrades, rest, navigation)
- Less ceremony around getting paid (feels less rewarding)
- Harder to create satisfying "results screen" feeling
- Rejected - dedicated pay scene creates better game feel

### Why very low initial pay (1 copper per 25 coal)?

**Low pay creates progression pressure:**
- Early runs earn 2-4 copper (feels scarce, valuable)
- Creates motivation to upgrade stamina/shovel (earn more)
- Makes later runs feel rewarding (6-10 copper+ with upgrades)
- Matches "harsh labor" theme (underpaid factory worker)

**Risk: Too punishing?**
- Playtesting will determine if 25:1 ratio is too harsh
- Easy to adjust: change `pay_coal_per_copper` to 20 or 15
- Can add flat bonus (always get 1+ copper) if players feel unrewarded
- Balance knob is in Level1Vars for quick iteration

### Why mysterious pay calculation instead of showing formula?

**Mystery creates engagement:**
- Players experiment to discover what affects pay
- Leaves room for hidden bonuses/modifiers without explaining everything
- Formula can be modified by upgrades/events without breaking UI expectations
- More immersive (realistic - employers don't explain exact formulas)
- Encourages experimentation and discovery

**Future modifications can add:**
- Quality bonuses (consecutive deliveries without drops)
- Speed bonuses (finish under time threshold)
- Equipment modifiers (better shovel = pay multiplier)
- Random events (double pay days, inspector penalties)
- All invisible to player until they notice patterns

### Why no penalty for dropped coal initially?

**Disabled for testing/early game:**
- Pay formula is already new mechanic (delivered → copper conversion)
- Adding penalty creates negative feedback (feels punishing)
- Players are learning shovel physics - drops are common early
- Better to reward good performance than punish bad performance
- `pay_drop_penalty_percent = 0.0` disables penalty entirely

**Future: Can enable if needed:**
- Variable exists for easy activation later
- Just set `pay_drop_penalty_percent > 0` to enable
- But not planned for initial implementation

---

## Common Issues & Prevention

### Issue: Day ends twice (both stamina and focus hit 0 simultaneously)

**Cause:** Both signals fire in same frame, both call end_day()

**Prevention:** Add flag to prevent double-triggering:
```gdscript
# In furnace.gd
var day_ended: bool = false

func end_day(reason: String):
	if day_ended:
		return  # Already transitioning
	day_ended = true
	get_tree().change_scene_to_file("res://level1/pay.tscn")
```

### Issue: Pay scene shows stale stats from previous run

**Cause:** Stats not reset between runs

**Solution:** Stats preserved in pay scene, will be reset when furnace scene starts next run:
```gdscript
# In furnace.gd _ready() or when starting new work shift:
Level1Vars.coal_delivered = 0
Level1Vars.coal_dropped = 0
# Then begin shoveling
```

**Note:** This allows dorm scene to potentially display last run stats if desired

### Issue: Negative pay or NaN from bad division

**Cause:** Unexpected values in coal_delivered or pay_coal_per_copper

**Solution:** Validation already implemented in calculate_pay() (see Task 1):
- Checks if pay_coal_per_copper <= 0 and returns 0 with error
- Uses max(0, int(base_pay)) to ensure non-negative result
- Prevents crashes from division by zero or invalid values

### Issue: Background doesn't load in pay scene

**Cause:** Missing pay.jpg/pay.png or incorrect naming

**Solution:** Already handled by ResponsiveLayout background auto-loading:
- Checks both .jpg and .png extensions
- Looks in level1/backgrounds/ folder
- Gracefully fails (empty TextureRect) if not found
- No errors, just missing background
- See [1.12-scene-template.md](../1/1.12-scene-template.md#background-auto-loading) lines 169-170

### Issue: Dorm scene not found when button pressed

**Cause:** Incorrect file path or scene not loaded

**Solution:** Dorm files already exist at:
- `res://level1/dorm.tscn`
- `res://level1/dorm.gd`
- `res://level1/backgrounds/dorm.jpg`
- Verify path in button handler is correct: `"res://level1/dorm.tscn"`

---

## Implementation Checklist

**Level1Vars modifications:**
- [ ] copper_current variable added
- [ ] pay_coal_per_copper variable added (default: 25)
- [ ] pay_drop_penalty_percent variable added (default: 0.0)
- [ ] calculate_pay() function implemented
- [ ] award_pay() function implemented

**Furnace scene modifications:**
- [ ] day_ended flag added to prevent double-trigger
- [ ] day_ended flag reset in _ready()
- [ ] end_day() function implemented with flag check
- [ ] _on_stamina_changed() checks for depletion (<=0.0)
- [ ] _on_focus_changed() checks for depletion (<=0) - prepared for future focus drain
- [ ] Both handlers call end_day() on depletion
- [ ] Coal stats (delivered/dropped) reset in _ready() or when starting new work shift

**Pay scene creation:**
- [ ] pay.tscn created with node structure (Pay → Background → AspectContainer → MainContainer → Background + StatsPanel)
- [ ] StatsPanel has orange background (30% opacity, 4px corners)
- [ ] All labels added (Title, CoalDelivered, CoalDropped, Pay)
- [ ] DormButton added with ForwardNavButton theme variation
- [ ] pay.gd script attached to Pay root node
- [ ] @onready references to all labels and button
- [ ] _ready() calls ResponsiveLayout.apply_to_scene()
- [ ] _ready() calculates and awards pay
- [ ] _ready() updates stats display
- [ ] _ready() connects dorm button signal
- [ ] _on_dorm_button_pressed() transitions to dorm (stats NOT reset here)

**Dorm scene verification:**
- [ ] Verify dorm.tscn exists at res://level1/dorm.tscn
- [ ] Verify dorm.gd exists
- [ ] Verify dorm.jpg exists in backgrounds folder
- [ ] Test transition from pay scene to dorm scene works

**Background assets:**
- [ ] pay.jpg or pay.png created/sourced for pay scene background
- [ ] Background placed in res://level1/backgrounds/ folder
- [ ] Verified background auto-loads correctly

**Testing:**
- [ ] Stamina depletion triggers pay scene transition
- [ ] Focus depletion triggers pay scene transition (when focus drain implemented)
- [ ] Pay scene displays correct coal stats
- [ ] Pay calculated correctly (delivered / 25, rounds down - e.g., 24 coal = 0 copper)
- [ ] Pay validation prevents errors from invalid pay_coal_per_copper values
- [ ] Copper awarded and persists
- [ ] Dorm button transitions to dorm scene
- [ ] Stats NOT reset when transitioning to dorm (preserved for next furnace scene)
- [ ] No double-trigger when both resources deplete (day_ended flag works)
- [ ] Responsive layout scales correctly
- [ ] All labels readable at target resolution

---

**Last Updated**: 2025-12-18
**Status**: Planning complete - ready for implementation
