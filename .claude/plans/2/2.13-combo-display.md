# Combo Display UI

**Goal**: Display combo meters and active benefits in the furnace menu so players can track their combo state and understand what bonuses they're receiving.

**Success Criteria**:
- Clean streak counter visible when combo system is unlocked
- Heavy load combo timer and stacks visible when heavy system is unlocked
- Active benefit indicators show current multipliers/reductions
- UI updates in real-time as combo state changes

## Prerequisites

**CRITICAL**: This plan requires [2.12-upgrade-pool.md](2.12-upgrade-pool.md) to be fully implemented and tested first.

### Required Level1Vars Methods

The following methods must exist in [level_1_vars.gd](../../game/v0.1/level1/level_1_vars.gd):
- `get_base_stamina_drain_multiplier()` - defined in 2.12 Part 6
- `get_xp_multiplier()` - defined in 2.12 Part 6
- `get_shovel_mass_multiplier()` - defined in 2.12 Part 6
- `get_heavy_timer_extension()` - defined in 2.12 Part 6
- `get_clean_streak_max()` - defined in 2.12 Part 6

### Required Level1Vars Variables

- `clean_streak_unlocked: bool`
- `heavy_combo_unlocked: bool`
- `clean_streak_count: int`
- `heavy_combo_stacks: int`
- `heavy_combo_timer: float`
- `forgiveness_charges: int`
- `forgiveness_max_capacity: int`

### Required Signals

- `clean_streak_changed(new_count: int)`
- `heavy_combo_changed(new_stacks: int, timer_remaining: float)`
- `technique_updated(technique_id: String, new_level: int)`

### Verification Before Implementation

Before starting implementation, read [level_1_vars.gd](../../game/v0.1/level1/level_1_vars.gd) to verify all above methods, variables, and signals exist. If any are missing, implement 2.12 first.

---

## Overview

Players who unlock combo systems (via technique selection) need visual feedback showing their current combo state and what benefits they're receiving. This creates a feedback loop that reinforces skillful play and helps players understand the value of their technique investments.

### Key Design Principles

- **Progressive disclosure**: UI elements only appear when relevant system is unlocked
- **Glanceable**: Quick to read without interrupting gameplay
- **Color-coded**: Matches rarity/quality color scheme from technique cards
- **Minimalist**: Show combo counts only - detailed bonuses shown on hover (performance + knowledge-based design)
- **Hover for details**: Active benefits appear as tooltip when hovering over combo panels (aligns with BIBLE - player investigates rather than passive display)

---

## Implementation Tasks

### 1. Combo Meter UI Container

Add a dedicated container in the furnace menu for combo-related UI elements.

**Location**: [level1/furnace.tscn](../../game/v0.1/level1/furnace.tscn)

**How to add nodes** (Manual editing in Godot Editor):
1. Open [furnace.tscn](../../game/v0.1/level1/furnace.tscn) in Godot editor
2. Navigate to Scene tree: `AspectContainer/MainContainer/mainarea/Menu`
3. Verify current children (should be: StaminaBar index 0, FocusBar index 1, ToMindButton index 2)
4. Add the new nodes following the structure below
5. After adding, ToMindButton will shift to index 4 (this is expected and safe - see verification below)

**Scene structure addition** (insert after FocusBar, before ToMindButton):
```
Menu/ (existing VBoxContainer at AspectContainer/MainContainer/mainarea/Menu)
  StaminaBar (existing, index 0)
  FocusBar (existing, index 1)
  ComboContainer (VBoxContainer, index 2) - NEW
    Properties: spacing = 6, visible = false (initially)
    NodropComboPanel (PanelContainer)
      HBoxContainer (spacing = 8)
        ComboLabel (Label - "Streak: 15/30")
        ForgivenessLabel (Label - "[2]" - greyed out, shows charges)
    HeavyComboPanel (PanelContainer)
      HBoxContainer (spacing = 8)
        HeavyStacksLabel (Label - "Heavy: 3")
        HeavyTimerBar (ProgressBar - shows remaining time)
  BenefitsTooltip (PanelContainer, index 3) - NEW, hidden by default
    Properties: visible = false, position anchored to right of hovered panel
    VBoxContainer (spacing = 4, padding = 8px)
      BenefitsHeaderLabel (Label - "Active Bonuses")
      BenefitsList (VBoxContainer - spacing = 2)
  ToMindButton (existing, index 4 after insertions)
```

**Index Shift Verification:**
- Adding ComboContainer at index 2 shifts ToMindButton from index 2 to index 4
- This is safe: furnace.gd uses `@onready var mind_button: Button = $AspectContainer/.../ToMindButton` (path-based, not index-based)
- Debug buttons use `get_node_or_null()` with paths, not indices
- No code in furnace.gd accesses Menu children by index

**Implementation details:**
- ComboContainer uses VBoxContainer with 6px spacing
- Both combo panels start hidden (visible = false)
- BenefitsTooltip starts hidden, appears only on hover over combo panels
- **Tooltip positioning**: Anchored to right edge of hovered panel (not mouse cursor)
  - **IMPORTANT**: Use `global_position` to handle different parent coordinate spaces
  - Position calculation: `tooltip.global_position = panel.global_position + Vector2(panel.size.x + 8, 0)`
  - Includes viewport clamping to prevent offscreen positioning
  - Stays in fixed position while hovering, doesn't follow mouse
- Forgiveness charges shown in clean streak panel when unlocked: "Streak: 15/30 [2]"
- All panels use StyleBoxFlat with semi-transparent background (see styling section below)

### 2. Clean Streak Display

Shows current streak count and maximum.

**Visual design:**
```
+---------------------------+
| [fire icon] Streak: 15/30 |
+---------------------------+
```

**Variables needed in furnace.gd**:
```gdscript
@onready var combo_container: VBoxContainer = $AspectContainer/MainContainer/mainarea/Menu/ComboContainer
@onready var clean_streak_panel: PanelContainer = $AspectContainer/MainContainer/mainarea/Menu/ComboContainer/NodropComboPanel
@onready var clean_streak_label: Label = $AspectContainer/MainContainer/mainarea/Menu/ComboContainer/NodropComboPanel/HBoxContainer/ComboLabel
@onready var forgiveness_label: Label = $AspectContainer/MainContainer/mainarea/Menu/ComboContainer/NodropComboPanel/HBoxContainer/ForgivenessLabel
```

**Implementation details:**
- Show panel only when `Level1Vars.clean_streak_unlocked == true`
- Update label text when `clean_streak_changed` signal fires
- Display format: "Streak: 15/30 [2]" where [2] is forgiveness charges (only when forgiveness unlocked)
- Color the count based on milestone thresholds:
  - 0-4: White (default)
  - 5-9: Green (building momentum)
  - 10+: Gold (Perfect Form threshold)
- Forgiveness charges shown in grey/dim text in brackets

### 3. Heavy Load Combo Display

Shows current stacks and remaining timer as a progress bar.

**Visual design:**
```
+--------------------------------+
| [weight icon] Heavy: 3  [====] |
+--------------------------------+
```

**Variables needed in furnace.gd**:
```gdscript
@onready var heavy_combo_panel: PanelContainer = $AspectContainer/MainContainer/mainarea/Menu/ComboContainer/HeavyComboPanel
@onready var heavy_stacks_label: Label = $AspectContainer/MainContainer/mainarea/Menu/ComboContainer/HeavyComboPanel/HBoxContainer/HeavyStacksLabel
@onready var heavy_timer_bar: ProgressBar = $AspectContainer/MainContainer/mainarea/Menu/ComboContainer/HeavyComboPanel/HBoxContainer/HeavyTimerBar
```

**Implementation details:**
- Show panel only when `Level1Vars.heavy_combo_unlocked == true`
- Update stacks label when `heavy_combo_changed` signal fires
- Timer bar max_value = base timer (5.0) + extensions
- Timer bar value = `Level1Vars.heavy_combo_timer`
- Update timer bar every frame in `_process()`
- Color coding:
  - Stacks 1-2: White
  - Stacks 3-4: Green
  - Stacks 5+: Gold

### 4. Benefits Tooltip (Hover-based)

Shows currently active bonuses from techniques + combos when hovering over combo panels. This provides performance optimization (only calculates on hover) and aligns with BIBLE knowledge-based progression (player investigates rather than passive display).

**Visual design:**
```
+---------------------------+
| Active Bonuses            |
| - Stamina: -45%           |
| - XP: +180%               |
| - Mass: +35%              |
+---------------------------+
```

**Variables needed in furnace.gd**:
```gdscript
@onready var benefits_tooltip: PanelContainer = $AspectContainer/MainContainer/mainarea/Menu/BenefitsTooltip
@onready var benefits_list: VBoxContainer = $AspectContainer/MainContainer/mainarea/Menu/BenefitsTooltip/VBoxContainer/BenefitsList

# UI constants for consistent styling
const COMBO_CONTAINER_SPACING: int = 6
const TOOLTIP_OFFSET: int = 8
const BENEFIT_FONT_SIZE: int = 14
const PANEL_PADDING: int = 8
const PANEL_CORNER_RADIUS: int = 4

# Color definitions for benefits display
const BENEFIT_COLORS = {
    "reduction": Color(0.4, 0.8, 0.4),  # Green for reductions
    "bonus": Color(1.0, 0.8, 0.2),      # Gold for bonuses
    "mass": Color(0.4, 0.8, 0.8)        # Cyan for mass
}

# Track currently hovered panel for tooltip positioning
var _hovered_panel: PanelContainer = null
```

**Implementation details:**
- Tooltip hidden by default (visible = false)
- Appears when mouse enters combo panel area (NodropComboPanel or HeavyComboPanel)
- **Positioning**: Anchored to right edge of hovered panel + 8px offset
  - Stays visible when moving between panels (shared tooltip)
  - Updates content when switching between panels
  - Position: `panel.position + Vector2(panel.size.x + 8, 0)`
- Rebuilds benefit list ONLY on mouse_entered event (not on combo signals)
- Hides when mouse exits all combo panels
- Only show benefits that are currently non-zero
- Format percentages consistently:
  - Reductions: "-XX%" in green (BENEFIT_COLORS["reduction"])
  - Multipliers: "+XX%" in gold (BENEFIT_COLORS["bonus"])
  - Mass bonuses: "+XX%" in cyan (BENEFIT_COLORS["mass"])
  - No change: Don't show the line

**Benefit calculation for display:**
```gdscript
func _get_active_benefits() -> Array[Dictionary]:
    var benefits: Array[Dictionary] = []

    # Stamina drain reduction
    var drain_mult = Level1Vars.get_base_stamina_drain_multiplier()
    if drain_mult < 1.0:
        var reduction_pct = (1.0 - drain_mult) * 100
        benefits.append({
            "label": "Stamina Drain",
            "value": "-%d%%" % int(reduction_pct),
            "color": BENEFIT_COLORS["reduction"]
        })

    # XP multiplier
    var xp_mult = Level1Vars.get_xp_multiplier()
    if xp_mult > 1.0:
        var bonus_pct = (xp_mult - 1.0) * 100
        benefits.append({
            "label": "XP Bonus",
            "value": "+%d%%" % int(bonus_pct),
            "color": BENEFIT_COLORS["bonus"]
        })

    # Shovel mass (if player is investing in it)
    var mass_mult = Level1Vars.get_shovel_mass_multiplier()
    if mass_mult > 1.0:
        var bonus_pct = (mass_mult - 1.0) * 100
        benefits.append({
            "label": "Shovel Mass",
            "value": "+%d%%" % int(bonus_pct),
            "color": BENEFIT_COLORS["mass"]
        })

    # Fallback: Show at least that combo system is active
    # This occurs when combo is unlocked but not providing bonuses yet:
    # - Clean streak at 0 (just unlocked or recently dropped coal)
    # - Heavy combo timer expired (stacks = 0)
    # - No passive bonuses from Rhythm/Economy/etc (player only selected combo techniques)
    if benefits.is_empty() and (Level1Vars.clean_streak_unlocked or Level1Vars.heavy_combo_unlocked):
        benefits.append({
            "label": "Combo System Active",
            "value": "(no bonuses yet)",
            "color": Color.WHITE
        })

    return benefits
```

### 5. Signal and Mouse Event Connections

Connect to Level1Vars signals for combo counter updates and mouse events for tooltip display.

**In furnace.gd _ready()**:
```gdscript
func _ready():
    # ...existing code...

    # Connect combo signals for counter updates (NOT tooltip updates)
    Level1Vars.clean_streak_changed.connect(_on_clean_streak_changed)
    Level1Vars.heavy_combo_changed.connect(_on_heavy_combo_changed)
    Level1Vars.technique_updated.connect(_on_technique_updated)

    # Connect mouse events for tooltip (only calculate benefits on hover)
    if clean_streak_panel:
        clean_streak_panel.mouse_entered.connect(_on_combo_panel_hover_start.bind(clean_streak_panel))
        clean_streak_panel.mouse_exited.connect(_on_combo_panel_hover_end)
    else:
        push_warning("Clean streak panel not found - combo display unavailable")

    if heavy_combo_panel:
        heavy_combo_panel.mouse_entered.connect(_on_combo_panel_hover_start.bind(heavy_combo_panel))
        heavy_combo_panel.mouse_exited.connect(_on_combo_panel_hover_end)
    else:
        push_warning("Heavy combo panel not found - combo display unavailable")

    # Initial visibility setup
    _update_combo_panel_visibility()

func _exit_tree():
    # Clean up signal connections
    if Level1Vars.clean_streak_changed.is_connected(_on_clean_streak_changed):
        Level1Vars.clean_streak_changed.disconnect(_on_clean_streak_changed)
    if Level1Vars.heavy_combo_changed.is_connected(_on_heavy_combo_changed):
        Level1Vars.heavy_combo_changed.disconnect(_on_heavy_combo_changed)
    if Level1Vars.technique_updated.is_connected(_on_technique_updated):
        Level1Vars.technique_updated.disconnect(_on_technique_updated)

    if clean_streak_panel:
        if clean_streak_panel.mouse_entered.is_connected(_on_combo_panel_hover_start):
            clean_streak_panel.mouse_entered.disconnect(_on_combo_panel_hover_start)
        if clean_streak_panel.mouse_exited.is_connected(_on_combo_panel_hover_end):
            clean_streak_panel.mouse_exited.disconnect(_on_combo_panel_hover_end)

    if heavy_combo_panel:
        if heavy_combo_panel.mouse_entered.is_connected(_on_combo_panel_hover_start):
            heavy_combo_panel.mouse_entered.disconnect(_on_combo_panel_hover_start)
        if heavy_combo_panel.mouse_exited.is_connected(_on_combo_panel_hover_end):
            heavy_combo_panel.mouse_exited.disconnect(_on_combo_panel_hover_end)
```

**Signal handlers:**
```gdscript
func _on_clean_streak_changed(new_count: int):
    _update_clean_streak_display(new_count)
    # No tooltip update here - only on hover

func _on_heavy_combo_changed(new_stacks: int, timer_remaining: float):
    _update_heavy_combo_display(new_stacks, timer_remaining)
    # No tooltip update here - only on hover

func _on_technique_updated(_technique_id: String, _new_level: int):
    _update_combo_panel_visibility()
    # No tooltip update here - only on hover

# Tooltip hover handlers
func _on_combo_panel_hover_start(panel: PanelContainer):
    if not benefits_tooltip:
        push_warning("Benefits tooltip not found - combo tooltip unavailable")
        return

    _hovered_panel = panel
    _rebuild_benefits_list()  # Calculate and display benefits
    _position_tooltip_near_panel(panel)
    benefits_tooltip.visible = true

func _on_combo_panel_hover_end():
    if benefits_tooltip:
        benefits_tooltip.visible = false
        _hovered_panel = null

func _position_tooltip_near_panel(panel: PanelContainer):
    if not benefits_tooltip or not panel:
        return

    # Position tooltip to the right of the hovered panel
    # Use global_position since tooltip and panel have different parents
    var offset = Vector2(panel.size.x + TOOLTIP_OFFSET, 0)
    var desired_pos = panel.global_position + offset

    # Clamp to viewport to prevent offscreen positioning
    var viewport_size = get_viewport_rect().size
    var tooltip_size = benefits_tooltip.size

    # Prevent going off right edge
    if desired_pos.x + tooltip_size.x > viewport_size.x:
        desired_pos.x = viewport_size.x - tooltip_size.x - TOOLTIP_OFFSET

    # Prevent going off bottom edge
    if desired_pos.y + tooltip_size.y > viewport_size.y:
        desired_pos.y = viewport_size.y - tooltip_size.y - TOOLTIP_OFFSET

    # Prevent going off top edge
    desired_pos.y = max(TOOLTIP_OFFSET, desired_pos.y)

    benefits_tooltip.global_position = desired_pos
```

### 6. Visibility Logic

Panels appear/disappear based on unlock state. Tooltip visibility controlled by mouse events.

```gdscript
func _update_combo_panel_visibility():
    if clean_streak_panel:
        clean_streak_panel.visible = Level1Vars.clean_streak_unlocked
    if heavy_combo_panel:
        heavy_combo_panel.visible = Level1Vars.heavy_combo_unlocked

    # Hide entire combo container if no combos unlocked
    if combo_container:
        combo_container.visible = Level1Vars.clean_streak_unlocked or Level1Vars.heavy_combo_unlocked

# Note: Tooltip visibility controlled by _on_combo_panel_hover_start/end
# No automatic update function needed - only builds on hover
```

---

## Code Examples

### Update Clean Streak Display

```gdscript
# Helper function for combo color thresholds
func _get_combo_color(count: int, green_threshold: int, gold_threshold: int) -> Color:
    if count >= gold_threshold:
        return Color(1.0, 0.8, 0.2)  # Gold
    elif count >= green_threshold:
        return Color(0.4, 0.8, 0.4)  # Green
    return Color.WHITE

func _update_clean_streak_display(count: int):
    if not clean_streak_label:
        push_warning("Clean streak label not found - streak display unavailable")
        return

    # Build display text: "Streak: 15/30" or "Streak: 15/30 [2]" with charges
    var max_combo = Level1Vars.get_clean_streak_max()
    clean_streak_label.text = "Streak: %d/%d" % [count, max_combo]

    # Show forgiveness charges if unlocked
    if forgiveness_label:
        if Level1Vars.forgiveness_max_capacity > 0:
            forgiveness_label.text = "[%d]" % Level1Vars.forgiveness_charges
            forgiveness_label.visible = true
            # Dim the charges display
            forgiveness_label.add_theme_color_override("font_color", Color(0.7, 0.7, 0.7))
        else:
            forgiveness_label.visible = false

    # Color based on milestones
    var color = _get_combo_color(count, 5, 10)
    clean_streak_label.add_theme_color_override("font_color", color)
```

**Explanation:** Updates the streak counter with color feedback based on meaningful game thresholds (5 = building, 10 = Perfect Form activates).

### Update Heavy Combo Display

```gdscript
func _update_heavy_combo_display(stacks: int, timer: float):
    if not heavy_stacks_label:
        push_warning("Heavy stacks label not found - heavy combo display unavailable")
        return

    heavy_stacks_label.text = "Heavy: %d" % stacks

    # Color based on stack count using helper
    var color = _get_combo_color(stacks, 3, 5)
    heavy_stacks_label.add_theme_color_override("font_color", color)

    if heavy_timer_bar:
        # Calculate max timer (base + extensions)
        var base_timer = 5.0
        var extension = Level1Vars.get_heavy_timer_extension()
        heavy_timer_bar.max_value = base_timer + extension
        heavy_timer_bar.value = max(0.0, timer)  # Prevent negative values

        # Show/hide bar based on active timer
        heavy_timer_bar.visible = timer > 0.0
```

**Explanation:** Updates both the stack count and the visual timer bar. Timer bar only visible when countdown is active.

### Rebuild Benefits List

```gdscript
func _rebuild_benefits_list():
    if not benefits_list:
        push_warning("Benefits list not found - tooltip content unavailable")
        return

    # Clear existing labels (use free() not queue_free() to prevent buildup on rapid hovering)
    for child in benefits_list.get_children():
        child.free()

    var benefits = _get_active_benefits()

    # Show at least header even if no benefits
    for benefit in benefits:
        var label = Label.new()
        label.text = "%s: %s" % [benefit["label"], benefit["value"]]
        label.add_theme_color_override("font_color", benefit["color"])
        label.add_theme_font_size_override("font_size", BENEFIT_FONT_SIZE)
        benefits_list.add_child(label)
```

**Explanation:** Dynamically creates labels for each active benefit. Clears and rebuilds on each update to handle changing combo states.

---

## Testing Strategy

### Manual Test Criteria

**Clean Streak Display:**
- [ ] Panel hidden when no combo technique selected
- [ ] Panel appears after selecting first clean_streak technique
- [ ] Panel shows "Streak: 0/20" when unlocked but at zero (not hidden)
- [ ] Counter increments on successful coal delivery
- [ ] Counter shows correct max value from Streak Ceiling technique
- [ ] Forgiveness charges display appears when Forgiveness unlocked
- [ ] Forgiveness charges increment correctly (verify with 2.12 implementation)
- [ ] Counter resets to 0 on drop (without forgiveness)
- [ ] Color changes at 5 streak (green)
- [ ] Color changes at 10 streak (gold)

**Heavy Load Combo Display:**
- [ ] Panel hidden when no heavy technique selected
- [ ] Panel appears after selecting first heavy_combo technique
- [ ] Panel shows "Heavy: 0" when unlocked but at zero (not hidden)
- [ ] Stacks counter increments on heavy load trigger (verify with 2.12 implementation)
- [ ] Timer bar appears when combo active
- [ ] Timer bar counts down in real-time
- [ ] Timer bar hides when combo expires
- [ ] Timer bar never shows negative values
- [ ] Color changes at 3 stacks (green)
- [ ] Color changes at 5 stacks (gold)

**Benefits Tooltip (Hover-based):**
- [ ] Tooltip hidden by default (not visible until hover)
- [ ] Tooltip appears when hovering over clean streak panel
- [ ] Tooltip appears when hovering over heavy combo panel
- [ ] Tooltip positioned to right of hovered panel (not at mouse cursor)
- [ ] Tooltip stays visible when moving between panels (shared tooltip)
- [ ] Tooltip updates content when switching from clean to heavy panel
- [ ] Tooltip hides when mouse exits all combo panels
- [ ] Shows stamina reduction when techniques active (verify method exists)
- [ ] Shows XP bonus when combo-based XP techniques active (verify method exists)
- [ ] Shows mass bonus when mass techniques active (verify method exists)
- [ ] Shows "Combo System Active" fallback when unlocked but no bonuses
- [ ] Values update when re-hovering after combo change (not automatically)
- [ ] Percentages display correctly (no floating point weirdness)
- [ ] Tooltip does NOT rebuild on every combo signal (performance check)

**Integration:**
- [ ] All panels update correctly after returning from Mind scene
- [ ] UI survives scene reload
- [ ] No performance issues with rapid updates

---

## Files to Create

None - all changes are modifications to existing files.

## Files to Modify

- [level1/furnace.tscn](../../game/v0.1/level1/furnace.tscn):
  - Add ComboContainer (VBoxContainer) to Menu
  - Add NodropComboPanel with streak display
  - Add HeavyComboPanel with stacks and timer bar
  - Add BenefitsTooltip (hidden by default) with header and list container

- [level1/furnace.gd](../../game/v0.1/level1/furnace.gd):
  - Add @onready references for new UI elements (all combo panels, labels, tooltip)
  - Add BENEFIT_COLORS constant dictionary
  - Add _hovered_panel variable for tooltip tracking
  - Add signal connections in _ready() (combo signals + mouse events with warnings)
  - Add mouse event connections for hover with panel binding
  - Add _get_combo_color() helper function
  - Add _update_combo_panel_visibility()
  - Add _update_clean_streak_display() (with forgiveness charges)
  - Add _update_heavy_combo_display() (with negative value protection)
  - Add _get_active_benefits() (with fallback message)
  - Add _rebuild_benefits_list() (with warning on missing nodes)
  - Add _on_combo_panel_hover_start(panel) handler with positioning
  - Add _on_combo_panel_hover_end() handler
  - Add _position_tooltip_near_panel() function
  - Add _on_technique_updated() handler
  - Modify _process() to update heavy timer bar conditionally (only when visible and active)

---

## Design Values (Reference)

### Color Thresholds

**Clean Streak:**
- 0-4: White (default)
- 5-9: Green (momentum building)
- 10+: Gold (Perfect Form active)

**Heavy Combo:**
- 1-2: White (default)
- 3-4: Green (building stacks)
- 5+: Gold (strong bonus)

### Panel Styling

**How to apply**: Create StyleBoxFlat for each combo panel and tooltip in Godot editor or via code.

**StyleBox Properties**:
- Background: `Color(0.1, 0.1, 0.1, 0.7)` - semi-transparent dark
- Border: `Color(0.3, 0.3, 0.3, 0.5)` - subtle grey
- Border width: 2px (all sides)
- Corner radius: 4px (all corners)
- Content margin: 8px (all sides)

**Example code** (if creating via script in _ready()):
```gdscript
func _setup_panel_styling():
    var panel_style = StyleBoxFlat.new()
    panel_style.bg_color = Color(0.1, 0.1, 0.1, 0.7)
    panel_style.border_color = Color(0.3, 0.3, 0.3, 0.5)
    panel_style.border_width_all = 2
    panel_style.corner_radius_all = PANEL_CORNER_RADIUS
    panel_style.content_margin_all = PANEL_PADDING

    # Apply to panels
    if clean_streak_panel:
        clean_streak_panel.add_theme_stylebox_override("panel", panel_style.duplicate())
    if heavy_combo_panel:
        heavy_combo_panel.add_theme_stylebox_override("panel", panel_style.duplicate())
    if benefits_tooltip:
        benefits_tooltip.add_theme_stylebox_override("panel", panel_style.duplicate())
```

**Preferred method**: Use Godot editor to apply StyleBoxFlat to panels during scene creation for easier visual adjustment.

### Font Sizes

- Combo labels: 16px
- Max combo label: 14px (dimmed)
- Benefits header: 16px bold
- Benefits items: 14px

---

## UI Mockups

### Full Menu Layout (Default - No Hover)

```
+----------------------------------+
| [Stamina Bar ################]   |
| [Focus Bar   ################]   |
+----------------------------------+
| [fire] Streak: 15/30             |  <- Only when nodrop unlocked
| [weight] Heavy: 3 [=====---]     |  <- Only when heavy unlocked
+----------------------------------+
| [To Mind] [DEBUG...]             |
+----------------------------------+
```

### Hovering Over Combo Panel (Tooltip Appears)

```
+----------------------------------+
| [Stamina Bar ################]   |
| [Focus Bar   ################]   |
+----------------------------------+
| [fire] Streak: 15/30  <--- HOVER |
| [weight] Heavy: 3 [=====---]     |
|  +-------------------------+     |
|  | Active Bonuses          |     | <- Tooltip appears on hover
|  | - Stamina Drain: -45%   |     |
|  | - XP Bonus: +180%       |     |
|  +-------------------------+     |
+----------------------------------+
| [To Mind] [DEBUG...]             |
+----------------------------------+
```

### Compact State (No Combos)

```
+----------------------------------+
| [Stamina Bar ################]   |
| [Focus Bar   ################]   |
+----------------------------------+
| [To Mind]                        |
+----------------------------------+
```

### Initial State (No Techniques)

```
+----------------------------------+
| [Stamina Bar ################]   |
| [Focus Bar   ################]   |
+----------------------------------+
| [To Mind]                        |
+----------------------------------+
```

---

## Notes & Decisions

**Decision 1:** Combine combo meters and benefits in same UI area
- **Rationale**: All technique-related feedback in one place, reduces UI clutter
- **Alternatives considered**: Separate floating panels (rejected - harder to position consistently)

**Decision 2:** Show benefits as calculated percentages, not per-technique breakdown
- **Rationale**: Players care about total effect, not individual contributions
- **Alternatives considered**: Per-technique list (rejected - too verbose, hard to read at a glance)

**Decision 3:** Color thresholds match gameplay milestones
- **Rationale**: 10+ streak = Perfect Form threshold (gold makes sense)
- **Alternatives considered**: Linear color gradient (rejected - no meaningful breakpoints)

**Decision 4:** Hide panels when systems not unlocked
- **Rationale**: Progressive disclosure - don't confuse new players with irrelevant UI
- **Alternatives considered**: Show greyed-out panels (rejected - still clutters UI)

**Decision 5:** Hover-based benefits tooltip instead of always-visible panel
- **Rationale**:
  - **Performance**: Benefits only calculate on hover (rare, player-initiated) vs every combo signal (frequent during gameplay)
  - **BIBLE alignment**: Exact percentages hidden by default, player investigates instead of passive display (knowledge-based progression)
  - **UI clarity**: Cleaner default state, less visual noise in menu
  - **Context-appropriate**: When actively playing, player sees combo counts. When investigating bonuses, they hover.
- **Alternatives considered**: Always-visible panel (rejected - performance + BIBLE issues), no benefits display (rejected - player needs feedback)

**Open Questions:**
- [ ] Should there be audio feedback when reaching color thresholds?
- [ ] Should there be a visual "pulse" effect when combo increases?
- [ ] Should combo panels have subtle highlight on hover to indicate interactivity?

**Resolved Decisions:**
- [x] Forgiveness charges shown in clean streak panel: "Streak: 15/30 [2]"
- [x] Tooltip anchored to hovered panel (not mouse cursor)
- [x] Shared tooltip between panels (updates content, stays visible when switching)
- [x] Panels always shown when combo unlocked (even at 0 count)

---

## Implementation Checklist

**Pre-Implementation Verification (MUST COMPLETE FIRST):**
- [ ] **Verify 2.12 is fully implemented** - Read [level_1_vars.gd](../../game/v0.1/level1/level_1_vars.gd) and confirm:
  - [ ] Variables exist: clean_streak_count, heavy_combo_stacks, forgiveness_charges, clean_streak_unlocked, heavy_combo_unlocked
  - [ ] Signals exist: clean_streak_changed, heavy_combo_changed, technique_updated
  - [ ] Methods exist: get_base_stamina_drain_multiplier(), get_xp_multiplier(), get_shovel_mass_multiplier(), get_clean_streak_max(), get_heavy_timer_extension()
- [ ] **Verify index shift safety** - Search furnace.gd for Menu child access:
  - [ ] Confirm no `Menu.get_child(index)` calls that would break when ToMindButton shifts to index 4
  - [ ] Confirm all Menu child references use paths (e.g., `$AspectContainer/.../ToMindButton`) not indices
  - [ ] If any index-based access found, update those references before proceeding

**Scene Structure (furnace.tscn):**
- [ ] Add ComboContainer to Menu (insert at index 2, after FocusBar)
- [ ] Add NodropComboPanel with ComboLabel and ForgivenessLabel
- [ ] Add HeavyComboPanel with HeavyStacksLabel and HeavyTimerBar
- [ ] Add BenefitsTooltip (hidden by default) with header and BenefitsList container
- [ ] Style all panels with consistent theme (reference existing panel styles)
- [ ] Configure ComboContainer spacing (6px) and initial visibility (false)

**Code Implementation (furnace.gd):**
- [ ] Add UI constants (COMBO_CONTAINER_SPACING, TOOLTIP_OFFSET, BENEFIT_FONT_SIZE, PANEL_PADDING, PANEL_CORNER_RADIUS)
- [ ] Add @onready references with full paths (all panels, labels, bars, tooltip)
- [ ] Add BENEFIT_COLORS constant dictionary
- [ ] Add _hovered_panel variable
- [ ] Connect Level1Vars signals in _ready() with error handling
- [ ] Connect mouse events in _ready() with panel binding and warnings
- [ ] Implement _get_combo_color() helper function
- [ ] Implement _update_combo_panel_visibility()
- [ ] Implement _update_clean_streak_display() (with forgiveness charges)
- [ ] Implement _update_heavy_combo_display() (with negative protection)
- [ ] Implement _get_active_benefits() (with fallback message for zero-state)
- [ ] Implement _rebuild_benefits_list() (use free() not queue_free(), use BENEFIT_FONT_SIZE constant)
- [ ] Implement _on_combo_panel_hover_start(panel) handler
- [ ] Implement _on_combo_panel_hover_end() handler
- [ ] Implement _position_tooltip_near_panel() (use global_position, add viewport clamping)
- [ ] Implement _on_technique_updated() handler
- [ ] Implement _exit_tree() for signal cleanup
- [ ] Modify _process() to update heavy timer bar conditionally
- [ ] Optional: Implement _setup_panel_styling() if applying styles via code instead of editor

**Testing:**
- [ ] Test tooltip appears on hover over clean streak panel
- [ ] Test tooltip appears on hover over heavy combo panel
- [ ] Test tooltip positioned to right of hovered panel (not mouse cursor)
- [ ] Test tooltip viewport clamping (hover near right edge - tooltip should not go offscreen)
- [ ] Test tooltip viewport clamping (hover near bottom edge - tooltip should adjust position)
- [ ] Test tooltip stays visible when moving between panels
- [ ] Test tooltip hides when mouse exits all panels
- [ ] Test tooltip does NOT rebuild on combo signals (performance verification)
- [ ] Test rapid hovering doesn't cause memory buildup (verify free() cleanup works)
- [ ] Test forgiveness charges display correctly
- [ ] Test zero-state display (panels show "0" when unlocked)
- [ ] Test fallback message appears when combo unlocked but no bonuses active
- [ ] Verify ToMindButton still works after index shift to position 4
- [ ] All manual tests passing
- [ ] UI tested at target resolution

---

**Last Updated**: 2025-12-31
**Status**: Ready for Implementation
**Version**: 1.3
**Depends On**: [2.12-upgrade-pool.md](2.12-upgrade-pool.md) (combo system implementation)

**Changelog v1.3** (2025-12-31):
- **CRITICAL FIXES**:
  - Fixed tooltip positioning to use `global_position` instead of local `position` (panels have different parents)
  - Added viewport clamping to prevent tooltip from going offscreen
  - Added prominent Prerequisites section at top verifying 2.12 dependencies upfront
  - Added explicit scene editing instructions (manual Godot editor method)
  - Added index shift safety verification to prevent breaking existing code
- **PERFORMANCE IMPROVEMENTS**:
  - Changed `queue_free()` to `free()` in _rebuild_benefits_list() to prevent memory buildup on rapid hovering
  - Added signal cleanup in `_exit_tree()` for proper resource management
- **CODE QUALITY**:
  - Added UI constants (COMBO_CONTAINER_SPACING, TOOLTIP_OFFSET, BENEFIT_FONT_SIZE, etc.)
  - Added detailed panel styling instructions with StyleBoxFlat example code
  - Clarified fallback message scenario (combo unlocked but no active bonuses)
- **DOCUMENTATION**:
  - Specified coordinate space handling for tooltip positioning
  - Added testing criteria for viewport clamping and memory cleanup
  - Updated implementation checklist with all new requirements

**Changelog v1.2** (2025-12-31):
- **Critical Fixes**:
  - Specified tooltip positioning strategy: anchored to panel (not mouse cursor)
  - Added complete node paths for all scene structure elements
  - Replaced Color.GREEN/GOLD/CYAN with BENEFIT_COLORS constant dictionary
  - Added forgiveness charges display to clean streak panel
- **Improvements**:
  - Shared tooltip between panels (no flicker when switching)
  - Added _get_combo_color() helper to reduce duplication
  - Added null checks and warnings for all UI element access
  - Added fallback message when combos unlocked but no bonuses active
  - Added negative value protection for timer bar
  - Specified zero-state behavior (panels always visible when unlocked)
  - Added pre-implementation verification checklist for 2.12 dependencies
- **Documentation**:
  - Clarified scene insertion point (index 2, after FocusBar)
  - Added complete @onready paths matching furnace.gd patterns
  - Updated testing criteria with positioning and zero-state tests
  - Resolved open questions about tooltip positioning and forgiveness display

**Changelog v1.1** (2025-12-31):
- **MAJOR CHANGE**: Benefits display changed from always-visible panel to hover-based tooltip
- **Performance**: Benefits only calculate on hover (rare) vs every combo signal (frequent)
- **BIBLE alignment**: Exact percentages hidden by default, player investigates (knowledge-based progression)
- **UI cleanup**: Removed ActiveBenefitsPanel from default menu layout, replaced with BenefitsTooltip
