# Train Shake Mechanic

**Goal**: Create a random environmental hazard where the train shakes, disrupting coal physics and requiring player skill to maintain coal on the shovel.

**Success Criteria**:
- Random shake events occur every 20-60 seconds (configurable interval)
- Warning shake (10-20% intensity) plays 500ms before big shake (upgradeable warning time)
- Big shake (0.5-2 second random duration) applies camera shake and physics impulses to all coal
- Warning shake plays rumble sound effect
- Shovel remains under player control (no physics impulses applied to shovel)
- Overlapping shakes are prevented (new shake ignored if one is active)
- All timing and intensity values stored in Level1Vars for runtime upgradeability

## Overview

The train shake mechanic adds unpredictable difficulty spikes to the shoveling gameplay. As the player works, the train periodically shakes from track bumps or mechanical stress. A brief warning shake gives the player time to prepare (tilt shovel level, reduce coal load, etc.), then a stronger shake makes all coal pieces jump and shift, potentially falling off the shovel.

This creates a risk/reward dynamic: carry more coal for faster progress, but risk losing it all during a shake. The upgradeable warning time creates progression where skilled players can react faster, or upgraded players get more prep time.

### Key Design Principles

- **Player agency preserved**: Shovel remains fully controllable during shakes - player skill determines coal retention
- **Fair warning system**: Predictable 500ms warning (upgradeable) prevents feel-bad surprise losses
- **Affects all coal**: Realistic shake physics - everything in the scene shakes, not just shovel coal
- **No overlap allowed**: Prevents chaotic stacking of shake effects
- **Fully configurable**: All values in Level1Vars for easy balancing and upgrade implementation

### Knowledge-as-Progression Alignment

**Reference**: [game-design-principles.md#knowledge-as-progression](.claude/docs/game-design-principles.md#knowledge-as-progression-high-priority-for-goa)

This mechanic follows GoA's core philosophy: players learn through observation, not tutorials.

**Hidden Knowledge to Discover**:
- **Shake patterns**: Players learn to recognize the warning rumble and anticipate big shakes
- **Optimal shovel technique**: Level positioning prevents coal loss, tilted shovel loses everything
- **Coal load management**: Fewer pieces = easier to stabilize during shakes
- **Timing mastery**: Experienced players develop rhythm for when to shovel vs when to wait

**No Explicit Tutorial**:
- Shakes happen without explanation - players experience consequence first
- Warning sound teaches cause-and-effect (rumble -> shake incoming)
- No UI text saying "Shake in 0.5 seconds!" - players feel it
- Upgrades improve warning time but don't display the value (players just notice "I have more time now")

**Discovery Progression**:
1. **First shake**: Surprise, likely lose coal, confusion
2. **Second shake**: Recognition of warning rumble, attempt to prepare
3. **After 5-10 shakes**: Pattern recognition, proactive positioning
4. **Mastery**: Predict shakes, maintain large coal loads confidently

**Why This Works**:
- Players feel smart discovering strategies themselves
- "Aha moment" when realizing level shovel = coal retention
- Upgrades feel earned (more reaction time) not just numerical
- Skill expression: good players can handle shakes, bad players struggle

---

## Implementation Methodology

**[!] CRITICAL: This implementation follows Test-Driven Development (TDD) per BIBLE.md requirements.**

### RED-GREEN-REFACTOR Cycle

All implementation must follow the TDD cycle:

1. **RED**: Write a failing test that defines desired behavior
2. **GREEN**: Write minimal code to make the test pass
3. **REFACTOR**: Improve code quality while keeping tests green

### Implementation Order (TDD-Driven)

Each task below follows this pattern:
1. Write the failing test first (verify it fails)
2. Implement minimal code to pass the test
3. Refactor for quality
4. Move to next test

**Test file**: Create `tests/test_phase_2_11_train_shake.gd` before starting implementation.

**Key TDD Rules**:
- No production code without a failing test first
- Tests must fail for the RIGHT reason before implementing
- Keep tests green throughout refactoring
- One behavior per test

---

## Implementation Tasks

### 1. Level1Vars Configuration

Add shake configuration variables to Level1Vars autoload.

**In level_1_vars.gd**, add these variables:

```gdscript
# Train shake mechanic
var shake_interval_min: float = 15.0  # Minimum seconds between shakes
var shake_interval_max: float = 60.0  # Maximum seconds between shakes
var shake_warning_duration: float = 0.5  # Warning time in seconds (upgradeable)
var shake_warning_intensity: float = 1.2  # Warning shake camera intensity (15% of big shake = 1.2/8.0)
var shake_big_duration_min: float = 0.5  # Big shake minimum duration
var shake_big_duration_max: float = 2.0  # Big shake maximum duration
var shake_big_intensity: float = 8.0  # Big shake camera intensity (pixels)
var shake_coal_impulse_strength: float = 75.0  # Physics impulse applied to coal (pixels/sec) - Tuned via playtesting
var shake_enabled: bool = true  # Master switch to enable/disable shakes
```

**Design rationale:**
- `shake_warning_duration` is the primary upgrade target (500ms -> 1000ms -> 1500ms etc.)
- `shake_interval_min/max` allow balancing shake frequency without code changes
- `shake_coal_impulse_strength` controls how much coal jumps - higher = more chaotic
- `shake_enabled` allows disabling for testing or accessibility

### 2. TrainShake Autoload

Create centralized shake system as autoload singleton.

**Create file: res://autoloads/train_shake.gd**

```gdscript
extends Node

# References set by scene
var camera: Camera2D = null
var coal_container: Node2D = null  # Parent node containing all coal RigidBody2D children

# Shake state
enum ShakeState { IDLE, WARNING, BIG_SHAKE }
var current_state: ShakeState = ShakeState.IDLE
var next_shake_timer: float = 0.0
var current_shake_timer: float = 0.0

# Camera shake offset tracking
var shake_offset: Vector2 = Vector2.ZERO

func _ready():
    randomize()
    schedule_next_shake()

func _process(delta):
    match current_state:
        ShakeState.IDLE:
            process_idle(delta)
        ShakeState.WARNING:
            process_warning(delta)
        ShakeState.BIG_SHAKE:
            process_big_shake(delta)

func process_idle(delta):
    if not Level1Vars.shake_enabled:
        return

    next_shake_timer -= delta

    if next_shake_timer <= 0.0:
        start_warning_shake()

func process_warning(delta):
    # Force cleanup if disabled mid-shake
    if not Level1Vars.shake_enabled:
        end_shake()
        return

    current_shake_timer -= delta

    # Apply warning shake to camera
    apply_camera_shake(Level1Vars.shake_warning_intensity)

    if current_shake_timer <= 0.0:
        start_big_shake()

func process_big_shake(delta):
    # Force cleanup if disabled mid-shake
    if not Level1Vars.shake_enabled:
        end_shake()
        return

    current_shake_timer -= delta

    # Apply big shake to camera
    apply_camera_shake(Level1Vars.shake_big_intensity)

    if current_shake_timer <= 0.0:
        end_shake()

func start_warning_shake():
    # Ignore if shake already active
    if current_state != ShakeState.IDLE:
        return

    current_state = ShakeState.WARNING
    current_shake_timer = Level1Vars.shake_warning_duration

    # Play warning sound
    play_warning_sound()

func start_big_shake():
    current_state = ShakeState.BIG_SHAKE

    # Random duration between min and max
    var duration = randf_range(Level1Vars.shake_big_duration_min, Level1Vars.shake_big_duration_max)
    current_shake_timer = duration

    # Apply coal shake impulse ONCE at shake start (not every frame to avoid accumulation)
    apply_coal_shake()

func end_shake():
    current_state = ShakeState.IDLE
    shake_offset = Vector2.ZERO

    # Reset camera offset
    if camera:
        camera.offset = Vector2.ZERO

    # Schedule next shake
    schedule_next_shake()

func schedule_next_shake():
    next_shake_timer = randf_range(Level1Vars.shake_interval_min, Level1Vars.shake_interval_max)

func apply_camera_shake(intensity: float):
    if not camera:
        return

    # Generate random target offset, then interpolate for smooth shake (prevents nauseating jitter)
    var target_angle = randf() * TAU
    var target_offset = Vector2(cos(target_angle), sin(target_angle)) * intensity
    shake_offset = shake_offset.lerp(target_offset, 0.3)  # Smooth interpolation

    camera.offset = shake_offset

func apply_coal_shake():
    # IMPORTANT: Coal pieces are NOT children of coal_container
    # They're spawned to PlayArea (see 2.3-coal-spawning.md line 374: playarea.add_child(coal))
    # Use the "coal" group instead (coal pieces add themselves in coal_piece.gd:7)
    var coal_pieces = get_tree().get_nodes_in_group("coal")

    for coal in coal_pieces:
        if coal is RigidBody2D:
            # Apply random impulse in random direction
            var angle = randf() * TAU
            var impulse = Vector2(cos(angle), sin(angle)) * Level1Vars.shake_coal_impulse_strength
            coal.apply_central_impulse(impulse)

func play_warning_sound():
    # TODO: Implement audio system integration
    # AudioManager.play_sfx("train_rumble_warning")
    print("[SHAKE] Warning sound would play here")

# Called by scene to provide references
func initialize(cam: Camera2D, coal_parent: Node2D):
    camera = cam
    coal_container = coal_parent
```

**Explanation:**
- State machine tracks IDLE -> WARNING -> BIG_SHAKE -> IDLE cycle
- Timer system handles both interval countdown and shake duration
- Camera shake uses interpolated random offsets for smooth movement (prevents jitter)
- Coal shake applies impulse ONCE at big shake start (prevents force accumulation bug)
- Ignores new shake requests if already active (prevents overlap)

### 3. Furnace Scene Integration

Integrate TrainShake autoload into the furnace scene.

**In furnace.gd**, add camera and coal container references:

```gdscript
@onready var camera: Camera2D = $Camera2D  # Add Camera2D to furnace.tscn if not present
@onready var coal_container: Node2D = $AspectContainer/MainContainer/mainarea/PlayArea/CoalContainer
```

**In furnace.gd `_ready()` function**, initialize TrainShake after physics setup:

```gdscript
func _ready():
    ResponsiveLayout.apply_to_scene(self)
    connect_navigation()
    await get_tree().process_frame
    setup_physics_objects()

    # Validate nodes exist before initializing shake system
    assert(camera != null, "Camera2D not found - add Camera2D node to furnace.tscn")
    assert(coal_container != null, "CoalContainer not found at path: AspectContainer/MainContainer/mainarea/PlayArea/CoalContainer")

    # Initialize train shake system
    TrainShake.initialize(camera, coal_container)
```

**In furnace.tscn:**
- Add Camera2D node at root level of furnace scene (if not present)
- Ensure coal pieces are children of a Node2D named "CoalContainer" under PlayArea
- Camera2D should have `enabled = true` and be set as current camera

**Camera setup in furnace.tscn:**
```
Camera2D
  - enabled: true
  - anchor_mode: ANCHOR_MODE_FIXED_TOP_LEFT
  - offset: Vector2(0, 0)
```

### 4. Project Autoload Registration

Register TrainShake as autoload singleton.

**In project.godot**, add autoload entry:

```ini
[autoload]

TrainShake="*res://autoloads/train_shake.gd"
```

**Manual steps:**
1. Open Project -> Project Settings -> Autoload tab
2. Add new autoload:
   - Path: `res://autoloads/train_shake.gd`
   - Name: `TrainShake`
   - Enable: checked
3. Click Add, then Close

---

## Code Examples

### Upgrade System Integration (Future)

When implementing warning time upgrades, modify Level1Vars:

```gdscript
func apply_warning_upgrade(level: int):
    # Each level adds 500ms to warning time
    shake_warning_duration = 0.5 + (level * 0.5)
    # Level 0: 500ms, Level 1: 1000ms, Level 2: 1500ms, etc.
```

### Manual Shake Trigger (Testing/Debug)

Add debug function to TrainShake for testing:

```gdscript
func force_shake():
    if current_state == ShakeState.IDLE:
        start_warning_shake()
```

Call from console or debug UI:
```gdscript
TrainShake.force_shake()
```

---

## Testing Strategy

### Unit Tests (Headless)

Testing shake timing and state transitions without visuals.

Create `tests/test_phase_2_11_train_shake.gd`:

```gdscript
extends GutTest

var train_shake: Node

func before_each():
    train_shake = load("res://autoloads/train_shake.gd").new()
    add_child(train_shake)
    Level1Vars.shake_enabled = true
    Level1Vars.shake_warning_duration = 0.5
    Level1Vars.shake_big_duration_min = 0.5
    Level1Vars.shake_big_duration_max = 2.0

func after_each():
    train_shake.queue_free()

func test_initial_state_is_idle():
    assert_eq(train_shake.current_state, train_shake.ShakeState.IDLE)

func test_shake_disabled_prevents_activation():
    Level1Vars.shake_enabled = false
    train_shake.next_shake_timer = 0.0
    train_shake.process_idle(0.1)
    assert_eq(train_shake.current_state, train_shake.ShakeState.IDLE)

func test_warning_shake_starts_after_timer():
    train_shake.next_shake_timer = 0.0
    train_shake.process_idle(0.1)
    assert_eq(train_shake.current_state, train_shake.ShakeState.WARNING)

func test_warning_transitions_to_big_shake():
    train_shake.start_warning_shake()
    train_shake.current_shake_timer = 0.0
    train_shake.process_warning(0.1)
    assert_eq(train_shake.current_state, train_shake.ShakeState.BIG_SHAKE)

func test_big_shake_transitions_to_idle():
    train_shake.start_big_shake()
    train_shake.current_shake_timer = 0.0
    train_shake.process_big_shake(0.1)
    assert_eq(train_shake.current_state, train_shake.ShakeState.IDLE)

func test_overlapping_shake_ignored():
    train_shake.start_warning_shake()
    var timer_before = train_shake.current_shake_timer
    train_shake.start_warning_shake()  # Should be ignored
    assert_eq(train_shake.current_shake_timer, timer_before)

func test_shake_duration_randomized():
    var durations = []
    for i in range(10):
        train_shake.start_big_shake()
        durations.append(train_shake.current_shake_timer)

    # Check that not all durations are identical (random variance exists)
    var all_same = true
    for i in range(1, durations.size()):
        if durations[i] != durations[0]:
            all_same = false
            break
    assert_false(all_same, "Shake durations should vary")

func test_shake_disabled_mid_shake_cleanup():
    train_shake.start_warning_shake()
    Level1Vars.shake_enabled = false
    train_shake.process_warning(0.1)
    assert_eq(train_shake.current_state, train_shake.ShakeState.IDLE, "Should force cleanup when disabled mid-shake")
```

**Test Cases:**
- [x] Initial state is IDLE
- [x] Shake disabled prevents activation
- [x] Warning shake starts after timer expires
- [x] Warning transitions to big shake after warning duration
- [x] Big shake transitions to idle after random duration
- [x] Overlapping shake requests are ignored
- [x] Shake duration is randomized within configured range
- [x] Disabling shake mid-shake forces cleanup

**Run tests:**
```bash
godot --headless --script res://tests/test_runner.gd
```

### Integration Tests

Test shake system interaction with coal physics.

**Test Scenarios:**

| Scenario | Setup | Action | Expected Result |
|----------|-------|--------|-----------------|
| Coal impulse application | Spawn coal, start big shake | Wait 1 frame | All coal RigidBody2D receive impulses, velocities != 0 |
| Camera shake offset | Initialize camera ref | Trigger warning shake | Camera.offset changes each frame during shake |
| No camera crash | No camera reference set | Trigger shake | No errors, shake continues normally |
| No coal crash | No coal container set | Trigger shake | No errors, shake continues normally |
| Shake resets camera | Camera offset during shake | Shake ends | Camera.offset returns to Vector2.ZERO |
| Performance with max coal | Spawn 100 coal pieces (max from 2.3-coal-spawning.md) | Trigger big shake | apply_coal_shake() completes in < 1ms, no frame drops |

**Performance Test Details:**

```gdscript
# Add to integration test suite
func test_shake_performance_with_max_coal():
    # Setup coal container
    var container = Node2D.new()
    add_child(container)

    # Spawn 100 coal pieces (max from plan 2.3-coal-spawning.md)
    for i in range(100):
        var coal = RigidBody2D.new()
        coal.position = Vector2(randf() * 100, randf() * 100)
        container.add_child(coal)

    # Initialize shake system
    train_shake.coal_container = container

    # Measure performance
    var start_time = Time.get_ticks_usec()
    train_shake.apply_coal_shake()
    var duration = Time.get_ticks_usec() - start_time

    # Assert performance target: should complete in < 1000 microseconds (1ms)
    assert_lt(duration, 1000, "Shake with 100 coal should complete in < 1ms, took: %d usec" % duration)

    # Cleanup
    container.queue_free()
```

### Manual Test Criteria

Manual testing for feel, timing, and player experience.

- [ ] Warning shake is subtle - noticeable but not disruptive
- [ ] Warning sound plays clearly during warning phase
- [ ] Big shake is dramatically stronger than warning (visually obvious difference)
- [ ] Coal jumps and bounces during big shake (physics impulses working)
- [ ] Coal on shovel can fall off during shake if not balanced properly
- [ ] Shovel remains fully controllable during shake (no unwanted movement)
- [ ] Shakes occur at reasonable intervals (not too frequent/rare)
- [ ] No screen tearing or visual glitches during camera shake
- [ ] Camera returns to centered position after shake ends
- [ ] Consecutive shakes don't overlap or cause stutter
- [ ] Changing warning duration in Level1Vars affects timing correctly
- [ ] Disabling shakes (shake_enabled = false) prevents new shakes

---

## Files to Create

- `res://autoloads/train_shake.gd` - TrainShake autoload singleton
- `tests/test_phase_2_11_train_shake.gd` - Unit test suite

## Files to Modify

- `level_1_vars.gd` - Add shake configuration variables
- `level1/furnace.gd` - Add camera/coal container references, initialize TrainShake
- `level1/furnace.tscn` - Add Camera2D node, ensure CoalContainer node exists
- `project.godot` - Register TrainShake autoload

---

## Design Values (Reference)

### Shake Timing
- **Warning duration**: 0.5 seconds (500ms) - **UPGRADEABLE**
- **Big shake duration**: Random 0.5 to 2.0 seconds - Creates unpredictability
- **Shake interval**: Random 15 to 60 seconds - Prevents pattern memorization

### Shake Intensity
- **Warning intensity**: 1.2 (15% of big shake) - Noticeable but gentle
- **Big shake intensity**: 8.0 pixels - Enough to be dramatic without inducing motion sickness
- **Coal impulse strength**: 75.0 pixels/sec - Applied ONCE at shake start (tuned via playtesting)

**Intensity rationale:**
- Warning at 15% (1.2 warning vs 8.0 big) = noticeable camera movement, feels like distant rumble
- Big shake at 8px = clear screen movement without being nauseating
- Coal impulse at 75.0 applied once = enough to make coal jump without flying off screen (tuned down from original 150.0 after testing showed it was too powerful)
- Interpolated camera shake (lerp 0.3) prevents jittery motion sickness

### Upgrade Progression (Example)

| Upgrade Level | Warning Duration | Cost (Example) |
|---------------|------------------|----------------|
| 0 (Base) | 500ms | N/A |
| 1 | 1000ms | 500 coal |
| 2 | 1500ms | 2000 coal |
| 3 | 2000ms | 5000 coal |
| 4 | 2500ms | 10000 coal |

**Warning time scaling**: Each level adds 500ms. Diminishing returns make early upgrades most valuable.

---

## Notes & Decisions

**Decision 1: Autoload vs Scene Component**
- **Chosen**: Autoload singleton
- **Rationale**:
  - Centralized state prevents multiple shake timers in different scenes
  - Easy access from anywhere (debug, UI, other systems)
  - Survives scene transitions if game expands to multiple levels
- **Alternative considered**: Component in furnace.gd - rejected because harder to test and less flexible

**Decision 2: Camera Shake vs Viewport Transform**
- **Chosen**: Camera2D offset manipulation
- **Rationale**:
  - Simple and direct - just modify camera.offset each frame
  - No compatibility issues with Godot 4.5
  - Easy to reset (set offset to zero)
- **Alternative considered**: Viewport transform shake - rejected as more complex

**Decision 3: Per-Frame Impulses vs Single Impulse**
- **Chosen**: Apply single impulse at BIG_SHAKE start
- **Rationale**:
  - Per-frame impulses accumulate (60fps * 1sec * 150 = 9000 pixels/sec - coal flies off screen)
  - Single impulse is physics-correct and predictable
  - Easier to tune and balance
  - Can increase impulse strength if more chaos needed
- **Alternative considered**: Per-frame impulses - rejected due to force accumulation bug

**Decision 4: Warning Sound Placeholder**
- **Chosen**: Print statement placeholder (no audio implementation planned currently)
- **Rationale**:
  - No audio system implementation plans as of now
  - Plan focuses on shake mechanics, not audio pipeline
  - Placeholder allows testing shake functionality without audio dependency
  - Easy to replace with real audio call when/if audio system is implemented
- **Note**: Audio integration is deferred - shake mechanic functional without it

**Decision 5: Shake Affects All Coal vs Shovel Coal Only**
- **Chosen**: All coal pieces in scene
- **Rationale**:
  - More realistic - entire train shakes, not just one area
  - Adds visual spectacle (coal pile jumps too)
  - User explicitly requested this approach
- **Alternative considered**: Only coal on shovel - rejected per user preference

**Decision 6: Shovel Physics Impulse**
- **Chosen**: Shovel NOT affected by shake
- **Rationale**:
  - Preserves player agency - skill determines coal retention
  - Less frustrating - player can compensate by leveling shovel
  - Difficulty comes from coal moving, not losing control
- **Alternative considered**: Shake shovel too - rejected per user preference

**Decision 7: Mysterious Discovery vs Explicit UI**
- **Chosen**: Mysterious discovery approach (knowledge-as-progression)
- **Rationale**:
  - Aligns with GoA's core design philosophy (players learn through observation)
  - Warning times and patterns are felt, not shown as numbers
  - Upgrades improve backend values but don't display them explicitly
  - Creates "aha moments" when players discover optimal strategies
  - Skill expression: good players learn to predict and prepare
- **Alternative considered**: Explicit timers and upgrade displays - rejected as contradicts game philosophy
- **Implementation**: Warning time in Level1Vars for balancing, but not displayed in UI

**Decision 8: Shake Frequency Scaling**
- **Chosen**: No frequency scaling in later gameplay
- **Rationale**:
  - Shake frequency stays constant throughout game (20-60 second intervals)
  - Difficulty comes from player skill improvement, not increasing pressure
  - Keeps mechanic predictable and masterable
- **Alternative considered**: Increase frequency in endgame - rejected to avoid punishing progression

**Decision 9: Performance Cap at 100 Coal**
- **Chosen**: Design assumes max 100 coal pieces (from plan 2.3-coal-spawning.md)
- **Rationale**:
  - Coal spawning caps at 100 pieces per gameplay design
  - Performance validated with 100-coal test (target: < 1ms)
  - Iterating 100 children once per shake is acceptable overhead
- **Confirmed**: Max coal count is hardcoded in plan 2.3-coal-spawning.md line 208

**Open Questions:**
- [ ] What sound effect should be used for warning? (rumble, bell, screech?)
- [ ] Should there be an upgrade to reduce shake intensity instead of/in addition to warning time?
- [ ] Should shakes pause during tutorial or first-time player experience?

---

## Common Issues & Prevention

### Camera Reference Not Set
**Problem**: TrainShake.camera is null, shake doesn't affect screen.

**Solution**: Ensure furnace.gd calls `TrainShake.initialize(camera, coal_container)` in _ready():
```gdscript
func _ready():
    # ... existing setup ...
    TrainShake.initialize(camera, coal_container)
```

### Coal Container Reference Wrong
**Problem**: Coal pieces aren't getting shake impulses.

**Solution**: Verify coal_container points to the correct parent node containing all coal RigidBody2D children. Check node path in furnace.gd:
```gdscript
@onready var coal_container: Node2D = $AspectContainer/MainContainer/mainarea/PlayArea/CoalContainer
```

### Shakes Overlapping Despite Prevention
**Problem**: Multiple shakes triggering simultaneously.

**Solution**: Check that `start_warning_shake()` early-returns if state != IDLE:
```gdscript
func start_warning_shake():
    if current_state != ShakeState.IDLE:
        return  # CRITICAL: prevents overlap
```

### Camera Doesn't Reset After Shake
**Problem**: Camera stays offset after shake ends.

**Solution**: Ensure `end_shake()` explicitly resets offset:
```gdscript
func end_shake():
    shake_offset = Vector2.ZERO
    if camera:
        camera.offset = Vector2.ZERO  # CRITICAL: reset camera
```

### Coal Flies Off Screen
**Problem**: Impulse strength too high, coal exits play area.

**Solution**: Impulse is applied ONCE at shake start (not per-frame). After playtesting, the final tuned value is 75.0 which provides good coal movement without excessive loss. Higher values = more chaos but risk losing coal permanently.

**Note**: Original plan had per-frame impulses which would accumulate to ~9000 pixels/sec - this was corrected to single impulse. Initial single impulse of 150.0 was still too strong, reduced to 75.0 after testing.

---

## Implementation Checklist

- [ ] Level1Vars shake configuration added (9 variables, warning_intensity = 1.2)
- [ ] TrainShake autoload created with state machine
- [ ] Camera shake system implemented (interpolated offset for smooth shake)
- [ ] Coal physics shake implemented (single impulse at shake start)
- [ ] Warning sound placeholder added (print statement)
- [ ] Furnace scene camera reference added
- [ ] Furnace scene coal container reference added
- [ ] TrainShake.initialize() called in furnace._ready()
- [ ] TrainShake registered as autoload in project.godot
- [ ] Unit tests created and passing
- [ ] Integration tests completed
- [ ] Manual tests completed
- [ ] Warning shake is subtle (10-20% intensity)
- [ ] Big shake is dramatic (8px camera movement)
- [ ] Shakes don't overlap (state check working)
- [ ] Coal moves during shake (impulses applied)
- [ ] Shovel remains controllable (no shovel impulses)
- [ ] Camera resets after shake (offset returns to zero)
- [ ] Warning duration upgradeable (Level1Vars.shake_warning_duration modifiable)

---

## Balance Tuning Notes

**Tuneable Parameters:**
- `shake_interval_min/max` in Level1Vars - Controls shake frequency (higher = less frequent, easier)
- `shake_warning_duration` in Level1Vars - Warning time before big shake (longer = easier, main upgrade target)
- `shake_warning_intensity` in Level1Vars - Subtlety of warning (lower = harder to notice, corrected to 1.2 = 15%)
- `shake_big_intensity` in Level1Vars - Camera shake strength (higher = more dramatic/nauseating, smoothed via lerp)
- `shake_big_duration_min/max` in Level1Vars - How long shake lasts (longer = harder)
- `shake_coal_impulse_strength` in Level1Vars - Single impulse strength at shake start (higher = coal jumps more)

**Expected Player Experience:**
- **First shake (no upgrades)**: Surprise -> panic -> likely lose coal -> learn to prepare
- **After learning**: Hear warning -> level shovel -> minimize coal load -> survive shake
- **With upgrades**: More warning time -> easier to react -> can maintain larger coal loads

**Warning Signs:**
- **Shakes too frequent**: Players can't establish rhythm -> increase interval_min
- **Shakes too rare**: Mechanic feels irrelevant -> decrease interval_max
- **Coal always lost**: Impulse too strong OR duration too long -> reduce strength or max duration
- **Shakes too easy**: Warning too long OR impulse too weak -> reduce warning time or increase strength
- **Motion sickness reports**: Camera intensity too high -> reduce shake_big_intensity below 8.0
- **Warning not noticed**: Intensity too low OR no sound -> increase warning_intensity or add audio

**Recommended Starting Point for Playtesting:**
- Interval: 15-60 seconds (reasonable frequency without being oppressive)
- Warning: 500ms (challenging but fair for skilled players)
- Big shake: 0.5-2.0 seconds (enough time to lose coal but not forever)
- Impulse: 75.0 (coal moves but doesn't instantly fly away - tuned via playtesting)

Adjust based on playtester feedback and target difficulty curve.

**Implementation Notes (Lessons Learned):**
- Initial impulse value of 150.0 was too powerful during playtesting; reduced to 75.0
- Critical bug: Coal pieces are spawned to PlayArea, NOT CoalContainer (see 2.3-coal-spawning.md)
- Must use `get_tree().get_nodes_in_group("coal")` instead of `coal_container.get_children()`
- Iterating coal_container children results in NO coal being affected (empty container)
- Testing with fast intervals (5-15s) allows rapid iteration on impulse strength tuning
