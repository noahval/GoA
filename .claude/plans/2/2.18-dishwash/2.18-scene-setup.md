# Dishwash: Scene Setup & UI

**Goal**: Create the visual structure and UI controls for the dishwash minigame

**Success Criteria**: Minigame area can be shown/hidden via buttons, all static elements positioned correctly

## Overview

This plan sets up the scene structure for the dishwash minigame without any game logic. Creates the visual layout (dirty stack, basin, rack), adds control buttons to the bar menu, and prepares Level1Vars to track progression.

### Key Design Principles

- Scene embedded in bar.tscn PlayArea (66% left side)
- Buttons in Menu (33% right side) control visibility
- No game logic yet - pure structure and layout
- Follow 1.9-responsive-layout.md conventions

---

## Implementation Tasks

### 1. Add Level1Vars Fields

**Variables needed**:
```gdscript
# In level_1_vars.gd
var mugs_washed: int = 0  # Lifetime total for mastery tracking
var dishwash_mastery_unlocked: bool = false
```

**Implementation details:**
- Add both variables to level_1_vars.gd
- No initialization needed (defaults work)
- These will be used in later plans for progression

### 2. Create DishwashMinigame Node Structure

Add to bar.tscn under PlayArea (currently empty):

```
PlayArea (66% width, left side - currently empty)
└── DishwashMinigame (Control, hidden by default)
    ├── Background (ColorRect) # 20% opacity orange - Color(1.0, 0.5, 0.0, 0.2)
    ├── DirtyStack (Area2D) # 15% x, 15% y - clickable for mug pickup
    │   ├── CollisionShape2D (RectangleShape2D - created in code, covers mug stack area)
    │   └── Mugs (Node2D) # container for mug sprites
    │       ├── Mug1 (Sprite2D) # res://level1/icons/mug-dirty.png, scale 0.25
    │       ├── Mug2 (Sprite2D) # res://level1/icons/mug-dirty.png, scale 0.25, offset +30px right
    │       └── Mug3 (Sprite2D) # res://level1/icons/mug-dirty.png, scale 0.25, offset +60px right
    ├── Basin (Node2D) # 50% x, 80% y - empty 3-wall container
    │   ├── DetectionArea (Area2D) # Mug entry/exit detection
    │   │   └── CollisionShape2D (RectangleShape2D - created in code)
    │   └── BasinWalls (Line2D) # 3 walls forming U-shape (left, bottom, right)
    ├── DryingRack (Area2D) # 85% x, 15% y - clickable for mug placement
    │   ├── CollisionShape2D (RectangleShape2D - created in code, covers rack sprite)
    │   └── RackSprite (Sprite2D) # res://level1/icons/drying-rack.png
    ├── BoundMug (Sprite2D) # follows cursor when bound
    │   # texture = mug-dirty.png (initially)
    │   # scale = Vector2(0.3, 0.3) - slightly larger than stack mugs
    │   # visible = false (initially hidden)
    │   # z_index = 100 (render above everything else)
    └── ErrorNotification (Label) # hidden by default, centered 60px above DryingRack
```

**Implementation details:**
- PlayArea is currently empty - DishwashMinigame fills it completely
- DishwashMinigame anchors/margins fill PlayArea
- Background fills entire control with orange tint
- Set all mug scales to 0.25 (small in stack)
- Set `visible = false` on DishwashMinigame by default
- Basin is empty container (water visual added in 2.21-dishwash-basin-particles.md)
- Basin DetectionArea triggers mug washing state (used in 2.20-dishwash-state-machine-basin.md)
- All CollisionShape2D nodes created programmatically (no shapes in scene editor)
- DirtyStack and DryingRack are Area2D for click detection (used in 2.19-dishwash-click-to-bind.md)
- BoundMug is Sprite2D that follows cursor when mug is picked up (logic in 2.19-dishwash-click-to-bind.md)
- ErrorNotification initially hidden, centered horizontally 60px above DryingRack position

### 3. Position Elements and Setup Basin

All elements positioned dynamically in `_ready()` based on DishwashMinigame control size:

**Positioning strategy:**
- DirtyStack: 15% x, 15% y (top-left area)
- Basin: 50% x (centered), 80% y (near bottom)
  - Width: 20% of control width
  - Height: 12% of control height
  - Collision shape created and sized programmatically
  - Walls drawn as 3-wall U-shape using Line2D
- DryingRack: 85% x, 15% y (top-right area)
- ErrorNotification: centered horizontally, 60px above DryingRack

**Technical details:**
- Percentage-based calculations scale with all resolutions
- Await `get_tree().process_frame` ensures ResponsiveLayout has calculated PlayArea size
- Basin dimensions calculated dynamically (20% width, 12% height of control)
- Basin walls drawn programmatically as Line2D U-shape
- RectangleShape2D created in code (not in scene editor)

See Task 5 for complete implementation code.

### 4. Add Menu Buttons

Add to bar.tscn under Menu:

```
Menu (33% width, right side)
├── CurrencyDisplay (copper) - added by bar.gd
├── CurrencyDisplay (holes) - added by bar.gd
├── WashMugsButton (Button) - ACTION button
│   # text = "Wash mugs"
│   # theme_type_variation = "" (default, not ForwardNavButton/BackNavButton)
│   # Scene-unique name: %WashMugsButton
│   # visible = true (initially shown)
├── StopWashingButton (Button) - ACTION button
│   # text = "Stop washing"
│   # theme_type_variation = "" (default, not ForwardNavButton/BackNavButton)
│   # Scene-unique name: %StopWashingButton
│   # visible = false (initially hidden)
├── ToGamblingButton (ForwardNavButton) - existing
├── ToDormButton (BackNavButton) - existing
└── SettingsButton - existing
```

**Implementation details:**
- Mark both buttons as scene-unique names (% prefix in editor)
- Use default theme (not ForwardNavButton or BackNavButton - these are ACTION buttons per 1.12-button-hierarchy.md)
- StopWashingButton hidden by default (`visible = false`)
- WashMugsButton visible by default (`visible = true`)

**Button ordering per 1.12-button-hierarchy.md:**
- ButtonHierarchy autoload automatically sorts buttons by type
- ACTION buttons (Priority 3) appear at top of menu
- Both wash buttons are ACTION buttons (start/stop minigame actions)
- Will appear after currency displays, before navigation buttons
- Final order: Currencies -> Wash buttons -> ToGamblingButton (Forward Nav) -> ToDormButton (Back Nav) -> SettingsButton

### 5. Create Basic Script

Create new script `dishwash_minigame.gd` attached to DishwashMinigame node:

```gdscript
extends Control

# Button references using scene-unique names
@onready var wash_mugs_button = get_node_or_null("%WashMugsButton")
@onready var stop_washing_button = get_node_or_null("%StopWashingButton")

func _ready():
	# Verify buttons exist
	if not wash_mugs_button or not stop_washing_button:
		push_error("DishwashMinigame: Required buttons not found (WashMugsButton or StopWashingButton)")
		return

	# Setup element positions (await to ensure positioning completes before signals connect)
	await setup_element_positions()

	# Connect button signals
	wash_mugs_button.pressed.connect(start_washing)
	stop_washing_button.pressed.connect(stop_washing)

func setup_element_positions():
	"""Position all minigame elements based on DishwashMinigame control size"""
	# Wait for ResponsiveLayout to calculate sizes
	await get_tree().process_frame

	var control_size = size

	# DirtyStack: 15% from left, 15% from top
	var dirty_stack_x = control_size.x * 0.15
	var dirty_stack_y = control_size.y * 0.15
	$DirtyStack.position = Vector2(dirty_stack_x, dirty_stack_y)

	# Setup DirtyStack collision shape (for click detection)
	var dirty_stack_shape = $DirtyStack/CollisionShape2D
	var dirty_rect = RectangleShape2D.new()
	dirty_rect.size = Vector2(100, 50)  # Covers 3-mug stack area
	dirty_stack_shape.shape = dirty_rect

	# Basin: 50% from left (centered), 80% from top (near bottom)
	var basin_width = control_size.x * 0.20  # 20% of control width
	var basin_height = control_size.y * 0.12  # 12% of control height
	var basin_x = control_size.x * 0.50
	var basin_y = control_size.y * 0.80
	$Basin.position = Vector2(basin_x, basin_y)

	# Setup basin collision shape (for mug detection)
	# IMPORTANT: Create RectangleShape2D programmatically (not in scene editor)
	var collision_shape = $Basin/DetectionArea/CollisionShape2D
	var rect_shape = RectangleShape2D.new()
	rect_shape.size = Vector2(basin_width, basin_height)
	collision_shape.shape = rect_shape

	# Setup basin walls (3-wall U-shape: left, bottom, right)
	var walls = $Basin/BasinWalls
	var hw = basin_width / 2  # half width
	var hh = basin_height / 2  # half height
	walls.points = PackedVector2Array([
		Vector2(-hw, -hh),  # Top-left
		Vector2(-hw, hh),   # Bottom-left
		Vector2(hw, hh),    # Bottom-right
		Vector2(hw, -hh)    # Top-right
	])
	walls.default_color = Color(0.2, 0.2, 0.2)  # Dark gray
	walls.width = 3.0

	# DryingRack: 85% from left, 15% from top
	var drying_rack_x = control_size.x * 0.85
	var drying_rack_y = control_size.y * 0.15
	$DryingRack.position = Vector2(drying_rack_x, drying_rack_y)

	# Setup DryingRack collision shape (for click detection)
	var rack_shape = $DryingRack/CollisionShape2D
	var rack_rect = RectangleShape2D.new()
	rack_rect.size = Vector2(80, 80)  # Covers rack sprite area
	rack_shape.shape = rack_rect

	# BoundMug: hidden initially, configured for cursor following
	$BoundMug.visible = false
	$BoundMug.z_index = 100

	# ErrorNotification: centered horizontally, 60px above DryingRack
	var error_label = $ErrorNotification
	error_label.position = Vector2(control_size.x * 0.5, drying_rack_y - 60)
	error_label.size = Vector2(control_size.x * 0.4, 40)  # 40% width, 40px height
	error_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
	error_label.visible = false

func start_washing():
	visible = true  # Show minigame area
	wash_mugs_button.visible = false  # Hide wash button
	stop_washing_button.visible = true  # Show stop button

func stop_washing():
	visible = false  # Hide minigame area
	wash_mugs_button.visible = true  # Show wash button
	stop_washing_button.visible = false  # Hide stop button
```

**Explanation**:
- Minimal script that handles showing/hiding the minigame and toggling button visibility
- Only one button visible at a time (wash OR stop, never both)
- Error handling if buttons missing from scene
- Dynamic positioning using percentage-based calculations
- RectangleShape2D created programmatically for basin collision
- ErrorNotification positioned and configured (centered, 40% width, hidden by default)
- `await setup_element_positions()` ensures positioning completes before button signals connect
- No game logic yet - pure UI control

**Note**: bar.gd does not need modification. The dishwash_minigame.gd script is self-contained and uses scene-unique names (%) to access buttons across the scene tree.

---

## Testing Strategy

### Manual Test Criteria

**Scene Structure:**
- [ ] DishwashMinigame node exists under PlayArea in bar.tscn
- [ ] PlayArea was empty before adding DishwashMinigame
- [ ] DishwashMinigame is hidden on scene load
- [ ] Background fills PlayArea with orange tint (20% opacity)
- [ ] DirtyStack (Area2D) shows 3 small dirty mugs (0.25 scale) at 15% x, 15% y
- [ ] DirtyStack has CollisionShape2D for click detection
- [ ] Basin shows 3-wall U-shaped container (dark gray, 3px thick) at 50% x, 80% y
- [ ] Basin is empty (no water visual) - water added in 2.21-dishwash-basin-particles.md
- [ ] Basin DetectionArea exists with CollisionShape2D node
- [ ] All RectangleShape2D nodes created programmatically (not in scene editor)
- [ ] Basin dimensions scale with resolution (20% width, 12% height of control)
- [ ] DryingRack (Area2D) shows rack sprite at 85% x, 15% y
- [ ] DryingRack has CollisionShape2D for click detection
- [ ] BoundMug (Sprite2D) exists, hidden initially, z_index = 100
- [ ] ErrorNotification is hidden initially
- [ ] ErrorNotification centered horizontally, 60px above DryingRack position

**Button Setup:**
- [ ] "Wash mugs" button appears in menu (default theme, not ForwardNavButton)
- [ ] "Stop washing" button exists in menu (hidden initially)
- [ ] Both buttons marked as scene-unique names (% prefix)
- [ ] Scene-unique names accessible from DishwashMinigame script (cross-branch access)

**Button Ordering (1.12-button-hierarchy.md):**
- [ ] ButtonHierarchy autoload sorts buttons automatically
- [ ] Wash buttons appear after currency displays
- [ ] Wash buttons appear before ToGamblingButton (Forward Nav)
- [ ] Wash buttons appear before ToDormButton (Back Nav)
- [ ] Order: Currencies -> ACTION buttons (wash) -> Forward Nav -> Back Nav -> Settings

**Button Visibility Toggle:**
- [ ] Only "Wash mugs" button visible initially (not "Stop washing")
- [ ] Clicking "Wash mugs" shows minigame area
- [ ] Clicking "Wash mugs" hides itself and shows "Stop washing"
- [ ] Only one button visible at a time (never both simultaneously)
- [ ] Clicking "Stop washing" hides minigame area
- [ ] Clicking "Stop washing" hides itself and shows "Wash mugs"

**Positioning & Scaling:**
- [ ] Element positions calculated dynamically in setup_element_positions()
- [ ] All positions scale correctly at different resolutions
- [ ] Positioning waits for ResponsiveLayout calculations (await process_frame)

**Error Handling:**
- [ ] Script logs error if WashMugsButton missing
- [ ] Script logs error if StopWashingButton missing
- [ ] Graceful failure if buttons not found (no crash)

**Data:**
- [ ] Level1Vars has mugs_washed and dishwash_mastery_unlocked fields

---

## Files to Create

- `c:\Goa\game\v0.1\level1\dishwash_minigame.gd` - Minimal visibility control script

## Files to Modify

- `c:\Goa\game\v0.1\level1\bar.tscn` - Add all scene nodes and buttons
- `c:\Goa\game\v0.1\level1\level_1_vars.gd` - Add mugs_washed and dishwash_mastery_unlocked variables

**Note**: `bar.gd` does NOT need modification - script is self-contained.

---

## Design Values (Reference)

See `setup_element_positions()` in Task 5 for implementation details.

### Element Positions (Percentage-based)

- **DirtyStack**: 15% horizontal, 15% vertical (top-left area)
- **Basin**: 50% horizontal, 80% vertical (bottom-center)
- **DryingRack**: 85% horizontal, 15% vertical (top-right area)

### Basin Dimensions

- **Width**: 20% of DishwashMinigame control width
- **Height**: 12% of DishwashMinigame control height
- **Walls**: 3px thick Line2D, Color(0.2, 0.2, 0.2) dark gray
- **Shape**: U-shaped (3 walls: left, bottom, right - open at top)
- **Collision**: RectangleShape2D created programmatically, matching basin dimensions

### Visual Properties

- **Background opacity**: 0.2 (20% orange tint)
- **Mug stack scale**: 0.25 (small mugs)
- **Bound mug scale**: 0.3 (slightly larger when held)
- **Basin walls**: 3px Line2D, no fill (empty container)

### Collision Shapes (created programmatically)

- **DirtyStack collision**: 100x50 RectangleShape2D (covers 3-mug stack)
- **DryingRack collision**: 80x80 RectangleShape2D (covers rack sprite)
- **Basin DetectionArea**: 20% x 12% of control size

### Button Hierarchy (1.12-button-hierarchy.md)

**Button Type Classification:**
- Both "Wash mugs" and "Stop washing" are ACTION buttons (Priority 3)
- ACTION buttons appear at top of menu (after currency displays)
- Not ForwardNavButton or BackNavButton (those are for navigation)

**Menu Order (automatic via ButtonHierarchy autoload):**
1. Currency displays (added by bar.gd)
2. ACTION buttons: "Wash mugs" / "Stop washing" (Priority 3)
3. ForwardNavButton: "Gambling" (Priority 6)
4. BackNavButton: "Dormitory" (Priority 8)
5. Settings (Priority 15)

### Z-Index Hierarchy

```
DishwashMinigame (Control)
├── Background (ColorRect) ............................ z_index = 0 (default)
├── DirtyStack (Area2D) ............................... z_index = 0
│   └── CollisionShape2D .............................. z_index = 0
├── Basin (Node2D) .................................... z_index = 0
│   ├── DetectionArea (Area2D) ........................ z_index = 0
│   └── BasinWalls (Line2D) ........................... z_index = 0
├── DryingRack (Area2D) ............................... z_index = 0
│   └── CollisionShape2D .............................. z_index = 0
├── BoundMug (Sprite2D) ............................... z_index = 100 (above all)
└── ErrorNotification (Label) ......................... z_index = 10 (UI layer)
```

**Note**: Water visual and particles added in 2.21-dishwash-basin-particles.md will use z_index = 1-2 to layer above basin structure

---

## Asset Files Required

**Must exist** (verified during Task 2):
- `res://level1/icons/mug-dirty.png` - Dirty mug sprite for stack (confirmed exists)
- `res://level1/icons/drying-rack.png` - Drying rack target area (confirmed exists)

---

## Notes & Decisions

**Decision: Scene-unique names for buttons**
- Rationale: Using % flag enables safe nested node access via `get_node("%NodeName")`
- Prevents fragile parent traversal paths like `../../Menu/Button`
- More resilient to scene restructuring
- Works across scene tree branches (DishwashMinigame can access Menu buttons)

**Decision: Control node instead of Node2D**
- Rationale: Better for UI layout with anchors and margins
- Handles resizing naturally
- Fits PlayArea container paradigm

**Decision: Separate script file for minigame**
- Rationale: Keeps bar.gd clean and unmodified
- Dishwash logic self-contained
- Easier to test independently
- No coupling with existing bar scene code

**Decision: Basin as empty 3-wall container**
- Rationale: Water visual and particles added in 2.21-dishwash-basin-particles.md
- Separation of concerns: structure first, aesthetics later
- Easier to test positioning without particle complexity

**Decision: Include DetectionArea now**
- Rationale: Needed for 2.20-dishwash-state-machine-basin.md (mug entry/exit detection)
- Area2D is structural (triggers state changes), not aesthetic
- Simpler to add now than retrofit later

**Decision: Create RectangleShape2D programmatically**
- Rationale: Basin size calculated dynamically based on resolution
- Cannot hardcode shape size in scene editor (size unknown until runtime)
- Shape must match basin dimensions (20% width, 12% height of control)

**Decision: Percentage-based sizing for basin**
- Rationale: Scales naturally across all resolutions (follows 1.9-responsive-layout.md)
- 20% width, 12% height maintains proportions at 1280x720, 1920x1080, etc.
- Similar to furnace opening percentage-based sizing in 2.2-physics-objects.md

**Decision: U-shaped basin (3 walls, open top)**
- Rationale: Mugs enter from top (visual clarity)
- Matches dishwashing metaphor (basin doesn't have lid)
- Simpler collision shape than full rectangle with cutout

**Decision: Only one button visible at a time**
- Rationale: Clearer user intent (either start or stop, not both)
- Reduces menu clutter
- Standard start/stop toggle pattern
- Wash button hidden (not disabled) when stop button shown

**Decision: ACTION button type (not ForwardNavButton)**
- Rationale: Wash buttons start/stop minigame (gameplay actions), not navigation
- Per 1.12-button-hierarchy.md: ACTION buttons appear at top of menu
- ButtonHierarchy autoload automatically sorts by priority (ACTION = 3, Forward Nav = 6, Back Nav = 8)
- Default theme (not nav button theme variations)

---

**Last Updated**: 2026-01-14
