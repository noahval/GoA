# Dishwash: Movement Drying

**Goal**: Speed up drying by moving WET mug through air outside basin

**Success Criteria**: Moving WET mug reduces dry time, 200 pixels moved = 1 second saved

## Overview

Adds movement-based acceleration to the auto-dry timer. Tracks distance moved while mug is WET and outside basin. Every 200 pixels of movement saves 1 second off the 7-second timer. Allows skilled players to dry mugs faster through active movement.

### Key Design Principles

- Movement only speeds up drying (doesn't start it)
- Only tracks movement while WET and outside basin
- Cumulative distance tracking (doesn't undo)
- Thematic: moving through air accelerates evaporation

---

## Implementation Tasks

### 1. Add Movement Tracking Variables

Add to `dishwash_minigame.gd`:

```gdscript
var dry_movement_bonus: float = 0.0  # Seconds saved by moving while drying
var last_dry_position: Vector2 = Vector2.ZERO  # For dry movement distance tracking

# PIXELS_PER_SECOND_SAVED already exists from 2.20 (200.0)
```

**Implementation details:**
- `dry_movement_bonus` accumulates seconds saved through movement
- Separate from `soak_movement_bonus` (different phase)
- `last_dry_position` tracks position for distance calculation

### 2. Track Movement During Drying

Update `_process()` function:

```gdscript
func _process(delta):
	if not visible:
		return

	# Update mug position (existing)
	if mug_bound_to_cursor:
		$BoundMug.global_position = get_global_mouse_position()

	# Basin soaking progress (existing from 2.20)
	if current_mug_state == MugState.DIRTY and mug_in_basin:
		basin_soak_time += delta
		var current_pos = get_global_mouse_position()
		var distance_moved = current_pos.distance_to(last_mug_position)
		soak_movement_bonus += distance_moved / PIXELS_PER_SECOND_SAVED
		last_mug_position = current_pos

		var total_progress = basin_soak_time + soak_movement_bonus
		if total_progress >= REQUIRED_SOAK_TIME:
			transition_to_wet()

	# NEW: Movement drying acceleration
	if mug_bound_to_cursor and current_mug_state == MugState.WET and dry_timer_start > 0.0:
		var current_pos = get_global_mouse_position()
		var distance_moved = current_pos.distance_to(last_dry_position)
		dry_movement_bonus += distance_moved / PIXELS_PER_SECOND_SAVED
		last_dry_position = current_pos

	# Auto-dry timer check (existing from 2.24, now with movement bonus)
	if current_mug_state == MugState.WET and dry_timer_start > 0.0:
		var elapsed = (Time.get_ticks_msec() / 1000.0) - dry_timer_start
		var adjusted_time = elapsed + dry_movement_bonus  # NEW: Add movement bonus
		if adjusted_time >= AUTO_DRY_DURATION:
			transition_to_dry()
```

**Explanation**: Tracks distance moved while WET. Adds movement bonus to elapsed time check. If total time (elapsed + bonus) >= 7 seconds, mug dries.

### 3. Initialize Dry Movement Tracking

Update `_on_basin_area_exited()`:

```gdscript
func _on_basin_area_exited(area: Area2D):
	if area == $BoundMug:
		mug_in_basin = false
		$Basin/WaterParticles.emitting = false

		if current_mug_state == MugState.WET:
			dry_timer_start = Time.get_ticks_msec() / 1000.0
			dry_movement_bonus = 0.0  # NEW: Reset movement bonus for this dry phase
			last_dry_position = get_global_mouse_position()  # NEW: Start tracking from exit point
```

**Explanation**: When WET mug leaves basin, reset movement tracking. Start position tracking from basin exit point.

### 4. Reset Between Mugs

Update `bind_mug_to_cursor()`:

```gdscript
func bind_mug_to_cursor():
	mug_bound_to_cursor = true
	current_mug_state = MugState.DIRTY
	basin_soak_time = 0.0
	soak_movement_bonus = 0.0
	mug_in_basin = false
	dry_timer_start = 0.0
	dry_movement_bonus = 0.0  # NEW: Reset dry movement
	$BoundMug.visible = true
	$BoundMug/MugSprite.texture = MUG_DIRTY_TEXTURE
	$BoundMug.global_position = get_global_mouse_position()
	last_mug_position = get_global_mouse_position()
	last_dry_position = get_global_mouse_position()  # NEW: Initialize dry tracking position
```

**Explanation**: Clean slate for each mug. All movement tracking reset.

### 5. Reset in transition_to_dry()

Update function:

```gdscript
func transition_to_dry():
	current_mug_state = MugState.DRY
	dry_timer_start = 0.0
	dry_movement_bonus = 0.0  # NEW: Reset after drying complete
	$BoundMug/MugSprite.texture = MUG_CLEAN_TEXTURE
```

**Explanation**: Clean up tracking variables when drying completes.

---

## Testing Strategy

### Manual Test Criteria

- [ ] Stationary WET mug dries in 7 seconds (baseline)
- [ ] Moving WET mug rapidly dries faster than 7 seconds
- [ ] ~1400 pixels of movement = instant dry (7 seconds saved)
- [ ] Circular swirling motion visibly speeds up drying
- [ ] Slow movement still provides some speedup
- [ ] Movement only counts while WET (not DIRTY or DRY)
- [ ] Movement only counts outside basin (not during soaking)
- [ ] Stopping movement doesn't undo progress (cumulative)

### Performance Test Scenarios

| Movement Pattern | Expected Dry Time |
|------------------|-------------------|
| Stationary | 7.0 seconds |
| Slow drift (~100px) | ~6.5 seconds |
| Moderate circles (~700px) | ~3.5 seconds |
| Fast swirling (~1400px) | ~0 seconds (instant) |

---

## Files to Modify

- `c:\Goa\game\v0.1\level1\dishwash_minigame.gd` - Add movement tracking for drying

---

## Design Values (Reference)

### Movement Parameters

- **Speedup rate**: 200 pixels = 1 second saved (PIXELS_PER_SECOND_SAVED)
- **Max theoretical speedup**: ~1400 pixels = 7 seconds saved = instant dry
- **Typical speedup**: Circular swirling ~700px = 3.5s saved = dry in 3.5s total

### Comparison Table

| Phase | Base Time | Movement Rate | Typical Result |
|-------|-----------|---------------|----------------|
| Soaking | 4.0s | 200px = 1s saved | ~2s with swirling |
| Drying | 7.0s | 200px = 1s saved | ~3.5s with swirling |

---

## Notes & Decisions

**Decision: Same speedup rate for soaking and drying**
- Rationale: Consistent mental model
- Both use PIXELS_PER_SECOND_SAVED constant (200.0)
- Player learns mechanic once, applies to both phases
- Simpler to balance

**Decision: Separate tracking variables for soak vs dry**
- Rationale: Different phases, different purposes
- `soak_movement_bonus` for basin phase
- `dry_movement_bonus` for air phase
- Prevents cross-contamination
- Clearer debugging

**Decision: Track distance only while WET and timer active**
- Rationale: Only counts during drying phase
- Doesn't track DIRTY or DRY state movement
- Condition: `mug_bound_to_cursor and current_mug_state == MugState.WET and dry_timer_start > 0.0`
- Prevents exploits or unintended tracking

**Decision: Cumulative distance (doesn't undo)**
- Rationale: Any movement helps
- Stopping doesn't reverse progress
- More forgiving than back-and-forth reversal
- Matches soaking behavior for consistency

**Decision: Initialize tracking on basin exit**
- Rationale: Start point is where mug leaves basin
- Prevents false distance from bind point
- Clearer separation between soak and dry phases
- Matches timer initialization timing

**Decision: Instant dry possible with enough movement**
- Rationale: Rewards skilled play
- ~1400 pixels is achievable with fast swirling
- Feels responsive and satisfying
- Not easy enough to trivialize mechanic

**Decision: Use global_mouse_position for tracking**
- Rationale: Consistent with soaking phase
- Simpler than node position calculations
- Accounts for all movement regardless of parent transforms
- More reliable

---

**Last Updated**: 2026-01-14
