# Upgrade Pool

**Goal**: Define the pool of available upgrades for shoveling level-ups

**Success Criteria**: Diverse upgrade paths with combo mechanics that reward skillful play

**Prerequisites**:
- Shovel experience system ([2.x-shovel-experience.md](2.x-shovel-experience.md)) complete

**Integration**:
- Mind scene selection UI ([2.x-shovelling-level-up.md](2.x-shovelling-level-up.md)) queries this pool to present upgrade choices
- Effect application ([2.x-apply-upgrade.md](2.x-apply-upgrade.md)) reads selected techniques to modify gameplay

---

## Upgrade Categories

All upgrades are now in a single pool (no branch locking). Upgrades are organized into functional categories:

### Core Stats
Basic improvements to shoveling mechanics (stamina, XP gain, shovel physics)

### No-Drop Combo Path
Unlocks and enhances streak mechanics for shoveling without dropping coal. Combo persists between deliveries until coal is dropped.

### Heavy Load Combo Path
Unlocks and enhances burst bonuses for delivering 3+ coal within 1 second. Uses a 5-second decay timer that refreshes on each heavy delivery.

### Shovel Mass Path
Increases shovel weight for different physics behavior

---

## Technique Definitions

All techniques use **experience** as their unlock cost. The `cost` field is currently informational only - XP costs are not deducted during selection. Multi-resource costs will be added later in 2.x-additional-resource-pools.md.

### Core Stat Techniques

**Rhythm**
- **Rarity**: Common
- **Cost**: 10 experience
- **Effect**: -25% inherent stamina drain from shovel weight (base value)
- **Description**: "Reduces stamina drain from holding shovel"

**Determination**
- **Rarity**: Rare
- **Cost**: 16 experience
- **Effect**: -15% all stamina drain (base value)
- **Description**: "All stamina drains slower"

**Economy of Motion**
- **Rarity**: Rare
- **Cost**: 20 experience
- **Effect**: -10% stamina drain while holding coal (base value)
- **Description**: "Reduces stamina drain while carrying coal"

**Pattern Recognition**
- **Rarity**: Rare
- **Cost**: 22 experience
- **Effect**: +1s shake warning time (base value)
- **Description**: "See shake warnings earlier"
- **Note**: Deferred until shake warning system designed

### No-Drop Combo Techniques

Selecting any of these unlocks the no-drop combo mechanic. Combo increases by 1 for each coal delivered without dropping. Combo resets to 0 when coal is dropped (unless Forgiveness prevents it).

**Cadence**
- **Rarity**: Rare
- **Cost**: 15 experience
- **Effect**: -5% stamina drain per combo stack (base value)
- **Description**: "Streak reduces stamina drain (stacks with combo)"
- **Max Effect**: Stacks multiplicatively with combo counter (e.g., 10 combo = 50% reduction at level 1)
- **Unlocks**: No-drop combo system on first selection

**Flow**
- **Rarity**: Epic
- **Cost**: 25 experience
- **Effect**: +0.5 focus regen per combo stack (base value)
- **Description**: "Streak grants focus regeneration (stacks with combo)"
- **Note**: Deferred until focus system implemented
- **Unlocks**: No-drop combo system on first selection

**Repetition Learning**
- **Rarity**: Rare
- **Cost**: 18 experience
- **Effect**: +10% XP gain per combo stack (base value)
- **Description**: "Streak multiplies XP earned (stacks with combo)"
- **Max Effect**: Stacks multiplicatively with combo counter (e.g., 10 combo = 2× XP at level 1)
- **Unlocks**: No-drop combo system on first selection

**Perfect Form**
- **Rarity**: Legendary
- **Cost**: 50 experience
- **Effect**: At 10+ combo, stamina drain reduced by 50% (boolean, stacks with other reductions)
- **Description**: "At 10+ streak, massive stamina reduction"
- **Max Level**: 1 (boolean effect)
- **Unlocks**: No-drop combo system on first selection

**Forgiveness**
- **Rarity**: Epic
- **Cost**: 30 experience
- **Effect**: Can drop 1 coal every 10 delivered without breaking combo (base value: 1 drop per 10)
- **Description**: "Prevents combo loss from occasional drops"
- **Note**: Tracks coal delivered since last forgiveness use. Resets counter after using forgiveness.
- **Unlocks**: No-drop combo system on first selection

**Combo Ceiling**
- **Rarity**: Rare
- **Cost**: 20 experience
- **Effect**: +10 to maximum combo counter (base value)
- **Description**: "Increases combo cap for stronger bonuses"
- **Note**: Default combo cap is 20. Each selection adds +10 (Common quality = +10, Rare = +12, Epic = +14, Legendary = +16)
- **Unlocks**: No-drop combo system on first selection

### Heavy Load Combo Techniques

Selecting any of these unlocks the heavy load combo mechanic. Delivering 3+ coal within 1 second triggers heavy load bonus. A 5-second timer refreshes on each heavy delivery and stacks counter increments. Timer expiration or dropping coal resets stacks to 0.

**Power Surge**
- **Rarity**: Rare
- **Cost**: 18 experience
- **Effect**: -15% stamina drain per heavy stack for next 5 seconds (base value)
- **Description**: "Heavy deliveries reduce stamina drain temporarily"
- **Unlocks**: Heavy load combo system on first selection

**Pressure Training**
- **Rarity**: Rare
- **Cost**: 20 experience
- **Effect**: +50% XP multiplier per heavy stack (base value)
- **Description**: "Heavy deliveries multiply XP earned"
- **Max Effect**: Stacks multiplicatively (e.g., 3 stacks = 2.5× XP at level 1)
- **Unlocks**: Heavy load combo system on first selection

**Perfect Balance**
- **Rarity**: Legendary
- **Cost**: 55 experience
- **Effect**: At 5+ heavy stacks, cannot spill coal for 2 seconds (boolean)
- **Description**: "High heavy streak grants brief invincibility to spills"
- **Max Level**: 1 (boolean effect)
- **Unlocks**: Heavy load combo system on first selection

**Extended Window**
- **Rarity**: Rare
- **Cost**: 22 experience
- **Effect**: +1s to heavy load timer duration (base value: +1s at Common, +1.2s at Rare, +1.4s at Epic, +1.6s at Legendary)
- **Description**: "Heavy load bonus lasts longer"
- **Note**: Base timer is 5 seconds. This extends it.
- **Unlocks**: Heavy load combo system on first selection

### Shovel Mass Techniques

**Mass Training**
- **Rarity**: Common
- **Cost**: 12 experience
- **Effect**: +15% shovel mass (base value)
- **Description**: "Increases shovel weight"
- **Note**: Heavier shovel = different physics (more momentum, harder to control)

**Weighted Mastery**
- **Rarity**: Epic
- **Cost**: 35 experience
- **Effect**: +2% shovel mass per no-drop combo stack (base value)
- **Description**: "Combo increases shovel mass dynamically"
- **Note**: Requires no-drop combo system to be unlocked (by selecting any no-drop combo technique)

---

## Data Structure

### File: res://data/techniques.gd

**IMPORTANT**: GDScript class_name export pattern for preloading.

```gdscript
# Technique pool definitions for upgrade system
# Referenced by Mind scene (2.x-shovelling-level-up.md) and effect application (2.x-apply-upgrade.md)
extends Node

const TECHNIQUES = {
    # Core Stat Techniques
    "rhythm": {
        "name": "Rhythm",
        "rarity": "common",
        "cost": 10,
        "max_level": 5,
        "description": "Reduces stamina drain from holding shovel",
        "effect": {"base_bonus": 0.25},  # -25% drain per selection
        "category": "core"
    },
    "determination": {
        "name": "Determination",
        "rarity": "rare",
        "cost": 16,
        "max_level": 5,
        "description": "All stamina drains slower",
        "effect": {"base_bonus": 0.15},  # -15% all drain per selection
        "category": "core"
    },
    "economy_of_motion": {
        "name": "Economy of Motion",
        "rarity": "rare",
        "cost": 20,
        "max_level": 5,
        "description": "Reduces stamina drain while carrying coal",
        "effect": {"base_bonus": 0.10},  # -10% coal carrying drain per selection
        "category": "core"
    },
    "pattern_recognition": {
        "name": "Pattern Recognition",
        "rarity": "rare",
        "cost": 22,
        "max_level": 5,
        "description": "See shake warnings earlier",
        "effect": {"base_bonus": 1.0},  # +1.0s warning time per selection
        "category": "core"
    },

    # No-Drop Combo Techniques
    "cadence": {
        "name": "Cadence",
        "rarity": "rare",
        "cost": 15,
        "max_level": 5,
        "description": "Streak reduces stamina drain (stacks with combo)",
        "effect": {"base_bonus": 0.05},  # -5% per combo stack per selection
        "category": "nodrop_combo",
        "unlocks_combo": true
    },
    "flow": {
        "name": "Flow",
        "rarity": "epic",
        "cost": 25,
        "max_level": 5,
        "description": "Streak grants focus regeneration (stacks with combo)",
        "effect": {"base_bonus": 0.5},  # +0.5 focus/s per combo stack per selection
        "category": "nodrop_combo",
        "unlocks_combo": true
    },
    "repetition_learning": {
        "name": "Repetition Learning",
        "rarity": "rare",
        "cost": 18,
        "max_level": 5,
        "description": "Streak multiplies XP earned (stacks with combo)",
        "effect": {"base_bonus": 0.10},  # +10% XP per combo stack per selection
        "category": "nodrop_combo",
        "unlocks_combo": true
    },
    "perfect_form": {
        "name": "Perfect Form",
        "rarity": "legendary",
        "cost": 50,
        "max_level": 1,
        "description": "At 10+ streak, massive stamina reduction",
        "effect": {"type": "boolean", "threshold": 10, "reduction": 0.50},
        "category": "nodrop_combo",
        "unlocks_combo": true
    },
    "forgiveness": {
        "name": "Forgiveness",
        "rarity": "epic",
        "cost": 30,
        "max_level": 5,
        "description": "Prevents combo loss from occasional drops",
        "effect": {"base_bonus": 10},  # 1 forgiveness per 10 coal delivered
        "category": "nodrop_combo",
        "unlocks_combo": true
    },
    "combo_ceiling": {
        "name": "Combo Ceiling",
        "rarity": "rare",
        "cost": 20,
        "max_level": 5,
        "description": "Increases combo cap for stronger bonuses",
        "effect": {"base_bonus": 10},  # +10 to max combo per selection
        "category": "nodrop_combo",
        "unlocks_combo": true
    },

    # Heavy Load Combo Techniques
    "power_surge": {
        "name": "Power Surge",
        "rarity": "rare",
        "cost": 18,
        "max_level": 5,
        "description": "Heavy deliveries reduce stamina drain temporarily",
        "effect": {"base_bonus": 0.15},  # -15% stamina per heavy stack per selection
        "category": "heavy_combo",
        "unlocks_combo": true
    },
    "pressure_training": {
        "name": "Pressure Training",
        "rarity": "rare",
        "cost": 20,
        "max_level": 5,
        "description": "Heavy deliveries multiply XP earned",
        "effect": {"base_bonus": 0.50},  # +50% XP per heavy stack per selection
        "category": "heavy_combo",
        "unlocks_combo": true
    },
    "perfect_balance": {
        "name": "Perfect Balance",
        "rarity": "legendary",
        "cost": 55,
        "max_level": 1,
        "description": "High heavy streak grants brief invincibility to spills",
        "effect": {"type": "boolean", "threshold": 5, "duration": 2.0},
        "category": "heavy_combo",
        "unlocks_combo": true
    },
    "extended_window": {
        "name": "Extended Window",
        "rarity": "rare",
        "cost": 22,
        "max_level": 5,
        "description": "Heavy load bonus lasts longer",
        "effect": {"base_bonus": 1.0},  # +1.0s to timer per selection
        "category": "heavy_combo",
        "unlocks_combo": true
    },

    # Shovel Mass Techniques
    "mass_training": {
        "name": "Mass Training",
        "rarity": "common",
        "cost": 12,
        "max_level": 5,
        "description": "Increases shovel weight",
        "effect": {"base_bonus": 0.15},  # +15% mass per selection
        "category": "mass"
    },
    "weighted_mastery": {
        "name": "Weighted Mastery",
        "rarity": "epic",
        "cost": 35,
        "max_level": 5,
        "description": "Combo increases shovel mass dynamically",
        "effect": {"base_bonus": 0.02},  # +2% mass per combo stack per selection
        "category": "mass",
        "requires": "nodrop_combo"  # Must have unlocked no-drop combo system
    },
}
```

**Loading pattern in other files**:
```gdscript
# In mind.gd or level_1_vars.gd
const TechniquesData = preload("res://data/techniques.gd")
const TECHNIQUES = TechniquesData.TECHNIQUES
```

---

## Draw Quality System

When a player selects a technique from the upgrade pool, a **draw quality** is randomly assigned that determines how powerful that particular instance is.

### Quality Tiers

Each technique has a base bonus defined in its data structure. The quality tier multiplies this bonus:

| Quality Tier | Quality Multiplier | Example (Balance base 0.20) |
|--------------|-------------------|----------------------------|
| Common | ×1.0 | 0.20 × 1.0 = 0.20 |
| Rare | ×1.2 | 0.20 × 1.2 = 0.24 |
| Epic | ×1.4 | 0.20 × 1.4 = 0.28 |
| Legendary | ×1.6 | 0.20 × 1.6 = 0.32 |

**Formula**: `actual_bonus = base_bonus × quality_multiplier`

**Why multiplicative**: Rare quality gives 20% MORE effect (1.2× instead of 1.0×). For Balance's base 20% bonus, a Rare draw gives 24% (20% base × 1.2 = 24%).

### Draw Quality Weights

Quality is determined by the **appearance rarity** of the technique (Common/Rare/Epic/Legendary from Rarity System below).

**Draw distribution when selecting a technique**:

| Technique Rarity | Common Draw | Rare Draw | Epic Draw | Legendary Draw |
|-----------------|-------------|-----------|-----------|----------------|
| Common | 70% | 25% | 4% | 1% |
| Rare | 50% | 35% | 12% | 3% |
| Epic | 30% | 40% | 25% | 5% |
| Legendary | 20% | 30% | 35% | 15% |

**Design intent**: Rarer techniques have better average draw quality, making them more desirable even at same base percentage.

**Implementation**: See [2.x-shovelling-level-up.md](2.x-shovelling-level-up.md) `_draw_quality_for_technique()` for roll logic.

### Storage Format

When a technique is selected, the draw quality is stored in Level1Vars.

**CRITICAL DATA STRUCTURE** (referenced by [2.x-shovelling-level-up.md](2.x-shovelling-level-up.md) and [2.x-apply-upgrade.md](2.x-apply-upgrade.md)):

```gdscript
# In level_1_vars.gd
var selected_techniques: Dictionary = {}
# Structure: { technique_id: { "level": int, "qualities": Array[String] } }

# Example after selecting Balance three times with different draw qualities:
selected_techniques = {
    "balance": {
        "level": 3,
        "qualities": ["common", "rare", "common"]
    },
    "rhythm": {
        "level": 1,
        "qualities": ["rare"]
    }
}
```

**Accessing technique data**:
```gdscript
# Get technique level (0 if not selected)
var level = Level1Vars.selected_techniques.get(tech_id, {}).get("level", 0)

# Get draw quality history
var qualities = Level1Vars.selected_techniques.get(tech_id, {}).get("qualities", [])

# Check if technique is selected
var has_technique = tech_id in Level1Vars.selected_techniques
```

### Calculating Total Effect

To get the total effect of a technique with multiple selections:

```gdscript
# In level_1_vars.gd
const TechniquesData = preload("res://data/techniques.gd")
const TECHNIQUES = TechniquesData.TECHNIQUES

func get_technique_total_bonus(technique_id: String) -> float:
    if technique_id not in selected_techniques:
        return 0.0

    # Validate technique exists in definition
    if technique_id not in TECHNIQUES:
        push_warning("Unknown technique: " + technique_id)
        return 0.0

    # Handle boolean techniques (like Perfect Form, Perfect Balance)
    var effect_data = TECHNIQUES[technique_id]["effect"]
    if effect_data.has("type") and effect_data["type"] == "boolean":
        return 0.0  # Boolean techniques checked with has_technique(), not bonus calculation

    var base_bonus = effect_data["base_bonus"]
    var qualities = selected_techniques[technique_id]["qualities"]
    var total = 0.0

    for quality in qualities:
        var quality_mult = get_quality_multiplier(quality)
        total += base_bonus * quality_mult

    return total

func get_quality_multiplier(quality: String) -> float:
    match quality:
        "common": return 1.0
        "rare": return 1.2
        "epic": return 1.4
        "legendary": return 1.6
        _:
            push_warning("Unknown quality tier: " + quality)
            return 1.0
```

**Example calculation (Balance with Common + Rare + Common)**:
- Draw 1 (Common): 0.20 × 1.0 = 0.20
- Draw 2 (Rare): 0.20 × 1.2 = 0.24
- Draw 3 (Common): 0.20 × 1.0 = 0.20
- **Total bonus**: 0.20 + 0.24 + 0.20 = 0.64
- **Final multiplier**: 1.0 + 0.64 = 1.64× torque

### Save/Load Integration

**Add to level_1_vars.gd save/load functions**:

```gdscript
# In get_save_data()
func get_save_data() -> Dictionary:
    return {
        # ...existing save data...
        "selected_techniques": selected_techniques.duplicate(true),  # Deep copy
        "technique_branch": technique_branch,
        "upgrades_qty": upgrades_qty,
    }

# In load_save_data()
func load_save_data(data: Dictionary):
    # ...existing load code...
    selected_techniques = data.get("selected_techniques", {})
    technique_branch = data.get("technique_branch", "")
    upgrades_qty = data.get("upgrades_qty", 0)
```

---

## Rarity System

**Appearance Rarity** controls how often a technique appears in level-up pools (NOT implemented yet - all techniques have equal appearance chance currently).

**Future Distribution** (for rarity-weighted selection):
- **Common**: 50% chance to appear
- **Rare**: 35% chance to appear
- **Epic**: 12% chance to appear
- **Legendary**: 3% chance to appear

**Visual Indicator**: Border color on technique card (implemented in [2.x-shovelling-level-up.md](2.x-shovelling-level-up.md))

| Rarity | Color Name | RGB Values | Godot Color |
|--------|-----------|-----------|-------------|
| Common | Gray | (153, 153, 153) | Color(0.6, 0.6, 0.6) |
| Rare | Blue | (51, 128, 255) | Color(0.2, 0.5, 1.0) |
| Epic | Purple | (179, 77, 255) | Color(0.7, 0.3, 1.0) |
| Legendary | Gold | (255, 204, 51) | Color(1.0, 0.8, 0.2) |

---

## Strengthening System

When picking the same technique multiple times, percentage bonuses stack **additively**.

**How It Works:**
Each time you select a technique, you draw a quality level that determines the percentage bonus:
- **Common quality**: Base percentage × 1.0 (e.g., 0.20 for Balance)
- **Rare quality**: Base percentage × 1.2 (e.g., 0.24 for Balance)
- **Epic quality**: Base percentage × 1.4 (e.g., 0.28 for Balance)
- **Legendary quality**: Base percentage × 1.6 (e.g., 0.32 for Balance)

The formula is: `total_multiplier = 1.0 + sum_of_all_percentage_bonuses`

**Example: Balance (+20% base torque per selection)**
- Level 1 (Common draw): 1.0 + 0.20 = 1.20× torque
- Level 2 (Common + Rare): 1.0 + (0.20 + 0.24) = 1.44× torque
- Level 3 (Common + Rare + Epic): 1.0 + (0.20 + 0.24 + 0.28) = 1.72× torque
- Level 4 (adds Common): 1.0 + (0.20 + 0.24 + 0.28 + 0.20) = 1.92× torque
- Level 5 (adds Legendary): 1.0 + (0.20 + 0.24 + 0.28 + 0.20 + 0.32) = 2.24× torque

**Note**: Subject to maximum caps in [2.x-apply-upgrade.md](2.x-apply-upgrade.md) (e.g., torque capped at 3.0×).

**Draw Quality System:**
Quality is randomly assigned each time you select a technique, weighted by appearance rarity (see Draw Quality Weights above).

**Max Levels:**
All techniques have a maximum of 5 levels (except boolean techniques like Perfect Form and Perfect Balance which max at 1).

---

## Combo System Unlocking

**No-Drop Combo System**:
- Unlocked when player selects any technique with `"category": "nodrop_combo"` and `"unlocks_combo": true`
- Tracks `Level1Vars.nodrop_combo_unlocked = true`
- Combo counter `Level1Vars.nodrop_combo_count` starts at 0
- Default max combo: 20 (increased by Combo Ceiling technique)
- Forgiveness tracking: `Level1Vars.forgiveness_coal_count` (coal delivered since last forgiveness use)

**Heavy Load Combo System**:
- Unlocked when player selects any technique with `"category": "heavy_combo"` and `"unlocks_combo": true`
- Tracks `Level1Vars.heavy_combo_unlocked = true`
- Heavy stack counter `Level1Vars.heavy_combo_stacks` starts at 0
- Timer `Level1Vars.heavy_combo_timer` starts at 0.0 (counts down from 5.0s base)
- Heavy load trigger: Deliver 3+ coal within 1 second

**Weighted Mastery Requirement**:
- Technique "weighted_mastery" has `"requires": "nodrop_combo"`
- Can only appear in upgrade pool if `Level1Vars.nodrop_combo_unlocked == true`

**Run Reset**:
- Each run resets all technique selections and combo states
- `Level1Vars.selected_techniques = {}`
- `Level1Vars.upgrades_qty = 0`
- `Level1Vars.nodrop_combo_unlocked = false`
- `Level1Vars.nodrop_combo_count = 0`
- `Level1Vars.heavy_combo_unlocked = false`
- `Level1Vars.heavy_combo_stacks = 0`
- `Level1Vars.heavy_combo_timer = 0.0`
- `Level1Vars.forgiveness_coal_count = 0`
- Player starts fresh with no techniques selected

---

## Configuration

Tuning values are defined inline in this plan's TECHNIQUES dictionary. No separate `technique_config.gd` file exists currently.

**Tuneable Parameters**:
- `base_bonus` - Effect strength per selection (in TECHNIQUES dictionary)
- `max_level` - Maximum selections allowed (default 5, boolean techniques max at 1)
- Quality multipliers (1.0/1.2/1.4/1.6 in `get_quality_multiplier()`)
- Draw quality weights (70%/25%/4%/1% etc. in [2.x-shovelling-level-up.md](2.x-shovelling-level-up.md))
- Appearance rarity weights (deferred - not implemented yet)
- Combo system defaults (max combo 20, heavy timer 5s, forgiveness ratio 1:10)

**Future**: If tuning becomes complex, extract to `data/technique_config.gd`.

---

## Notes

**Current Scope**:
- Experience costs defined but NOT enforced (informational only)
- No branch system - all techniques in single pool
- Combo systems unlock dynamically when first combo technique is selected
- All techniques max at level 5 (except boolean techniques at 1)
- No rarity-weighted appearance (all techniques equal chance to appear)

**New Mechanics**:
- **No-Drop Combo**: Persistent streak counter, rewards consistency
- **Heavy Load Combo**: Timed burst bonuses with stack counter, rewards aggressive play
- **Forgiveness System**: Allows occasional mistakes without breaking combo
- **Combo Ceiling**: Upgradeable max combo cap (default 20)
- **Shovel Mass**: Physics-affecting stat that can scale with combo

**Future Expansion**:
- Multi-resource costs (Insight, Passion, Drive) in 2.x-additional-resource-pools.md
- Rarity-weighted selection (filter by appearance rarity percentages)
- Pool expansion to 30+ techniques in 2.x-content-and-balance.md
- Visual feedback for combo systems (meters, timers, particle effects)

**Cross-References**:
- **XP System**: See [2.x-shovel-experience.md](2.x-shovel-experience.md) for player_level and player_exp
- **UI Integration**: See [2.x-shovelling-level-up.md](2.x-shovelling-level-up.md) for Mind scene and selection mechanics
- **Effect Implementation**: See [2.x-apply-upgrade.md](2.x-apply-upgrade.md) for how technique effects modify gameplay and combo logic

**Implementation Order**:
1. Create `res://data/techniques.gd` (this plan)
2. Implement Mind scene UI ([2.x-shovelling-level-up.md](2.x-shovelling-level-up.md))
3. Implement combo tracking and effect application ([2.x-apply-upgrade.md](2.x-apply-upgrade.md))

---

**Last Updated**: 2025-12-28
**Status**: Ready for Implementation
**Version**: 3.0 (Removed automation branch, added combo systems, removed torque upgrades, added mass path)
