# Delivered Coal Tracking

**Goal**: Track coal pieces that successfully enter the furnace delivery zone with visual feedback.

**Success Criteria**:
- Level1Vars has coal_delivered counter and DEBUG_COAL_TRACKING flag
- Delivery zone created programmatically at furnace opening
- Coal entering delivery zone increments coal_delivered
- Delivered coal cannot trigger dropped flag (has_been_tracked state)
- Coal fades red over 0.3s then despawns
- Delivery takes priority over dropped when both zones trigger simultaneously

## Overview

This phase adds tracking for coal that successfully makes it into the furnace. A 15px wide detection zone is positioned inside the furnace opening. When coal enters, it's counted once, changes state to prevent dropped tracking, fades to red over 0.3 seconds, then despawns. The has_been_tracked flag ensures delivery always takes priority over drop tracking.

**Dependencies:**
- Requires 2.x-physics-objects.md for FurnaceWall structure and furnace opening dimensions
- Requires 2.x-coal-physics-spawning.md for coal layer configuration
- Requires 2.x-dropped-coal.md for has_been_tracked state flag

**Key Confirmations:**
- **Collision layers**: Coal uses collision_layer = 4 (Layer 3 = bit position 2 = 2^2 = 4)
- **Furnace opening**: From 2.x-physics-objects.md:
  - FurnaceWall positioned at furnace_line_x = playarea_size.x - 50
  - Opening defined by furnace_opening_top and furnace_opening_bottom (playarea coordinates)
  - Opening height = playarea_size.y * Level1Vars.furnace_opening_height_percent (default 0.20)
- **Detection zone**: 15px wide (matches furnace wall thickness), positioned inside furnace
- **Priority**: If coal enters delivery and drop zones simultaneously, only delivery increments

---

## Implementation Tasks

### 1. Add has_been_tracked Flag to Coal

Prevents coal from being counted as both delivered AND dropped.

**In coal_piece.gd (add at top of script):**
```gdscript
extends RigidBody2D

var has_been_tracked: bool = false  # Prevents double-counting
```

**Notes:**
- Flag is checked by both delivery and drop handlers
- First handler to run sets flag to true
- Second handler sees flag and returns early
- Delivery zone is positioned before drop zone, so delivery wins if both trigger simultaneously

### 2. Update Drop Handler to Check Flag

Modify existing drop handler to skip if coal already tracked.

**In coal_piece.gd _on_entered_drop_zone():**
```gdscript
func _on_entered_drop_zone():
    # Skip if already counted as delivered
    if has_been_tracked:
        queue_free()  # Still remove it, just don't count
        return

    # Mark as tracked FIRST (before incrementing)
    has_been_tracked = true

    # Track as dropped
    Level1Vars.coal_dropped += 1
    if Level1Vars.DEBUG_COAL_TRACKING:
        print("[COAL] Dropped! Total: ", Level1Vars.coal_dropped)

    queue_free()  # Remove immediately
```

**Notes:**
- Removed null check - Level1Vars is autoload, if missing entire game is broken
- Set has_been_tracked BEFORE incrementing counter (prevents race condition)
- Still call queue_free() even if already tracked (cleanup orphaned coal)

### 3. Delivery Zone Setup

Create Area2D delivery zone programmatically inside furnace opening.

**In furnace.tscn:**
- Add empty Node2D named "DeliveryZone" under FurnaceWall (same parent as TopObstacle/BottomObstacle)

**In furnace.gd (add constant and onready):**
```gdscript
const DELIVERY_ZONE_WIDTH: float = 15.0

@onready var delivery_zone_node: Node2D = $AspectContainer/MainContainer/mainarea/PlayArea/FurnaceWall/DeliveryZone
```

**In furnace.gd setup_physics_objects():**
```gdscript
func setup_physics_objects():
    # ... (existing coal pile and furnace wall setup)

    # Setup delivery zone at end
    setup_delivery_zone()
```

**In furnace.gd (add new function):**
```gdscript
func setup_delivery_zone():
    if not delivery_zone_node:
        push_error("DeliveryZone node not found in scene")
        return

    # Guard against double setup
    if delivery_zone_node.get_child_count() > 0:
        push_warning("Delivery zone already setup, skipping")
        return

    # Validate opening dimensions
    var opening_height = furnace_opening_bottom - furnace_opening_top
    if opening_height <= 0:
        push_error("Invalid furnace opening dimensions: top=%s bottom=%s" % [furnace_opening_top, furnace_opening_bottom])
        return

    # Create Area2D
    var area = Area2D.new()
    area.name = "DeliveryArea"
    area.monitoring = true
    area.monitorable = false
    area.collision_layer = 0
    area.collision_mask = 4  # Layer 3 (coal)

    # Create collision shape
    var shape = CollisionShape2D.new()
    var rect = RectangleShape2D.new()
    rect.size = Vector2(DELIVERY_ZONE_WIDTH, opening_height)
    shape.shape = rect

    # Position shape (local coordinates relative to DeliveryZone)
    # DeliveryZone inherits FurnaceWall's X position (furnace_line_x)
    # X: Center the 15px zone (half width from origin)
    # Y: Center vertically in opening
    shape.position = Vector2(
        DELIVERY_ZONE_WIDTH / 2,
        furnace_opening_top + opening_height / 2
    )

    area.add_child(shape)
    delivery_zone_node.add_child(area)
    area.body_entered.connect(_on_coal_entered_delivery_zone)

func _on_coal_entered_delivery_zone(body: Node2D):
    # Only coal can trigger this (collision_mask = 4)
    body._on_entered_delivery_zone()
```

**Coordinate System:**
- DeliveryZone is child of FurnaceWall
- FurnaceWall.position.x = furnace_line_x (set in 2.x-physics-objects.md)
- DeliveryZone inherits this X position (global X = furnace_line_x)
- shape.position is in local coordinates relative to DeliveryZone
- furnace_opening_top/bottom are in playarea coordinates (y=0 at playarea top)
- Since DeliveryZone local origin is at FurnaceWall origin, we can use opening_top/bottom directly for Y

### 4. Coal Delivery Handler

Add delivery handler with red fade animation.

**In coal_piece.gd (add after _on_entered_drop_zone):**
```gdscript
# Called by delivery zone Area2D when coal enters furnace
func _on_entered_delivery_zone():
    # Mark as tracked FIRST (prevents drop zone from counting it during fade)
    has_been_tracked = true

    # Track as delivered
    Level1Vars.coal_delivered += 1
    if Level1Vars.DEBUG_COAL_TRACKING:
        print("[COAL] Delivered! Total: ", Level1Vars.coal_delivered)

    # Red fade animation: gradually change color to red over 0.3 seconds, then remove
    var tween = create_tween()
    tween.tween_property(self, "modulate", Color.RED, 0.3)
    tween.finished.connect(queue_free)
```

**Notes:**
- No has_been_tracked check needed - if coal was dropped first, it's already queue_free()'d and can't reach here
- Set has_been_tracked before incrementing - prevents drop zone from counting during the 0.3s fade
- Tween explanation: `create_tween()` creates animation helper, `tween_property()` animates the "modulate" (color tint) property from current color to RED over 0.3 seconds, when animation finishes it calls `queue_free()` to remove the coal
- 0.3s is long enough to see but won't create visual clutter

---

## Testing Checklist

**Basic Functionality:**
- [ ] Coal entering delivery zone increments coal_delivered
- [ ] Coal fades to red over 0.3s when delivered
- [ ] Coal despawns after fade completes

**Double-Tracking Prevention:**
- [ ] Coal delivered first cannot be counted as dropped (has_been_tracked prevents it)
- [ ] Coal dropped first cannot be counted as delivered (has_been_tracked prevents it)

**Mixed Delivery/Drop:**
- [ ] Scoop 5 coal, lose 2 to border, deliver 3 to furnace → coal_dropped=2, coal_delivered=3

**Priority Handling:**
- [ ] Coal entering delivery zone during same frame as border → only coal_delivered increments

**Error Handling:**
- [ ] setup_delivery_zone() logs error if DeliveryZone node missing
- [ ] setup_delivery_zone() logs error if furnace dimensions invalid
- [ ] setup_delivery_zone() prevents double-setup if called twice

---

## Files Modified

- [level1/level_1_vars.gd](../../../game/v0.1/level1/level_1_vars.gd) - coal_delivered already exists; add DEBUG_COAL_TRACKING if missing
- [level1/furnace.gd](../../../game/v0.1/level1/furnace.gd) - Add delivery zone creation and handler
- [level1/furnace.tscn](../../../game/v0.1/level1/furnace.tscn) - Add empty DeliveryZone Node2D under FurnaceWall
- [level1/coal_piece.gd](../../../game/v0.1/level1/coal_piece.gd) - Add has_been_tracked flag and delivery handler, update drop handler

---

## Debug Helper

**Enable tracking prints:**
```gdscript
# In level_1_vars.gd:
var DEBUG_COAL_TRACKING: bool = true
```

**Verify collision layers:**
```gdscript
# In coal_piece.gd _ready(), temporary debug:
print("Coal collision_layer: ", collision_layer)  # Should be 4
```

---

## Troubleshooting

**Coal not detected by delivery zone:**
- Verify coal collision_layer = 4 (NOT 3!)
- Verify delivery zone collision_mask = 4
- Check DeliveryZone node exists under FurnaceWall in scene

**Coal being counted twice:**
- Verify has_been_tracked is set to true BEFORE incrementing counter in both handlers
- Both handlers should check `if has_been_tracked: return` at the start

**Delivery zone positioned wrong:**
- Check furnace_opening_top and furnace_opening_bottom values are valid
- Verify DeliveryZone is child of FurnaceWall (inherits X position)
- Zone should be visible just inside furnace opening (15px from furnace line)

**Coal not fading to red:**
- Verify tween is created (add debug print in handler)
- Check console for tween errors
- Make sure coal isn't being queue_free()'d before fade finishes

---

## Notes

**Why 15px wide detection zone?**
- Matches furnace wall thickness (from 2.x-physics-objects.md)
- Creates tight detection - coal must clearly enter opening to count
- Prevents early triggering while coal still in playarea
- Predictable trigger point - edges align with visual furnace line

**Why 0.3 second fade?**
- Long enough to see visual feedback
- Short enough to not clutter screen with many simultaneous fades
- Different from dropped coal (immediate despawn) - player can distinguish success from failure
- Red color simulates coal burning/heating

**Why has_been_tracked flag?**
- Drop handler calls queue_free() immediately - coal is gone instantly
- Delivery handler calls queue_free() after 0.3s fade - coal still exists and can move during fade
- If coal enters delivery zone, it might continue moving right and hit the right border drop zone during fade
- Flag prevents drop handler from counting coal that's already been counted as delivered
- One-directional check: only drop handler needs to check flag, delivery handler just sets it

**Why remove group check?**
- collision_mask = 4 already ensures only Layer 3 objects trigger signal
- Coal is the ONLY thing on Layer 3
- If non-coal triggers it, that's a layer configuration bug that needs fixing at source
- Defensive check hides real problems instead of fixing them

**Why remove null checks for Level1Vars?**
- Level1Vars is autoload singleton
- If it's null, entire game is broken (not just this feature)
- Silent failure hides critical initialization problems
- Better to crash loudly with clear error than silently fail

---

## Automated Tests (Optional)

**Create res://tests/test_coal_tracking.gd** if using GUT test framework:

```gdscript
extends GutTest

func before_each():
    if Level1Vars:
        Level1Vars.coal_delivered = 0
        Level1Vars.coal_dropped = 0

# Test: Coal only increments counters once per piece
func test_coal_no_double_tracking():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    # Try to deliver twice
    coal_piece._on_entered_delivery_zone()
    coal_piece._on_entered_delivery_zone()

    assert_eq(Level1Vars.coal_delivered, 1, "Should only count once")

# Test: Delivered coal cannot be counted as dropped
func test_delivered_coal_prevents_drop_tracking():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    # Deliver first
    coal_piece._on_entered_delivery_zone()

    # Try to drop (should be prevented by has_been_tracked)
    coal_piece._on_entered_drop_zone()

    assert_eq(Level1Vars.coal_delivered, 1, "Should count delivery")
    assert_eq(Level1Vars.coal_dropped, 0, "Should NOT count drop")

# Test: Dropped coal cannot be counted as delivered
func test_dropped_coal_prevents_delivery_tracking():
    var coal_piece = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal_piece)

    # Drop first (coal is queue_free'd, so this test may need adjustment)
    coal_piece._on_entered_drop_zone()

    assert_eq(Level1Vars.coal_dropped, 1, "Should count drop")
    assert_eq(Level1Vars.coal_delivered, 0, "Should NOT count delivery")
    # Note: Coal is removed after drop, so delivery can't trigger anyway

# Test: Physics properties are correct
func test_coal_physics_properties():
    var coal = preload("res://level1/coal_piece.tscn").instantiate()
    add_child_autofree(coal)

    assert_eq(coal.mass, 0.8, "Mass should be 0.8")
    assert_eq(coal.gravity_scale, 1.0, "Gravity scale should be 1.0")
    assert_eq(coal.linear_damp, 0.8, "Linear damp should be 0.8")
    assert_eq(coal.angular_damp, 1.5, "Angular damp should be 1.5")

    # Check physics material
    assert_not_null(coal.physics_material_override, "Should have physics material")
    assert_eq(coal.physics_material_override.friction, Level1Vars.coal_friction, "Should use Level1Vars.coal_friction")
    assert_eq(coal.physics_material_override.bounce, Level1Vars.coal_bounce, "Should use Level1Vars.coal_bounce")
```

**Run tests:**
```bash
# If using GUT (Godot Unit Testing)
godot --headless --script res://addons/gut/gut_cmdln.gd -gtest=res://tests/test_coal_tracking.gd
```

---

## Performance Benchmarks

**Target performance:**
- 60 FPS with 20 simultaneous coal pieces
- No stuttering during scooping
- No physics tunneling (coal phasing through objects)

**Monitor in-game:**
- Frame time (should stay below 16ms for 60 FPS)
- Number of active coal pieces (check active_coal_count)

**If performance issues occur:**
- Reduce MAX_COAL_PIECES (100 -> 50)
- Reduce spawn rate (4/sec -> 2/sec)
- Increase coal damping (settles faster = fewer active physics calculations)

---

**Next Phase**: See [2.x-furnace-bars.md](2.x-furnace-bars.md) for furnace progress visualization.
