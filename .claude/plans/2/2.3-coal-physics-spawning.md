# Coal Physics & Spawning (Shovelling Phase 2)

**Goal**: Implement coal pieces with physics properties and the scooping mechanism that spawns them.

**Success Criteria**:
- Coal pieces are RigidBody2D with proper physics properties
- Coal pieces use shared PhysicsMaterial from [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md)
- Scooping mechanism detects shovel upward movement from coal pile and spawns coal
- Coal rests on shovel naturally via physics friction
- Coal falls off shovel when moved too fast or tilted (pure physics, no attachment logic)

## Overview

This phase implements the coal pieces and scooping mechanism. Coal pieces are physics objects that interact with the shovel through friction and damping - no manual attachment logic. The scoop mechanism detects when the shovel exits the coal pile with upward motion and spawns 5 coal pieces onto it.

**Dependencies**:
- **REQUIRED**: [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md) must be complete
- Uses `coal_physics_material.tres` created in 2.x-physics-objects-setup.md
- Uses `CoalPileArea` created in 2.x-physics-objects-setup.md (requires collision config update)
- Uses `Shovel` RigidBody2D from 2.x-physics-objects-setup.md with 3-segment bowl collision
- **CRITICAL**: Shovel MUST use velocity-based movement (not direct position setting) for collision to work
- **NOTE**: Shovel tilt mechanic (hold left/right mouse) is already implemented in 2.x-physics-objects-setup.md
- **NOTE**: Shovel has concave bowl collision (3 line segments) that naturally contains coal

---

## Physics Layers Configuration

**Layer Setup** (extends 2.x-physics-objects-setup.md):
- Layer 1: World objects (furnace walls, ground)
- Layer 2: Shovel
- Layer 3: Coal pieces (NEW - added in this phase)
- Layer 4: Detection areas (NEW - added in this phase)

**Collision Configuration**:
- Shovel: Layer 2, Mask [1, 3] - collides with world and coal
- Coal: Layer 3, Mask [1, 2, 3] - collides with world, shovel, and other coal
- CoalPileArea: Layer 4, Mask [2] - detects shovel only (update from 2.x-physics-objects-setup.md)

**NOTE**: CoalPileArea was created in [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md) but needs collision layer/mask updated to layer 4/mask 2.

---

## Implementation Tasks

### 1. Update CoalPileArea Collision Settings

CoalPileArea already exists from [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md). Update its collision settings for scoop detection.

**In furnace.tscn:**
- Select `PlayArea/CoalPile/CoalPileArea` node
- Set collision_layer to 4 (detection layer)
- Set collision_mask to 2 (detects shovel only)

**Why update?** 2.x-physics-objects-setup.md created the area but didn't configure it for detection. Layer 4 keeps detection separate from physics collisions.

### 2. Coal Piece Scene

Create reusable coal piece with physics properties and visual.

**Create res://level1/coal_piece.tscn:**
1. Root node: `RigidBody2D` (name: CoalPiece)
2. Add child: `CollisionShape2D`
   - Shape: CircleShape2D
   - Radius: 10px
3. Add child: `Polygon2D` (name: Visual)
   - Polygon points: Create 6-8 sided irregular shape for lumpy look
   - Example points (relative to center):
     ```
     [Vector2(-8, -6), Vector2(-4, -10), Vector2(4, -9),
      Vector2(9, -3), Vector2(7, 6), Vector2(2, 10),
      Vector2(-6, 8), Vector2(-10, 2)]
     ```
   - Color: Black `#000000` or very dark gray `#1a1a1a`

**Visual Design Notes**:
- CircleShape2D for physics (10px radius = 20px diameter)
- Polygon2D for visuals (slightly irregular, lumpy coal look)
- Keep polygon within ~10px radius to match collision shape
- Black or near-black color for coal appearance

### 3. Coal Piece Script

**Create res://level1/coal_piece.gd:**
```gdscript
extends RigidBody2D

const COAL_PHYSICS_MAT = preload("res://level1/coal_physics_material.tres")
const OFFSCREEN_THRESHOLD: float = 2000.0  # Distance from origin before cleanup
const MAX_LIFETIME: float = 30.0  # Seconds before forced cleanup

var lifetime: float = 0.0

func _ready():
	# Setup physics properties
	mass = 0.8
	gravity_scale = 1.0
	linear_damp = 0.8
	angular_damp = 1.5

	# Collision layers
	collision_layer = 3  # Coal on layer 3
	collision_mask = 7   # Binary 111 = collides with layers 1, 2, 3

	# Use shared physics material (friction 0.7, bounce 0.15)
	physics_material_override = COAL_PHYSICS_MAT

func _process(delta):
	lifetime += delta

	# Cleanup if too far from origin or too old
	if global_position.length() > OFFSCREEN_THRESHOLD or lifetime > MAX_LIFETIME:
		queue_free()
```

**In coal_piece.tscn:**
- Attach `coal_piece.gd` to root RigidBody2D node

**Physics Properties**:
- Mass 0.8: Light but has weight
- Gravity scale 1.0: Normal gravity
- Linear damp 0.8: Settles quickly, not too bouncy
- Angular damp 1.5: Reduces spinning
- Friction 0.7: From coal_physics_material.tres (created in 2.x-physics-objects-setup.md)
- Bounce 0.15: From coal_physics_material.tres

### 4. Scooping Mechanism

Detect shovel exit from coal pile with upward motion, spawn coal pieces.

**In furnace.gd** (add to existing file from [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md)):

**Add @onready variables** (add near top with other @onready vars):
```gdscript
@onready var coal_pile_area: Area2D = $AspectContainer/MainContainer/mainarea/PlayArea/CoalPile/CoalPileArea
@onready var shovel_body: RigidBody2D = $AspectContainer/MainContainer/mainarea/PlayArea/Shovel/RigidBody2D
```

**IMPORTANT NODE PATH**: In [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md), Shovel is structured as `Shovel (Node2D) -> RigidBody2D (child)`. Reference the RigidBody2D child, not the parent Node2D.

**Add scoop state variables** (add near top with other variables):
```gdscript
# Preload coal scene
var coal_piece_scene = preload("res://level1/coal_piece.tscn")

# Scoop detection state
var shovel_was_in_pile: bool = false
var shovel_entry_position: Vector2 = Vector2.ZERO
var scoop_cooldown_timer: float = 0.0
const SCOOP_COOLDOWN_DURATION: float = 0.4
const SCOOP_UPWARD_THRESHOLD: float = 50.0  # Minimum upward pixels for scoop
var active_coal_count: int = 0
const MAX_COAL_PIECES: int = 100  # Performance limit
```

**Add to existing _ready() function** (after `setup_physics_objects()` call):
```gdscript
func _ready():
	ResponsiveLayout.apply_to_scene(self)
	connect_navigation()
	await get_tree().process_frame
	setup_physics_objects()

	# Connect coal pile area signals (ADD THIS)
	coal_pile_area.body_entered.connect(_on_coal_pile_entered)
	coal_pile_area.body_exited.connect(_on_coal_pile_exited)
```

**Add to existing _process() function** (or create if doesn't exist):
```gdscript
func _process(delta):
	# Update scoop cooldown
	if scoop_cooldown_timer > 0.0:
		scoop_cooldown_timer -= delta
```

**Add new functions** (add at end of file):
```gdscript
func _on_coal_pile_entered(body):
	if body == shovel_body:
		shovel_was_in_pile = true
		shovel_entry_position = shovel_body.global_position

func _on_coal_pile_exited(body):
	if body == shovel_body and shovel_was_in_pile and scoop_cooldown_timer <= 0.0:
		# Calculate upward movement
		# In Godot: Y increases downward, so upward = entry.y - exit.y (positive)
		var y_delta = shovel_entry_position.y - shovel_body.global_position.y

		# Scoop if moving upward by at least threshold
		if y_delta >= SCOOP_UPWARD_THRESHOLD:
			spawn_coal_at_shovel()
			scoop_cooldown_timer = SCOOP_COOLDOWN_DURATION

		shovel_was_in_pile = false

func spawn_coal_at_shovel():
	# Enforce performance limit
	if active_coal_count >= MAX_COAL_PIECES:
		return

	# Spawn 5 coal pieces in a row
	var spawn_offsets = [-30, -15, 0, 15, 30]

	for offset_x in spawn_offsets:
		if active_coal_count >= MAX_COAL_PIECES:
			break

		var coal = coal_piece_scene.instantiate()
		get_node("AspectContainer/MainContainer/mainarea/PlayArea").add_child(coal)

		# Track coal lifetime
		active_coal_count += 1
		coal.tree_exited.connect(_on_coal_destroyed)

		# Spawn above shovel to prevent tunneling
		coal.global_position = shovel_body.global_position + Vector2(offset_x, -60)

		# EDGE CASE: If shovel is tilted, coal will immediately start sliding
		# This is intended behavior - creates skill challenge

func _on_coal_destroyed():
	active_coal_count -= 1
```

**Scoop Detection Logic**:
1. `body_entered`: Shovel enters pile → capture position, set flag
2. `body_exited`: Shovel exits pile → check upward movement
   - Calculate Y delta: `entry.y - exit.y` (Godot Y+ is down, so positive = upward)
   - If delta >= 50px AND cooldown expired → spawn coal
3. Cooldown prevents rapid spam (0.4s between scoops)
4. Performance cap at 100 coal pieces total

**Why capture position on entry, not track continuously?**
- Prevents race conditions where signal callbacks fire mid-frame with inconsistent data
- More predictable - Y delta is always "from entry to exit"
- Simpler - no need to track in _process()

**Design Values**:
- Coal per scoop: 5 pieces
- Spawn X offsets: [-30, -15, 0, 15, 30] (spreads coal across shovel)
- Spawn Y offset: -60px above shovel (prevents tunneling)
- Cooldown: 0.4s (prevents spam but feels responsive)
- Upward threshold: 50px (deliberate motion required, not drift)
- Max coal: 100 pieces (performance cap - reduce if needed)
- Coal cleanup: 2000px from origin OR 30s lifetime

### 5. Expected Physics Behavior

No manual attachment code - pure physics interaction.

**How coal stays on shovel**:
- Friction (0.7) between coal and shovel prevents sliding
- Linear damp (0.8) makes coal settle quickly
- Mass (0.8) gives coal weight but doesn't overpower friction
- Shovel bowl shape (3-segment concave collision) provides angled walls that contain coal
- Bottom line (36 units wide) creates stable resting surface

**How coal falls off**:
- Fast shovel movement: Coal's inertia overcomes friction → slides off
- Shovel tilt: Gravity component pulls coal toward lower side → slides off
- More tilt = steeper slope = faster sliding
- Creates skill challenge: balance speed vs tilt angle

**Edge Cases**:
- **Tilted shovel spawn**: If shovel is tilted when coal spawns, coal will immediately start sliding toward lower side (intended - creates challenge)
- **Multiple coal stacking**: Coal pieces can rest against each other via friction
- **Fast spawn**: Y offset -60px prevents tunneling even with rapid scooping

---

## Testing Checklist

### Setup Verification (Prerequisites from 2.x-physics-objects-setup.md)
- [ ] CoalPileArea exists under `PlayArea/CoalPile/` (created in 2.x-physics-objects-setup.md)
- [ ] CoalPileArea collision layer updated to 4
- [ ] CoalPileArea collision mask updated to 2
- [ ] Shovel structure is `Shovel (Node2D) -> RigidBody2D (child)`
- [ ] Shovel RigidBody2D collision layer is 2
- [ ] Shovel RigidBody2D collision mask includes layer 3 (updated to include coal)
- [ ] `coal_physics_material.tres` exists from 2.x-physics-objects-setup.md

### Coal Piece Scene
- [ ] `coal_piece.tscn` exists
- [ ] Root is RigidBody2D named CoalPiece
- [ ] Has CircleShape2D collision (10px radius)
- [ ] Has Polygon2D visual (black/dark gray, irregular shape)
- [ ] Script `coal_piece.gd` attached
- [ ] Mass = 0.8, gravity_scale = 1.0
- [ ] linear_damp = 0.8, angular_damp = 1.5
- [ ] collision_layer = 3, collision_mask = 7
- [ ] Uses `coal_physics_material.tres` (friction 0.7, bounce 0.15)

### Scoop Mechanism
- [ ] `coal_piece_scene` preloaded in furnace.gd
- [ ] Scoop state variables declared
- [ ] Area signals connected in _ready()
- [ ] Cooldown timer decrements in _process()
- [ ] `shovel_body` reference points to RigidBody2D child (not parent Node2D)
- [ ] Entry position captured when shovel enters pile
- [ ] Y-delta calculation correct: `entry.y - exit.y` (positive = upward)
- [ ] Upward threshold 50px enforced
- [ ] Cooldown 0.4s enforced
- [ ] Max 100 coal pieces enforced
- [ ] Coal spawns at Y offset -60 (above shovel)
- [ ] Coal spawns at 5 X positions relative to shovel
- [ ] `active_coal_count` increments/decrements correctly

### Physics Behavior
- [ ] Coal falls onto shovel from spawn position (gravity working)
- [ ] Coal rests on level, stationary shovel (friction working)
- [ ] Coal stays on shovel during slow movement
- [ ] Coal slides off during fast movement
- [ ] Coal slides toward lower side on tilted shovel
- [ ] More tilt = faster sliding
- [ ] Coal pieces can stack/cluster without sliding apart
- [ ] Coal settles quickly (damping working)
- [ ] Coal doesn't spin excessively
- [ ] Coal cleanup works (offscreen and lifetime)
- [ ] No attachment/detachment code exists

### Integration
- [ ] Scoop from pile multiple times - each spawns 5 coal
- [ ] 100 piece cap enforced - spawning stops
- [ ] Coal cleanup works - old/distant coal disappears
- [ ] No console errors during gameplay
- [ ] Shovel tilt (via holding mouse buttons) causes coal to slide naturally
- [ ] Tilt interaction works smoothly - coal responds to shovel angle changes

---

## Manual Testing Guide

**Test 1: Basic Scoop**
1. Move shovel into coal pile (bottom-left)
2. Move downward into pile, then quickly upward (50+ pixels)
3. Expected: 5 coal pieces spawn on shovel
4. Hold mouse still - coal should rest on shovel, not slide off
5. If coal slides off stationary shovel, friction is too low - see Troubleshooting

**Test 2: Scoop Threshold**
1. Move shovel into pile
2. Move upward slowly (<50px)
3. Expected: No coal spawns (below threshold)
4. Move upward quickly (50+ px)
5. Expected: Coal spawns

**Test 3: Cooldown**
1. Scoop coal
2. Immediately scoop again (<0.4s)
3. Expected: No coal spawns (cooldown active)
4. Wait 0.5s, scoop again
5. Expected: Coal spawns

**Test 4: Tilt Interaction**
1. Scoop coal
2. Hold left mouse button to tilt shovel left
3. Expected: Coal slides toward right (lower side)
4. Hold right mouse button to tilt shovel right
5. Expected: Coal slides toward left (lower side)

**Test 5: Movement Speed**
1. Scoop coal
2. Move shovel slowly - coal stays on
3. Move shovel rapidly - coal slides/falls off

**Test 6: Performance Cap**
1. Scoop coal repeatedly until count reaches 100
2. Expected: Spawning stops at 100 pieces
3. Throw coal offscreen to reduce count
4. Expected: Can scoop again after cleanup

**Test 7: Edge Case - Tilted Spawn**
1. Tilt shovel (hold left or right mouse button)
2. While tilted, scoop coal
3. Expected: Coal spawns but immediately starts sliding toward lower side (intended behavior)

---

## Troubleshooting

**Scoop not triggering:**
- Verify CoalPileArea collision_layer = 4, collision_mask = 2
- Verify Shovel collision_layer = 2
- Check `shovel_body` reference points to RigidBody2D child: `$path/Shovel/RigidBody2D`
- Debug print y_delta to see actual values
- Temporarily lower threshold to 20px for testing
- Check area is large enough (shovel might skip over with fast movement)

**Coal tunnels through shovel:**
- Increase spawn Y offset (try -80 or -100)
- Verify shovel collision_mask includes layer 3
- Verify coal collision_layer = 3
- Spawning too many pieces at once can overwhelm physics - check count

**Coal too slippery (slides off immediately):**
- Increase friction in `coal_physics_material.tres` (try 0.8-0.9)
- Increase coal linear_damp (try 1.0-1.2)
- Decrease coal mass (try 0.6-0.7)
- Check shovel isn't tilted (tilt causes sliding)

**Coal too sticky (never falls off):**
- Decrease friction (try 0.5-0.6)
- Decrease linear_damp (try 0.6-0.7)
- Increase coal mass (try 1.0-1.2)

**Scoop triggers on downward motion:**
- Verify Y-delta calculation: `entry.y - exit.y` (NOT reversed)
- Remember: Godot Y+ is down, so positive delta = upward motion

**Performance issues:**
- Check `active_coal_count` caps at 100
- Check coal cleanup (offscreen/lifetime)
- Reduce MAX_COAL_PIECES if needed (try 50)

**shovel_body reference error:**
- Verify node path: Should be `$path/Shovel/RigidBody2D` (child, not parent)
- Check 2.x-physics-objects-setup.md implementation - Shovel is Node2D with RigidBody2D child

---

## Balance Tuning

Adjust these values if physics behavior doesn't feel right:

**Coal slips too easily:**
- `coal_physics_material.tres` friction: 0.7 → 0.8-0.9
- `coal_piece.gd` linear_damp: 0.8 → 1.0-1.2
- `coal_piece.gd` mass: 0.8 → 0.6-0.7

**Coal too sticky:**
- Friction: 0.7 → 0.5-0.6
- Linear damp: 0.8 → 0.6-0.7
- Mass: 0.8 → 1.0-1.2

**Coal bounces too much:**
- `coal_physics_material.tres` bounce: 0.15 → 0.05-0.1
- Angular damp: 1.5 → 2.0-2.5

**Coal spins excessively:**
- Angular damp: 1.5 → 2.0-2.5

**Scoop too slow/fast:**
- Cooldown: 0.4s → slower: 0.5-0.6s, faster: 0.2-0.3s

**Scoop too sensitive/insensitive:**
- Threshold: 50px → more sensitive: 30-40px, less: 60-80px

---

## Files Modified

- [level1/furnace.gd](../../level1/furnace.gd) - Added scoop detection, coal spawning, count tracking
- [level1/furnace.tscn](../../level1/furnace.tscn) - Updated CoalPileArea collision settings

## Files Created

- [level1/coal_piece.tscn](../../level1/coal_piece.tscn) - Coal RigidBody2D scene with visual
- [level1/coal_piece.gd](../../level1/coal_piece.gd) - Coal physics and cleanup script

## Files Referenced

- [level1/coal_physics_material.tres](../../level1/coal_physics_material.tres) - From [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md)
- [level1/shovel_physics_material.tres](../../level1/shovel_physics_material.tres) - From [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md)

---

## GDScript Error Prevention

**Common pitfalls specific to this phase:**

### Variable Naming in Coal Tracking
When iterating over coal-related arrays, avoid built-in function names:
```gdscript
# WRONG - 'error' shadows built-in function
for error in error_logs:
    print(error.message)

# CORRECT
for error_entry in error_logs:
    print(error_entry.message)
```

### Reference the Correct Node
Shovel structure from [2.x-physics-objects-setup.md](2.x-physics-objects-setup.md):
```
Shovel (Node2D)
└── RigidBody2D (child)
```

**CRITICAL:** Reference the RigidBody2D child, NOT the parent:
```gdscript
# CORRECT
@onready var shovel_body: RigidBody2D = $path/Shovel/RigidBody2D

# WRONG - references Node2D parent instead of RigidBody2D child
@onready var shovel_body = $path/Shovel
```

### See Also
Refer to [1.x-simple-logging.md](../1/1.x-simple-logging.md) for comprehensive GDScript common pitfalls (iterator names, output parameters, type formatting, etc.).

---

## Design Notes

**Why spawn coal above shovel (no initial velocity)?**
- Gravity naturally pulls coal onto shovel - feels realistic
- Physics engine handles landing - no manual placement
- Y offset -60px prevents tunneling
- No magic velocity values needed

**Why pure physics (no attachment)?**
- More emergent gameplay - players discover optimal techniques
- Simpler code - no attach/detach state management
- Feels natural and satisfying
- RigidBody2D-to-RigidBody2D friction works reliably
- Tilt mechanic creates natural sliding via gravity
- Bowl-shaped collision provides physical containment without attachment logic

**Why 5 coal per scoop?**
- Feels substantial without being chaotic
- Allows some to fall off while others reach furnace
- Tunable based on feedback

**Why 50px upward threshold?**
- 20px would trigger on accidental drift
- 50px requires deliberate scooping motion
- Not so high that it feels unresponsive (100px too strict)
- Tune based on feel

**Why capture position on entry?**
- Prevents race conditions (signal timing issues)
- More predictable - delta always measures from entry to exit
- Simpler - no continuous tracking

**Why 100 coal max?**
- Prevents physics engine overload
- Distance cleanup handles thrown coal
- Lifetime cleanup handles stuck coal
- Tune down if performance issues occur

**Shovel tilt gameplay** (implemented in 2.x-physics-objects-setup.md):
- Hold left/right mouse buttons to apply continuous rotation torque
- Tilt creates gravity component perpendicular to surface
- Coal naturally slides "downhill" on tilted shovel via physics
- Skill challenge: balance movement speed vs tilt angle
- Too much tilt = coal falls off
- Tilt mechanic uses TILT_TORQUE = 108000.0 for responsive rotation
- Shovel mass = 20.0 prevents coal from pushing it around

**No delivery tracking yet**:
- This phase only spawns coal
- Phase 2.4 will add delivery/drop detection
- Keeps this phase focused on core physics

**Next Phase**: Phase 2.4 implements coal tracking - counting delivered vs dropped coal.
