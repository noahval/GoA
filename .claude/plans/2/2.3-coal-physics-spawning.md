# Coal Physics & Spawning (Shovelling Phase 2)

**Goal**: Implement coal pieces with physics properties and the scooping mechanism that spawns them.

**Success Criteria**:
- Coal pieces are RigidBody2D with proper physics properties
- Coal pieces use shared PhysicsMaterial resource
- Scooping mechanism detects shovel movement and spawns coal
- Coal rests on shovel naturally via physics friction
- Coal falls off shovel when moved too fast (pure physics)
- No tracking or delivery detection yet

## Overview

This phase implements the coal pieces themselves and the mechanism for scooping them. Coal pieces are physics objects that interact with the shovel through friction and damping - no manual attachment logic. The scoop mechanism detects when the shovel exits the coal pile area with upward motion and spawns 5 coal pieces.

**Dependencies**:
- Requires Phase 2.2.1 (physics objects) to be complete
- Uses shared coal_physics_material.tres from Phase 2.2.1

---

## Physics Layers Configuration

**Layer Setup:**
- Layer 1: World objects (furnace walls, ground)
- Layer 2: Shovel
- Layer 3: Coal pieces
- Layer 4: Detection areas (CoalPileArea)

**Collision Configuration:**
- Shovel: Layer 2, Mask [1, 3] (collides with world and coal)
- Coal: Layer 3, Mask [1, 2, 3] (collides with world, shovel, and other coal)
- CoalPileArea: Layer 4, Mask [2] (detects shovel only)

---

## Implementation Tasks

### 1. Coal Pile Detection Area

Create Area2D to detect when shovel enters/exits coal pile.

**In furnace.tscn:**
- Select CoalPile node
- Add child node: Area2D (name it CoalPileArea)
- Add CollisionShape2D child to CoalPileArea
- Set shape to RectangleShape2D covering coal pile region
- Set CoalPileArea collision layer to 4
- Set CoalPileArea collision mask to 2 (detects shovel)

**Size guidance:**
- Make rectangle slightly larger than visual coal pile
- Should fully contain the region where scooping is valid

### 2. Coal Piece Scene and Script

Create a reusable coal piece with physics properties.

**Create res://level1/coal_piece.tscn:**
- Root node: RigidBody2D
- Add CollisionShape2D child with CircleShape2D (radius: 10px)
- Add Polygon2D child for visual (black filled circle or lumpy polygon)

**Create res://level1/coal_piece.gd:**
```gdscript
extends RigidBody2D

const COAL_PHYSICS_MAT = preload("res://level1/coal_physics_material.tres")
const OFFSCREEN_THRESHOLD: float = 2000.0  # Distance from origin before cleanup
const MAX_LIFETIME: float = 30.0  # Seconds before forced cleanup

var lifetime: float = 0.0

func _ready():
    # Setup physics properties
    mass = 0.8
    gravity_scale = 1.0
    linear_damp = 0.8
    angular_damp = 1.5

    # Collision layers
    collision_layer = 3  # Coal on layer 3
    collision_mask = 7   # Binary 111 = collides with layers 1, 2, 3

    # Use shared physics material
    physics_material_override = COAL_PHYSICS_MAT

func _process(delta):
    lifetime += delta

    # Cleanup if too far from origin or too old
    if global_position.length() > OFFSCREEN_THRESHOLD or lifetime > MAX_LIFETIME:
        queue_free()
```

**Visual design:**
- Shape: Circle or slightly irregular polygon (6-8 sides for lumpy look)
- Color: Black (#000000) or very dark gray (#1a1a1a)
- Size: 10px radius (20px diameter)

**In coal_piece.tscn:**
- Attach coal_piece.gd script to root RigidBody2D
- Set CircleShape2D radius to 10

### 3. Scooping Mechanism

Detect when shovel exits coal pile with upward motion and spawn coal pieces.

**In furnace.gd:**
```gdscript
@onready var coal_pile_area: Area2D = $playarea/CoalPile/CoalPileArea
@onready var shovel: RigidBody2D = $playarea/Shovel

var coal_piece_scene = preload("res://level1/coal_piece.tscn")

# Scoop detection state
var shovel_was_in_pile: bool = false
var shovel_entry_position: Vector2 = Vector2.ZERO
var scoop_cooldown_timer: float = 0.0
var scoop_cooldown_duration: float = 0.4
var scoop_upward_threshold: float = 50.0  # Minimum Y delta for scoop (pixels)
var active_coal_count: int = 0
const MAX_COAL_PIECES: int = 100  # Performance limit

func _ready():
    # ... (previous setup code)

    # Connect coal pile area signals
    coal_pile_area.body_entered.connect(_on_coal_pile_entered)
    coal_pile_area.body_exited.connect(_on_coal_pile_exited)

func _process(delta):
    # Update scoop cooldown
    if scoop_cooldown_timer > 0.0:
        scoop_cooldown_timer -= delta

func _on_coal_pile_entered(body):
    if body == shovel:
        shovel_was_in_pile = true
        shovel_entry_position = shovel.global_position  # Capture entry point

func _on_coal_pile_exited(body):
    if body == shovel and shovel_was_in_pile and scoop_cooldown_timer <= 0.0:
        # Calculate upward movement (in Godot, Y increases downward)
        var y_delta = shovel_entry_position.y - shovel.global_position.y

        # Scoop if moving upward by at least threshold amount
        if y_delta >= scoop_upward_threshold:
            spawn_coal_at_shovel()
            scoop_cooldown_timer = scoop_cooldown_duration

        shovel_was_in_pile = false

func spawn_coal_at_shovel():
    # Enforce performance limit
    if active_coal_count >= MAX_COAL_PIECES:
        return

    # Spawn positions relative to shovel
    var spawn_offsets = [-30, -15, 0, 15, 30]

    for offset_x in spawn_offsets:
        if active_coal_count >= MAX_COAL_PIECES:
            break

        var coal = coal_piece_scene.instantiate()
        $playarea.add_child(coal)

        # Track active coal
        active_coal_count += 1
        coal.tree_exited.connect(_on_coal_destroyed)

        # Set position above shovel to prevent tunneling
        coal.global_position = shovel.global_position + Vector2(offset_x, -60)

func _on_coal_destroyed():
    active_coal_count -= 1
```

**Scoop detection logic:**
1. When shovel enters coal pile area: set flag and capture entry position
2. When shovel exits coal pile area:
   - Check if shovel was in pile
   - Check if cooldown has expired
   - Calculate Y delta: `entry_y - exit_y` (positive = upward motion)
   - If delta >= 50px upward, spawn coal and start cooldown
3. Clear flag after exit

**IMPORTANT:** Position is captured on entry, not tracked every frame. This prevents race conditions where signal callbacks might fire mid-frame and get inconsistent position data.

**Design values:**
- Coal pieces per scoop: 5
- Spawn offsets X: [-30, -15, 0, 15, 30]
- Spawn offset Y: -60px (above shovel, prevents tunneling)
- Scoop cooldown: 0.4 seconds
- Upward threshold: 50px (ensures deliberate scoop motion)
- Max active coal: 100 pieces (performance limit)
- Coal cleanup: 2000px from origin or 30s lifetime

**Why 50px threshold?**
Requires deliberate upward motion to trigger scoop, but not so high that it feels unresponsive. Original 100px may be too strict - start conservative and tune based on feel.

### 4. Coal Physics Tuning

Ensure coal behaves naturally - rests on shovel, falls off when moved fast.

**Physics Interaction:** Friction between `RigidBody2D` (coal) and `RigidBody2D` (shovel) works reliably in Godot. Coal should naturally stick to the shovel surface via friction and slide off when tilted or moved too fast.

**Physics property verification (in coal_piece.gd):**
- Mass: 0.8 (light but has weight)
- Gravity scale: 1.0 (normal gravity)
- Linear damp: 0.8 (helps settle quickly)
- Angular damp: 1.5 (reduces spinning)
- Friction: 0.7 (from coal_physics_material.tres)
- Bounce: 0.15 (from coal_physics_material.tres)

**Expected behavior:**
- Coal spawns above shovel and falls onto it due to gravity
- Friction between coal and shovel prevents immediate sliding
- When shovel moves slowly, coal stays on shovel
- When shovel moves quickly, coal's inertia overcomes friction and it slides off
- When shovel tilts (via left/right click), coal slides toward lower side
- More tilt = faster sliding - creates balancing skill challenge
- Coal pieces can rest against each other (friction prevents sliding apart)
- Damping makes coal settle into stable configurations quickly

---

## Testing Checklist

### Scene Setup Tests
- [ ] CoalPileArea exists as Area2D under CoalPile
- [ ] CoalPileArea has CollisionShape2D (RectangleShape2D)
- [ ] CoalPileArea collision layer is 4
- [ ] CoalPileArea collision mask is 2
- [ ] Shovel collision layer is 2
- [ ] Shovel collision mask includes layers 1 and 3
- [ ] CoalPileArea is large enough that fast mouse movement won't skip over it

### Coal Piece Tests
- [ ] Coal piece scene exists (coal_piece.tscn)
- [ ] Coal piece is RigidBody2D
- [ ] Coal has CircleShape2D collision (10px radius)
- [ ] Coal has visual representation (black circle/polygon)
- [ ] Coal uses shared coal_physics_material.tres
- [ ] Coal mass is 0.8
- [ ] Coal linear_damp is 0.8
- [ ] Coal angular_damp is 1.5
- [ ] Coal gravity_scale is 1.0
- [ ] Coal collision layer is 3
- [ ] Coal collision mask is 7 (layers 1, 2, 3)
- [ ] Coal cleanup works (offscreen and lifetime limits)
- [ ] Coal count decrements when coal is destroyed

### Scooping Mechanism Tests
- [ ] shovel_entry_position is captured when entering coal pile
- [ ] scoop_cooldown_timer decrements in _process()
- [ ] Shovel entering coal pile sets flag and captures position
- [ ] Shovel exiting coal pile checks scoop condition
- [ ] Upward motion >= 50px triggers scoop
- [ ] Downward or horizontal motion does NOT trigger scoop
- [ ] Small upward drift (<50px) does NOT trigger scoop
- [ ] Scoop spawns exactly 5 coal pieces (or less if at max limit)
- [ ] Coal pieces spawn at Y offset -60 (prevents tunneling)
- [ ] Coal pieces spawn at correct X positions relative to shovel
- [ ] Scoop cooldown prevents rapid spam (0.4s minimum between scoops)
- [ ] Max coal limit (100) is enforced
- [ ] active_coal_count increments/decrements correctly

### Physics Behavior Tests
- [ ] Coal falls onto shovel due to gravity
- [ ] Coal rests on shovel when shovel is stationary and level (friction working)
- [ ] Coal stays on shovel when moved slowly/moderately
- [ ] Coal slides off shovel when moved very fast
- [ ] Coal slides toward lower side when shovel is tilted
- [ ] More tilt = faster sliding (gravity component increases)
- [ ] Multiple coal pieces can stack/cluster on shovel
- [ ] Coal pieces resist sliding past each other (friction)
- [ ] Coal settles quickly (not bouncing endlessly)
- [ ] Coal doesn't spin excessively
- [ ] No attachment/detachment code exists (pure physics)
- [ ] Coal cleanup works - pieces far offscreen disappear
- [ ] Coal cleanup works - pieces older than 30s disappear

### Integration Tests
- [ ] Scoop coal from pile multiple times
- [ ] Move shovel slowly with coal - coal stays on
- [ ] Move shovel rapidly - coal falls off
- [ ] Tilt shovel (arc motion) - coal slides toward lower side
- [ ] Coal collides naturally with furnace obstacles
- [ ] No console errors during scooping/physics

---

## Files Modified

- `level1/furnace.gd` - Added scoop detection, position capture, coal spawning, and coal count tracking
- `level1/furnace.tscn` - Added CoalPileArea for scoop detection

## Files Created

- `level1/coal_piece.tscn` - Coal RigidBody2D scene
- `level1/coal_piece.gd` - Coal physics script with cleanup logic

## Files Referenced

- `level1/coal_physics_material.tres` - Created in Phase 2.2.1, used by coal pieces

---

## Troubleshooting

**Scoop not triggering:**
- Check CoalPileArea collision layer (should be 4) and mask (should be 2)
- Check Shovel collision layer (should be 2)
- Verify shovel_entry_position is captured in _on_coal_pile_entered
- Debug print y_delta in _on_coal_pile_exited to see actual values
- Threshold might be too high - temporarily lower to 20px for testing
- Area might be too small - shovel could skip over it with fast movement

**Coal tunnels through shovel:**
- Increase spawn Y offset (try -80 or -100)
- Check shovel collision mask includes layer 3
- Check coal collision layer is 3
- Reduce number of coal pieces spawned (physics can't handle too many simultaneous spawns)

**Coal too slippery (slides off immediately):**
- Increase friction in coal_physics_material.tres (try 0.8 or 0.9)
- Increase linear_damp on coal (try 1.0 or 1.2)
- Decrease coal mass (try 0.6 or 0.7)
- Check that shovel tilt isn't too extreme - tilt affects sliding

**Coal too sticky:**
- See "Balance Tuning Notes" section below

**Scooping happens on downward motion:**
- Check Y-delta calculation: `entry.y - exit.y` (NOT reversed)
- Remember: In Godot, Y increases downward

**Performance issues:**
- Check active_coal_count - should cap at 100
- Check coal cleanup - pieces should disappear when far offscreen
- Reduce MAX_COAL_PIECES if needed

---

## Manual Testing Guide

**Test 1: Basic Scoop**
1. Run furnace scene
2. Move mouse/shovel to coal pile (bottom-left)
3. Move mouse downward into pile, then quickly upward (at least 50px)
4. Expected: 5 coal pieces spawn on shovel
5. Note: Must be deliberate upward motion, not gentle drift

**Test 1b: Friction Verification**
1. Scoop coal
2. Hold mouse completely still and don't click (keep shovel level)
3. Expected: Coal should rest on shovel, not slide off
4. If coal slides off, friction values need tuning - see Troubleshooting

**Test 1c: Tilt Interaction**
1. Scoop coal
2. Click left mouse button to tilt shovel left
3. Expected: Coal slides toward right (lower) side of shovel
4. Click right mouse button to tilt shovel right
5. Expected: Coal slides toward left (lower) side of shovel

**Test 2: Cooldown**
1. Scoop coal (Test 1)
2. Immediately try to scoop again (within 0.4s)
3. Expected: No coal spawns (cooldown active)
4. Wait 0.5s and scoop again
5. Expected: Coal spawns (cooldown expired)

**Test 3: Slow Movement (Coal Stays)**
1. Scoop coal
2. Move shovel slowly toward furnace
3. Expected: Coal pieces stay clustered on shovel, may shift slightly but don't fall off

**Test 4: Fast Movement (Coal Falls)**
1. Scoop coal
2. Move shovel very rapidly in any direction
3. Expected: Coal pieces slide/roll off shovel naturally, fall due to gravity

**Test 5: Tilting**
1. Scoop coal
2. Move shovel in a circular arc (tilting effect)
3. Expected: Coal pieces slide toward the lower side of the tilted shovel

**Test 6: Multiple Scoops**
1. Scoop coal multiple times
2. Expected: Each scoop adds 5 more pieces, all interact with each other via physics
3. Continue scooping until 100+ pieces would exist
4. Expected: Spawning stops at 100 pieces total

**Test 6b: Coal Cleanup**
1. Scoop coal and throw it far offscreen
2. Expected: Coal disappears when >2000px from origin
3. Let coal sit for 30+ seconds
4. Expected: Coal disappears after lifetime expires

**Test 7: Furnace Collision**
1. Scoop coal
2. Move shovel into furnace obstacles (above/below opening)
3. Expected: Coal bounces off obstacles naturally

---

## Balance Tuning Notes

If coal behavior doesn't feel right, adjust these values:

**Coal too slippery (falls off too easily):**
- Increase friction in coal_physics_material.tres (try 0.8 or 0.9)
- Increase linear_damp (try 1.0 or 1.2)
- Decrease mass (try 0.6 or 0.7)

**Coal too sticky (never falls off):**
- Decrease friction (try 0.5 or 0.6)
- Decrease linear_damp (try 0.6 or 0.7)
- Increase mass (try 1.0 or 1.2)

**Coal bounces too much:**
- Decrease bounce in coal_physics_material.tres (try 0.05 or 0.1)
- Increase angular_damp (try 2.0 or 2.5)

**Coal spins too much:**
- Increase angular_damp (try 2.0 or 2.5)

**Scoop feels too slow/fast:**
- Adjust scoop_cooldown_duration (slower: 0.5-0.6s, faster: 0.2-0.3s)

---

## Notes

**Why spawn coal above shovel (without initial velocity)?**
- Ensures coal falls onto shovel naturally via gravity
- Physics engine handles the "landing" - no manual placement
- Creates slight settling motion that feels more realistic
- Y offset of -60px prevents tunneling through shovel on fast spawns
- No need for magic velocity numbers - gravity does the work

**Why pure physics instead of attachment?**
- More emergent gameplay - players discover optimal movement speed and tilt angle
- Feels more natural and satisfying
- Simpler code - no state management for attach/detach
- Friction and damping create the desired behavior automatically
- RigidBody2D-to-RigidBody2D friction works reliably
- Tilting mechanic creates natural sliding behavior via gravity components

**Why 5 coal pieces per scoop?**
- Enough to feel substantial
- Not so many that physics becomes chaotic
- Allows for some to fall off while others make it to furnace
- Tunable based on playtesting feedback

**Why 50px upward threshold?**
- 20px would trigger on accidental upward drift
- 50px ensures deliberate scooping motion
- Not so high that it feels unresponsive (100px may be too strict)
- Tune based on actual gameplay feel - start conservative

**Position tracking on entry, not every frame:**
- Prevents race conditions where signals fire mid-frame
- More predictable - Y delta is always from entry point to exit point
- Simpler code - no need to track position in _process()
- Signal ordering doesn't matter

**Performance limits:**
- 100 coal max prevents physics engine overload
- Cleanup by distance handles pieces thrown far away
- Cleanup by lifetime handles pieces stuck in corners
- active_coal_count tracking ensures accurate enforcement

**Shovel tilt affects gameplay:**
- Shovel can tilt +/- 45 degrees via left/right click
- Tilted shovel has gravity component perpendicular to surface
- Coal slides "downhill" on tilted shovel naturally
- Creates skill challenge: balance speed vs tilt angle
- Too much tilt = coal falls off, too little tilt = slower movement

**No coal tracking yet:**
- This phase only spawns coal, doesn't track it
- Phase 2.4 (coal tracking system) will add delivery/drop detection
- Keeps this phase focused on core physics behavior

**Next Phase**: Phase 2.4 will implement the tracking system to count dropped and delivered coal.
