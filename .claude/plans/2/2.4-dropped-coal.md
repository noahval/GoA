# Dropped Coal Tracking

**Goal**: Track coal pieces that leave the playarea boundary.

**Success Criteria**:
- Level1Vars has coal_dropped counter and DEBUG_COAL_TRACKING flag
- Border zones created programmatically with corner overlap
- Coal leaving playarea (entering border zone) increments coal_dropped
- Only coal group members trigger counter (group checking)
- All tracking is null-safe with error messages

## Overview

This phase adds tracking for coal that leaves the playarea. A 50px border zone surrounds the playarea on all sides (top, bottom, left, right). Borders are created programmatically and overlap at corners to prevent diagonal escapes. When coal enters any border zone, it's counted as dropped once and removed from the game. Coal pieces are identified using group membership checking. Simple Area2D detection - no velocity polling or timers needed.

**Dependencies:**
- Requires 2.x-physics-objects.md for PlayArea structure
- Requires 2.x-coal-physics-spawning.md for coal layer configuration
- Requires 1.x-responsive-layout.md for PlayArea dimensions

**Key Confirmations:**
- **Collision layers - CRITICAL**: Coal uses `collision_layer = 4` (Layer 3 in Godot's bitmask system where Layer 3 = 2^2 = 4, NOT 3!)
  - Border zones monitor with `collision_mask = 4` to detect Layer 3 objects
  - See 2.x-coal-physics-spawning.md for detailed bitmask explanation
- **PlayArea reference**: Confirmed in 1.x-responsive-layout.md - PlayArea is a Control node at $AspectContainer/MainContainer/mainarea/PlayArea with dynamic size property
- **Border thickness**: 50px is safe at any resolution as long as setup_border_zones() is called after ResponsiveLayout.apply_to_scene() establishes final dimensions
- **Coal preexistence**: No coal pieces exist in scene - all coal is spawned at runtime (confirmed in 2.x-coal-physics-spawning.md)
- **Resolution safety**: Border zones refresh on viewport changes (future: connect to ResponsiveLayout resize signal if needed)

---

## Implementation Tasks

### 1. Level1Vars Variable

Add dropped counter and debug flag to the Level1Vars autoload.

**Status:** coal_dropped ALREADY IMPLEMENTED in level1/level_1_vars.gd

**Existing code:**
```gdscript
# Coal tracking - gameplay stats
var coal_dropped: int = 0   # Total coal pieces that fell/were dropped
var coal_delivered: int = 0 # Total coal pieces successfully delivered to furnace
```

**Add debug flag:**
```gdscript
# Debug flags
var DEBUG_COAL_TRACKING: bool = false  # Toggle coal drop console prints
```

**Notes:**
- coal_dropped variable already exists and is saved/loaded
- DEBUG_COAL_TRACKING controls console spam during testing
- No reset function currently - can add if needed
- Null-safe access in coal_piece.gd (check if Level1Vars exists)

### 2. Border Zones (Drop Detection)

Create 4 Area2D border zones programmatically, positioned 50px outside the playarea on each side. Borders overlap at corners to prevent diagonal escapes. When coal enters any border, count as dropped and remove.

**In furnace.tscn:**
- Add empty Node2D named "BorderZones" under PlayArea

**In furnace.gd:**
```gdscript
const BORDER_THICKNESS: float = 50.0  # Border zone thickness in pixels

@onready var border_zones: Node2D = $AspectContainer/MainContainer/mainarea/PlayArea/BorderZones

func setup_physics_objects():
    # ... (existing setup code)

    # Setup border zones at end of function
    setup_border_zones()

func setup_border_zones():
    if not border_zones:
        push_error("BorderZones node not found in scene")
        return

    var playarea_size = playarea.size

    # Offset left border to accommodate off-screen coal container
    # Coal spawns at -60px (offscreen_extension), so left border must be further left
    var left_border_offset = 80.0  # Push left border this far past playarea edge

    # Create borders programmatically (overlapping at corners to prevent gaps)
    var border_configs = [
        {
            "name": "TopBorder",
            "pos": Vector2(playarea_size.x / 2, -BORDER_THICKNESS / 2),
            "size": Vector2(playarea_size.x + BORDER_THICKNESS * 2 + left_border_offset, BORDER_THICKNESS)
        },
        {
            "name": "BottomBorder",
            "pos": Vector2(playarea_size.x / 2, playarea_size.y + BORDER_THICKNESS / 2),
            "size": Vector2(playarea_size.x + BORDER_THICKNESS * 2 + left_border_offset, BORDER_THICKNESS)
        },
        {
            "name": "LeftBorder",
            "pos": Vector2(-left_border_offset - BORDER_THICKNESS / 2, playarea_size.y / 2),
            "size": Vector2(BORDER_THICKNESS, playarea_size.y + BORDER_THICKNESS * 2)
        },
        {
            "name": "RightBorder",
            "pos": Vector2(playarea_size.x + BORDER_THICKNESS / 2, playarea_size.y / 2),
            "size": Vector2(BORDER_THICKNESS, playarea_size.y + BORDER_THICKNESS * 2)
        }
    ]

    for config in border_configs:
        var area = Area2D.new()
        area.name = config.name
        area.monitoring = true
        area.monitorable = false
        area.collision_layer = 0
        area.collision_mask = 4  # Layer 3 (coal) = 2^2 = 4

        var shape = CollisionShape2D.new()
        var rect = RectangleShape2D.new()
        rect.size = config.size
        shape.shape = rect
        shape.position = config.pos

        area.add_child(shape)
        border_zones.add_child(area)
        area.body_entered.connect(_on_coal_entered_border)

func _on_coal_entered_border(body: Node2D):
    # Check if it's a coal piece using group membership
    if body.is_in_group("coal"):
        body._on_entered_drop_zone()
```

**IMPORTANT - Left Border Offset:** The coal container extends 60px off-screen to the left (see 2.3-coal-spawning.md). The left border must be pushed further left (80px offset) to avoid triggering drop detection when coal spawns in the off-screen container area.

### 3. Coal Drop Tracking

Add coal to "coal" group and implement drop zone handler. Called by border zone signal.

**In coal_piece.gd _ready():**
```gdscript
func _ready():
    # Add to coal group for border detection
    add_to_group("coal")

    # ... (existing physics setup)
```

**In coal_piece.gd (add after _ready):**
```gdscript
# Called by border zone Area2D when coal enters drop zone
func _on_entered_drop_zone():
    # Track as dropped
    if Level1Vars:
        Level1Vars.coal_dropped += 1
        if Level1Vars.DEBUG_COAL_TRACKING:
            print("[COAL] Dropped! Total: ", Level1Vars.coal_dropped)

    queue_free()  # Remove immediately
```

**Notes:**
- No velocity polling needed
- No settle timers
- No furnace position tracking
- Instant detection and cleanup when entering border
- Group membership check prevents non-coal objects from triggering counter
- Debug print controlled by Level1Vars.DEBUG_COAL_TRACKING flag

---

## Testing Checklist

### Level1Vars Tests
- [ ] Level1Vars.coal_dropped exists and initializes to 0
- [ ] coal_dropped persists across save/load

### Border Zone Tests
- [ ] BorderZones empty Node2D exists in scene
- [ ] 4 border zones created programmatically: TopBorder, BottomBorder, LeftBorder, RightBorder
- [ ] Border zones positioned 50px outside playarea on all sides
- [ ] Border zones use collision_mask = 4 (Layer 3 detection)
- [ ] Coal uses collision_layer = 4 (Layer 3, NOT 3!)
- [ ] Top/Bottom borders extend BORDER_THICKNESS past left/right edges (overlap at corners)
- [ ] Left/Right borders extend BORDER_THICKNESS past top/bottom edges (overlap at corners)
- [ ] Coal entering top border triggers _on_coal_entered_border
- [ ] Coal entering bottom border triggers _on_coal_entered_border
- [ ] Coal entering left border triggers _on_coal_entered_border
- [ ] Coal entering right border triggers _on_coal_entered_border
- [ ] Coal traveling diagonally at corner gets caught (no gap)

### Drop Tracking Tests
- [ ] Coal is added to "coal" group in _ready()
- [ ] Coal entering border increments coal_dropped
- [ ] Coal entering border calls queue_free
- [ ] Non-coal objects entering border do NOT increment counter
- [ ] Console prints "[COAL] Dropped! Total: X" when DEBUG_COAL_TRACKING = true
- [ ] Console does NOT print when DEBUG_COAL_TRACKING = false

### Double-Tracking Prevention Tests
- [ ] Coal delivered cannot subsequently be counted as dropped (see 2.6-delivered-coal.md)

### Null-Safety Tests
- [ ] Coal tracking doesn't crash if Level1Vars is null
- [ ] Code uses `if Level1Vars:` before accessing properties

---

## Integration Testing Guide

**Test 1: Coal Leaving Top Border**
1. Reset counter: `Level1Vars.coal_dropped = 0`
2. Move coal upward off screen
3. Expected:
   - Console prints "[COAL] Dropped! Total: 1"
   - coal_dropped = 1
   - Coal disappears immediately

**Test 2: Coal Leaving Bottom Border**
1. Reset counter
2. Let coal fall down off screen
3. Expected:
   - coal_dropped increments
   - Coal disappears

**Test 3: Coal Leaving Left Border**
1. Reset counter
2. Push coal left off screen
3. Expected:
   - coal_dropped increments
   - Coal disappears

**Test 4: Coal Leaving Right Border**
1. Reset counter
2. Push coal right off screen (past furnace wall)
3. Expected:
   - coal_dropped increments
   - Coal disappears

**Test 5: Multiple Coal Drops**
1. Reset counter
2. Let 5 coal pieces fall off different edges
3. Expected:
   - coal_dropped = 5
   - Each piece counted exactly once

**Test 6: Coal Staying in Playarea**
1. Reset counter
2. Keep coal within playarea bounds
3. Expected:
   - coal_dropped = 0 (no increment)

**Test 7: Diagonal Corner Escape (Critical Bug Test)**
1. Reset counter
2. Launch coal diagonally toward top-left corner at high speed
3. Repeat for all 4 corners (top-left, top-right, bottom-left, bottom-right)
4. Expected:
   - Coal is caught by overlapping borders at corners
   - coal_dropped increments for each corner escape
   - No coal escapes uncounted through corner gaps

---

## Files Modified

- `level1/level_1_vars.gd` - Variable already exists; add DEBUG_COAL_TRACKING flag
- `level1/furnace.gd` - Add programmatic border zones creation and _on_coal_entered_border handler
- `level1/furnace.tscn` - Add empty BorderZones Node2D under PlayArea
- `level1/coal_piece.gd` - Add to "coal" group and implement _on_entered_drop_zone method

---

## Debug Helpers

**Print tracking to console:**
```gdscript
# In level_1_vars.gd, set to true:
var DEBUG_COAL_TRACKING: bool = true  # Enables coal drop console logs
```

**Verify collision layer configuration:**
```gdscript
# In coal_piece.gd _ready(), add temporary debug print:
print("Coal collision_layer: ", collision_layer)  # Should print 4, NOT 3!
print("Coal collision_mask: ", collision_mask)    # Should print 7

# In furnace.gd setup_border_zones(), add debug print:
for config in border_configs:
    var area = Area2D.new()
    # ... (setup code)
    print("Border ", config.name, " collision_mask: ", area.collision_mask)  # Should print 4
```

**Display counter on screen (optional temporary UI):**
```gdscript
# In furnace.gd, add Label node and update in _process():
func _process(_delta):
    if Level1Vars:
        $DebugLabel.text = "Dropped: %d" % Level1Vars.coal_dropped
```

**Visualize border zones (optional for debugging):**
```gdscript
# In furnace.gd setup_border_zones(), after creating each border:
for config in border_configs:
    # ... (create area and shape)

    # Add debug visualization
    var debug_rect = ColorRect.new()
    debug_rect.color = Color(1, 0, 0, 0.2)  # Red transparent
    debug_rect.position = config.pos - config.size / 2
    debug_rect.size = config.size
    area.add_child(debug_rect)
```

---

## Troubleshooting

**Coal not being detected by border zones (counter not incrementing):**
- **MOST COMMON**: Verify coal `collision_layer = 4` (NOT 3!)
  - Layer 3 in Godot = bit position 2 = 2^2 = 4
  - Setting `collision_layer = 3` puts coal on layers 1 AND 2 (binary 011)
  - Debug print coal.collision_layer - should be 4
- Verify border zones `collision_mask = 4`
- Check coal is in "coal" group: `print(coal.is_in_group("coal"))`
- Enable DEBUG_COAL_TRACKING to see if drop handler is called
- Check border zones were created: `print(border_zones.get_child_count())` - should be 4

**Coal not despawning after leaving playarea:**
- Verify `queue_free()` is called in `_on_entered_drop_zone()`
- Check for null errors in console
- Verify `_on_coal_destroyed()` signal is connected (decrements active_coal_count)

**Border zones detecting non-coal objects:**
- Verify `is_in_group("coal")` check in `_on_coal_entered_border()`
- Only objects in "coal" group should trigger counter

**Coal escaping through corners:**
- Verify borders overlap at corners (Top/Bottom extend ±BORDER_THICKNESS in X, Left/Right extend ±BORDER_THICKNESS in Y)
- Check border sizes in setup_border_zones() match plan
- Add debug visualization to see border zones (see Debug Helpers)

---

## Notes

**Why border zones instead of velocity/position polling?**
- Much simpler - no timers, no velocity checks, no position tracking
- Instant detection when coal leaves playarea
- No false positives from bouncing coal
- Uses Godot's built-in Area2D body_entered signal
- Cleaner separation: playarea = safe, border = dropped

**CRITICAL - Collision Layer Bitmask (collision_mask = 4):**
- Godot's collision system uses bit positions, NOT sequential numbers
- Layer 1 = bit 0 = 2^0 = value 1
- Layer 2 = bit 1 = 2^1 = value 2
- Layer 3 = bit 2 = 2^2 = value 4 (NOT 3!)
- Border zones use `collision_mask = 4` to detect Layer 3 objects (coal)
- Coal must use `collision_layer = 4` to be on Layer 3
- **Common mistake**: Setting `collision_layer = 3` puts objects on Layers 1 AND 2 (binary 011), not Layer 3
- See 2.x-coal-physics-spawning.md for complete bitmask reference

**Why 50px border thickness?**
- Ensures coal is fully offscreen before removal
- Large enough to catch fast-moving coal
- Can be adjusted if needed (thicker = more forgiving, thinner = tighter)
- **CRITICAL**: Safe at any resolution since setup_border_zones() calculates AFTER ResponsiveLayout.apply_to_scene() establishes PlayArea size
- Border dimensions are calculated from playarea.size which is set by ResponsiveLayout based on current viewport
- If viewport changes, furnace.gd should call setup_border_zones() again to refresh (future enhancement: connect to ResponsiveLayout resize signal)

**Why 80px left border offset?**
- Coal container extends 60px off-screen to the left (for off-screen spawning)
- Coal spawns in this off-screen area and rolls into view
- Left border must be pushed past this spawn area (80px > 60px) to avoid false drops
- Top/bottom borders also extended to maintain corner overlap with the offset left border

**Why immediate removal instead of delay?**
- Coal is already offscreen - player can't see it anyway
- No need for visual feedback when coal is invisible
- Cleaner performance - less objects in memory
- If we want delay, can add `get_tree().create_timer(0.5).timeout.connect(queue_free)`

**Border zone as "hollow rectangle":**
- 4 separate Area2D nodes form a "picture frame" around playarea
- Center (playarea) has no detection - coal moves freely
- Leaving any edge triggers drop detection
- Borders overlap at corners by BORDER_THICKNESS to prevent diagonal escapes
- Created programmatically to eliminate manual scene setup errors

**Why programmatic border creation?**
- Eliminates manual scene setup (no "TopBorder" naming errors)
- Self-contained - all logic in one place
- Easier to modify dimensions or add borders
- Null-safe with clear error messages
- Borders guaranteed to overlap at corners

**Why group checking instead of method checking?**
- `is_in_group("coal")` is more explicit than `has_method("_on_entered_drop_zone")`
- Prevents accidental triggering by unrelated objects
- Groups are intended for type identification in Godot
- More maintainable - method names can change, groups are semantic
- **Coal preexistence**: All coal is spawned at runtime (see 2.x-coal-physics-spawning.md), so adding to group in _ready() catches all coal pieces
- No need to update scene files - coal_piece.tscn instances automatically join "coal" group when instantiated

**Next Phase**: See 2.6-delivered-coal.md for delivery tracking.
