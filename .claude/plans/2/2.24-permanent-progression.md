# Permanent Progression

**Goal**: Long-term advancement through stats, equipment, and purse gating.

**Success Criteria**: Persistent progression feels meaningful over 10+ days

**Prerequisites**: Phase 2.1 complete

---

## Implementation Tasks

### 1. Equipment System Foundation
- Create `res://autoloads/equipment_manager.gd` (autoload)
- Equipment data structure:
  ```gdscript
  var equipment = {
      "shovel_head": "basic",    # basic, iron, steel, quality, master
      "shovel_shaft": "wooden",  # wooden, ash, hickory, reinforced
      "shovel_handle": "basic",  # basic, wrapped, ergonomic, master
      "gloves": "none",          # none, cloth, leather, padded
      "boots": "old"             # old, work, steel_toe, comfort
  }
  ```
- Equipment effects on RunState (stamina costs, spill chance, stability)

### 2. Modular Shovel Components

#### Shovel Heads (Capacity)
- Basic (1 coal, free)
- Iron (2 coal, 20c)
- Steel (3 coal, 50c)
- Quality (4 coal, 120c)
- Master (5 coal, 300c)

#### Shovel Shafts (Stamina + Stability)
- Wooden (0% benefit, free)
- Ash (-10% stamina, +10% stability, 15c)
- Hickory (-15% stamina, +20% stability, 40c)
- Reinforced (-25% stamina, +35% stability, 100c)

#### Shovel Handles (Stamina + Lactic Acid)
- Basic (free)
- Wrapped (-10% stamina, -15% lactic, 18c)
- Ergonomic (-15% stamina, -30% lactic, 45c)
- Master (-25% stamina, -50% lactic, 110c)

### 3. Other Equipment

#### Gloves (Stamina vs. Precision Tradeoff)
- Bare Hands (0% stamina, 0% precision loss, free)
- Cloth (+10% stamina, -5% precision, 12c)
- Leather (+20% stamina, -10% precision, 35c)
- Padded (+35% stamina, -20% precision, 80c)

#### Boots (Stamina Drain + Max Safe Drag Speed)
- Old Shoes (free)
- Work Boots (-10% stamina, +10% speed, 15c)
- Steel-toe (-15% stamina, +20% speed, 40c)
- Comfort (-25% stamina, +35% speed, 95c)

### 4. Purse Gating System
- Torn Pocket (150c cap, free)
- Small Pouch (300c cap, costs 135c) - ~90% of cap
- Leather Purse (500c cap, costs 285c)
- Sturdy Purse (700c cap, costs 650c)
- Money Belt (900c cap, costs 850c)
- Secure Pouch (1100c cap, costs 1050c)
- Lockbox (1400c cap, costs 1350c)

**Cap enforcement**:
- Cannot earn more copper in a shift than purse space allows
- Must purchase purse upgrade to progress
- Warning at 90% capacity

### 5. Equipment Shop UI
- Extend `evening.tscn` with equipment shop panel
- Category tabs: Shovel, Accessories, Purse
- Display current equipment + available upgrades
- Show stat effects (stamina reduction, spill chance, etc.)
- Purchase button (disabled if insufficient copper or owned)

### 6. Consumables Expanded
Add to evening shop:
- Murky Water (1c): +20 stamina next shift
- Stale Bread (1c): +20 focus next shift
- Weak Coffee (2c): +15 focus next shift
- Better Bread (3c): +30 stamina next shift
- Chalk (3c): -10% spill chance next shift only
- Pain Tonic (4c): -30% lactic acid buildup next shift

### 7. Stat Effects Integration
- **Constitution**: Max stamina = 100 + (20 * constitution_level)
- **Wisdom**: Max focus = 100 + (20 * wisdom_level)
- **Strength**: Stamina per shovel = 5 - (0.1 * strength_level)
- **Dexterity**: Base spill chance = 10% - (1% * dexterity_level)
- **Intelligence**: (No direct effect yet, reserved for Phase 2.3)

**New XP earning**:
- **Constitution XP**: +1 when stamina < 30% and you shovel
- **Wisdom XP**: +1 per efficient action (break at right time, good purchase, etc.)

### 8. Zone-Out System (Muscle Memory Progression)

**Purpose**: Permanent action-based automation unlocked through repetitive labor

Add to `Global.gd`:
```gdscript
var shovel_repetitions = 0  # Lifetime shovels (persists forever)
```

#### Repetition Tracking
- Increments on every successful manual shovel (coal reaches furnace)
- Never decreases, never resets
- Displayed in UI: "Shovels: 3,847" (small, unobtrusive)

#### Zone-Out Mechanic
**NOT time-based** - triggers after manual actions:
- After each manual shovel: Roll for auto-shovel
- Auto-shovel uses same drag path, slightly faster animation
- Auto-shovel costs 75% stamina (worse than manual 100%)
- Auto-shovel costs 0 focus
- Auto-shovel has 50% reduced spill chance

#### Three Progressive Paths

**Path 1: RHYTHM (DEX-focused)**
*"Your hands move without thought."*

| Repetitions | Effect | Benefit |
|-------------|--------|---------|
| 500 | Rhythm I | +5% auto-shovel chance |
| 2,000 | Rhythm II | +5% auto-shovel chance, DEX reduces auto-shovel spill by 2% per level |
| 5,000 | Rhythm III | +5% auto-shovel chance, auto-shovels 15% faster animation |

**Path 2: ENDURANCE (CON-focused)**
*"You can do this forever."*

| Repetitions | Effect | Benefit |
|-------------|--------|---------|
| 750 | Endurance I | +5% auto-shovel chance |
| 3,000 | Endurance II | +5% auto-shovel chance, auto-shovel costs 60% stamina (vs 75%) |
| 7,500 | Endurance III | +5% auto-shovel chance, CON reduces auto-shovel stamina cost by 2% per level |

**Path 3: DISSOCIATION (WIS-focused)**
*"You are no longer required."*

| Repetitions | Effect | Benefit |
|-------------|--------|---------|
| 1,000 | Dissociation I | +5% auto-shovel chance |
| 4,000 | Dissociation II | +5% auto-shovel chance, 10% chance auto-shovel chains (triggers another auto) |
| 10,000 | Dissociation III | +5% auto-shovel chance, chain chance = 15% + (WIS * 2%) |

#### Total Permanent Progression
- Maximum: 45% auto-shovel chance (15% per path Ã— 3 paths)
- Unlocked over ~15-20 hours of play
- All paths unlock automatically (no choices)
- Stacks with technique-based zone-out bonuses (Phase 2.3)

#### Implementation
```gdscript
# In Global.gd
func get_zone_out_chance() -> float:
    var chance = 0.0

    # Rhythm path
    if shovel_repetitions >= 500: chance += 0.05
    if shovel_repetitions >= 2000: chance += 0.05
    if shovel_repetitions >= 5000: chance += 0.05

    # Endurance path
    if shovel_repetitions >= 750: chance += 0.05
    if shovel_repetitions >= 3000: chance += 0.05
    if shovel_repetitions >= 7500: chance += 0.05

    # Dissociation path
    if shovel_repetitions >= 1000: chance += 0.05
    if shovel_repetitions >= 4000: chance += 0.05
    if shovel_repetitions >= 10000: chance += 0.05

    return chance

func get_auto_shovel_stamina_mult() -> float:
    var mult = 0.75  # Base 75% cost

    # Endurance II/III effects
    if shovel_repetitions >= 3000:
        mult = 0.60
    if shovel_repetitions >= 7500:
        mult -= constitution * 0.02

    return max(0.25, mult)  # Min 25% cost

func get_auto_shovel_chain_chance() -> float:
    if shovel_repetitions < 4000:
        return 0.0

    var chance = 0.10
    if shovel_repetitions >= 10000:
        chance = 0.15 + (wisdom * 0.02)

    return chance
```

#### UI Requirements
- Small counter in furnace scene: "Shovels: X,XXX"
- Optional flavor text on tier unlocks (like equipment purchase)
- NO detailed breakdown or progress bars
- Auto-shovel visual: Slightly transparent shovel sprite, faster movement

#### Thematic Fit
- Muscle memory developing over time
- Becoming more efficient through repetition
- Body works while mind wanders
- Grimdark: Dehumanization through repetitive labor
- Complements (not replaces) active gameplay

---

### 9. Multi-Day Progression Loop
- Save persistent stats (Global.gd) after each day
- Save equipment (EquipmentManager) after each day
- Save copper (Global.gd) after each day
- **Save shovel_repetitions (Global.gd)** - never resets
- Reset run state (RunState.gd) each morning
- Apply equipment effects at day start

---

## TDD Requirements (Headless Tests)

Create `tests/test_phase_2_2.gd`:

```gdscript
# Test: Equipment affects stamina costs
func test_equipment_stamina_reduction():
    EquipmentManager.equipment.shovel_shaft = "ash"  # -10% stamina
    var cost = calculate_shovel_stamina_cost()
    assert_eq(cost, 4.5)  # 5 * 0.9 = 4.5

# Test: Purse cap enforcement
func test_purse_cap_enforcement():
    Global.copper = 140
    EquipmentManager.equipment.purse = "torn_pocket"  # 150 cap
    var can_earn = can_earn_copper(15)
    assert_false(can_earn)  # Would exceed cap

# Test: Shovel head increases capacity
func test_shovel_head_capacity():
    EquipmentManager.equipment.shovel_head = "iron"  # 2 capacity
    var capacity = get_shovel_capacity()
    assert_eq(capacity, 2)

# Test: Constitution increases max stamina
func test_constitution_max_stamina():
    Global.constitution = 3
    var max_stamina = calculate_max_stamina()
    assert_eq(max_stamina, 160)  # 100 + (20 * 3)

# Test: Consumable effects apply next day
func test_consumable_effects():
    purchase_consumable("murky_water")  # +20 stamina
    start_new_day()
    assert_eq(RunState.stamina, 120)  # 100 + 20 from consumable

# Test: Equipment persistence across days
func test_equipment_persistence():
    purchase_equipment("shovel_head", "iron")
    save_and_load()
    assert_eq(EquipmentManager.equipment.shovel_head, "iron")

# Test: Zone-out chance increases with repetitions
func test_zone_out_progression():
    Global.shovel_repetitions = 500
    var chance = Global.get_zone_out_chance()
    assert_eq(chance, 0.05)  # Rhythm I only

    Global.shovel_repetitions = 5000
    chance = Global.get_zone_out_chance()
    assert_eq(chance, 0.25)  # Multiple paths unlocked

# Test: Auto-shovel triggers after manual shovel
func test_auto_shovel_trigger():
    Global.shovel_repetitions = 1000  # 15% chance
    var triggered = false
    for i in range(100):  # Test many times
        if check_auto_shovel_trigger():
            triggered = true
            break
    assert_true(triggered)

# Test: Auto-shovel stamina cost
func test_auto_shovel_stamina_cost():
    Global.shovel_repetitions = 1000
    var base_cost = 5.0
    var auto_cost = base_cost * Global.get_auto_shovel_stamina_mult()
    assert_eq(auto_cost, 3.75)  # 75% of base

# Test: Shovel repetitions persist
func test_repetitions_persistence():
    Global.shovel_repetitions = 5000
    save_and_load()
    assert_eq(Global.shovel_repetitions, 5000)
```

---

## Manual Test Criteria

- [ ] Play 10 days, verify stats leveling feels meaningful
- [ ] Purchase first equipment upgrade (~Day 5-7), see effect
- [ ] Hit purse cap, forced to upgrade purse to progress
- [ ] Constitution/Wisdom levelups increase stamina/focus bars visibly
- [ ] Consumables bought in evening apply next day
- [ ] Equipment shop shows accurate costs and effects
- [ ] Save/load preserves equipment and copper
- [ ] Auto-shovels start occurring after 500 repetitions (~1-2 hours)
- [ ] Auto-shovel animation visibly different (faster, semi-transparent)
- [ ] Notice stamina efficiency improving with Endurance path
- [ ] Witness auto-shovel chains at Dissociation II (4,000+ reps)
- [ ] Repetition counter persists across save/load

---

## Files to Create

- `res://autoloads/equipment_manager.gd`
- `res://tests/test_phase_2_2.gd`
- `res://ui/equipment_shop_panel.tscn` (reusable component)

## Files to Modify

- `res://level1/evening.gd`: Add equipment shop integration
- `res://level1/evening.tscn`: Add equipment UI panels
- `res://level1/furnace_work.gd`: Apply equipment effects to calculations
- `res://autoloads/run_state.gd`: Add consumable effect tracking
- `global.gd`: Extend save/load for EquipmentManager
- `project.godot`: Add EquipmentManager autoload

---

## Design Values (Reference)

### Target Progression Timeline
- Day 5: 5-8c (can afford first permanent upgrade)
- Day 10: 12-18c
- Day 15: 25-35c (2nd purse upgrade)

### Equipment Costs
- Tier 1 (free): Basic shovel, bare hands, old shoes
- Tier 2 (12-20c): Ash shaft, cloth gloves, work boots, iron head
- Tier 3 (35-50c): Hickory shaft, leather gloves, steel-toe boots, steel head
- Tier 4 (80-120c): Ergonomic handle, padded gloves, comfort boots, quality head

### Purse Progression
Each purse costs ~90-95% of new capacity, forcing strategic saving.
