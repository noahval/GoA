# Furnace Progress Bars

**Goal**: Add visual progress bars to the furnace scene menu to track stamina (green) and focus (blue) resources in real-time

**Success Criteria**:
- Two progress bars visible in furnace scene menu
- Stamina bar displays current/max stamina in green
- Focus bar displays current/max focus in blue
- Bars update automatically when stats change via signals
- Bars follow theme design guidelines from [1.9-default-theme.md](../1/1.9-default-theme.md)

## Overview

The furnace scene currently has no visual feedback for stamina and focus consumption. Players need to see their resource levels while performing physical (stamina) and mental (focus) actions. This feature adds two horizontal progress bars to the existing Menu area in the furnace scene, connected to the Level1Vars autoload signals for automatic updates.

### Key Design Principles

- Use ProgressBar template from [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar) (lines 316-333)
- Use named progress bars from [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar-variables):
  - "stamina" (yellow-green) - already defined
  - "focus" (light blue) - already defined
- Use signal-based updates (no polling) for performance
- Positioned in Menu VBoxContainer per [1.10-responsive-layout.md](../1/1.10-responsive-layout.md#layout-structure) (vertically stacked)

---

## Implementation Tasks

### 1. Add ProgressBar Nodes to Furnace Scene

Open [furnace.tscn](../../game/v0.1/level1/furnace.tscn) in Godot Editor:

**Scene tree structure:**
```
AspectContainer/MainContainer/mainarea/Menu/
  -> StaminaBar (ProgressBar)
  -> FocusBar (ProgressBar)
  -> ToMindButton (existing)
```

**Node setup:**
1. Navigate to `Menu` node in scene tree (VBoxContainer per [1.10-responsive-layout.md](../1/1.10-responsive-layout.md))
2. Add child node: `ProgressBar`, rename to `StaminaBar`
3. Add child node: `ProgressBar`, rename to `FocusBar`
4. Bars will automatically stack vertically in VBoxContainer above navigation buttons

**ProgressBar properties (set in Inspector):**
- **Min Value**: 0
- **Max Value**: 100 (will be updated dynamically)
- **Value**: 50 (will be updated dynamically)
- **Show Percentage**: false (we'll use custom labels if needed)
- **Size**: Width fills Menu VBoxContainer, height ~20px (scaled with resolution)

### 2. Style Progress Bars According to Theme

Apply ProgressBar template structure from [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar) (lines 316-333):

**StaminaBar styling:**
- Follow template structure (background, border, corner_radius)
- Use `progress_bars["stamina"]` fill color: `Color(0.2, 0.9, 0.3, 0.3)` - yellow-green, 30% opacity
- Reference: [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar-variables) lines 356-360

**FocusBar styling:**
- Follow template structure (background, border, corner_radius)
- Use `progress_bars["focus"]` fill color: `Color(0.3, 0.6, 1, 0.3)` - light blue, 30% opacity
- Reference: [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar-variables) lines 380-384

**Implementation:**
1. In Inspector -> Theme Overrides -> Styles -> Background: Create StyleBoxFlat
   - `bg_color = Color(0.2, 0.2, 0.2, 0)` (transparent dark grey)
   - `border_width = 1`, `border_color = Color(0.3, 0.3, 0.3, 0.5)`
   - `corner_radius = 2` (all corners)
2. In Inspector -> Theme Overrides -> Styles -> Fill: Create StyleBoxFlat
   - StaminaBar: Use stamina fill color from above
   - FocusBar: Use focus fill color from above
   - `corner_radius = 2` (all corners)

### 3. Connect Signal Handlers in furnace.gd

Add signal connections and update handlers to [furnace.gd](../../game/v0.1/level1/furnace.gd):

**Variables needed:**
```gdscript
# In furnace.gd
@onready var stamina_bar: ProgressBar = $AspectContainer/MainContainer/mainarea/Menu/StaminaBar
@onready var focus_bar: ProgressBar = $AspectContainer/MainContainer/mainarea/Menu/FocusBar
```

**Connect signals in _ready():**
```gdscript
func _ready():
	ResponsiveLayout.apply_to_scene(self)  # REQUIRED (existing)
	connect_navigation()  # Existing

	# Connect resource signals from level_1_vars
	connect_resource_bars()

	# Defer physics setup until after layout is applied
	await get_tree().process_frame
	setup_physics_objects()

func connect_resource_bars():
	# Connect to Level1Vars signals
	Level1Vars.stamina_changed.connect(_on_stamina_changed)
	Level1Vars.focus_changed.connect(_on_focus_changed)

	# Initialize bars with current values
	_on_stamina_changed(Level1Vars.stamina, Level1Vars.stamina_max)
	_on_focus_changed(Level1Vars.focus, Level1Vars.focus_max)

func _on_stamina_changed(new_value: int, max_value: int):
	stamina_bar.max_value = max_value
	stamina_bar.value = new_value

func _on_focus_changed(new_value: int, max_value: int):
	focus_bar.max_value = max_value
	focus_bar.value = new_value
```

**Implementation details:**
- Signals are already defined in [level_1_vars.gd:35-36](../../game/v0.1/level1/level_1_vars.gd#L35-L36)
- `stamina_changed` and `focus_changed` emit (new_value, max_value)
- Bars automatically update when `modify_stamina()` or `modify_focus()` are called
- Initial values set on scene load to display current state
- **Note**: The autoload is named `Level1Vars` (not `level_1_vars`) per project.godot

### 4. Add Optional Labels (Future Enhancement)

Consider adding Label nodes to display numeric values:

**Structure:**
```
StaminaBar
  -> StaminaLabel (Label) - "Stamina: 50/100"
FocusBar
  -> FocusLabel (Label) - "Focus: 50/100"
```

**Implementation (optional):**
```gdscript
@onready var stamina_label: Label = $AspectContainer/MainContainer/mainarea/Menu/StaminaBar/StaminaLabel
@onready var focus_label: Label = $AspectContainer/MainContainer/mainarea/Menu/FocusBar/FocusLabel

func _on_stamina_changed(new_value: int, max_value: int):
	stamina_bar.max_value = max_value
	stamina_bar.value = new_value
	stamina_label.text = "Stamina: %d/%d" % [new_value, max_value]

func _on_focus_changed(new_value: int, max_value: int):
	focus_bar.max_value = max_value
	focus_bar.value = new_value
	focus_label.text = "Focus: %d/%d" % [new_value, max_value]
```

**Note**: Labels are optional. Start with visual bars only, add labels if players request numeric feedback.

---

## Code Examples

### Complete Signal Flow

**How bars update when stamina is consumed:**

```gdscript
# Somewhere in game logic (e.g., when shoveling coal):
Level1Vars.modify_stamina(-5)  # Consume 5 stamina

# Inside level_1_vars.gd (existing code):
func modify_stamina(amount: int) -> bool:
    stamina = clampi(stamina + amount, 0, stamina_max)
    emit_signal("stamina_changed", stamina, stamina_max)  # Signal emitted
    return true

# Inside furnace.gd (new code):
func _on_stamina_changed(new_value: int, max_value: int):
    stamina_bar.max_value = max_value  # Update bar capacity
    stamina_bar.value = new_value      # Update bar fill
```

**Result**: Bar automatically updates without polling or manual refresh.

---

## Testing Strategy

### Manual Test Criteria

**Visual appearance:**
- [ ] StaminaBar visible in furnace scene Menu area
- [ ] FocusBar visible in furnace scene Menu area
- [ ] StaminaBar fill is yellow-green color (matches theme)
- [ ] FocusBar fill is light blue color (matches theme)
- [ ] Both bars have transparent background with subtle border
- [ ] Corner radius is 2px (rounded corners)
- [ ] Bars are approximately 20px height
- [ ] Bars positioned clearly, not overlapping navigation buttons

**Functionality:**
- [ ] Both bars display correct initial values on scene load (50/100)
- [ ] StaminaBar updates when `Level1Vars.modify_stamina()` is called
- [ ] FocusBar updates when `Level1Vars.modify_focus()` is called
- [ ] Bars correctly handle max value changes (e.g., stamina_max increases)
- [ ] Bars clamp at 0 (empty) and max value (full)
- [ ] No console errors on scene load

**Interactive testing:**
- [ ] Open Debug Console (F3 or similar)
- [ ] Test stamina change: `Level1Vars.modify_stamina(-20)` -> Bar decreases
- [ ] Test stamina restore: `Level1Vars.modify_stamina(30)` -> Bar increases
- [ ] Test focus change: `Level1Vars.modify_focus(-15)` -> Bar decreases
- [ ] Test focus restore: `Level1Vars.modify_focus(25)` -> Bar increases
- [ ] Test full restore: `Level1Vars.restore_all_resources()` -> Both bars full

**Edge cases:**
- [ ] Set stamina to 0: `Level1Vars.stamina = 0` + emit signal -> Bar empty
- [ ] Set stamina to max: `Level1Vars.stamina = 100` + emit signal -> Bar full
- [ ] Modify beyond bounds: `modify_stamina(-200)` -> Bar stays at 0, no crash
- [ ] Modify beyond bounds: `modify_stamina(200)` -> Bar stays at max, no crash

---

## Files to Create

None - all changes are modifications to existing files

## Files to Modify

- [furnace.tscn](../../game/v0.1/level1/furnace.tscn) - Add StaminaBar and FocusBar ProgressBar nodes to Menu area with theme styling
- [furnace.gd](../../game/v0.1/level1/furnace.gd) - Add @onready references, signal connections, and update handlers

---

## Design Values (Reference)

### Progress Bar Styling

**ALL styling values are defined in [1.9-default-theme.md](../1/1.9-default-theme.md#progressbar).**

**Quick reference for this implementation:**
- **Stamina bar**: `progress_bars["stamina"]` - `Color(0.2, 0.9, 0.3, 0.3)` yellow-green
- **Focus bar**: `progress_bars["focus"]` - `Color(0.3, 0.6, 1, 0.3)` light blue
- **Template structure**: Lines 316-333 in [1.9-default-theme.md](../1/1.9-default-theme.md)
- **Height**: ~20px scaled with resolution per [1.10-responsive-layout.md](../1/1.10-responsive-layout.md)

### Resource Stats (From level_1_vars.gd)

- **Stamina starting value**: 50
- **Stamina max**: 100
- **Focus starting value**: 50
- **Focus max**: 100
- **Signal names**: `stamina_changed`, `focus_changed`
- **Signal parameters**: `(new_value: int, max_value: int)`

---

## UI Mockups

**Furnace Scene Menu Area (with progress bars):**

```
+----------------------------------------+
|  Menu Area (top-left of screen)       |
|                                        |
| Stamina: [########----------] 50/100   | <- Green bar
| Focus:   [######------------] 40/100   | <- Blue bar
|                                        |
| [ To Mind ]  (navigation button)       |
+----------------------------------------+
```

**Visual appearance:**
- Green bar: Translucent yellow-green fill on dark grey background
- Blue bar: Translucent light blue fill on dark grey background
- Both bars: Subtle grey border, 2px rounded corners
- Bars resize with responsive layout

## Balance Tuning Notes

Not applicable for this feature - pure UI display with no gameplay balance implications.

**Note**: Balance tuning for stamina/focus consumption rates should be documented in the plans where those mechanics are implemented (e.g., shovel actions, puzzle solving).

---

## Notes & Decisions

**Decision 1:** Use signal-based updates instead of polling
- **Rationale**: More performant and reactive. Bars update immediately when stats change without constantly checking values in _process()
- **Benefit**: Signals already exist in level_1_vars.gd, no additional infrastructure needed

**Decision 2:** Use existing named progress bars from [1.9-default-theme.md](../1/1.9-default-theme.md)
- **Rationale**:
  - Stamina and focus bars already defined in theme progress_bars dictionary
  - Yellow-green for stamina = positive resource (standard game UI convention)
  - Light blue for focus = mental/magic resource (standard game UI convention)
  - Hierarchical updates: changes to template in plan 1.9 automatically apply to all progress bars
- **Benefit**: No styling duplication, consistent with future progress bars

**Decision 3:** Place bars in Menu VBoxContainer (vertical stack)
- **Rationale**:
  - Menu is VBoxContainer per [1.10-responsive-layout.md](../1/1.10-responsive-layout.md) (line 99)
  - Items stack vertically, not side-by-side
  - Menu area is UI space, separate from gameplay/physics space (PlayArea)
  - Menu already contains navigation buttons - natural location for status displays
- **Benefit**: Clean separation of UI and gameplay elements, consistent with responsive layout structure

**Decision 4:** Start with visual-only bars, add numeric labels later if needed
- **Rationale**:
  - Visual bars provide quick at-a-glance feedback during fast-paced gameplay
  - Numeric values might clutter UI or distract from action
  - Easy to add labels later if players request precise numbers
- **Alternatives considered**:
  - Labels from start (rejected - test visual-only first)
  - Percentage display (rejected - raw values more meaningful)

**Decision 5:** Reference global theme definitions instead of duplicating styling
- **Rationale**:
  - Progress bar template and named bars already defined in [1.9-default-theme.md](../1/1.9-default-theme.md)
  - Hierarchical approach: changes to template propagate to all progress bars automatically
  - Prevents style drift and inconsistency across scenes
- **Benefit**: Single source of truth for progress bar styling, easier to maintain

**Open Questions:**
- [ ] Should bars have labels showing numeric values? (Test without first)
- [ ] Should bars animate when values change? (Implement smooth transitions or instant updates? - Critical for game feel)
- [ ] Do bars need tooltips explaining what stamina/focus do? (Wait for playtesting feedback)

---

## Implementation Checklist

**Scene setup:**
- [ ] StaminaBar ProgressBar node added to furnace.tscn Menu area
- [ ] FocusBar ProgressBar node added to furnace.tscn Menu area
- [ ] StaminaBar styled: green fill, transparent background, 2px corners
- [ ] FocusBar styled: blue fill, transparent background, 2px corners
- [ ] Bars positioned clearly without overlapping navigation buttons

**Code implementation:**
- [ ] @onready references added to furnace.gd for both bars
- [ ] connect_resource_bars() function created in furnace.gd
- [ ] Signal connections to Level1Vars.stamina_changed added
- [ ] Signal connections to Level1Vars.focus_changed added
- [ ] _on_stamina_changed() handler implemented
- [ ] _on_focus_changed() handler implemented
- [ ] Initial bar values set on scene load

**Testing:**
- [ ] Bars visible in furnace scene
- [ ] Bars display correct colors (green/blue)
- [ ] Bars show correct initial values (50/100)
- [ ] Stamina bar updates when modify_stamina() called
- [ ] Focus bar updates when modify_focus() called
- [ ] Bars handle edge cases (0, max, overflow) correctly
- [ ] No console errors on scene load
- [ ] Responsive layout doesn't break bar display

**Polish:**
- [ ] Bars resize appropriately with resolution changes
- [ ] Bar positioning looks good at target resolution (1438x817)
- [ ] Optional: Add numeric labels if visual feedback insufficient
- [ ] Optional: Add smooth animation to bar value changes

---

**Last Updated**: 2025-12-14
**Status**: Planning complete - ready for implementation
