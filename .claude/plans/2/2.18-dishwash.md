# Dishwash Minigame

**Goal**: Simple bar work minigame where player dunks and shakes mugs to earn Holes

**Success Criteria**: Player can complete dishwashing sessions, earn Holes based on mugs processed, and eventually master the job for passive mode

## Overview

First of the bar work minigames. The player "washes" mugs by dunking them in a basin and shaking off the water. Thematically grim - you're not actually cleaning anything, just making mugs damp-then-dry. The patrons get grimy mugs with the dirt still on them. Fits the poverty aesthetic of the train's underclass.

### Key Design Principles

- Ultra-simple: three-beat rhythm (drag, shake, rack)
- No waiting/idle phases - constant player input
- Grim theme over cleanliness fantasy
- Foundation for job mastery system (Active -> Passive)

---

## Core Mechanic

### The Loop

1. **Click** dirty mug from stack (left side)
2. **Drag** through wash basin (center)
3. **Wiggle** mouse left-right to shake water off
4. **Release** over drying rack (right side)

Repeat until shift ends or dirty stack is empty.

### Input Detection

**Drag**: Standard click-and-hold, mug follows cursor

**Wiggle Detection**:
- Track mouse X position over last ~0.3 seconds
- Require 3+ direction reversals within threshold
- Mug plays shake animation when wiggle detected
- Water droplet particles fly off

**Basin Contact**:
- Mug must pass through basin hitbox while dragged
- Brief splash particle effect
- Mug state changes from `dirty` to `wet`

**Rack Placement**:
- Release mug over rack hitbox
- Only accepts `shaken` state mugs
- Mug snaps to next available rack slot
- Score increments

---

## Visual Layout

```
+--------------------------------------------------+
|  [Dirty Stack]    [Basin]         [Drying Rack]  |
|                                                  |
|     ___            ~~~~~            |__|__|__|   |
|    |___|           ~~~~~            |__|__|__|   |
|    |___|           ~~~~~            |__|__|__|   |
|    |___|                                         |
|                                                  |
|  [Mugs: 0/15]              [Holes Earned: 0]     |
+--------------------------------------------------+
```

- Dirty stack on left, mugs visually stacked
- Basin in center with water line
- Rack on right with grid slots for clean mugs
- Counter shows progress and earnings

---

## Implementation Tasks

### 1. Scene Structure

Create `res://scenes/minigames/dishwash.tscn`:

```
DishwashMinigame (Control)
├── Background (TextureRect)
├── DirtyStack (Area2D)
│   └── StackedMugs (visual indicator)
├── Basin (Area2D)
│   └── WaterEffect (particles)
├── DryingRack (Area2D)
│   └── RackSlots (GridContainer)
├── DraggedMug (Sprite2D) # follows cursor when dragging
├── UI (CanvasLayer)
│   ├── MugCounter (Label)
│   ├── HolesEarned (Label)
│   └── Timer (Label)
└── SFX (AudioStreamPlayer)
```

### 2. Mug State Machine

```gdscript
enum MugState { DIRTY, WET, SHAKEN }

var current_mug_state: MugState = MugState.DIRTY
var is_dragging: bool = false
```

State transitions:
- `DIRTY` -> `WET`: Mug passes through basin
- `WET` -> `SHAKEN`: Wiggle detected
- `SHAKEN` -> (racked): Released over rack

### 3. Wiggle Detection

```gdscript
var mouse_history: Array[Vector2] = []
var wiggle_threshold: float = 30.0  # pixels of movement to count
var wiggle_window: float = 0.3      # seconds
var required_reversals: int = 3

func _process(delta):
    if is_dragging and current_mug_state == MugState.WET:
        track_mouse_movement()
        if detect_wiggle():
            current_mug_state = MugState.SHAKEN
            play_shake_animation()

func detect_wiggle() -> bool:
    # Count direction reversals in mouse X movement
    var reversals = 0
    var last_direction = 0

    for i in range(1, mouse_history.size()):
        var delta_x = mouse_history[i].x - mouse_history[i-1].x
        if abs(delta_x) > wiggle_threshold:
            var direction = sign(delta_x)
            if direction != last_direction and last_direction != 0:
                reversals += 1
            last_direction = direction

    return reversals >= required_reversals
```

### 4. Session Flow

```gdscript
var mugs_to_wash: int = 15        # per session
var mugs_completed: int = 0
var session_time: float = 60.0    # seconds
var holes_per_mug: int = 1

func start_session():
    mugs_to_wash = 15
    mugs_completed = 0
    start_timer(session_time)

func complete_mug():
    mugs_completed += 1
    # Mug goes to rack, score updates
    if mugs_completed >= mugs_to_wash:
        end_session_early_bonus()

func end_session():
    var holes_earned = mugs_completed * holes_per_mug
    GlobalSignals.emit_signal("holes_earned", holes_earned)
    # Return to bar scene
```

### 5. Feedback Systems

**Audio**:
- Mug pickup: ceramic clink
- Basin splash: water slosh
- Shake: water droplet sounds
- Rack placement: solid thunk
- Session complete: coin jingle (holes earned)

**Visual**:
- Water splash particles when entering basin
- Droplet particles during shake
- Mug sprite changes (dirty texture -> wet sheen -> dry)
- Rack slots fill visibly

---

## Job Mastery System

### Active Mode (Default)

Player performs all actions manually. Full payment rate.

### Passive Mode (Unlocked via Mastery)

After completing X sessions (maybe 10?), player can assign character to dishwashing without input.

**Passive Tradeoffs**:
- Character is occupied (can't do other jobs)
- Reduced output: 60% of active rate
- Runs during day shift or while doing other evening activities

```gdscript
var dishwash_mastery: int = 0
var mastery_threshold: int = 10

func complete_session():
    dishwash_mastery += 1
    if dishwash_mastery >= mastery_threshold:
        unlock_passive_mode()
```

---

## Payment & Economy

**Holes per mug**: 1 (base rate)

**Session structure**:
- 15 mugs available per session
- 60 second time limit
- Skilled player can finish all 15 in ~45 seconds
- Average player gets 10-12

**Per-session earnings**: 10-15 Holes

**Passive mode**: ~9 Holes per session (60% rate)

---

## Files to Create

- `res://scenes/minigames/dishwash.tscn` - Main minigame scene
- `res://scripts/minigames/dishwash.gd` - Core logic
- `res://assets/sfx/dishwash/` - Sound effects folder

## Files to Modify

- `global.gd` - Add `dishwash_mastery` tracking
- Bar scene - Add entry point to dishwash minigame

---

## Design Values

| Parameter | Value | Notes |
|-----------|-------|-------|
| Mugs per session | 15 | Full stack |
| Session time limit | 60s | Pressure but achievable |
| Holes per mug | 1 | Base rate |
| Wiggle reversals needed | 3 | Left-right-left minimum |
| Wiggle time window | 0.3s | Must be quick |
| Mastery threshold | 10 sessions | Unlock passive |
| Passive efficiency | 60% | Tradeoff for convenience |

---

## Testing Strategy

### Manual Test Criteria

- [ ] Mug picks up on click
- [ ] Mug follows cursor while dragging
- [ ] Basin splash triggers on pass-through
- [ ] Wiggle detection feels responsive (not too sensitive, not too strict)
- [ ] Rack only accepts shaken mugs
- [ ] Counter increments correctly
- [ ] Session ends at time limit
- [ ] Holes awarded on session end
- [ ] Mastery increments after session

---

## Open Questions

- [ ] What does the bar scene look like? Where is dishwash station located?
- [ ] Can player quit mid-session? Partial payment?
- [ ] Visual style for mugs - simple shapes or detailed?
- [ ] How does player access this minigame from the bar?

---

## Notes & Decisions

**Decision: No drying phase**
- Rationale: User requested ultra-simple. Shake replaces separate dry step.
- Thematically justified: poor workers don't have time for proper drying

**Decision: Wiggle over click-spam**
- Rationale: Feels like physical shaking motion
- Distinct from drag gesture, creates rhythm variety

**Decision: Active/Passive only, no Auto**
- Rationale: User specified. Keeps bar work as character-committed activity.
