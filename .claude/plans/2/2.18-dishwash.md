# Dishwash Minigame

**Goal**: Simple bar work minigame where player dunks and shakes mugs to earn Holes

**Success Criteria**: Player can wash mugs indefinitely, earn Holes based on mugs processed, and eventually master the job for passive mode

**Status**: IN PROGRESS - Awaiting mug sprite asset

---

## Overview

First of the bar work minigames. The player "washes" mugs by dunking them in a basin and shaking off the water. Thematically grim - you're not actually cleaning anything, just making mugs damp-then-dry. The patrons get grimy mugs with the dirt still on them. Fits the poverty aesthetic of the train's underclass.

### Key Design Principles

- Ultra-simple: three-beat rhythm (drag, shake, rack)
- No waiting/idle phases - constant player input
- Grim theme over cleanliness fantasy
- Foundation for job mastery system (Active -> Passive)
- No session time limits - player controls when to stop

---

## Core Mechanic

### The Loop

1. **Click** dirty mug from stack (left side)
2. **Drag** through wash basin (center)
3. **Wiggle** mouse left-right to shake water off
4. **Release** over drying rack (right side)

Repeat until player clicks "Stop washing" button.

### Input Detection

**Drag**: Standard click-and-hold, mug follows cursor

**Wiggle Detection**:
- Track cumulative mouse X travel distance
- Require 5 direction reversals
- No time limit - player can shake as slow/fast as they want
- Mug plays shake animation when wiggle detected
- Water droplet particles fly off

**Basin Contact**:
- Mug must pass through basin hitbox while dragged
- Brief splash particle effect
- Mug state changes from `dirty` to `wet`

**Rack Placement**:
- Release mug over rack hitbox
- Only accepts `shaken` state mugs
- Mug snaps to next available rack slot
- Progress toward next Hole increments

---

## Visual Layout

```
+--------------------------------------------------+
|  [Dirty Stack]    [Basin]         [Drying Rack]  |
|                                                  |
|     ___            ~~~~~            |__|__|__|   |
|    |___|           ~~~~~            |__|__|__|   |
|    |___|           ~~~~~            |__|__|__|   |
|    |___|                                         |
|                                                  |
|  [Mugs: 0/3]              [Holes Earned: 0]      |
|                                                  |
|              [Stop washing]                      |
+--------------------------------------------------+
```

- Dirty stack on left, mugs visually stacked (infinite supply)
- Basin in center with water line
- Rack on right with grid slots for clean mugs
- Counter shows progress toward next Hole (0/3) and total earnings
- "Stop washing" button (AffirmativeButton) to end session

---

## Bar Scene Integration

### UI Buttons

**"Wash mugs" Button**:
- Style: `AffirmativeButton` (gold/amber theme)
- Colors: `Color(0.85, 0.65, 0.13, 0.25)` normal, 2px golden border
- Behavior: Shows minigame in play area, hides itself, shows "Stop washing" button

**"Stop washing" Button**:
- Style: `AffirmativeButton` (gold/amber theme)
- Behavior: Ends session, awards earned Holes, hides minigame, shows "Wash mugs" button again

### Minigame Placement

- Minigame renders inside the bar scene's play area (not a separate scene)
- Overlays/replaces current play area content while active

---

## Implementation Tasks

### 1. Scene Structure

Create dishwash minigame as embedded Control node in bar scene:

```
BarScene
├── ... existing nodes ...
├── PlayArea
│   ├── DishwashMinigame (Control) # hidden by default
│   │   ├── DirtyStack (Area2D)
│   │   │   └── StackedMugs (visual indicator)
│   │   ├── Basin (Area2D)
│   │   │   └── WaterEffect (particles)
│   │   ├── DryingRack (Area2D)
│   │   │   └── RackSlots (visual)
│   │   ├── DraggedMug (Sprite2D) # follows cursor when dragging
│   │   ├── MugCounter (Label)
│   │   └── HolesEarned (Label)
│   └── ... other play area content ...
├── WashMugsButton (Button) # AffirmativeButton style
├── StopWashingButton (Button) # AffirmativeButton style, hidden by default
└── SFX (AudioStreamPlayer)
```

### 2. Mug State Machine

```gdscript
enum MugState { DIRTY, WET, SHAKEN }

var current_mug_state: MugState = MugState.DIRTY
var is_dragging: bool = false
```

State transitions:
- `DIRTY` -> `WET`: Mug passes through basin
- `WET` -> `SHAKEN`: Wiggle detected (5 reversals + distance)
- `SHAKEN` -> (racked): Released over rack

### 3. Wiggle Detection

```gdscript
var wiggle_distance: float = 0.0         # cumulative X travel
var wiggle_reversals: int = 0
var last_direction: int = 0
var min_movement_threshold: float = 10.0  # pixels to count as intentional movement
var distance_per_reversal: float = 20.0   # minimum travel before reversal counts
var required_reversals: int = 5

func _process(delta):
    if is_dragging and current_mug_state == MugState.WET:
        track_wiggle()
        if wiggle_reversals >= required_reversals:
            current_mug_state = MugState.SHAKEN
            play_shake_animation()
            reset_wiggle_tracking()

func track_wiggle():
    var delta_x = current_mouse_x - last_mouse_x
    if abs(delta_x) > min_movement_threshold:
        wiggle_distance += abs(delta_x)
        var direction = sign(delta_x)
        if direction != last_direction and last_direction != 0:
            if wiggle_distance >= distance_per_reversal:
                wiggle_reversals += 1
                wiggle_distance = 0.0
        last_direction = direction
```

### 4. Session Flow

```gdscript
var mugs_this_session: int = 0
var mugs_toward_hole: int = 0    # 0, 1, or 2 - resets at 3
var holes_earned: int = 0

func start_washing():
    mugs_this_session = 0
    mugs_toward_hole = 0
    holes_earned = 0
    show_minigame()
    $WashMugsButton.hide()
    $StopWashingButton.show()

func complete_mug():
    mugs_this_session += 1
    mugs_toward_hole += 1
    Level1Vars.mugs_washed += 1  # lifetime tracking

    if mugs_toward_hole >= 3:
        mugs_toward_hole = 0
        holes_earned += 1
        # Play coin sound, flash UI

    check_mastery_unlock()
    spawn_new_dirty_mug()

func stop_washing():
    # Award earned holes to player
    GlobalSignals.emit_signal("holes_earned", holes_earned)
    hide_minigame()
    $WashMugsButton.show()
    $StopWashingButton.hide()

func check_mastery_unlock():
    if Level1Vars.mugs_washed >= 150 and not Level1Vars.dishwash_mastery_unlocked:
        Level1Vars.dishwash_mastery_unlocked = true
        # Show unlock notification
```

### 5. Feedback Systems

**Audio**:
- Mug pickup: ceramic clink
- Basin splash: water slosh
- Shake: water droplet sounds
- Rack placement: solid thunk
- Hole earned: coin jingle

**Visual**:
- Water splash particles when entering basin
- Droplet particles during shake
- Mug sprite changes (dirty -> wet -> clean)
- Counter flashes when Hole earned

---

## Job Mastery System

### Active Mode (Default)

Player performs all actions manually. Earns 1 Hole per 3 mugs.

### Passive Mode (Unlocked via Mastery)

After washing 150 total mugs (`Level1Vars.mugs_washed >= 150`), player can assign character to dishwashing without input.

**Passive Rate**: 1 Hole every 10 seconds while selected

```gdscript
# In Level1Vars
var mugs_washed: int = 0                    # lifetime total
var dishwash_mastery_unlocked: bool = false
```

---

## Payment & Economy

| Parameter | Value | Notes |
|-----------|-------|-------|
| Holes per mugs | 1 per 3 mugs | Must complete 3 to earn |
| Session limit | None | Player stops when they want |
| Mastery threshold | 150 mugs total | Tracked in Level1Vars |
| Passive rate | 1 Hole / 10 seconds | When passive mode selected |

---

## Mug Sprite

**Status**: IN PROGRESS

**Style**: 2D glass mug with baked-in transparency effect
- Simple silhouette with handle
- ~20-30% opacity fill (glass look)
- Static white highlight on upper left (light reflection)
- Subtle darker edge on right for depth

**Variants needed**:
1. **Dirty** - brown smudges/grime overlay
2. **Wet** - blue tint, drip shapes
3. **Clean** - base transparent mug

**Image prompt used**:
```
2D game sprite sheet, side-by-side comparison of the same glass beer mug, left side dirty with brown grime and smudges, right side clean and transparent, simple cartoon style, white highlight reflection on upper left of each mug, transparent glass material, plain flat background, pixel art or vector style, game asset, icon style, matching proportions
```

---

## Files to Create

- `res://assets/sprites/mug_dirty.png` - Dirty mug sprite
- `res://assets/sprites/mug_wet.png` - Wet mug sprite
- `res://assets/sprites/mug_clean.png` - Clean mug sprite

## Files to Modify

- Bar scene - Add dishwash minigame nodes, buttons
- `Level1Vars` - Add `mugs_washed`, `dishwash_mastery_unlocked`

---

## Design Values

| Parameter | Value | Notes |
|-----------|-------|-------|
| Mugs per Hole | 3 | Batch payment |
| Session time limit | None | Unlimited washing |
| Wiggle reversals needed | 5 | Direction changes |
| Wiggle distance threshold | 20px per reversal | Must travel before reversal counts |
| Mastery threshold | 150 mugs | Lifetime total |
| Passive rate | 1 Hole / 10s | When selected |

---

## Testing Strategy

### Manual Test Criteria

- [ ] "Wash mugs" button shows minigame, hides itself
- [ ] "Stop washing" button ends session, shows "Wash mugs" again
- [ ] Mug picks up on click
- [ ] Mug follows cursor while dragging
- [ ] Basin splash triggers on pass-through
- [ ] Wiggle detection requires 5 reversals with movement
- [ ] Rack only accepts shaken mugs
- [ ] Counter shows X/3 toward next Hole
- [ ] Hole awarded every 3 mugs
- [ ] `Level1Vars.mugs_washed` increments correctly
- [ ] Mastery unlocks at 150 mugs
- [ ] Passive mode generates 1 Hole / 10 seconds

---

## Open Questions

- [x] ~~Visual style for mugs~~ - 2D glass with baked transparency
- [x] ~~How does player access this minigame~~ - "Wash mugs" button in bar
- [x] ~~Session limits~~ - No limit, player chooses when to stop
- [ ] What does the bar scene play area look like? Where does minigame render?

---

## Notes & Decisions

**Decision: No drying phase**
- Rationale: User requested ultra-simple. Shake replaces separate dry step.
- Thematically justified: poor workers don't have time for proper drying

**Decision: Wiggle over click-spam**
- Rationale: Feels like physical shaking motion
- Distinct from drag gesture, creates rhythm variety

**Decision: Active/Passive only, no Auto**
- Rationale: User specified. Keeps bar work as character-committed activity.

**Decision: No session time limit**
- Rationale: User requested. Player washes as long as they want.
- "Stop washing" button ends session manually.

**Decision: 1 Hole per 3 mugs**
- Rationale: User specified. Batched payment.

**Decision: Mastery at 150 mugs (not 10 sessions)**
- Rationale: User specified. Tracks lifetime progress in Level1Vars.

**Decision: Wiggle detection without time limit**
- Rationale: User requested. 5 direction changes + distance threshold instead.

**Decision: 2D sprite with baked glass effect**
- Rationale: Simpler than shader-based glass. Static highlight, transparency in PNG.

---

**Last Updated**: 2026-01-09
