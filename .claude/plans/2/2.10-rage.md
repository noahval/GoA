# Overseer Rage System

**Goal**: Punish players for dropping coal through escalating warnings and whipping mechanics.

**Success Criteria**:
- Red vignette flashes 300ms when coal is dropped
- Rage counter (Level1Vars) tracks dropped coal, decreases with deliveries
- Warning notifications at rage 2, severe warnings at rage 5
- Whipping at rage 8+ removes stamina (10 base, +5 per 4 additional rage)
- Constitution_exp increases by 0.5 when whipped
- Rage resets at start of each day
- 5 warning + 5 severe warning dialog pools for variety

## Overview

Dropping coal triggers immediate visual punishment (red vignette flash) and builds overseer rage. As rage accumulates, the overseer issues warnings, then severe warnings, then physically punishes the player through whipping. Successfully delivering coal reduces rage over time. This creates tension around careless coal handling while providing a path to redemption through good performance.

**Dependencies:**
- Requires 2.x-dropped-coal.md for coal_dropped tracking
- Requires 2.x-delivered-coal.md for coal_delivered tracking
- Requires 1.x-notifications.md for notification system (Global.show_notification API)

### Key Design Principles

- **Rage is hidden** - Player learns system through observation, not explicit UI
- Punishment should feel impactful but not game-ending
- Warnings give players chance to course-correct before punishment
- Delivering coal provides a clear path to reduce rage
- Randomized dialog prevents repetition fatigue
- Constitution_exp gain from whipping creates subtle long-term benefit (toughening up)
- Uses standard notification system (Global.show_notification with NOTIFICATION_TYPE_WARNING)

---

## Design Values

### Rage Mechanics

- **Rage increase**: +1 per coal dropped
- **Rage decrease**: -1 per 10 coal delivered
- **Rage reset**: To 0 at start of each day
- **Warning threshold**: 2 rage (first warning)
- **Severe warning threshold**: 5 rage (final warning)
- **Whipping threshold**: 8 rage (first whip)

### Whipping Formula

```
Whip triggers at: 8, 12, 16, 20, 24... (every 4 rage after first whip)
Stamina removed = 10 + (5 * whip_count)

Rage 8:  Whip #1, remove 10 stamina
Rage 12: Whip #2, remove 15 stamina
Rage 16: Whip #3, remove 20 stamina
Rage 20: Whip #4, remove 25 stamina
...
```

### Visual Feedback

- **Red vignette duration**: 300ms
- **Vignette style**: Radial gradient shader (dark red edges, clear center)
- **Vignette color**: Red (0.8, 0.1, 0.1) with intensity up to 50% at peak
- **Fade style**: Quick fade in (50ms), slower fade out (250ms)

### Constitution Experience Gain

- **Per whip**: +0.5 constitution_exp (subtle, accumulates over time)
- **Purpose**: Toughening effect from repeated punishment

---

## Implementation Tasks

### 1. Level1Vars - Rage Variables (if not present)

**Note:** These variables may already exist in level_1_vars.gd. Only add if not already present.

**In level1/level_1_vars.gd:**
```gdscript
# Overseer rage tracking (add only if not present)
var rage: int = 0  # Increases when coal dropped, decreases when coal delivered
var whip_count: int = 0  # Track whip count for escalating punishment
```

**Notes:**
- Rage resets at day start via existing `perform_daily_reset()` function
- whip_count tracks how many times player has been whipped this day
- Do NOT add separate reset_rage() function - use perform_daily_reset() which already handles this

### 2. Red Vignette Flash (Shader-Based)

Create radial vignette overlay using a shader for proper gradient effect (dark edges, clear center).

**Create shader file level1/vignette.gdshader:**
```gdshader
shader_type canvas_item;

uniform float intensity : hint_range(0.0, 1.0) = 0.0;
uniform vec4 vignette_color : source_color = vec4(0.8, 0.1, 0.1, 1.0);
uniform float inner_radius : hint_range(0.0, 1.0) = 0.3;
uniform float outer_radius : hint_range(0.0, 1.0) = 0.8;

void fragment() {
    vec2 uv = UV - vec2(0.5);
    float dist = length(uv) * 2.0;  // Distance from center (0 at center, 1+ at corners)
    float vignette = smoothstep(inner_radius, outer_radius, dist);
    COLOR = vec4(vignette_color.rgb, vignette * intensity);
}
```

**In level1/vignette_overlay.gd:**
```gdscript
extends ColorRect

const FLASH_DURATION: float = 0.3  # 300ms

func _ready():
    add_to_group("vignette")
    mouse_filter = Control.MOUSE_FILTER_IGNORE
    # Shader is assigned in scene, just ensure full screen coverage
    anchors_preset = Control.PRESET_FULL_RECT
    # Reset intensity to 0 in case scene was reloaded mid-flash
    _set_intensity(0.0)

func flash_red():
    var tween = create_tween()
    tween.tween_method(_set_intensity, 0.0, 0.5, 0.05)  # Fade in fast
    tween.tween_method(_set_intensity, 0.5, 0.0, 0.25)  # Fade out slower

func _set_intensity(value: float):
    material.set_shader_parameter("intensity", value)
```

**Scene setup (vignette_overlay.tscn):**
- CanvasLayer (layer 100 to render on top)
  - ColorRect (anchors full rect, ShaderMaterial with vignette.gdshader)

**Integration:**
- Add VignetteOverlay scene as child of furnace scene root
- Call `get_tree().get_first_node_in_group("vignette").flash_red()` when coal dropped

### 3. Overseer Warning Dialog Pools

**Warning Pool (rage 2-4):**
```gdscript
const WARNINGS: Array[String] = [
    "Watch yourself, rat. That coal isn't free.",
    "Another piece lost. The furnace master is counting.",
    "Clumsy hands make for busy whips.",
    "I see that coal hit the floor. So does the ledger.",
    "Keep dropping coal and you'll be carrying the quota on your back.",
]
```

**Severe Warning Pool (rage 5-7):**
```gdscript
const SEVERE_WARNINGS: Array[String] = [
    "LAST WARNING. The next piece that falls, you answer for in flesh.",
    "My patience is gone. One more and the whip comes out.",
    "You're testing me, rat. The lash is hungry.",
    "I've had enough. Drop another and you'll feel every piece you've wasted.",
    "Final chance. The next coal that touches the floor, your back pays the price.",
]
```

### 4. Rage System Logic (Integrated into Level1Vars)

Add rage handling functions directly to Level1Vars instead of a separate autoload.

**Add to level1/level_1_vars.gd:**
```gdscript
# ===== RAGE SYSTEM =====

signal rage_warning_triggered(message: String)
signal rage_severe_warning_triggered(message: String)
signal rage_whip_triggered(stamina_removed: int)

const RAGE_WARNINGS: Array[String] = [
    "Watch yourself, rat. That coal isn't free.",
    "Another piece lost. The furnace master is counting.",
    "Clumsy hands make for busy whips.",
    "I see that coal hit the floor. So does the ledger.",
    "Keep dropping coal and you'll be carrying the quota on your back.",
]

const RAGE_SEVERE_WARNINGS: Array[String] = [
    "LAST WARNING. The next piece that falls, you answer for in flesh.",
    "My patience is gone. One more and the whip comes out.",
    "You're testing me, rat. The lash is hungry.",
    "I've had enough. Drop another and you'll feel every piece you've wasted.",
    "Final chance. The next coal that touches the floor, your back pays the price.",
]

const RAGE_WARNING_THRESHOLD: int = 2
const RAGE_SEVERE_WARNING_THRESHOLD: int = 5
const RAGE_WHIP_THRESHOLD: int = 8
const RAGE_WHIP_INTERVAL: int = 4
const RAGE_BASE_WHIP_DAMAGE: int = 10
const RAGE_WHIP_DAMAGE_INCREASE: int = 5
const RAGE_CONSTITUTION_EXP_PER_WHIP: float = 0.5
const RAGE_COAL_PER_DECREASE: int = 10

var _rage_coal_delivered_counter: int = 0
var _rage_last_warning_level: int = -1
var _rage_last_severe_level: int = -1

func on_coal_dropped_rage():
    rage += 1
    _check_rage_thresholds()

func on_coal_delivered_rage():
    _rage_coal_delivered_counter += 1
    if _rage_coal_delivered_counter >= RAGE_COAL_PER_DECREASE:
        _rage_coal_delivered_counter = 0
        if rage > 0:
            rage -= 1
            if rage < RAGE_WARNING_THRESHOLD:
                _rage_last_warning_level = -1
            if rage < RAGE_SEVERE_WARNING_THRESHOLD:
                _rage_last_severe_level = -1

func _check_rage_thresholds():
    # Check for whipping (8, 12, 16, 20...)
    if rage >= RAGE_WHIP_THRESHOLD:
        var whips_due = 1 + int((rage - RAGE_WHIP_THRESHOLD) / RAGE_WHIP_INTERVAL)
        if whips_due > whip_count:
            _apply_whip()
            return

    # Check for severe warning (5, 6, 7)
    if rage >= RAGE_SEVERE_WARNING_THRESHOLD and rage < RAGE_WHIP_THRESHOLD:
        if rage != _rage_last_severe_level:
            _rage_last_severe_level = rage
            var msg = RAGE_SEVERE_WARNINGS[randi() % RAGE_SEVERE_WARNINGS.size()]
            rage_severe_warning_triggered.emit(msg)
            return

    # Check for warning (2, 3, 4)
    if rage >= RAGE_WARNING_THRESHOLD and rage < RAGE_SEVERE_WARNING_THRESHOLD:
        if rage != _rage_last_warning_level:
            _rage_last_warning_level = rage
            var msg = RAGE_WARNINGS[randi() % RAGE_WARNINGS.size()]
            rage_warning_triggered.emit(msg)

func _apply_whip():
    whip_count += 1
    var stamina_removed = RAGE_BASE_WHIP_DAMAGE + (RAGE_WHIP_DAMAGE_INCREASE * (whip_count - 1))

    # Apply stamina damage
    modify_stamina(-stamina_removed)

    # Increase constitution experience (toughening effect)
    Global.add_stat_exp("constitution", RAGE_CONSTITUTION_EXP_PER_WHIP)

    rage_whip_triggered.emit(stamina_removed)
```

**Update perform_daily_reset() to also reset rage tracking state:**
```gdscript
# Add to existing perform_daily_reset():
    _rage_coal_delivered_counter = 0
    _rage_last_warning_level = -1
    _rage_last_severe_level = -1
```

### 5. Integration with Coal Tracking

**Modify coal_piece.gd _on_entered_drop_zone():**
```gdscript
func _on_entered_drop_zone():
    # Skip if already counted as delivered
    if has_been_tracked:
        queue_free()
        return

    # Mark as tracked FIRST
    has_been_tracked = true

    # Track as dropped
    Level1Vars.coal_dropped += 1
    if Level1Vars.DEBUG_COAL_TRACKING:
        print("[COAL] Dropped! Total: ", Level1Vars.coal_dropped)

    # Trigger rage system (integrated in Level1Vars)
    Level1Vars.on_coal_dropped_rage()

    # Flash red vignette (null check required - get_tree() can be null during physics callbacks)
    var tree = get_tree()
    if tree:
        var vignette = tree.get_first_node_in_group("vignette")
        if vignette:
            vignette.flash_red()

    queue_free()
```

**Modify coal_piece.gd _on_entered_delivery_zone():**
```gdscript
func _on_entered_delivery_zone() -> bool:
    # Skip if already counted
    if has_been_tracked:
        queue_free()
        return false

    # Mark as tracked FIRST
    has_been_tracked = true

    # Track as delivered
    Level1Vars.coal_delivered += 1
    if Level1Vars.DEBUG_COAL_TRACKING:
        print("[COAL] Delivered! Total: ", Level1Vars.coal_delivered)

    # Notify rage system (integrated in Level1Vars)
    Level1Vars.on_coal_delivered_rage()

    # Red fade animation
    var tween = create_tween()
    tween.tween_property(self, "modulate", Color.RED, 0.3)
    tween.finished.connect(queue_free)

    return true
```

### 6. Connect to Notification System

**In furnace.gd _ready():**
```gdscript
func _ready():
    # ... existing setup

    Level1Vars.rage_warning_triggered.connect(_on_overseer_warning)
    Level1Vars.rage_severe_warning_triggered.connect(_on_overseer_severe_warning)
    Level1Vars.rage_whip_triggered.connect(_on_player_whipped)

func _on_overseer_warning(message: String):
    Global.show_notification(message, Global.NOTIFICATION_TYPE_WARNING)

func _on_overseer_severe_warning(message: String):
    Global.show_notification(message, Global.NOTIFICATION_TYPE_WARNING)

func _on_player_whipped(stamina_removed: int):
    var msg = "The overseer's whip bites deep. -%d stamina" % stamina_removed
    Global.show_notification(msg, Global.NOTIFICATION_TYPE_WARNING)
    # TODO: Add whip sound effect
```

---

## Files to Create

- `level1/vignette.gdshader` - Radial vignette shader
- `level1/vignette_overlay.gd` - Vignette flash controller
- `level1/vignette_overlay.tscn` - Vignette scene (CanvasLayer + ColorRect with shader)

## Files to Modify

- `level1/level_1_vars.gd` - Add rage system logic (signals, constants, functions), rage tracking state variables (if not present)
- `level1/coal_piece.gd` - Call Level1Vars rage methods in drop/delivery handlers, flash vignette
- `level1/furnace.gd` - Connect rage signals to notification system, add vignette scene instance

---

## Testing Checklist

### Rage Tracking Tests
- [ ] Rage starts at 0
- [ ] Dropping coal increments rage by 1
- [ ] Delivering 10 coal decrements rage by 1
- [ ] Rage cannot go below 0
- [ ] Rage resets to 0 at day start

### Warning Tests
- [ ] Warning notification appears at rage 2
- [ ] Warning notification appears at rage 3, 4
- [ ] Different warning messages appear (randomized)
- [ ] Severe warning appears at rage 5
- [ ] Severe warning appears at rage 6, 7
- [ ] Different severe warning messages appear (randomized)
- [ ] No duplicate warnings for same rage level

### Whipping Tests
- [ ] First whip at rage 8, removes 10 stamina
- [ ] Second whip at rage 12, removes 15 stamina
- [ ] Third whip at rage 16, removes 20 stamina
- [ ] Constitution_exp increases by 0.5 per whip
- [ ] Whip count resets with rage at day start

### Visual Feedback Tests
- [ ] Red vignette flashes when coal dropped
- [ ] Vignette lasts approximately 300ms
- [ ] Vignette fades in quickly, fades out slowly
- [ ] Multiple drops can trigger overlapping flashes

### Integration Tests
- [ ] Coal dropped -> vignette + rage increase + possible warning
- [ ] Coal delivered -> rage decrease tracking
- [ ] Day transition -> rage reset
- [ ] Stamina display updates after whipping

---

## Balance Tuning Notes

**Tuneable Parameters (in Level1Vars):**
- `RAGE_WARNING_THRESHOLD` (2) - When first warning appears
- `RAGE_SEVERE_WARNING_THRESHOLD` (5) - When severe warnings appear
- `RAGE_WHIP_THRESHOLD` (8) - When first whip occurs
- `RAGE_WHIP_INTERVAL` (4) - Rage between whips
- `RAGE_BASE_WHIP_DAMAGE` (10) - First whip stamina cost
- `RAGE_WHIP_DAMAGE_INCREASE` (5) - Additional damage per subsequent whip
- `RAGE_COAL_PER_DECREASE` (10) - Coal deliveries to reduce rage by 1
- `RAGE_CONSTITUTION_EXP_PER_WHIP` (0.5) - Constitution experience gain per punishment

**Expected Player Experience:**
- Occasional drops (1-2): Minor visual punishment only
- Careless play (2-4 drops): Warnings create tension
- Continued carelessness (5-7 drops): Severe warnings, player knows punishment is coming
- Reckless play (8+ drops): Stamina punishment, must recover through good performance

**Warning Signs:**
- If players never reach rage 2, punishment is too lenient
- If players frequently hit rage 8+, consider increasing RAGE_COAL_PER_DECREASE
- If warnings feel spammy, increase thresholds or add cooldowns

---

## Notes & Decisions

**Decision: Rage resets daily**
- **Rationale**: Prevents death spiral where one bad day ruins the entire run
- **Alternative**: Rage persists but decays over time - rejected as too punishing
- **Implementation Note**: Handled by existing perform_daily_reset() in Level1Vars

**Decision: 10 coal per rage decrease**
- **Rationale**: Requires sustained good performance to recover, not just a few deliveries
- **Alternative**: Faster decrease (5 coal) - felt too forgiving for "punishment" system

**Decision: Whip gives constitution_exp**
- **Rationale**: Creates interesting tradeoff - punishment has silver lining, fits "toughening up" narrative
- **Implementation**: Adds 0.5 to constitution_exp per whip via Global.add_stat_exp("constitution", 0.5)
- **Alternative**: Pure punishment - rejected as too one-dimensional

**Decision: Warning at 2, severe at 5, whip at 8**
- **Rationale**: Gives player 7 drops worth of warnings before punishment
- **Alternative**: Faster escalation (1, 3, 5) - felt too punishing for early game

**Gotcha: get_tree() null check in coal_piece.gd**
- **Issue**: `get_tree()` returns null when called during physics callbacks on nodes being removed from tree
- **Fix**: Always check `var tree = get_tree()` before calling `tree.get_first_node_in_group()`
- **Symptom**: Crash with "Cannot call method 'get_first_node_in_group' on a null value"

**Gotcha: Vignette intensity carries over between days**
- **Issue**: If scene changes mid-flash (e.g., day ends due to dropped coal triggering stamina loss), shader intensity is left at non-zero value
- **Fix**: Reset intensity to 0 in vignette_overlay.gd `_ready()` with `_set_intensity(0.0)`
- **Symptom**: Red vignette visible at start of new day

---

## Implementation Checklist

- [ ] Level1Vars rage/whip_count variables present (add if not already there)
- [ ] Level1Vars rage system signals added (rage_warning_triggered, rage_severe_warning_triggered, rage_whip_triggered)
- [ ] Level1Vars rage constants added (thresholds, damage values)
- [ ] Level1Vars rage functions added (on_coal_dropped_rage, on_coal_delivered_rage, _check_rage_thresholds, _apply_whip)
- [ ] Level1Vars perform_daily_reset() updated with rage tracking state reset
- [ ] Vignette shader (vignette.gdshader) created with radial gradient
- [ ] VignetteOverlay scene created (CanvasLayer + ColorRect with shader)
- [ ] Vignette flash_red() function working with shader intensity
- [ ] Warning dialog pool implemented in Level1Vars
- [ ] Severe warning dialog pool implemented in Level1Vars
- [ ] Whipping logic implemented (increases constitution_exp by 0.5)
- [ ] Coal drop triggers rage increase and vignette flash
- [ ] Coal delivery triggers rage decrease check
- [ ] Furnace connects to Level1Vars rage signals for notifications
- [ ] All tests passing
