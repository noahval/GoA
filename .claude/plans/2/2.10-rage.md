# Overseer Rage System

**Goal**: Punish players for dropping coal through escalating warnings and whipping mechanics.

**Success Criteria**:
- Red vignette flashes 300ms when coal is dropped
- Rage counter (Level1Vars) tracks dropped coal, decreases with deliveries
- Warning notifications at rage 2, severe warnings at rage 5
- Whipping at rage 8+ removes stamina (10 base, +5 per 4 additional rage)
- Constitution global var increases subtly when whipped
- Rage resets at start of each day
- 5 warning + 5 severe warning dialog pools for variety

## Overview

Dropping coal triggers immediate visual punishment (red vignette flash) and builds overseer rage. As rage accumulates, the overseer issues warnings, then severe warnings, then physically punishes the player through whipping. Successfully delivering coal reduces rage over time. This creates tension around careless coal handling while providing a path to redemption through good performance.

**Dependencies:**
- Requires 2.4-dropped-coal.md for coal_dropped tracking
- Requires 2.5-delivered-coal.md for coal_delivered tracking
- Requires 1.15-notifications.md for notification system (Global.show_notification API)

### Key Design Principles

- **Rage is hidden** - Player learns system through observation, not explicit UI
- Punishment should feel impactful but not game-ending
- Warnings give players chance to course-correct before punishment
- Delivering coal provides a clear path to reduce rage
- Randomized dialog prevents repetition fatigue
- Constitution_exp gain from whipping creates subtle long-term benefit (toughening up)
- Uses standard notification system (Global.show_notification with NOTIFICATION_TYPE_WARNING)

---

## Design Values

### Rage Mechanics

- **Rage increase**: +1 per coal dropped
- **Rage decrease**: -1 per 10 coal delivered
- **Rage reset**: To 0 at start of each day
- **Warning threshold**: 2 rage (first warning)
- **Severe warning threshold**: 5 rage (final warning)
- **Whipping threshold**: 8 rage (first whip)

### Whipping Formula

```
Whip triggers at: 8, 12, 16, 20, 24... (every 4 rage after first whip)
Stamina removed = 10 + (5 * whip_count)

Rage 8:  Whip #1, remove 10 stamina
Rage 12: Whip #2, remove 15 stamina
Rage 16: Whip #3, remove 20 stamina
Rage 20: Whip #4, remove 25 stamina
...
```

### Visual Feedback

- **Red vignette duration**: 300ms
- **Vignette color**: Red with ~40% opacity at edges
- **Fade style**: Quick fade in, slower fade out

### Constitution Experience Gain

- **Per whip**: +1 constitution_exp (subtle, accumulates over time)
- **Purpose**: Toughening effect from repeated punishment

---

## Implementation Tasks

### 1. Level1Vars - Rage Variable

Add rage tracking to Level1Vars autoload.

**In level1/level_1_vars.gd:**
```gdscript
# Overseer rage tracking
var rage: int = 0  # Increases when coal dropped, decreases when coal delivered

# Track whip count for escalating punishment (resets with rage)
var whip_count: int = 0

func reset_rage():
    rage = 0
    whip_count = 0
```

**Notes:**
- rage resets at day start (call reset_rage() in day transition)
- whip_count tracks how many times player has been whipped this day

### 2. Red Vignette Flash

Create vignette overlay that flashes when coal is dropped.

**Create vignette scene or add to existing UI:**

**In level1/vignette_overlay.gd:**
```gdscript
extends ColorRect

const FLASH_DURATION: float = 0.3  # 300ms

func _ready():
    # Full screen overlay, transparent by default
    mouse_filter = Control.MOUSE_FILTER_IGNORE
    color = Color(0.8, 0.1, 0.1, 0.0)  # Red, fully transparent

func flash_red():
    # Quick flash effect
    var tween = create_tween()
    tween.tween_property(self, "color:a", 0.4, 0.05)  # Fade in fast
    tween.tween_property(self, "color:a", 0.0, 0.25)  # Fade out slower
```

**Integration:**
- Add VignetteOverlay as CanvasLayer child (renders on top)
- Add to "vignette" group for easy access
- Call vignette.flash_red() when coal is dropped

### 3. Overseer Warning Dialog Pools

**Warning Pool (rage 2-4):**
```gdscript
const WARNINGS: Array[String] = [
    "Watch yourself, rat. That coal isn't free.",
    "Another piece lost. The furnace master is counting.",
    "Clumsy hands make for busy whips.",
    "I see that coal hit the floor. So does the ledger.",
    "Keep dropping coal and you'll be carrying the quota on your back.",
]
```

**Severe Warning Pool (rage 5-7):**
```gdscript
const SEVERE_WARNINGS: Array[String] = [
    "LAST WARNING. The next piece that falls, you answer for in flesh.",
    "My patience is gone. One more and the whip comes out.",
    "You're testing me, rat. The lash is hungry.",
    "I've had enough. Drop another and you'll feel every piece you've wasted.",
    "Final chance. The next coal that touches the floor, your back pays the price.",
]
```

### 4. Rage System Manager

Central manager for rage logic.

**In level1/rage_manager.gd:**
```gdscript
extends Node

signal warning_triggered(message: String)
signal severe_warning_triggered(message: String)
signal whip_triggered(stamina_removed: int)

const WARNINGS: Array[String] = [
    "Watch yourself, rat. That coal isn't free.",
    "Another piece lost. The furnace master is counting.",
    "Clumsy hands make for busy whips.",
    "I see that coal hit the floor. So does the ledger.",
    "Keep dropping coal and you'll be carrying the quota on your back.",
]

const SEVERE_WARNINGS: Array[String] = [
    "LAST WARNING. The next piece that falls, you answer for in flesh.",
    "My patience is gone. One more and the whip comes out.",
    "You're testing me, rat. The lash is hungry.",
    "I've had enough. Drop another and you'll feel every piece you've wasted.",
    "Final chance. The next coal that touches the floor, your back pays the price.",
]

const WARNING_THRESHOLD: int = 2
const SEVERE_WARNING_THRESHOLD: int = 5
const WHIP_THRESHOLD: int = 8
const WHIP_INTERVAL: int = 4  # Whip every 4 rage after threshold
const BASE_WHIP_DAMAGE: int = 10
const WHIP_DAMAGE_INCREASE: int = 5
const CONSTITUTION_EXP_PER_WHIP: int = 1
const COAL_PER_RAGE_DECREASE: int = 10

var _coal_delivered_since_last_decrease: int = 0
var _last_warning_rage: int = -1  # Track to avoid spam
var _last_severe_rage: int = -1

func on_coal_dropped():
    Level1Vars.rage += 1
    _check_rage_thresholds()

func on_coal_delivered():
    _coal_delivered_since_last_decrease += 1
    if _coal_delivered_since_last_decrease >= COAL_PER_RAGE_DECREASE:
        _coal_delivered_since_last_decrease = 0
        if Level1Vars.rage > 0:
            Level1Vars.rage -= 1
            # Reset warning tracking if rage drops below thresholds
            if Level1Vars.rage < WARNING_THRESHOLD:
                _last_warning_rage = -1
            if Level1Vars.rage < SEVERE_WARNING_THRESHOLD:
                _last_severe_rage = -1

func _check_rage_thresholds():
    var rage = Level1Vars.rage

    # Check for whipping (8, 12, 16, 20...)
    if rage >= WHIP_THRESHOLD:
        var whips_due = 1 + int((rage - WHIP_THRESHOLD) / WHIP_INTERVAL)
        if whips_due > Level1Vars.whip_count:
            _apply_whip()
            return  # Whip overrides warnings

    # Check for severe warning (5, 6, 7)
    if rage >= SEVERE_WARNING_THRESHOLD and rage < WHIP_THRESHOLD:
        if rage != _last_severe_rage:
            _last_severe_rage = rage
            var msg = SEVERE_WARNINGS[randi() % SEVERE_WARNINGS.size()]
            severe_warning_triggered.emit(msg)
            return

    # Check for warning (2, 3, 4)
    if rage >= WARNING_THRESHOLD and rage < SEVERE_WARNING_THRESHOLD:
        if rage != _last_warning_rage:
            _last_warning_rage = rage
            var msg = WARNINGS[randi() % WARNINGS.size()]
            warning_triggered.emit(msg)

func _apply_whip():
    Level1Vars.whip_count += 1
    var stamina_removed = BASE_WHIP_DAMAGE + (WHIP_DAMAGE_INCREASE * (Level1Vars.whip_count - 1))

    # Apply stamina damage
    if Level1Vars.has_method("remove_stamina"):
        Level1Vars.remove_stamina(stamina_removed)
    else:
        Level1Vars.stamina -= stamina_removed
        Level1Vars.stamina = max(0, Level1Vars.stamina)

    # Increase constitution experience (toughening effect)
    Global.constitution_exp += CONSTITUTION_EXP_PER_WHIP

    whip_triggered.emit(stamina_removed)

func reset_for_new_day():
    Level1Vars.reset_rage()
    _coal_delivered_since_last_decrease = 0
    _last_warning_rage = -1
    _last_severe_rage = -1
```

### 5. Integration with Coal Tracking

**Modify coal_piece.gd _on_entered_drop_zone():**
```gdscript
func _on_entered_drop_zone():
    # Skip if already counted as delivered
    if has_been_tracked:
        queue_free()
        return

    # Mark as tracked FIRST
    has_been_tracked = true

    # Track as dropped
    Level1Vars.coal_dropped += 1
    if Level1Vars.DEBUG_COAL_TRACKING:
        print("[COAL] Dropped! Total: ", Level1Vars.coal_dropped)

    # Trigger rage system
    RageManager.on_coal_dropped()

    # Flash red vignette
    var vignette = get_tree().get_first_node_in_group("vignette")
    if vignette:
        vignette.flash_red()

    queue_free()
```

**Modify coal_piece.gd _on_entered_delivery_zone():**
```gdscript
func _on_entered_delivery_zone() -> bool:
    # Skip if already counted
    if has_been_tracked:
        queue_free()
        return false

    # Mark as tracked FIRST
    has_been_tracked = true

    # Track as delivered
    Level1Vars.coal_delivered += 1
    if Level1Vars.DEBUG_COAL_TRACKING:
        print("[COAL] Delivered! Total: ", Level1Vars.coal_delivered)

    # Notify rage system
    RageManager.on_coal_delivered()

    # Red fade animation
    var tween = create_tween()
    tween.tween_property(self, "modulate", Color.RED, 0.3)
    tween.finished.connect(queue_free)

    return true
```

### 6. Connect to Notification System

**In furnace.gd _ready():**
```gdscript
func _ready():
    # ... existing setup

    RageManager.warning_triggered.connect(_on_overseer_warning)
    RageManager.severe_warning_triggered.connect(_on_overseer_severe_warning)
    RageManager.whip_triggered.connect(_on_player_whipped)

func _on_overseer_warning(message: String):
    Global.show_notification(message, Global.NOTIFICATION_TYPE_WARNING)

func _on_overseer_severe_warning(message: String):
    Global.show_notification(message, Global.NOTIFICATION_TYPE_WARNING)

func _on_player_whipped(stamina_removed: int):
    var msg = "The overseer's whip bites deep. -%d stamina" % stamina_removed
    Global.show_notification(msg, Global.NOTIFICATION_TYPE_WARNING)
    # TODO: Add whip sound effect
    # TODO: Add screen shake or additional visual feedback
```

### 7. Configure Autoload

**In project.godot, add RageManager to autoloads:**

Open Project -> Project Settings -> Autoload tab, then add:
- **Path**: `res://level1/rage_manager.gd`
- **Node Name**: `RageManager`
- **Enable**: Check "Enable" checkbox

Or manually edit project.godot:
```ini
[autoload]

Global="*res://autoloads/global.gd"
Level1Vars="*res://level1/level_1_vars.gd"
RageManager="*res://level1/rage_manager.gd"
```

### 8. Setup Vignette Group

**In vignette_overlay.gd _ready():**
```gdscript
func _ready():
    add_to_group("vignette")  # Allow easy access via get_first_node_in_group()
    mouse_filter = Control.MOUSE_FILTER_IGNORE
    color = Color(0.8, 0.1, 0.1, 0.0)  # Red, fully transparent
```

---

## Files to Create

- `level1/rage_manager.gd` - Rage system logic (autoload)
- `level1/vignette_overlay.gd` - Red flash effect
- `level1/vignette_overlay.tscn` - Vignette scene (CanvasLayer + ColorRect)

## Files to Modify

- `level1/level_1_vars.gd` - Add rage, whip_count, reset_rage()
- `level1/coal_piece.gd` - Call RageManager methods in drop/delivery handlers, flash vignette
- `level1/furnace.gd` - Connect rage signals to notification system
- `project.godot` - Add RageManager autoload
- **Day transition handler (TBD)** - Call RageManager.reset_for_new_day() when new day starts

---

## Testing Checklist

### Rage Tracking Tests
- [ ] Rage starts at 0
- [ ] Dropping coal increments rage by 1
- [ ] Delivering 10 coal decrements rage by 1
- [ ] Rage cannot go below 0
- [ ] Rage resets to 0 at day start

### Warning Tests
- [ ] Warning notification appears at rage 2
- [ ] Warning notification appears at rage 3, 4
- [ ] Different warning messages appear (randomized)
- [ ] Severe warning appears at rage 5
- [ ] Severe warning appears at rage 6, 7
- [ ] Different severe warning messages appear (randomized)
- [ ] No duplicate warnings for same rage level

### Whipping Tests
- [ ] First whip at rage 8, removes 10 stamina
- [ ] Second whip at rage 12, removes 15 stamina
- [ ] Third whip at rage 16, removes 20 stamina
- [ ] Constitution increases by 0.5 per whip
- [ ] Whip count resets with rage at day start

### Visual Feedback Tests
- [ ] Red vignette flashes when coal dropped
- [ ] Vignette lasts approximately 300ms
- [ ] Vignette fades in quickly, fades out slowly
- [ ] Multiple drops can trigger overlapping flashes

### Integration Tests
- [ ] Coal dropped -> vignette + rage increase + possible warning
- [ ] Coal delivered -> rage decrease tracking
- [ ] Day transition -> rage reset
- [ ] Stamina display updates after whipping

---

## Balance Tuning Notes

**Tuneable Parameters:**
- `WARNING_THRESHOLD` (2) - When first warning appears
- `SEVERE_WARNING_THRESHOLD` (5) - When severe warnings appear
- `WHIP_THRESHOLD` (8) - When first whip occurs
- `WHIP_INTERVAL` (4) - Rage between whips
- `BASE_WHIP_DAMAGE` (10) - First whip stamina cost
- `WHIP_DAMAGE_INCREASE` (5) - Additional damage per subsequent whip
- `COAL_PER_RAGE_DECREASE` (10) - Coal deliveries to reduce rage by 1
- `CONSTITUTION_EXP_PER_WHIP` (1) - Constitution experience gain per punishment

**Expected Player Experience:**
- Occasional drops (1-2): Minor visual punishment only
- Careless play (2-4 drops): Warnings create tension
- Continued carelessness (5-7 drops): Severe warnings, player knows punishment is coming
- Reckless play (8+ drops): Stamina punishment, must recover through good performance

**Warning Signs:**
- If players never reach rage 2, punishment is too lenient
- If players frequently hit rage 8+, consider increasing COAL_PER_RAGE_DECREASE
- If warnings feel spammy, increase thresholds or add cooldowns

---

## Notes & Decisions

**Decision: Rage resets daily**
- **Rationale**: Prevents death spiral where one bad day ruins the entire run
- **Alternative**: Rage persists but decays over time - rejected as too punishing
- **Implementation Note**: Day transition system will call RageManager.reset_for_new_day() when implemented

**Decision: 10 coal per rage decrease**
- **Rationale**: Requires sustained good performance to recover, not just a few deliveries
- **Alternative**: Faster decrease (5 coal) - felt too forgiving for "punishment" system

**Decision: Whip gives constitution_exp**
- **Rationale**: Creates interesting tradeoff - punishment has silver lining, fits "toughening up" narrative
- **Implementation**: Adds to constitution_exp (not constitution directly) to accumulate gradually
- **Alternative**: Pure punishment - rejected as too one-dimensional

**Decision: Warning at 2, severe at 5, whip at 8**
- **Rationale**: Gives player 7 drops worth of warnings before punishment
- **Alternative**: Faster escalation (1, 3, 5) - felt too punishing for early game

---

## Implementation Checklist

- [ ] Level1Vars rage variable added
- [ ] Level1Vars whip_count variable added
- [ ] Level1Vars reset_rage() function added
- [ ] VignetteOverlay scene created
- [ ] Vignette added to "vignette" group
- [ ] Vignette flash_red() function working
- [ ] RageManager autoload created and configured in project.godot
- [ ] Warning dialog pool implemented
- [ ] Severe warning dialog pool implemented
- [ ] Whipping logic implemented (increases constitution_exp)
- [ ] Coal drop triggers rage increase and vignette flash
- [ ] Coal delivery triggers rage decrease check
- [ ] Notifications connected to rage signals (using Global.show_notification)
- [ ] Day reset calls reset_for_new_day() - **TBD when day transition is implemented**
- [ ] All tests passing
