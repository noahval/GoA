# Dishwash: Rewards & Currency

**Goal**: Award Holes currency based on mugs completed, track progression toward mastery

**Success Criteria**: Player earns 1 Hole per 3 mugs completed, Level1Vars tracks lifetime mug count

## Overview

Implements the reward system for dishwashing. Tracks mugs completed this session and toward Hole rewards. Awards currency directly via Level1Vars.add_currency(). Increments lifetime mug counter for mastery tracking.

### Key Design Principles

- Batch payment: 3 mugs = 1 Hole
- Real-time currency updates (no session-end payment)
- Track partial progress (0/3, 1/3, 2/3 cycle)
- Lifetime counter for mastery unlock (used in 2.26)

---

## Implementation Tasks

### 1. Add Session Tracking Variables

Add to `dishwash_minigame.gd`:

```gdscript
var mugs_this_session: int = 0  # Total mugs completed this session
var mugs_toward_hole: int = 0  # Progress toward next Hole (0-2)

const MUGS_PER_HOLE: int = 3  # 3 mugs = 1 Hole
```

**Implementation details:**
- `mugs_this_session` tracks total for statistics (not used for rewards yet)
- `mugs_toward_hole` cycles 0→1→2→0 (resets on payment)
- Both reset when session starts

### 2. Update Session Start/Stop

Modify existing functions:

```gdscript
func start_washing():
	mugs_this_session = 0
	mugs_toward_hole = 0
	visible = true
	wash_mugs_button.disabled = true
	stop_washing_button.visible = true

func stop_washing():
	# (existing cleanup)
	if mug_bound_to_cursor:
		unbind_mug()

	# Reset session stats
	mugs_this_session = 0
	mugs_toward_hole = 0

	visible = false
	wash_mugs_button.disabled = false
	stop_washing_button.visible = false
```

**Explanation**: Session counters reset when starting/stopping washing. Fresh slate each session.

### 3. Implement Mug Completion Logic

Modify `attempt_rack_placement()`:

```gdscript
func attempt_rack_placement():
	if current_mug_state == MugState.DIRTY:
		show_error_notification("Clean it first!")
		return
	elif current_mug_state == MugState.WET:
		show_error_notification("Dry it first!")
		return
	elif current_mug_state == MugState.DRY:
		complete_mug()  # NEW: Handle progression

func complete_mug():
	# Increment counters
	mugs_this_session += 1
	mugs_toward_hole += 1
	Level1Vars.mugs_washed += 1

	# Unbind mug
	unbind_mug()

	# Award Holes if batch complete
	if mugs_toward_hole >= MUGS_PER_HOLE:
		mugs_toward_hole = 0
		Level1Vars.add_currency("holes", 1.0)
		# TODO: Play coin sound, flash UI (future polish)
```

**Explanation**: Tracks progress, awards Hole every 3 mugs. Uses Level1Vars.add_currency() for direct currency increment (triggers signal for UI updates).

### 4. Reset State Between Mugs

Ensure `unbind_mug()` resets all state:

```gdscript
func unbind_mug():
	mug_bound_to_cursor = false
	$BoundMug.visible = false

	# Reset state for next mug
	current_mug_state = MugState.DIRTY
	basin_soak_time = 0.0
	soak_movement_bonus = 0.0
	mug_in_basin = false
	# Note: Dry timer variables reset in 2.24
```

**Explanation**: Clean slate for next mug. Prevents state leakage between cycles.

---

## Testing Strategy

### Manual Test Criteria

- [ ] Completing 1 mug: No Hole awarded, progress saved
- [ ] Completing 2 mugs: No Hole awarded, progress saved
- [ ] Completing 3 mugs: 1 Hole awarded, progress resets to 0/3
- [ ] Completing 6 mugs: 2 Holes awarded total
- [ ] Level1Vars.mugs_washed increments by 1 per mug completed
- [ ] Currency display updates immediately when Hole awarded
- [ ] mugs_this_session increments correctly
- [ ] mugs_toward_hole cycles: 0→1→2→0→1→2→0
- [ ] Stopping session resets mugs_this_session and mugs_toward_hole
- [ ] Lifetime mug count (Level1Vars.mugs_washed) persists across sessions

### Test Scenarios

| Mugs Completed | Holes Awarded | mugs_toward_hole | Level1Vars.mugs_washed |
|----------------|---------------|------------------|------------------------|
| 1 | 0 | 1 | 1 |
| 2 | 0 | 2 | 2 |
| 3 | 1 | 0 | 3 |
| 4 | 1 | 1 | 4 |
| 5 | 1 | 2 | 5 |
| 6 | 2 | 0 | 6 |

---

## Files to Modify

- `c:\Goa\game\v0.1\level1\dishwash_minigame.gd` - Add all tracking and reward logic

---

## Design Values (Reference)

### Reward Formula

- **Mugs per Hole**: 3 (MUGS_PER_HOLE constant)
- **Hole calculation**: `mugs_washed / 3` (integer division)
- **Payment timing**: Immediate (not session-end)

### Tracking Variables

- **mugs_this_session**: Session-only counter (resets on stop)
- **mugs_toward_hole**: Progress counter (0-2, cycles)
- **Level1Vars.mugs_washed**: Lifetime counter (never resets)

---

## Notes & Decisions

**Decision: Real-time payment over session-end**
- Rationale: Immediate feedback more satisfying
- Player sees reward as soon as 3rd mug placed
- No waiting until session end
- Clearer cause-and-effect

**Decision: Direct currency increment over signal emission**
- Rationale: Level1Vars.add_currency() already handles signals
- Currency display auto-updates via existing signal system
- Simpler code (no manual signal emit needed)
- Follows established pattern from other systems

**Decision: Track partial progress (mugs_toward_hole)**
- Rationale: Necessary for batch payment
- Shows player they're making progress even without Hole
- Could be displayed in UI later (1/3, 2/3 counter)
- Prevents confusion about why mug didn't award Hole

**Decision: Separate session vs lifetime counters**
- Rationale: mugs_this_session for statistics/display
- Level1Vars.mugs_washed for mastery unlock
- Different purposes, different scopes
- Lifetime persists, session resets

**Decision: Reset mugs_toward_hole on Hole award**
- Rationale: Cycle starts fresh after payment
- Prevents accumulation bugs
- Clear 0-2 range makes logic simple
- Matches "batch of 3" mental model

**Decision: Increment Level1Vars.mugs_washed per mug**
- Rationale: Tracks every mug completed, not just Holes earned
- Needed for mastery threshold (150 mugs in 2.26)
- More granular progression tracking
- Matches "wash mugs" theme (not "earn Holes")

---

**Last Updated**: 2026-01-14
