# Shovel Experience System

**Goal**: Grant experience when coal is delivered to furnace, tracking both player level progression and Strength stat growth

**Success Criteria**:
- Coal delivery awards XP to both player level and Strength stat
- Player levels up at 15 XP (first level), then 1.3x multiplier for each subsequent level
- All progression values easily modifiable in Level1Vars
- Experience system integrates with existing coal delivery detection

## Overview

This system rewards players for successfully delivering coal to the furnace. Each delivery grants:
1. **Player Level XP** - A new separate progression system tracked in Level1Vars
2. **Strength Stat XP** - Uses Global's existing 6-stat experience system

The dual-track approach allows for simple player level tracking while also developing the character's Strength stat over time.

### Key Design Principles

- **1 XP per coal delivered** - Simple, clear reward rate
- **Progressive difficulty** - First level at 15 XP, then 1.3x multiplier (easier than Global's stat curve)
- **Dual progression** - Player level (local to coal shoveling) + Strength stat (global character stat)
- **Easily modifiable** - All values exposed in Level1Vars for balance tuning
- **No level-up effects yet** - Future plan will add rewards/unlocks

---

## Implementation Tasks

### 1. Add Level1Vars Variables

**Variables needed**:
```gdscript
# In level1/level_1_vars.gd

# Player level system (coal shoveling progression)
var player_level: int = 1
var player_experience: float = 0.0
var experience_gain_rate: float = 1.0  # Multiplier for XP gains (1.0 = normal, 2.0 = double XP)

# Experience curve configuration
const BASE_XP_FOR_LEVEL: float = 15.0  # XP needed for level 1 -> 2
const LEVEL_XP_MULTIPLIER: float = 1.3  # Each level requires 1.3x more XP

# Upgrade tracking
var upgrade_qty: int = 0  # Total number of upgrades purchased
```

**Implementation details:**
- `player_level` starts at 1 (tutorial/starting level)
- `player_experience` accumulates from coal deliveries
- `experience_gain_rate` allows future upgrades to boost XP (e.g., "XP Boost" upgrade sets this to 1.5)
- `BASE_XP_FOR_LEVEL` = 15 means first level-up happens at 15 coal delivered
- `LEVEL_XP_MULTIPLIER` = 1.3 means level 2->3 requires 15 * 1.3 = 19.5 XP

---

### 2. Experience Formula Function

**Calculate XP needed for a specific level**:
```gdscript
# In level1/level_1_vars.gd

# Calculate total XP needed to reach a specific level
func get_xp_for_level(level: int) -> float:
	if level <= 1:
		return 0.0

	# Cumulative formula: sum of (BASE * MULTIPLIER^(n-1)) for each level
	# Level 2: 15
	# Level 3: 15 + 15*1.3 = 15 + 19.5 = 34.5
	# Level 4: 34.5 + 19.5*1.3 = 34.5 + 25.35 = 59.85
	var total_xp: float = 0.0
	for lvl in range(2, level + 1):
		total_xp += BASE_XP_FOR_LEVEL * pow(LEVEL_XP_MULTIPLIER, lvl - 2)

	return total_xp

# Get progress toward next level (0.0 to 1.0)
func get_level_progress() -> float:
	var xp_for_current = get_xp_for_level(player_level)
	var xp_for_next = get_xp_for_level(player_level + 1)
	var xp_in_level = player_experience - xp_for_current
	var xp_needed_in_level = xp_for_next - xp_for_current

	if xp_needed_in_level <= 0:
		return 1.0

	return clampf(xp_in_level / xp_needed_in_level, 0.0, 1.0)
```

**Explanation:**
- Formula uses cumulative sum (not exponential like Global's stat system)
- `get_xp_for_level(N)` returns total XP needed to reach level N from level 1
- Example progression:
  - Level 1 -> 2: 15 XP
  - Level 2 -> 3: 19.5 XP (15 * 1.3)
  - Level 3 -> 4: 25.35 XP (19.5 * 1.3)
  - Level 4 -> 5: 32.96 XP (25.35 * 1.3)

---

### 3. Add Experience Function

**Award experience and check for level-ups**:
```gdscript
# In level1/level_1_vars.gd

# Award experience to player level and Strength stat
func add_experience(base_amount: float) -> void:
	# Apply experience gain rate modifier
	var actual_amount = base_amount * experience_gain_rate

	# Add to player level XP
	player_experience += actual_amount

	# Also grant Strength XP (physical work)
	Global.add_stat_exp("strength", actual_amount)

	# Check for level-ups (can level multiple times if enough XP)
	_check_level_up()

# Internal: Check if player should level up
func _check_level_up() -> void:
	var xp_for_next = get_xp_for_level(player_level + 1)

	while player_experience >= xp_for_next:
		player_level += 1

		# Show level-up notification (no other effects yet)
		if Global and Global.has_method("show_notification"):
			Global.show_notification("Level Up! You are now level %d" % player_level)

		# Recalculate for potential multiple level-ups
		xp_for_next = get_xp_for_level(player_level + 1)
```

**Key points:**
- `experience_gain_rate` multiplier applied first (allows future XP boost upgrades)
- Awards XP to both player level AND Strength stat
- Can level up multiple times in one call (if player gets massive XP dump)
- Level-up only shows notification (future plan adds mechanical effects)

---

### 4. Integrate with Coal Delivery

**Modify coal delivery detection to award XP**:

**In** `level1/furnace.gd`:
```gdscript
# Inside _on_coal_entered_delivery_zone callback

func _on_coal_entered_delivery_zone(body: Node2D):
	# Only coal can trigger this (collision_mask = 4)
	body._on_entered_delivery_zone()

	# Award experience for successful delivery
	Level1Vars.add_experience(1.0)  # 1 XP per coal delivered
```

**Implementation notes:**
- Hook into existing delivery zone detection (from plan 2.5-delivered-coal.md)
- Award 1.0 base XP per coal piece
- `experience_gain_rate` multiplier applied inside `add_experience()`
- Strength stat also gains XP automatically

---

### 5. Update Save/Load System

**Add new variables to save data**:

**In** `level1/level_1_vars.gd` (modify existing functions):
```gdscript
func get_save_data() -> Dictionary:
	return {
		# ... existing save data ...

		# Player level system (add these lines)
		"player_level": player_level,
		"player_experience": player_experience,
		"experience_gain_rate": experience_gain_rate,
		"upgrade_qty": upgrade_qty
	}

func load_save_data(data: Dictionary):
	# ... existing load code ...

	# Player level system (add these lines)
	player_level = data.get("player_level", 1)
	player_experience = data.get("player_experience", 0.0)
	experience_gain_rate = data.get("experience_gain_rate", 1.0)
	upgrade_qty = data.get("upgrade_qty", 0)

func reset_to_defaults():
	# ... existing reset code ...

	# Player level system (add these lines)
	player_level = 1
	player_experience = 0.0
	experience_gain_rate = 1.0
	upgrade_qty = 0
```

---

## Testing Strategy

### Unit Tests (Headless)

Create `tests/test_shovel_experience.gd`:

```gdscript
extends GutTest

# Test: XP formula for first few levels
func test_xp_for_level():
	# Level 1 -> 2: 15 XP
	assert_eq(Level1Vars.get_xp_for_level(2), 15.0, "Level 2 requires 15 XP")

	# Level 2 -> 3: 15 + 19.5 = 34.5 XP total
	assert_almost_eq(Level1Vars.get_xp_for_level(3), 34.5, 0.1, "Level 3 requires 34.5 total XP")

	# Level 3 -> 4: 34.5 + 25.35 = 59.85 XP total
	assert_almost_eq(Level1Vars.get_xp_for_level(4), 59.85, 0.1, "Level 4 requires ~59.85 total XP")

# Test: Level-up from 1 to 2
func test_level_up_basic():
	# Reset to defaults
	Level1Vars.player_level = 1
	Level1Vars.player_experience = 0.0

	# Add 15 XP (enough for level 2)
	Level1Vars.add_experience(15.0)

	assert_eq(Level1Vars.player_level, 2, "Player reaches level 2")
	assert_eq(Level1Vars.player_experience, 15.0, "XP stays at 15")

# Test: Multiple level-ups at once
func test_multiple_level_ups():
	Level1Vars.player_level = 1
	Level1Vars.player_experience = 0.0

	# Add 60 XP (enough for levels 2, 3, and 4)
	Level1Vars.add_experience(60.0)

	assert_eq(Level1Vars.player_level, 4, "Player reaches level 4")

# Test: Experience gain rate multiplier
func test_experience_gain_rate():
	Level1Vars.player_level = 1
	Level1Vars.player_experience = 0.0
	Level1Vars.experience_gain_rate = 2.0  # Double XP

	# Add 10 base XP -> becomes 20 XP with 2x multiplier
	Level1Vars.add_experience(10.0)

	assert_eq(Level1Vars.player_experience, 20.0, "2x multiplier doubles XP")
	assert_eq(Level1Vars.player_level, 2, "Player levels up with multiplied XP")

# Test: Progress toward next level
func test_level_progress():
	Level1Vars.player_level = 1
	Level1Vars.player_experience = 0.0

	# 0 XP = 0% progress
	assert_almost_eq(Level1Vars.get_level_progress(), 0.0, 0.01, "0 XP = 0% progress")

	# 7.5 XP = 50% progress (halfway to 15)
	Level1Vars.player_experience = 7.5
	assert_almost_eq(Level1Vars.get_level_progress(), 0.5, 0.01, "7.5 XP = 50% progress")

	# 15 XP = 100% progress (ready to level)
	Level1Vars.player_experience = 15.0
	assert_almost_eq(Level1Vars.get_level_progress(), 1.0, 0.01, "15 XP = 100% progress")

# Test: Strength stat also gains XP
func test_strength_xp_granted():
	var initial_strength_xp = Global.strength_exp

	# Award 10 XP to player level
	Level1Vars.add_experience(10.0)

	# Strength should also have gained 10 XP
	assert_eq(Global.strength_exp, initial_strength_xp + 10.0, "Strength gains same XP")
```

**Run tests:**
```bash
godot --headless --script res://tests/test_runner.gd
```

### Integration Tests

| Scenario | Setup | Action | Expected Result |
|----------|-------|--------|-----------------|
| Coal delivery awards XP | Level 1, 0 XP | Deliver 1 coal | Player has 1 XP, Strength has 1 XP |
| Level up at 15 coal | Level 1, 14 XP | Deliver 1 coal | Player reaches level 2, notification shown |
| Multiple deliveries accumulate | Level 1, 0 XP | Deliver 20 coal | Player reaches level 2 (15 XP), has 20 total XP |
| XP multiplier works | 2x XP rate, 0 XP | Deliver 1 coal | Player has 2 XP (1 base * 2x) |

### Manual Test Criteria

- [ ] Start furnace scene with 0 XP
- [ ] Deliver 1 coal to furnace
- [ ] Verify player_experience increased by 1.0
- [ ] Verify Global.strength_exp also increased by 1.0
- [ ] Deliver 14 more coal (15 total)
- [ ] Verify level-up notification appears
- [ ] Verify player_level increased to 2
- [ ] Check save/load preserves player level and XP
- [ ] Test with experience_gain_rate = 2.0, verify XP doubles

---

## Design Values (Reference)

### Experience Progression Table

**First 10 levels** (for balance reference):

| Level | XP This Level | Total XP Needed | Coal Deliveries |
|-------|---------------|-----------------|-----------------|
| 1 -> 2 | 15.0 | 15 | 15 |
| 2 -> 3 | 19.5 | 34.5 | 35 |
| 3 -> 4 | 25.35 | 59.85 | 60 |
| 4 -> 5 | 32.96 | 92.81 | 93 |
| 5 -> 6 | 42.84 | 135.65 | 136 |
| 6 -> 7 | 55.70 | 191.35 | 192 |
| 7 -> 8 | 72.41 | 263.76 | 264 |
| 8 -> 9 | 94.13 | 357.89 | 358 |
| 9 -> 10 | 122.37 | 480.26 | 481 |
| 10 -> 11 | 159.08 | 639.34 | 640 |

**Balance notes:**
- Level 2 after ~60 seconds of active shoveling (15 coal @ 4/second spawn rate)
- Level 5 after ~6-8 minutes of gameplay
- Level 10 after ~25-30 minutes of gameplay
- Progression feels meaningful but not grindy
- 1.3x multiplier gentler than Global's 1.8x stat curve

### Tuneable Parameters

**In Level1Vars:**
- `BASE_XP_FOR_LEVEL` (15.0) - Adjust to make leveling faster/slower
  - Lower = faster progression (e.g., 10.0 for casual play)
  - Higher = slower progression (e.g., 20.0 for more challenge)
- `LEVEL_XP_MULTIPLIER` (1.3) - Adjust difficulty curve
  - Lower = flatter curve (e.g., 1.2 for linear-ish progression)
  - Higher = steeper curve (e.g., 1.5 for exponential growth)
- `experience_gain_rate` (1.0) - Runtime XP boost
  - Future upgrades can set to 1.5, 2.0, etc.
  - Could be temporary buff (double XP weekend event)

**XP award location:**
- Currently: 1.0 XP per coal in `_on_coal_entered_delivery_zone()`
- Could vary by coal quality/type in future features
- Could scale with difficulty modifiers (rush orders = bonus XP)

---

## Files to Create

- `tests/test_shovel_experience.gd` - Experience system unit tests

## Files to Modify

- [level1/level_1_vars.gd](../../game/v0.1/level1/level_1_vars.gd) - Add player level variables, XP functions, save/load integration
- [level1/furnace.gd](../../game/v0.1/level1/furnace.gd) - Award XP on coal delivery

---

## Notes & Decisions

**Decision 1:** Dual-track progression (player level + Strength)
- **Rationale:** Allows simple local progression tracking while developing global character stats
- **Player level:** Coal shoveling mastery (local to furnace gameplay)
- **Strength stat:** Physical power (global character development, affects other scenes)
- **Benefit:** Both systems benefit from coal delivery, no wasted effort

**Decision 2:** 1.3x multiplier vs Global's 1.8x
- **Rationale:** Player level should feel faster/easier than stat progression
- **Comparison:**
  - Player level 1->2: 15 XP
  - Strength level 1->2: 100 XP (Global's stat system)
- **Feel:** Player level provides frequent "level up" dopamine hits, stats are long-term goals

**Decision 3:** No level-up effects yet
- **Rationale:** Decouple XP system from rewards (future plan handles upgrades/bonuses)
- **Benefit:** Can implement core XP tracking without designing full upgrade tree
- **Next step:** Future plan will add "spend points on upgrades" or "unlock new equipment" mechanics

**Decision 4:** upgrade_qty as simple counter
- **Rationale:** Track total upgrades purchased for achievements/milestones
- **Usage:** "You've purchased 10 upgrades!" achievement
- **Future:** Could gate content ("unlock X after 5 upgrades")

**Open Questions:**
- Should XP scale with difficulty? (e.g., 2x XP during rush orders)
- Should different coal types give different XP amounts?
- Should level-up restore stamina/focus? (QoL feature)

---

## Implementation Checklist

- [ ] Add player level variables to Level1Vars (player_level, player_experience, experience_gain_rate, upgrade_qty)
- [ ] Add experience constants to Level1Vars (BASE_XP_FOR_LEVEL, LEVEL_XP_MULTIPLIER)
- [ ] Implement get_xp_for_level() function
- [ ] Implement get_level_progress() function
- [ ] Implement add_experience() function with dual-track (player + Strength)
- [ ] Implement _check_level_up() with notification
- [ ] Integrate XP award in furnace.gd _on_coal_entered_delivery_zone()
- [ ] Update get_save_data() with new variables
- [ ] Update load_save_data() with new variables
- [ ] Update reset_to_defaults() with new variables
- [ ] Write unit tests (7 tests covering formulas, level-ups, multipliers)
- [ ] Run unit tests, verify all pass
- [ ] Manual test: deliver coal, verify XP awarded
- [ ] Manual test: reach level 2, verify notification
- [ ] Manual test: save/load preserves progression
- [ ] Verify Strength stat gains XP alongside player level

---

**Last Updated**: 2025-12-24
**Maintainer**: Claude + User collaboration
**Plan Version**: 1.0 (Initial implementation - dual-track XP system)
