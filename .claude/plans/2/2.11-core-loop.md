# Core Loop MVP

**Goal**: Complete one work day from start to finish with satisfying coal-shoveling feel.

**Success Criteria**: Can play one work day with satisfying coal shoveling

---

## Implementation Tasks

### 1. Furnace Scene Setup
- Create `res://level1/furnace_work.tscn`
- Basic layout: coal pile (left), furnace (right), UI bars (top)
- Stamina bar (starts 100, max 100)
- Focus bar (starts 100, max 100)
- Coal counter (current shift only)
- Copper display (persistent)

### 2. Click-Drag Coal Mechanic
- Click coal pile -> shovel loads with 1 coal
- Drag toward furnace -> coal follows cursor
- Release over furnace -> coal added to counter
- Stamina drain: 5 per successful shovel (base, before stats/equipment)
- Visual feedback: Shovel sprite follows cursor, coal sprite on top

### 3. Coal Spillage Physics
- **Distance-based chance**: Farther from pile = higher spill chance
- **Speed-based chance**: Faster drag = higher spill chance
- **Base spill chance**: 10% at normal speed/distance
- **Spilled coal**: Falls to ground, lost forever, visual feedback
- **Dexterity integration**: -1% spill per dexterity level

### 4. Screen Shake System
- **Train shake event**: Random frequency (every 15-45 seconds)
- **Small shake**: 2px amplitude, 0.3s duration, 30% spill increase
- **Big shake**: 5px amplitude, 0.8s duration, 60% spill increase
- **Patterns**: 30% chance small precedes big, 70% immediate big
- **Visual**: Camera shake + coal wobble on shovel

### 5. Lactic Acid Buildup
- **Trigger**: Shoveling faster than 1 shovel per 2 seconds
- **Buildup**: +5 lactic acid per fast shovel (max 100)
- **Effects**:
  - At 50+: +10% spill chance, arm shake visual
  - At 75+: +20% spill chance, screen edge blur
- **Decay**: -10 lactic acid per second when not shoveling fast
- **Visual**: Arm icon shaking intensity scales with buildup

### 6. Day End Conditions
- **Trigger**: Stamina OR focus hits 0
- **Payment calculation**: Copper earned at end of day based on total performance
  - Base rate: 0.05 copper per coal
  - Multiplier: 1.0x (no biases yet)
  - Payment = coal_count * 0.05 * 1.0
  - Result: ~20-60 coal possible on Day 1 = 1-3 copper
  - Note: Payment happens once at day end, not per shovel
- **Transition**: Auto-load evening scene

### 7. Evening Scene (Barebones)
- Create `res://level1/evening.tscn`
- Display: Copper earned, total copper, stats
- **Shop access**: Purchase equipment and items
  - Example: Better shovels, tools, optional treats with special effects
  - NOT for stamina/focus consumables (that's handled by rations)
- **Rations Choice** (Critical mechanic):
  - Free rations offered in mess hall before bed
  - "Eat Rations" button: Restores stamina/focus for next day BUT secretly resets daily upgrades (siphoned by nobility)
  - "Decline Rations" button: Keep your daily upgrades BUT start next day with reduced stamina/focus
  - Risk: Declining too obviously may trigger forced feeding event
  - Player must discover this trade-off through experimentation
- Sleep button -> restart at furnace_work.tscn

### 8. Stat XP Integration
- Strength XP: +1 per coal successfully shoveled
- Dexterity XP: +1 per shovel without spilling
- Use existing Global.add_stat_exp() system
- Notifications via Global.show_stat_notification()

---

## TDD Requirements (Headless Tests)

Create `tests/test_phase_2_1.gd`:

```gdscript
# Test: Coal shoveling grants Strength XP
func test_coal_shoveling_grants_strength_xp():
    var initial_strength_xp = Global.strength_exp
    simulate_coal_shovel(5)  # 5 successful shovels
    assert_eq(Global.strength_exp, initial_strength_xp + 5)

# Test: Stamina depletes on shovel
func test_stamina_depletion():
    RunState.stamina = 100
    simulate_coal_shovel(1)
    assert_eq(RunState.stamina, 95)  # 5 stamina per shovel

# Test: Day ends when stamina hits 0
func test_day_ends_at_zero_stamina():
    RunState.stamina = 10
    simulate_coal_shovel(2)
    assert_true(RunState.is_day_ended)

# Test: Payment calculation
func test_payment_calculation():
    RunState.coal_count = 50
    var payment = calculate_payment()
    assert_eq(payment, 2.5)  # 50 * 0.05 = 2.5 copper

# Test: Spill chance increases with speed
func test_spill_chance_speed():
    var base_chance = calculate_spill_chance(1.0, 100)  # Normal speed
    var fast_chance = calculate_spill_chance(2.0, 100)  # 2x speed
    assert_true(fast_chance > base_chance)

# Test: Lactic acid buildup
func test_lactic_acid_buildup():
    RunState.lactic_acid = 0
    simulate_fast_shovels(10)  # 10 fast shovels
    assert_eq(RunState.lactic_acid, 50)  # 5 per fast shovel
```

**Test execution**:
```bash
godot --headless --script res://tests/test_runner.gd
```

---

## Manual Test Criteria

- [ ] Can complete a full day (100 stamina = ~20 shovels at 5 stamina each)
- [ ] Coal spills visibly when dragging fast or far
- [ ] Screen shakes occur randomly during work
- [ ] Lactic acid visual appears after fast shoveling
- [ ] Payment shows 1-3 copper at end of day with ~40-60 coal
- [ ] Rations choice appears in evening scene
- [ ] Eating rations restores stamina but secretly resets daily upgrades
- [ ] Declining rations keeps upgrades but reduces next day stamina
- [ ] Strength/Dexterity level up after enough XP
- [ ] Can test rations trade-off across multiple days

---

## Files to Create

- `res://level1/furnace_work.gd` (main scene logic)
- `res://level1/furnace_work.tscn` (furnace UI)
- `res://level1/evening.gd` (evening phase logic)
- `res://level1/evening.tscn` (evening UI)
- `res://autoloads/run_state.gd` (run-specific variables)
- `res://tests/test_phase_2_1.gd` (headless tests)

## Files to Modify

- `global.gd`: Add furnace_work and evening to scene registry
- `project.godot`: Add RunState autoload

---

## Design Values (Reference)

### Economy
- Day 1 earnings: 1-3 copper at end of day (intentionally oppressive)
- Base rate: 0.05 copper per coal
- ~20-60 coal achievable on Day 1 with 100 stamina
- Payment is lump sum at day end, not per-shovel

### Rations Mechanic
- Free rations restore stamina/focus but secretly reset daily upgrades
- Declining rations preserves upgrades but reduces next day resources
- Trade-off discovery is key to player agency and narrative themes

### Resources
- Starting stamina: 100
- Starting focus: 100
- Stamina per shovel: 5 (base, before stats/equipment)

### Spillage
- Base spill chance: 10%
- Distance factor: Increases with distance
- Speed factor: Increases with drag speed
- Dexterity reduction: -1% per level

### Lactic Acid
- Trigger threshold: 1 shovel per 2 seconds
- Buildup rate: +5 per fast shovel
- Decay rate: -10 per second (when not shoveling fast)
- Max lactic acid: 100

