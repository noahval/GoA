# Dishwash: Rack Validation

**Goal**: Add state checking before rack placement with error notifications for invalid attempts

**Success Criteria**: Rack only accepts DRY mugs, shows "Clean it first!" for DIRTY, "Dry it first!" for WET

## Overview

Adds validation logic to rack placement. Checks mug state before allowing unbind. Shows contextual error messages for 1 second when player tries to rack dirty or wet mugs.

### Key Design Principles

- Clear feedback for invalid actions
- Contextual error messages based on state
- Errors disappear automatically after 1 second
- No punishment for mistakes (just informative)

---

## Implementation Tasks

### 1. Modify Rack Click Handler

Update `dishwash_minigame.gd`:

```gdscript
func _on_rack_clicked(_viewport, event, _shape_idx):
	if event is InputEventMouseButton and event.pressed and event.button_index == MOUSE_BUTTON_LEFT:
		if mug_bound_to_cursor:
			attempt_rack_placement()  # Now validates instead of always succeeding

func attempt_rack_placement():
	if current_mug_state == MugState.DIRTY:
		show_error_notification("Clean it first!")
		return
	elif current_mug_state == MugState.WET:
		show_error_notification("Dry it first!")
		return
	elif current_mug_state == MugState.DRY:
		unbind_mug()  # Success - place mug
		# Note: Actual progression tracking added in 2.23

# (show_error_notification already exists from 2.19)
```

**Explanation**: Checks state before unbinding. DIRTY and WET show errors. Only DRY succeeds.

### 2. Test Manually Setting DRY State

Since drying logic doesn't exist yet (comes in 2.24), add temporary debug helper:

```gdscript
func _input(event):
	# TEMPORARY DEBUG: Press D to force DRY state for testing
	if event is InputEventKey and event.pressed and event.keycode == KEY_D:
		if mug_bound_to_cursor and current_mug_state == MugState.WET:
			transition_to_dry()

func transition_to_dry():
	current_mug_state = MugState.DRY
	$BoundMug/MugSprite.texture = MUG_CLEAN_TEXTURE

# Add to texture preloads
const MUG_CLEAN_TEXTURE = preload("res://level1/icons/mug-clean.png")
```

**Explanation**: Debug key allows testing rack validation. Press D to manually dry WET mug. Will be removed when auto-dry timer added in 2.24.

---

## Testing Strategy

### Manual Test Criteria

- [ ] Clicking rack with DIRTY mug shows "Clean it first!" error
- [ ] Clicking rack with WET mug shows "Dry it first!" error
- [ ] Error notification appears centered above rack
- [ ] Error disappears automatically after 1 second
- [ ] Multiple error clicks don't stack notifications (only one visible)
- [ ] Mug stays bound to cursor after error (doesn't unbind)
- [ ] Pressing D key with WET mug transitions to DRY state (debug helper)
- [ ] Clicking rack with DRY mug successfully unbinds (no error)

### Test Flow

1. Start washing session
2. Click dirty stack (bind DIRTY mug)
3. Click rack → "Clean it first!" error
4. Move mug into basin, wait 4 seconds (becomes WET)
5. Click rack → "Dry it first!" error
6. Press D key (debug: becomes DRY)
7. Click rack → Success, mug unbinds

---

## Files to Modify

- `c:\Goa\game\v0.1\level1\dishwash_minigame.gd` - Add validation logic and debug helper

---

## Design Values (Reference)

### Error Messages

- **DIRTY mug**: "Clean it first!"
- **WET mug**: "Dry it first!"
- **Error duration**: 1.0 seconds (auto-hide)

### Debug Controls (Temporary)

- **D key**: Force WET → DRY transition for testing
- **Purpose**: Test rack validation without waiting for drying timer
- **Remove in**: 2.24 when auto-dry timer implemented

---

## Notes & Decisions

**Decision: Mug stays bound after error**
- Rationale: Player can immediately try again after fixing mistake
- No punishment for failed placement
- More forgiving UX
- Doesn't force player to pick up mug again

**Decision: Error notification centered above rack**
- Rationale: Close to action point (rack)
- Doesn't obscure basin or stack
- Clear connection between action and error
- Consistent positioning helps readability

**Decision: 1 second auto-hide**
- Rationale: Long enough to read
- Short enough not to be annoying
- Doesn't interrupt flow if player clicks repeatedly
- No manual dismiss needed

**Decision: Contextual error messages**
- Rationale: Tells player exactly what's wrong
- "Clean it first!" clearly states need to soak
- "Dry it first!" clearly states need to dry
- Better than generic "Can't place mug here"

**Decision: Debug key for testing**
- Rationale: Allows testing validation before drying timer exists
- Faster iteration during development
- Marked as TEMPORARY in comments
- Will be removed when 2.24 completes

**Decision: No error sound yet**
- Rationale: Audio system added later if needed
- Visual feedback sufficient for now
- Can be enhanced in future polish pass
- Keeps this plan focused on logic

---

**Last Updated**: 2026-01-14
